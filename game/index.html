<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galaxy Clash - Ultimate Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --gold:#FFD700;--gold-dark:#B8860B;--gold-light:#FFE55C;
  --blue:#00D9FF;--blue-dark:#0099CC;
  --red:#FF0040;--red-dark:#CC0033;
  --green:#00ff88;--green-dark:#00CC6A;
  --purple:#9b59b6;--purple-dark:#7D3C98;
  --orange:#ff8c00;--cyan:#00ffff;
  --bg-dark:#0a0a1a;--bg-mid:#141428;--bg-light:#1e1e3a;
  --border-glow:0 0 20px rgba(255,215,0,0.3);
  --text-shadow:0 2px 4px rgba(0,0,0,0.5);
}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
@keyframes glow{0%,100%{filter:drop-shadow(0 0 5px var(--gold))}50%{filter:drop-shadow(0 0 15px var(--gold))}}
@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
@keyframes floatUp{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes borderGlow{0%,100%{box-shadow:0 0 5px var(--gold),inset 0 0 5px rgba(255,215,0,0.1)}50%{box-shadow:0 0 20px var(--gold),inset 0 0 10px rgba(255,215,0,0.2)}}
@keyframes hit{0%{filter:brightness(1);transform:scale(1)}25%{filter:brightness(2.5) hue-rotate(-30deg);transform:scale(0.85) rotate(-5deg)}50%{filter:brightness(1.5);transform:scale(1.1) rotate(3deg)}100%{filter:brightness(1);transform:scale(1) rotate(0)}}
@keyframes heal{0%{filter:brightness(1);transform:scale(1)}50%{filter:brightness(1.6) hue-rotate(90deg);transform:scale(1.15);box-shadow:0 0 20px var(--green)}100%{filter:brightness(1);transform:scale(1)}}
@keyframes lightning{0%{filter:brightness(1);transform:scale(1)}20%{filter:brightness(3) hue-rotate(200deg);transform:scale(0.9)}40%{filter:brightness(1.5);transform:scale(1.1)}60%{filter:brightness(2.5) hue-rotate(180deg);transform:scale(0.95)}80%{filter:brightness(2);transform:scale(1.05)}100%{filter:brightness(1);transform:scale(1)}}
@keyframes death{0%{opacity:1;transform:scale(1) rotate(0)}30%{transform:scale(1.1) rotate(-10deg)}60%{opacity:0.7;transform:scale(0.8) rotate(15deg)}100%{opacity:0.25;transform:scale(0.9) rotate(0);filter:grayscale(1)}}
@keyframes crit{0%{transform:scale(1)}20%{transform:scale(1.3);filter:brightness(2) saturate(2)}50%{transform:scale(0.8)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px) rotate(-2deg)}40%{transform:translateX(8px) rotate(2deg)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
@keyframes block{0%{transform:scale(1)}50%{transform:scale(1.1);box-shadow:0 0 25px var(--blue);filter:brightness(1.3)}100%{transform:scale(1)}}
@keyframes poison{0%,100%{filter:hue-rotate(0)}50%{filter:hue-rotate(80deg) brightness(0.8);box-shadow:0 0 15px #00ff00}}
@keyframes betray{0%{filter:brightness(1);border-color:rgba(255,215,0,0.3)}25%{filter:brightness(1.5) hue-rotate(-60deg);border-color:var(--red)}50%{transform:scale(1.2);box-shadow:0 0 20px var(--red)}75%{filter:brightness(2);border-color:var(--red)}100%{filter:brightness(1);border-color:var(--red)}}
@keyframes resurrect{0%{opacity:0.2;transform:scale(0.5) rotate(-180deg);filter:grayscale(1)}50%{opacity:0.7;transform:scale(1.2) rotate(0);filter:hue-rotate(120deg) brightness(1.5)}100%{opacity:1;transform:scale(1);filter:hue-rotate(0)}}
@keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes comboFlash{0%{background:rgba(255,215,0,0.1)}50%{background:rgba(255,215,0,0.4);box-shadow:0 0 30px var(--gold)}100%{background:rgba(255,215,0,0.1)}}
@keyframes achievementPop{0%{transform:translateX(100%) scale(0.5);opacity:0}20%{transform:translateX(0) scale(1.1);opacity:1}30%{transform:scale(1)}90%{transform:translateX(0);opacity:1}100%{transform:translateX(100%);opacity:0}}

body{
  font-family:'Rajdhani',sans-serif;
  background:linear-gradient(180deg,#050510 0%,#0a0a1a 20%,#12122a 50%,#0a0a1a 80%,#050510 100%);
  background-attachment:fixed;
  min-height:100vh;
  color:#e0e0e0;
  line-height:1.5;
}

/* SOUND CONTROLS */
.sound-toggle{position:fixed;top:15px;right:15px;z-index:800;display:flex;gap:8px}
.sound-btn{
  background:linear-gradient(145deg,rgba(30,30,60,0.95),rgba(15,15,35,0.95));
  border:2px solid var(--gold);
  color:var(--gold);
  width:44px;height:44px;
  border-radius:50%;
  cursor:pointer;
  font-size:1.2em;
  transition:all 0.3s ease;
  box-shadow:0 4px 15px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.1);
}
.sound-btn:hover{transform:scale(1.1) rotate(5deg);box-shadow:0 0 20px rgba(255,215,0,0.4)}
.sound-btn.muted{opacity:0.4;border-color:#444;color:#444;box-shadow:none}

/* AI MODE SELECTOR */
.ai-mode-bar{display:flex;gap:8px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
.ai-btn{
  background:linear-gradient(145deg,rgba(20,30,50,0.9),rgba(10,15,30,0.9));
  border:2px solid var(--cyan);
  color:var(--cyan);
  padding:8px 18px;
  border-radius:20px;
  cursor:pointer;
  font-family:'Orbitron';
  font-size:0.7em;
  font-weight:600;
  transition:all 0.3s ease;
  text-transform:uppercase;
  letter-spacing:1px;
}
.ai-btn:hover{background:rgba(0,255,255,0.15);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,255,255,0.2)}
.ai-btn.active{background:linear-gradient(145deg,var(--cyan),var(--blue-dark));color:#000;font-weight:700;box-shadow:0 0 20px rgba(0,255,255,0.4)}
.ai-difficulty{display:flex;gap:6px;align-items:center}
.diff-btn{
  background:linear-gradient(145deg,rgba(30,30,50,0.9),rgba(15,15,30,0.9));
  border:2px solid #555;
  color:#888;
  padding:6px 14px;
  border-radius:15px;
  cursor:pointer;
  font-size:0.65em;
  font-family:'Orbitron';
  transition:all 0.3s ease;
  text-transform:uppercase;
}
.diff-btn:hover{border-color:var(--gold);color:var(--gold);transform:translateY(-1px)}
.diff-btn.active{font-weight:700;box-shadow:0 0 15px currentColor}
.diff-btn.easy{border-color:var(--green);color:var(--green)}.diff-btn.easy.active{background:linear-gradient(145deg,var(--green),var(--green-dark));color:#000}
.diff-btn.hard{border-color:var(--orange);color:var(--orange)}.diff-btn.hard.active{background:linear-gradient(145deg,var(--orange),#cc6600);color:#000}
.diff-btn.brutal{border-color:var(--red);color:var(--red)}.diff-btn.brutal.active{background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff}

/* COMBO ATTACKS */
.combo-alert{
  background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,165,0,0.1));
  border:3px solid var(--gold);
  border-radius:16px;
  padding:20px;
  margin:12px 0;
  text-align:center;
  animation:comboFlash 0.8s ease-in-out;
  box-shadow:0 0 30px rgba(255,215,0,0.2),inset 0 0 30px rgba(255,215,0,0.05);
}
.combo-title{
  font-family:'Orbitron';
  font-size:1.4em;
  font-weight:900;
  color:var(--gold);
  text-shadow:0 0 20px var(--gold),0 2px 4px rgba(0,0,0,0.5);
  letter-spacing:2px;
}
.combo-fighters{display:flex;justify-content:center;gap:25px;margin:15px 0}
.combo-fighter{text-align:center}
.combo-fighter .emoji{font-size:2.5em;filter:drop-shadow(0 0 10px rgba(255,215,0,0.5))}
.combo-fighter .name{font-size:0.85em;color:#fff;font-weight:600;margin-top:5px}
.combo-damage{
  font-family:'Orbitron';
  font-size:1.8em;
  font-weight:900;
  color:var(--red);
  text-shadow:0 0 20px var(--red),0 2px 4px rgba(0,0,0,0.5);
}

/* ACHIEVEMENTS */
.achievement-popup{
  position:fixed;top:80px;right:20px;
  background:linear-gradient(145deg,rgba(30,30,60,0.98),rgba(15,15,40,0.98));
  border:3px solid var(--gold);
  border-radius:20px;
  padding:20px 25px;
  z-index:1100;
  min-width:300px;
  animation:achievementPop 4s ease-in-out forwards;
  box-shadow:0 10px 40px rgba(0,0,0,0.5),0 0 40px rgba(255,215,0,0.3),inset 0 1px 0 rgba(255,255,255,0.1);
}
.achievement-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.achievement-icon{font-size:2.5em;filter:drop-shadow(0 0 10px var(--gold))}
.achievement-title{font-family:'Orbitron';font-size:1em;font-weight:700;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,0.5)}
.achievement-label{font-size:0.65em;color:#666;text-transform:uppercase;letter-spacing:2px}
.achievement-desc{font-size:0.85em;color:#ccc;line-height:1.4}
.achievement-xp{font-family:'Orbitron';font-size:0.75em;color:var(--green);margin-top:8px;text-shadow:0 0 10px rgba(0,255,136,0.5)}

.achievements-panel{
  background:linear-gradient(145deg,rgba(20,20,40,0.9),rgba(10,10,25,0.9));
  border:2px solid var(--gold);
  border-radius:12px;
  padding:15px;
  margin-top:12px;
  box-shadow:inset 0 0 20px rgba(0,0,0,0.3);
}
.achievements-title{font-family:'Orbitron';font-size:0.8em;color:var(--gold);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;max-height:220px;overflow-y:auto;padding-right:5px}
.achievements-grid::-webkit-scrollbar{width:6px}
.achievements-grid::-webkit-scrollbar-track{background:rgba(0,0,0,0.3);border-radius:3px}
.achievements-grid::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px}
.ach-card{
  background:linear-gradient(145deg,rgba(50,50,90,0.7),rgba(30,30,60,0.7));
  border:2px solid rgba(100,100,150,0.4);
  border-radius:10px;
  padding:10px;
  text-align:center;
  transition:all 0.3s ease;
  cursor:help;
}
.ach-card:hover{border-color:var(--gold);transform:scale(1.03);box-shadow:0 5px 20px rgba(0,0,0,0.3)}
.ach-card.unlocked{border-color:var(--gold);background:linear-gradient(145deg,rgba(80,70,40,0.5),rgba(50,45,25,0.5));box-shadow:0 0 15px rgba(255,215,0,0.2)}
.ach-card.locked{opacity:0.5;filter:grayscale(0.6)}
.ach-card .icon{font-size:1.8em;margin-bottom:6px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.ach-card .name{font-size:0.7em;color:#fff;font-weight:700}
.ach-card .desc{font-size:0.6em;color:#888;margin-top:4px;line-height:1.3}
.ach-card .xp{font-size:0.6em;color:var(--green);font-family:'Orbitron';margin-top:4px}
.ach-progress{background:rgba(0,0,0,0.5);height:5px;border-radius:3px;margin-top:6px;overflow:hidden}
.ach-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold-light));transition:width 0.3s}

/* XP BAR */
.xp-bar-container{
  background:linear-gradient(145deg,rgba(30,20,50,0.9),rgba(15,10,30,0.9));
  border:2px solid var(--purple);
  border-radius:12px;
  padding:10px 15px;
  margin-bottom:12px;
  box-shadow:0 4px 15px rgba(155,89,182,0.2),inset 0 0 20px rgba(0,0,0,0.3);
}
.xp-header{display:flex;justify-content:space-between;font-size:0.7em;margin-bottom:6px;align-items:center}
.xp-level{color:var(--purple);font-family:'Orbitron';font-weight:900;font-size:1.1em;text-shadow:0 0 10px rgba(155,89,182,0.5)}
.xp-amount{color:#aaa;font-family:'Rajdhani'}
.xp-bar{height:10px;background:rgba(0,0,0,0.5);border-radius:5px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,0.5)}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--purple),#e056fd,var(--purple));background-size:200% 100%;animation:shimmer 3s linear infinite;transition:width 0.5s;box-shadow:0 0 10px var(--purple)}

/* CONTAINER & LAYOUT */
.container{max-width:1450px;margin:0 auto;padding:15px}

/* HEADER */
.header{
  text-align:center;
  padding:18px 20px;
  background:linear-gradient(145deg,rgba(25,25,50,0.98),rgba(15,15,35,0.98));
  border:3px solid var(--gold);
  border-radius:16px;
  margin-bottom:15px;
  box-shadow:0 8px 30px rgba(0,0,0,0.4),0 0 40px rgba(255,215,0,0.15),inset 0 1px 0 rgba(255,255,255,0.1);
  position:relative;
  overflow:hidden;
}
.header::before{
  content:'';
  position:absolute;
  top:0;left:-100%;
  width:50%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,215,0,0.1),transparent);
  animation:shimmer 4s infinite;
}
.title{
  font-family:'Orbitron';
  font-size:2.2em;
  font-weight:900;
  background:linear-gradient(135deg,#FFD700 0%,#FFA500 25%,#FFD700 50%,#FFEC8B 75%,#FFD700 100%);
  background-size:200% auto;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  animation:shimmer 3s linear infinite;
  text-shadow:none;
  filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  letter-spacing:2px;
}

/* MODE BUTTONS */
.mode-bar{display:flex;justify-content:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.mode-btn{
  background:linear-gradient(145deg,rgba(30,30,55,0.95),rgba(15,15,35,0.95));
  border:2px solid var(--gold);
  color:var(--gold);
  padding:10px 22px;
  border-radius:25px;
  cursor:pointer;
  font-family:'Orbitron';
  font-weight:700;
  font-size:0.75em;
  transition:all 0.3s ease;
  text-transform:uppercase;
  letter-spacing:1px;
  box-shadow:0 4px 15px rgba(0,0,0,0.3);
}
.mode-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(255,215,0,0.25)}
.mode-btn.active{
  background:linear-gradient(145deg,var(--gold),var(--gold-dark));
  color:#000;
  box-shadow:0 0 25px rgba(255,215,0,0.5);
}
.mode-btn.red{border-color:var(--red);color:var(--red)}
.mode-btn.red:hover{box-shadow:0 8px 25px rgba(255,0,64,0.25)}
.mode-btn.red.active{background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff;box-shadow:0 0 25px rgba(255,0,64,0.5)}
.mode-btn.purple{border-color:var(--purple);color:var(--purple)}
.mode-btn.purple:hover{box-shadow:0 8px 25px rgba(155,89,182,0.25)}
.mode-btn.purple.active{background:linear-gradient(145deg,var(--purple),var(--purple-dark));color:#fff;box-shadow:0 0 25px rgba(155,89,182,0.5)}

/* MAIN GRID */
.main-grid{display:grid;grid-template-columns:1fr 320px;gap:15px}
@media(max-width:900px){.main-grid{grid-template-columns:1fr}}
/* ARENA */
.arena{
  background:linear-gradient(145deg,rgba(25,25,50,0.98),rgba(12,12,30,0.98));
  border:3px solid var(--gold);
  border-radius:16px;
  padding:15px;
  min-height:420px;
  box-shadow:0 8px 30px rgba(0,0,0,0.4),inset 0 0 40px rgba(0,0,0,0.3);
  position:relative;
}
.bf-title{
  font-family:'Orbitron';
  text-align:center;
  color:var(--gold);
  font-size:1em;
  font-weight:700;
  margin-bottom:12px;
  text-shadow:0 0 15px rgba(255,215,0,0.4);
  letter-spacing:1px;
}

/* TEAMS ROW */
.teams-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.team-box{
  background:linear-gradient(145deg,rgba(20,25,50,0.9),rgba(10,12,30,0.9));
  border-radius:12px;
  padding:12px;
  border-left:4px solid var(--blue);
  box-shadow:0 4px 15px rgba(0,0,0,0.3),inset 0 0 20px rgba(0,0,0,0.2);
  transition:all 0.3s ease;
}
.team-box:hover{box-shadow:0 6px 20px rgba(0,0,0,0.4)}
.team-box.enemy{border-left-color:var(--red)}
.team-box.active-team{
  box-shadow:0 0 20px rgba(255,215,0,0.2);
  border:2px solid rgba(255,215,0,0.4);
  border-left-width:4px;
}
.team-label{
  font-family:'Orbitron';
  font-size:0.8em;
  font-weight:700;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  text-shadow:0 0 10px currentColor;
}
.units-flex{display:flex;flex-wrap:wrap;gap:6px;min-height:65px;align-content:flex-start}
.units-flex.team-drop-zone{
  transition:all 0.3s ease;
  border:2px dashed transparent;
  border-radius:8px;
  padding:4px;
  margin:-4px;
}
.team-box.drag-over .units-flex.team-drop-zone{
  border-color:var(--cyan);
  background:rgba(0,255,255,0.1);
  box-shadow:inset 0 0 20px rgba(0,255,255,0.2);
}

/* Draggable roster cards */
.u-card[draggable="true"]{cursor:grab}
.u-card[draggable="true"]:active{cursor:grabbing}
.u-card.dragging{opacity:0.5;transform:scale(0.95)}

/* BATTLE UNITS */
.battle-unit{
  width:60px;
  background:linear-gradient(145deg,rgba(50,55,90,0.95),rgba(30,35,60,0.95));
  border:2px solid rgba(255,215,0,0.3);
  border-radius:10px;
  padding:5px;
  text-align:center;
  transition:all 0.3s ease;
  position:relative;
  cursor:grab;
  box-shadow:0 3px 10px rgba(0,0,0,0.3);
}
.battle-unit:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.4);border-color:rgba(255,215,0,0.6)}
.battle-unit:active{cursor:grabbing}
.battle-unit.drag-over{border-color:var(--cyan);box-shadow:0 0 20px var(--cyan);transform:scale(1.05)}
.battle-unit.dragging{opacity:0.5;transform:scale(0.9)}
.battle-unit.editable{cursor:pointer}
.battle-unit.editable:hover{border-color:var(--cyan);box-shadow:0 0 15px rgba(0,255,255,0.4);transform:translateY(-3px)}
.battle-unit.dead{animation:death 0.6s forwards}.battle-unit.hit{animation:hit 0.4s}
.battle-unit.heal{animation:heal 0.5s}.battle-unit.lightning{animation:lightning 0.6s}
.battle-unit.crit{animation:crit 0.4s}.battle-unit.shake{animation:shake 0.4s}
.battle-unit.block{animation:block 0.4s}.battle-unit.poison{animation:poison 0.8s}
.battle-unit.betray{animation:betray 0.8s}.battle-unit.resurrect{animation:resurrect 1s}
.battle-unit.betrayed{border-color:var(--red)!important;box-shadow:0 0 15px var(--red)}
.battle-unit.undead{border-color:#00ff00!important;box-shadow:0 0 12px #00ff00;filter:hue-rotate(80deg) saturate(0.7)}
.battle-unit.buffed{box-shadow:0 0 12px var(--cyan)}.battle-unit.shielded{box-shadow:0 0 12px var(--blue)}
.battle-unit.leader{border-color:var(--gold);box-shadow:0 0 15px var(--gold);animation:borderGlow 2s infinite}
.battle-unit.front{border-bottom:3px solid var(--red)}.battle-unit.back{border-bottom:3px solid var(--blue)}

/* BADGES */
.leader-badge{
  position:absolute;top:-8px;left:50%;transform:translateX(-50%);
  background:linear-gradient(145deg,var(--gold),var(--gold-dark));
  color:#000;font-size:0.45em;padding:2px 6px;border-radius:4px;font-weight:900;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
  letter-spacing:0.5px;
}
.row-badge{
  position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);
  font-size:0.4em;padding:2px 5px;border-radius:3px;font-weight:700;
  letter-spacing:0.5px;
}
.row-badge.front{background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff}
.row-badge.back{background:linear-gradient(145deg,var(--blue),var(--blue-dark));color:#fff}
.unit-equip-icons{
  position:absolute;bottom:16px;left:50%;transform:translateX(-50%);
  display:flex;gap:2px;font-size:0.55em;
  background:rgba(0,0,0,0.8);padding:2px 4px;border-radius:4px;
}

/* UNIT AVATAR */
.unit-avatar{
  width:36px;height:36px;margin:0 auto 3px;
  border-radius:8px;
  background:linear-gradient(145deg,rgba(20,20,40,0.9),rgba(0,0,0,0.5));
  display:flex;align-items:center;justify-content:center;
  font-size:1.2em;overflow:hidden;position:relative;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.5);
}
.unit-avatar img{width:100%;height:100%;object-fit:cover;object-position:center top;border-radius:6px}
.unit-avatar .emoji-fallback{font-size:1.2em}
.unit-nm{
  font-size:0.55em;
  color:#fff;
  text-align:center;
  line-height:1.2;
  max-width:100%;
  word-wrap:break-word;
  font-weight:600;
  text-shadow:0 1px 2px rgba(0,0,0,0.5);
}
.hp-bar{
  height:4px;
  background:rgba(0,0,0,0.6);
  border-radius:2px;
  margin-top:3px;
  overflow:hidden;
  box-shadow:inset 0 1px 2px rgba(0,0,0,0.5);
}
.hp-fill{
  height:100%;
  background:linear-gradient(90deg,var(--green),var(--green-dark));
  transition:width 0.3s ease;
  box-shadow:0 0 5px var(--green);
}
.hp-fill.mid{background:linear-gradient(90deg,var(--orange),#cc6600);box-shadow:0 0 5px var(--orange)}
.hp-fill.low{background:linear-gradient(90deg,var(--red),var(--red-dark));box-shadow:0 0 5px var(--red)}
.buff-icons{position:absolute;top:-3px;right:-3px;display:flex;gap:2px;font-size:0.55em}

/* DRAG DROP ZONES */
.drop-zone{
  border:2px dashed rgba(255,215,0,0.4);
  border-radius:10px;
  padding:10px;
  min-height:55px;
  transition:all 0.3s ease;
  margin:6px 0;
  background:rgba(0,0,0,0.2);
}
.drop-zone.drag-active{border-color:var(--cyan);background:rgba(0,255,255,0.05)}
.drop-zone.drag-over{border-color:var(--gold);background:rgba(255,215,0,0.1);box-shadow:0 0 20px rgba(255,215,0,0.3)}
.drop-zone-label{font-size:0.65em;color:#666;text-align:center;margin-bottom:6px;font-family:'Orbitron';text-transform:uppercase;letter-spacing:1px}
.formation-drop{display:flex;gap:12px;margin-top:10px}
.formation-zone{flex:1;min-height:75px}
.formation-zone.front{border-color:rgba(255,0,64,0.5)}.formation-zone.front.drag-over{border-color:var(--red);background:rgba(255,0,64,0.15)}
.formation-zone.back{border-color:rgba(0,136,255,0.5)}.formation-zone.back.drag-over{border-color:var(--blue);background:rgba(0,136,255,0.15)}
.leader-drop{border-color:rgba(255,215,0,0.6);text-align:center;min-height:65px}
.leader-drop.drag-over{background:rgba(255,215,0,0.15)}

/* EQUIPMENT DRAG */
.equip-item{
  background:linear-gradient(145deg,rgba(50,55,90,0.95),rgba(30,35,60,0.95));
  border:2px solid rgba(100,100,150,0.5);
  border-radius:10px;
  padding:8px 12px;
  cursor:grab;
  transition:all 0.3s ease;
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin:4px;
  box-shadow:0 3px 10px rgba(0,0,0,0.2);
}
.equip-item:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.3)}
.equip-item:active{cursor:grabbing}
.equip-item.dragging{opacity:0.5}
.equip-item.assigned{border-color:var(--green);background:linear-gradient(145deg,rgba(0,80,50,0.4),rgba(0,50,30,0.4))}
.equip-item .emoji{font-size:1.3em}
.equip-item .name{font-size:0.75em;color:#fff;font-weight:600}
.equip-item .stats{font-size:0.6em;color:var(--green)}
.equip-item .assigned-to{font-size:0.55em;color:var(--cyan);margin-left:6px}

/* BATTLEFIELD PREVIEW */
.battlefield-preview{
  background:linear-gradient(145deg,rgba(30,20,50,0.98),rgba(15,10,35,0.98));
  border:3px solid var(--gold);
  border-radius:18px;
  padding:18px;
  margin-bottom:12px;
  position:relative;
  overflow:hidden;
  box-shadow:0 8px 30px rgba(0,0,0,0.4),0 0 30px rgba(255,215,0,0.1);
}
.battlefield-preview::before{content:'';position:absolute;inset:0;background-size:cover;background-position:center;opacity:0.25;pointer-events:none}
.bf-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;position:relative;z-index:2}
.bf-preview-title{
  font-family:'Orbitron';
  font-size:1.2em;
  font-weight:700;
  color:var(--gold);
  text-shadow:0 0 15px rgba(255,215,0,0.5);
  letter-spacing:1px;
}
.bf-preview-reroll{
  background:linear-gradient(145deg,rgba(20,30,50,0.9),rgba(10,15,30,0.9));
  border:2px solid var(--cyan);
  color:var(--cyan);
  padding:8px 16px;
  border-radius:20px;
  cursor:pointer;
  font-family:'Orbitron';
  font-size:0.7em;
  font-weight:600;
  transition:all 0.3s ease;
}
.bf-preview-reroll:hover{background:var(--cyan);color:#000;box-shadow:0 0 15px rgba(0,255,255,0.4)}
.bf-preview-image{
  width:100%;height:130px;
  border-radius:12px;
  background:linear-gradient(145deg,rgba(0,0,0,0.6),rgba(20,20,40,0.4));
  margin-bottom:12px;
  overflow:hidden;
  position:relative;
  z-index:2;
  box-shadow:inset 0 0 30px rgba(0,0,0,0.5);
}
.bf-preview-image img{width:100%;height:100%;object-fit:cover}
.bf-preview-image .emoji-fallback{font-size:3.5em;display:flex;align-items:center;justify-content:center;height:100%}
.bf-preview-info{position:relative;z-index:2}
.bf-preview-terrain{
  display:flex;align-items:center;gap:10px;
  background:linear-gradient(145deg,rgba(0,0,0,0.5),rgba(20,20,40,0.3));
  padding:10px 15px;
  border-radius:10px;
  margin-bottom:10px;
  border:1px solid rgba(255,215,0,0.2);
}
.bf-preview-terrain .icon{font-size:1.6em}
.bf-preview-terrain .text{font-size:0.8em;color:#ccc;line-height:1.4}
.bf-preview-hazards{font-size:0.7em;color:#999;margin:6px 0}
.bf-preview-hazards .hazard-tag{
  background:linear-gradient(145deg,rgba(255,0,64,0.25),rgba(180,0,45,0.15));
  padding:4px 10px;border-radius:6px;margin:3px;
  color:var(--red);cursor:help;display:inline-block;
  transition:all 0.3s ease;
  border:1px solid rgba(255,0,64,0.3);
  position:relative;
}
.bf-preview-hazards .hazard-tag:hover{background:rgba(255,0,64,0.4);transform:scale(1.05);box-shadow:0 0 10px rgba(255,0,64,0.3)}
.bf-preview-hazards .hazard-tag .tooltip{
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(145deg,#1a1a3a,#0a0a1a);
  border:2px solid var(--red);
  border-radius:8px;
  padding:10px 12px;
  font-size:0.9em;
  color:#ccc;
  width:220px;
  opacity:0;
  visibility:hidden;
  transition:all 0.2s;
  z-index:100;
  pointer-events:none;
  text-align:left;
  line-height:1.4;
  box-shadow:0 5px 20px rgba(0,0,0,0.5);
}
.bf-preview-hazards .hazard-tag .tooltip::after{
  content:'';
  position:absolute;
  top:100%;
  left:50%;
  transform:translateX(-50%);
  border:6px solid transparent;
  border-top-color:var(--red);
}
.bf-preview-hazards .hazard-tag:hover .tooltip{opacity:1;visibility:visible;bottom:calc(100% + 8px)}
.bf-preview-npcs{font-size:0.7em;color:#999;margin:6px 0}
.bf-preview-npcs .npc-tag{
  padding:4px 10px;border-radius:6px;margin:3px;
  cursor:help;display:inline-block;
  transition:all 0.3s ease;
  border:1px solid transparent;
  position:relative;
}
.bf-preview-npcs .npc-tag.hostile{background:linear-gradient(145deg,rgba(255,0,64,0.25),rgba(180,0,45,0.15));color:var(--red);border-color:rgba(255,0,64,0.3)}
.bf-preview-npcs .npc-tag.friendly{background:linear-gradient(145deg,rgba(0,255,136,0.25),rgba(0,180,100,0.15));color:var(--green);border-color:rgba(0,255,136,0.3)}
.bf-preview-npcs .npc-tag:hover{transform:scale(1.05);filter:brightness(1.2);box-shadow:0 0 10px currentColor}
.bf-preview-npcs .npc-tag .tooltip{
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(145deg,#1a1a3a,#0a0a1a);
  border:2px solid currentColor;
  border-radius:8px;
  padding:10px 12px;
  font-size:0.9em;
  color:#ccc;
  width:240px;
  opacity:0;
  visibility:hidden;
  transition:all 0.2s;
  z-index:100;
  pointer-events:none;
  text-align:left;
  line-height:1.4;
  box-shadow:0 5px 20px rgba(0,0,0,0.5);
}
.bf-preview-npcs .npc-tag .tooltip::after{
  content:'';
  position:absolute;
  top:100%;
  left:50%;
  transform:translateX(-50%);
  border:6px solid transparent;
  border-top-color:currentColor;
}
.bf-preview-npcs .npc-tag:hover .tooltip{opacity:1;visibility:visible;bottom:calc(100% + 8px)}
.bf-preview-npcs .npc-tag .tooltip .npc-stats{color:var(--gold);font-family:'Orbitron';font-size:0.85em;margin-top:5px}
.bf-preview-npcs .npc-tag .tooltip .npc-type{font-weight:700;text-transform:uppercase;margin-bottom:4px}
.bf-preview-npcs{font-size:0.7em;color:#999;margin-top:6px}
.bf-preview-npcs .hostile{color:var(--red)}.bf-preview-npcs .friendly{color:var(--green)}

/* BATTLE LOG */
.log{
  background:linear-gradient(145deg,rgba(10,10,25,0.95),rgba(5,5,15,0.95));
  border-radius:12px;
  padding:12px;
  max-height:240px;
  overflow-y:auto;
  font-size:0.75em;
  line-height:1.5;
  box-shadow:inset 0 0 30px rgba(0,0,0,0.5);
  border:1px solid rgba(255,215,0,0.15);
}
.log::-webkit-scrollbar{width:8px}
.log::-webkit-scrollbar-track{background:rgba(0,0,0,0.3);border-radius:4px}
.log::-webkit-scrollbar-thumb{background:linear-gradient(var(--gold),var(--gold-dark));border-radius:4px}
.log-entry{
  padding:6px 10px;
  margin:3px 0;
  border-radius:6px;
  background:rgba(255,255,255,0.02);
  border-left:4px solid #444;
  animation:floatUp 0.2s ease-out;
  transition:all 0.2s ease;
}
.log-entry:hover{background:rgba(255,255,255,0.05)}
.log-entry.round{
  background:linear-gradient(90deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05));
  border-color:var(--gold);
  font-family:'Orbitron';
  font-weight:700;
  text-shadow:0 0 10px rgba(255,215,0,0.3);
}
.log-entry.damage{border-color:var(--red);background:linear-gradient(90deg,rgba(255,0,64,0.1),transparent)}
.log-entry.death{border-color:#ff0040;background:linear-gradient(90deg,rgba(255,0,64,0.2),rgba(255,0,64,0.05))}
.log-entry.special{border-color:var(--purple);background:linear-gradient(90deg,rgba(155,89,182,0.15),transparent)}
.log-entry.heal{border-color:var(--green);background:linear-gradient(90deg,rgba(0,255,136,0.15),transparent)}
.log-entry.synergy{border-color:var(--cyan);background:linear-gradient(90deg,rgba(0,255,255,0.15),transparent)}
.log-entry.env{border-color:var(--blue);font-style:italic;color:#aaa}

/* CONTROLS */
.controls{display:flex;gap:10px;justify-content:center;margin:12px 0;flex-wrap:wrap}

/* BUTTONS */
.btn{
  background:linear-gradient(145deg,var(--gold),var(--gold-dark));
  border:none;
  color:#000;
  padding:12px 24px;
  border-radius:25px;
  cursor:pointer;
  font-family:'Orbitron';
  font-weight:900;
  font-size:0.8em;
  transition:all 0.3s ease;
  text-transform:uppercase;
  letter-spacing:1px;
  box-shadow:0 4px 15px rgba(255,215,0,0.3);
}
.btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(255,215,0,0.4)}
.btn:active{transform:translateY(-1px)}
.btn.sec{
  background:linear-gradient(145deg,rgba(0,180,220,0.2),rgba(0,120,160,0.2));
  border:2px solid var(--blue);
  color:var(--blue);
  box-shadow:0 4px 15px rgba(0,217,255,0.2);
}
.btn.sec:hover{box-shadow:0 8px 25px rgba(0,217,255,0.3)}
.btn.red{
  background:linear-gradient(145deg,rgba(255,0,64,0.2),rgba(180,0,45,0.2));
  border:2px solid var(--red);
  color:var(--red);
  box-shadow:0 4px 15px rgba(255,0,64,0.2);
}
.btn.red:hover{box-shadow:0 8px 25px rgba(255,0,64,0.3)}
.btn.cont{
  background:linear-gradient(145deg,var(--red),var(--red-dark));
  color:#fff;
  animation:pulse 1.5s infinite;
  box-shadow:0 0 20px rgba(255,0,64,0.4);
}
.btn.cont:hover{animation:none;box-shadow:0 0 30px rgba(255,0,64,0.6)}

/* PANEL */
.panel{
  background:linear-gradient(145deg,rgba(25,25,50,0.98),rgba(12,12,30,0.98));
  border:3px solid var(--gold);
  border-radius:16px;
  padding:15px;
  box-shadow:0 8px 30px rgba(0,0,0,0.4),inset 0 0 30px rgba(0,0,0,0.2);
}
.panel-title{
  font-family:'Orbitron';
  color:var(--gold);
  font-size:0.85em;
  font-weight:700;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  text-shadow:0 0 10px rgba(255,215,0,0.3);
}
/* PLAYER TABS */
.player-tabs{display:flex;gap:6px;margin-bottom:10px}
.p-tab{
  flex:1;
  padding:8px;
  border-radius:10px;
  cursor:pointer;
  text-align:center;
  font-size:0.7em;
  font-family:'Orbitron';
  font-weight:600;
  background:linear-gradient(145deg,rgba(20,20,40,0.9),rgba(10,10,25,0.9));
  border:2px solid transparent;
  transition:all 0.3s ease;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.p-tab:hover{border-color:rgba(255,215,0,0.5);background:rgba(255,215,0,0.05)}
.p-tab.active{
  border-color:var(--gold);
  background:linear-gradient(145deg,rgba(80,70,30,0.4),rgba(50,45,20,0.4));
  box-shadow:0 0 15px rgba(255,215,0,0.2);
}

/* ROSTER & UNIT CARDS */
.roster{display:grid;grid-template-columns:1fr;gap:6px;max-height:340px;overflow-y:auto;padding-right:5px}
.roster::-webkit-scrollbar{width:6px}
.roster::-webkit-scrollbar-track{background:rgba(0,0,0,0.3);border-radius:3px}
.roster::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px}
.u-card{
  background:linear-gradient(145deg,rgba(45,50,80,0.95),rgba(25,30,55,0.95));
  border:2px solid rgba(100,100,140,0.4);
  border-radius:10px;
  padding:8px;
  cursor:pointer;
  transition:all 0.3s ease;
  display:flex;
  gap:8px;
  align-items:center;
  position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.u-card:hover{
  border-color:var(--gold);
  transform:translateX(3px);
  box-shadow:0 4px 15px rgba(255,215,0,0.15);
}
.u-card.sel{
  border-color:var(--green);
  background:linear-gradient(145deg,rgba(0,80,50,0.4),rgba(0,50,30,0.4));
  box-shadow:0 0 15px rgba(0,255,136,0.2);
}
.u-card.dis{opacity:0.35;pointer-events:none;filter:grayscale(0.5)}
.u-img{
  width:38px;height:38px;
  border-radius:8px;
  background:linear-gradient(145deg,rgba(20,20,40,0.9),rgba(0,0,0,0.5));
  display:flex;align-items:center;justify-content:center;
  font-size:1.3em;flex-shrink:0;overflow:hidden;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.5);
  position:relative;
}
.u-img img{width:100%;height:100%;object-fit:cover;object-position:center top;border-radius:6px}
.u-img .emoji-fallback{font-size:1.3em}
.u-info{flex:1;min-width:0}
.u-name{font-weight:700;font-size:0.75em;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.u-cost{
  background:linear-gradient(145deg,var(--gold),var(--gold-dark));
  color:#000;
  padding:2px 6px;
  border-radius:6px;
  font-size:0.6em;
  font-family:'Orbitron';
  font-weight:900;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
}
.u-stats{display:flex;gap:6px;font-size:0.6em;color:#888;margin-top:2px}
.u-stats span{color:var(--gold);font-weight:600}
.sel-count{
  position:absolute;top:-5px;right:-5px;
  background:linear-gradient(145deg,var(--green),var(--green-dark));
  color:#000;
  width:18px;height:18px;
  border-radius:50%;
  font-size:0.6em;font-weight:900;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 6px rgba(0,255,136,0.4);
}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:15px}
.modal-bg.show{display:flex}
.modal{background:linear-gradient(135deg,#1a1a3a,#0a0a1a);border:2px solid var(--gold);border-radius:15px;max-width:400px;width:100%;max-height:80vh;overflow-y:auto;position:relative}
.modal-close{position:absolute;top:8px;right:12px;background:none;border:none;color:var(--gold);font-size:1.2em;cursor:pointer}
.modal-head{padding:12px;text-align:center;border-bottom:1px solid rgba(255,215,0,0.2)}
.modal-avatar{width:60px;height:60px;margin:0 auto 6px;border-radius:10px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:2em;border:2px solid var(--gold)}
.modal-name{font-family:'Orbitron';font-size:1.1em;color:var(--gold)}
.modal-cost{background:var(--gold);color:#000;padding:3px 10px;border-radius:10px;font-family:'Orbitron';font-weight:900;display:inline-block;margin-top:4px}
.modal-body{padding:12px}
.modal-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px}
.m-stat{background:rgba(0,0,0,0.3);border-radius:6px;padding:6px;text-align:center}
.m-stat-lbl{font-size:0.6em;color:#888;text-transform:uppercase}.m-stat-val{font-family:'Orbitron';font-size:1em;color:var(--gold)}
.modal-desc{background:rgba(0,0,0,0.3);border-radius:6px;padding:8px;margin-bottom:8px;font-size:0.8em;line-height:1.4;color:#ccc}
.modal-special{background:rgba(155,89,182,0.2);border:1px solid var(--purple);border-radius:6px;padding:6px;margin-bottom:8px;position:relative;cursor:help}
.modal-special-lbl{color:var(--purple);font-family:'Orbitron';font-size:0.65em}.modal-special-nm{color:#fff;font-weight:700}
.modal-special .tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#1a1a3a;border:1px solid var(--purple);border-radius:6px;padding:8px 10px;font-size:0.75em;color:#ccc;width:240px;opacity:0;visibility:hidden;transition:all 0.2s;z-index:10;pointer-events:none;text-align:left;line-height:1.4}
.modal-special:hover .tooltip{opacity:1;visibility:visible;bottom:calc(100% + 5px)}
.modal-synergy{
  background:linear-gradient(145deg,rgba(0,200,200,0.15),rgba(0,150,150,0.1));
  border:2px solid var(--cyan);
  border-radius:10px;
  padding:10px;
  margin-bottom:12px;
  font-size:0.8em;
}
.modal-synergy-lbl{color:var(--cyan);font-family:'Orbitron';font-size:0.65em;text-transform:uppercase;letter-spacing:1px}
.modal-btns{display:flex;gap:8px;margin-top:5px}
.modal-btn{
  flex:1;
  background:linear-gradient(145deg,var(--gold),var(--gold-dark));
  border:none;
  color:#000;
  padding:12px;
  border-radius:10px;
  font-family:'Orbitron';
  font-weight:900;
  cursor:pointer;
  font-size:0.85em;
  transition:all 0.3s ease;
  text-transform:uppercase;
  letter-spacing:1px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
.modal-btn:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(255,215,0,0.3)}
.modal-btn:disabled{background:#444;cursor:not-allowed;color:#666;box-shadow:none;transform:none}
.modal-btn.rem{background:linear-gradient(145deg,var(--red),var(--red-dark));color:#fff;box-shadow:0 4px 10px rgba(255,0,64,0.3)}
.modal-btn.rem:hover{box-shadow:0 6px 15px rgba(255,0,64,0.4)}
.winner-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:2000;display:none;align-items:center;justify-content:center;flex-direction:column;padding:15px;overflow-y:auto}
.winner-overlay.show{display:flex}

/* Victory Screen */
.victory-screen{max-width:500px;width:100%;text-align:center}
.victory-screen.victory .victory-banner{background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,165,0,0.1))}
.victory-screen.defeat .victory-banner{background:linear-gradient(135deg,rgba(255,0,64,0.2),rgba(150,0,40,0.1))}
.victory-screen.draw .victory-banner{background:linear-gradient(135deg,rgba(100,100,150,0.2),rgba(60,60,100,0.1))}

.victory-banner{
  padding:25px 20px;
  border-radius:20px;
  border:3px solid var(--gold);
  margin-bottom:20px;
  position:relative;
  overflow:hidden;
}
.victory-glow{position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,rgba(255,215,0,0.3),transparent 60%);pointer-events:none}
.victory-text{
  font-family:'Orbitron';
  font-size:2em;
  font-weight:900;
  color:var(--gold);
  text-shadow:0 0 30px rgba(255,215,0,0.5),0 4px 8px rgba(0,0,0,0.5);
  animation:glow 2s infinite;
  margin-bottom:15px;
}
.victory-champion{margin-top:15px}
.champion-portrait{
  width:100px;height:100px;
  margin:0 auto 10px;
  border-radius:15px;
  border:4px solid var(--gold);
  overflow:hidden;
  box-shadow:0 0 30px rgba(255,215,0,0.4);
}
.champion-portrait img{width:100%;height:100%;object-fit:cover}
.champion-name{font-family:'Orbitron';font-size:1.2em;color:var(--gold);font-weight:700}
.champion-hp{color:#888;font-size:0.9em;margin-top:5px}

.victory-stats{
  background:linear-gradient(145deg,rgba(25,25,50,0.95),rgba(15,15,35,0.95));
  border:2px solid rgba(255,215,0,0.3);
  border-radius:15px;
  padding:20px;
  margin-bottom:20px;
}
.stats-title{font-family:'Orbitron';color:var(--gold);font-size:1em;margin-bottom:15px}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.stat-card{
  background:rgba(40,40,70,0.6);
  border-radius:10px;
  padding:12px;
  border:1px solid rgba(100,100,150,0.3);
}
.stat-card.mvp{border-color:var(--gold);background:rgba(255,215,0,0.1)}
.stat-card.kills{border-color:var(--red)}
.stat-card.healer{border-color:var(--green)}
.stat-card.tank{border-color:var(--blue)}
.stat-icon{font-size:1.5em;margin-bottom:5px}
.stat-label{font-size:0.7em;color:#888;text-transform:uppercase}
.stat-value{font-family:'Orbitron';font-size:1.1em;color:var(--gold);margin:5px 0}
.stat-name{font-size:0.8em;color:#ccc}

.battle-totals{
  display:flex;flex-wrap:wrap;justify-content:center;gap:15px;
  margin-top:15px;padding-top:15px;
  border-top:1px solid rgba(255,215,0,0.2);
  font-size:0.75em;color:#888;
}
.battle-totals span{display:flex;align-items:center;gap:4px}

.victory-actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.victory-btn{min-width:120px}

/* Battle History */
.history-screen{max-width:500px;width:100%;max-height:80vh;overflow-y:auto}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.history-header h2{font-family:'Orbitron';color:var(--gold);font-size:1.2em;margin:0}
.history-list{background:rgba(20,20,40,0.9);border-radius:15px;padding:10px;max-height:400px;overflow-y:auto}
.history-entry{
  display:flex;gap:10px;align-items:center;
  padding:10px;border-radius:8px;
  background:rgba(40,40,70,0.5);
  margin-bottom:8px;
  border-left:3px solid var(--gold);
}
.history-entry.tournament{border-left-color:var(--orange)}
.history-rank{font-family:'Orbitron';color:var(--gold);font-size:0.8em;min-width:30px}
.history-info{flex:1}
.history-winner{font-weight:700;color:var(--gold);font-size:0.9em}
.history-details{font-size:0.7em;color:#888;margin-top:2px}
.history-mvp{font-size:0.65em;color:var(--cyan);margin-top:2px}
.history-date{font-size:0.6em;color:#666}

/* Tournament Styles */
.tournament-setup{
  background:linear-gradient(145deg,rgba(30,25,50,0.95),rgba(15,12,30,0.95));
  border:3px solid var(--orange);
  border-radius:20px;
  padding:20px;
  margin-bottom:15px;
}
.tournament-title{font-family:'Orbitron';font-size:1.3em;color:var(--orange);text-align:center;margin-bottom:10px}
.tournament-desc{text-align:center;color:#888;font-size:0.8em;margin-bottom:15px}

.tournament-bracket-preview{
  background:rgba(0,0,0,0.3);
  border-radius:15px;
  padding:20px;
  margin-bottom:15px;
}
.bracket-round{display:flex;flex-direction:column;gap:20px}
.bracket-match{
  display:flex;flex-direction:column;gap:5px;
  background:rgba(40,40,70,0.5);
  border-radius:10px;
  padding:10px;
}
.bracket-team{
  padding:8px 15px;
  border-radius:8px;
  border:2px solid #555;
  font-size:0.8em;
  text-align:center;
}
.bracket-vs{font-family:'Orbitron';color:var(--red);font-size:0.7em;text-align:center}
.bracket-connector{width:2px;height:40px;background:var(--gold);margin:0 auto}
.bracket-round.finals .bracket-team{border-color:var(--gold);color:var(--gold)}

.tournament-options{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:10px}
.tournament-tip{text-align:center;font-size:0.7em;color:#888}

/* Tournament Bracket Screen */
.tournament-bracket-screen{max-width:600px;width:100%;text-align:center}
.tournament-header{font-family:'Orbitron';font-size:1.5em;color:var(--orange);margin-bottom:20px;text-shadow:0 0 20px rgba(255,140,0,0.5)}

.bracket-display{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:20px}
.bracket-column{display:flex;flex-direction:column;gap:30px}
.bracket-label{font-family:'Orbitron';font-size:0.7em;color:#888;margin-bottom:10px}

.bracket-display .bracket-match{min-width:150px}
.bracket-display .bracket-match.current{border:2px solid var(--cyan);box-shadow:0 0 15px rgba(0,255,255,0.3)}
.bracket-display .bracket-match.complete{opacity:0.7}
.bracket-display .bracket-match.champion{border:2px solid var(--gold);box-shadow:0 0 20px rgba(255,215,0,0.5)}

.bracket-display .bracket-team.winner{background:rgba(0,255,136,0.2);border-color:var(--green);color:var(--green)}
.bracket-display .bracket-team.loser{opacity:0.4;text-decoration:line-through}
.bracket-display .bracket-team.tbd{color:#666;border-style:dashed}

.bracket-lines{display:flex;flex-direction:column;align-items:center;justify-content:center;width:40px}
.line-connector{width:100%;height:2px;background:var(--gold)}

.tournament-champion{
  background:linear-gradient(145deg,rgba(255,215,0,0.2),rgba(255,165,0,0.1));
  border:3px solid var(--gold);
  border-radius:20px;
  padding:20px;
  margin-bottom:20px;
  animation:borderGlow 2s infinite;
}
.tournament-champion .champion-title{font-family:'Orbitron';font-size:1.2em;color:var(--gold);margin-bottom:10px}
.tournament-champion .champion-name{font-family:'Orbitron';font-size:1.8em;text-shadow:0 0 20px currentColor}

.bracket-actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.stats-panel{background:rgba(0,0,0,0.6);border-radius:10px;padding:12px;margin-top:15px;max-width:500px;width:90%;max-height:300px;overflow-y:auto}
.stats-title{font-family:'Orbitron';color:var(--gold);font-size:0.9em;margin-bottom:10px;text-align:center;border-bottom:1px solid rgba(255,215,0,0.3);padding-bottom:5px}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.stat-card{background:rgba(40,40,80,0.7);border-radius:6px;padding:8px;border-left:3px solid var(--gold)}
.stat-card.mvp{border-color:var(--red);background:rgba(255,0,64,0.15)}
.stat-card.healer{border-color:var(--green);background:rgba(0,255,136,0.1)}
.stat-card.tank{border-color:var(--blue);background:rgba(0,217,255,0.1)}
.stat-label{font-size:0.6em;color:#888;text-transform:uppercase;font-family:'Orbitron'}
.stat-value{font-size:1em;color:#fff;font-weight:700}
.stat-name{font-size:0.7em;color:var(--gold)}
.unit-stats-row{display:flex;align-items:center;gap:8px;padding:6px;background:rgba(0,0,0,0.3);border-radius:4px;margin:4px 0}
.unit-stats-row .emoji{font-size:1.2em}
.unit-stats-row .name{flex:1;font-size:0.75em;color:#fff}
.unit-stats-row .stats{display:flex;gap:10px;font-size:0.65em}
.unit-stats-row .stats span{color:#888}.unit-stats-row .stats strong{color:var(--gold)}
.toast{position:fixed;bottom:15px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--green);color:#000;padding:8px 18px;border-radius:20px;font-family:'Orbitron';font-weight:700;z-index:3000;opacity:0;transition:all 0.3s;font-size:0.8em}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.error{background:var(--red);color:#fff}
.save-bar{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}

/* Budget Control */
.budget-control{display:flex;align-items:center;gap:6px;margin-bottom:8px;padding:6px;background:rgba(0,0,0,0.3);border-radius:6px;flex-wrap:wrap;justify-content:center}
.budget-control label{color:#888;font-size:0.75em}
.budget-control input{width:50px;padding:4px;background:#1a1a2e;border:1px solid #333;border-radius:4px;color:#fff;text-align:center;font-size:0.85em}
.budget-preset{padding:4px 8px;background:#2a2a4e;border:1px solid #444;border-radius:4px;color:#aaa;font-size:0.7em;cursor:pointer;transition:all 0.2s}
.budget-preset:hover{background:#3a3a5e;color:#fff}
.budget-preset.active{background:var(--primary);border-color:var(--primary);color:#000}

/* Roster Search */
.roster-search{position:relative;margin-bottom:8px}
.roster-search input{width:100%;padding:8px 30px 8px 10px;background:#1a1a2e;border:1px solid #333;border-radius:6px;color:#fff;font-size:0.85em}
.roster-search input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 5px rgba(0,217,255,0.3)}
.roster-search input::placeholder{color:#666}
.clear-search{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:#666;cursor:pointer;font-size:0.9em;padding:2px 6px}
.clear-search:hover{color:#fff}

/* Roster Filters */
.roster-filters{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap;justify-content:center}
.filter-btn{padding:4px 8px;background:#1a1a2e;border:1px solid #333;border-radius:4px;color:#888;font-size:0.65em;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.filter-btn:hover{background:#2a2a4e;color:#fff;border-color:#555}
.filter-btn.active{background:var(--primary);border-color:var(--primary);color:#000;font-weight:bold}
.save-btn{background:rgba(0,0,0,0.4);border:1px solid var(--blue);color:var(--blue);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.65em;font-family:'Orbitron';transition:all 0.2s}
.save-btn:hover{background:rgba(0,217,255,0.2);transform:translateY(-1px)}
.save-btn.gold{border-color:var(--gold);color:var(--gold)}.save-btn.gold:hover{background:rgba(255,215,0,0.2)}
.save-btn.green{border-color:var(--green);color:var(--green)}.save-btn.green:hover{background:rgba(0,255,136,0.2)}
.saved-teams{background:rgba(0,0,0,0.3);border-radius:6px;padding:6px;margin-top:8px;max-height:120px;overflow-y:auto}
.saved-team{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;background:rgba(40,40,80,0.5);border-radius:4px;margin:3px 0;font-size:0.65em}
.saved-team .name{color:var(--gold);flex:1}
.saved-team .cost{color:#888;margin:0 8px}
.saved-team .actions{display:flex;gap:4px}
.saved-team button{background:none;border:1px solid;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:0.9em}
.saved-team .load-btn{border-color:var(--green);color:var(--green)}
.saved-team .del-btn{border-color:var(--red);color:var(--red)}
.formation-panel{background:rgba(0,0,0,0.3);border:1px solid rgba(255,215,0,0.3);border-radius:8px;padding:8px;margin-top:8px}
.auto-form-btn{background:var(--cyan);color:#000;border:none;border-radius:4px;padding:4px 10px;font-size:0.7em;cursor:pointer;margin-left:auto;font-weight:bold;transition:all 0.2s}
.auto-form-btn:hover{background:#fff;transform:scale(1.05)}
.unassigned-notice{background:rgba(255,100,0,0.2);border:1px solid rgba(255,100,0,0.5);border-radius:4px;padding:6px;margin-bottom:8px;font-size:0.7em;color:#ff8c00;text-align:center}
.formation-title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.formation-title{font-family:'Orbitron';font-size:0.65em;color:var(--gold);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.formation-title .info{font-size:0.85em;color:#888;font-family:'Rajdhani'}
.formation-rows{display:flex;flex-direction:column;gap:6px}
.formation-row{background:rgba(40,40,80,0.4);border-radius:6px;padding:6px}
.formation-row-label{font-size:0.55em;color:#888;text-transform:uppercase;margin-bottom:4px;display:flex;align-items:center;gap:4px}
.formation-row-label .dot{width:8px;height:8px;border-radius:50%}
.formation-row-label .dot.front{background:var(--red)}.formation-row-label .dot.back{background:var(--blue)}
.formation-units{display:flex;flex-wrap:wrap;gap:4px;min-height:40px}
.formation-unit{
  width:50px;
  background:linear-gradient(145deg,rgba(40,40,70,0.9),rgba(25,25,50,0.9));
  border:2px solid rgba(100,100,150,0.4);
  border-radius:8px;
  padding:4px;
  text-align:center;
  cursor:pointer;
  transition:all 0.3s ease;
  position:relative;
}
.formation-unit:hover{border-color:var(--cyan);transform:scale(1.08);box-shadow:0 0 15px rgba(0,255,255,0.3)}
.formation-unit.editable{cursor:pointer}
.formation-unit.leader{border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,0.5)}
.formation-unit-portrait{width:32px;height:32px;border-radius:6px;overflow:hidden;margin:0 auto 2px}
.formation-unit-portrait img{width:100%;height:100%;object-fit:cover}
.formation-unit-name{font-size:0.5em;color:#ccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.formation-unit-variant{font-size:0.45em;color:var(--purple)}
.formation-unit-equip{font-size:0.5em;margin-top:1px}
.formation-leader-btn{
  position:absolute;
  top:-6px;
  right:-6px;
  width:18px;
  height:18px;
  border-radius:50%;
  background:rgba(30,30,50,0.95);
  border:2px solid #555;
  font-size:0.5em;
  cursor:pointer;
  opacity:0;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}
.formation-unit:hover .formation-leader-btn{opacity:1}
.formation-leader-btn:hover{border-color:var(--gold);transform:scale(1.2)}
.formation-leader-btn.active{
  opacity:1;
  border-color:var(--gold);
  background:linear-gradient(145deg,var(--gold),var(--gold-dark));
  box-shadow:0 0 8px var(--gold);
}
.formation-units-row{display:flex;flex-wrap:wrap;gap:6px;min-height:40px;align-items:center}
.formation-empty{color:#555;font-size:0.6em;padding:10px;font-style:italic}

/* Leader display in drop zone */
.leader-display{
  display:flex;
  align-items:center;
  gap:10px;
  background:linear-gradient(145deg,rgba(50,45,20,0.5),rgba(30,25,10,0.5));
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,215,0,0.3);
}
.leader-portrait{
  width:40px;
  height:40px;
  border-radius:8px;
  overflow:hidden;
  border:2px solid var(--gold);
  transition:all 0.2s ease;
}
.leader-portrait:hover{transform:scale(1.1);box-shadow:0 0 10px var(--gold)}
.leader-portrait img{width:100%;height:100%;object-fit:cover}
.leader-info{flex:1}
.leader-name{font-weight:700;color:var(--gold);font-size:0.8em}
.leader-bonus{font-size:0.65em;color:var(--green)}
.leader-remove-btn{
  background:none;
  border:2px solid var(--red);
  color:var(--red);
  width:24px;
  height:24px;
  border-radius:50%;
  cursor:pointer;
  font-size:0.8em;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
}
.leader-remove-btn:hover{background:var(--red);color:#fff}

.formation-unit .emoji{font-size:1em}.formation-unit .name{font-size:0.45em;color:#ccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.leader-section{background:rgba(255,215,0,0.1);border:1px dashed var(--gold);border-radius:6px;padding:6px;margin-bottom:8px}
.leader-section-title{font-size:0.6em;color:var(--gold);font-family:'Orbitron';margin-bottom:4px}
.leader-slot{min-height:50px;display:flex;align-items:center;justify-content:center;gap:8px}
.leader-slot.empty{color:#666;font-size:0.7em;font-style:italic}
.leader-display{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.3);padding:6px 10px;border-radius:6px}
.leader-display .emoji{font-size:1.5em}.leader-display .info{text-align:left}
.leader-display .name{font-size:0.75em;color:var(--gold);font-weight:700}
.leader-display .bonus{font-size:0.55em;color:var(--green)}
.no-leader-toggle{display:flex;align-items:center;gap:6px;font-size:0.65em;color:#888;cursor:pointer;margin-top:6px}
.no-leader-toggle input{accent-color:var(--gold)}
.formation-help{font-size:0.55em;color:#666;margin-top:6px;line-height:1.3}
.equipment-section{background:rgba(255,165,0,0.1);border:1px solid var(--orange);border-radius:8px;padding:8px;margin-top:8px}
.equipment-title{font-family:'Orbitron';font-size:0.65em;color:var(--orange);margin-bottom:6px;display:flex;justify-content:space-between}
.equipment-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;max-height:150px;overflow-y:auto}
.equip-item{background:rgba(0,0,0,0.3);border:1px solid rgba(255,165,0,0.3);border-radius:4px;padding:4px;cursor:pointer;transition:all 0.2s;font-size:0.6em}
.equip-item:hover{border-color:var(--orange);transform:scale(1.02)}
.equip-item.selected{border-color:var(--green);background:rgba(0,255,136,0.1)}
.equip-item .top{display:flex;justify-content:space-between;align-items:center}
.equip-item .name{color:#fff;font-weight:600}.equip-item .cost{color:var(--gold);font-family:'Orbitron'}
.equip-item .stats{color:#888;font-size:0.9em;margin-top:2px}
.equip-item .emoji{font-size:1.2em}
.equipped-list{margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,165,0,0.2)}
.equipped-item{display:inline-flex;align-items:center;gap:3px;background:rgba(255,165,0,0.2);padding:2px 6px;border-radius:10px;margin:2px;font-size:0.6em}
.equipped-item .remove{cursor:pointer;color:var(--red);margin-left:3px}
.variant-section{background:rgba(155,89,182,0.1);border:1px solid var(--purple);border-radius:6px;padding:6px;margin-bottom:8px}
.variant-title{font-family:'Orbitron';font-size:0.6em;color:var(--purple);margin-bottom:4px}
.variant-options{display:flex;flex-wrap:wrap;gap:4px}
.variant-opt{background:rgba(0,0,0,0.3);border:2px solid rgba(155,89,182,0.3);border-radius:4px;padding:4px 8px;cursor:pointer;transition:all 0.2s;font-size:0.6em;text-align:center}
.variant-opt:hover{border-color:var(--purple)}
.variant-opt.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
.variant-opt.unaffordable{opacity:0.4;cursor:not-allowed}
.variant-opt.unaffordable:hover{border-color:#555}
.variant-opt .emoji{font-size:1.3em;display:block}.variant-opt .name{color:#fff;font-size:0.85em}
.variant-opt .mods{color:#888;font-size:0.8em}
.variant-opt .mods .pos{color:var(--green)}.variant-opt .mods .neg{color:var(--red)}
.mod-pos{color:var(--green);font-size:0.7em;margin-left:3px}
.mod-neg{color:var(--red);font-size:0.7em;margin-left:3px}
.unit-equip-badge{position:absolute;bottom:-2px;left:2px;display:flex;gap:1px;font-size:0.4em}
.modal-equipment{
  margin-top:12px;
  padding-top:12px;
  border-top:2px solid rgba(255,215,0,0.2);
}
.modal-equip-title{
  font-size:0.75em;
  color:var(--orange);
  font-family:'Orbitron';
  margin-bottom:8px;
  text-transform:uppercase;
  letter-spacing:1px;
}

/* Quick action buttons in modal */
.unit-quick-actions{
  display:flex;
  gap:8px;
  margin-bottom:15px;
  flex-wrap:wrap;
}
.quick-btn{
  flex:1;
  min-width:80px;
  background:linear-gradient(145deg,rgba(40,40,70,0.9),rgba(25,25,50,0.9));
  border:2px solid rgba(255,215,0,0.3);
  color:#ccc;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-size:0.7em;
  font-family:'Rajdhani';
  font-weight:600;
  transition:all 0.3s ease;
}
.quick-btn:hover{
  border-color:var(--gold);
  color:var(--gold);
  transform:translateY(-2px);
}
.quick-btn.active{
  border-color:var(--gold);
  background:linear-gradient(145deg,rgba(80,70,30,0.5),rgba(50,45,20,0.5));
  color:var(--gold);
}
.quick-btn.danger{
  border-color:rgba(255,0,64,0.4);
  color:var(--red);
}
.quick-btn.danger:hover{
  border-color:var(--red);
  background:rgba(255,0,64,0.2);
}

/* Equipped item styling */
.equipped-item{
  background:linear-gradient(145deg,rgba(50,50,80,0.9),rgba(30,30,55,0.9));
  border:2px solid rgba(100,100,150,0.4);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:0.75em;
  transition:all 0.3s ease;
}
.equipped-item:hover{
  border-color:var(--gold);
  transform:translateY(-2px);
}
.equipped-item.assigned{
  border-color:var(--green);
  background:linear-gradient(145deg,rgba(0,80,50,0.4),rgba(0,50,30,0.4));
  color:var(--green);
}
.terrain-bar{background:rgba(0,0,0,0.5);border:1px solid var(--cyan);border-radius:6px;padding:6px 10px;margin:8px 0;font-size:0.7em;display:flex;align-items:center;gap:8px}
.terrain-bar .icon{font-size:1.5em}.terrain-bar .desc{color:#aaa}
.npc-encounter{background:rgba(255,165,0,0.15);border:2px solid var(--orange);border-radius:8px;padding:10px;margin:8px 0;animation:pulse 1s ease-in-out}
.npc-encounter.hostile{background:rgba(255,0,64,0.15);border-color:var(--red)}
.npc-encounter.friendly{background:rgba(0,255,136,0.15);border-color:var(--green)}
.npc-unit{display:inline-flex;align-items:center;gap:6px;background:rgba(0,0,0,0.3);padding:4px 10px;border-radius:20px;margin:4px 0}
.npc-unit .emoji{font-size:1.3em}.npc-unit .stats{font-size:0.7em;color:#888}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}

/* FACTION BONUSES */
.faction-bonuses{background:rgba(155,89,182,0.15);border:1px solid var(--purple);border-radius:8px;padding:8px;margin-top:10px}
.faction-title{font-family:'Orbitron';font-size:0.65em;color:var(--purple);margin-bottom:6px}
.faction-bonus{display:flex;align-items:center;gap:6px;padding:4px 6px;background:rgba(0,0,0,0.3);border-radius:4px;margin:3px 0;font-size:0.6em}
.faction-emoji{font-size:1.3em}
.faction-name{color:var(--gold);font-weight:600;min-width:100px}
.faction-desc{color:#aaa;flex:1}

/* UNDO BUTTON */
.undo-btn{background:rgba(255,165,0,0.2);border:1px solid var(--orange);color:var(--orange)}
.undo-btn:hover:not(:disabled){background:rgba(255,165,0,0.3)}
.undo-btn:disabled{opacity:0.4;cursor:not-allowed}

/* SPEED STAT */
.stat-spd{color:var(--cyan)}

/* CINEMATIC NARRATION STYLES */
.log-entry.death{background:rgba(139,0,0,0.2);border-left:3px solid var(--red);padding-left:8px}
.log-entry.round{background:linear-gradient(90deg,rgba(255,215,0,0.2),transparent);font-size:1.1em;padding:8px 0;margin:10px 0}
.log-entry .atmosphere{font-style:italic;color:#888;font-size:0.85em;margin-top:4px;padding-left:10px;border-left:2px solid rgba(255,215,0,0.3)}
.battle-summary{background:rgba(0,0,0,0.5);border:2px solid var(--gold);border-radius:10px;padding:15px;margin:15px 0;text-align:center}
.battle-summary strong{color:var(--gold)}
.log-entry em{color:#aaa}
.log-entry.damage{border-left:2px solid rgba(255,100,100,0.5);padding-left:6px}
.log-entry.special{border-left:2px solid var(--purple);padding-left:6px;background:rgba(155,89,182,0.1)}
.log-entry.synergy{border-left:2px solid var(--cyan);padding-left:6px;color:var(--cyan)}
.log-entry.env{background:rgba(255,165,0,0.1);border-left:2px solid var(--orange);padding-left:6px}
.log-entry.info{color:var(--cyan);font-style:italic}

/* CINEMATIC BATTLE STYLES */
.round-header{font-family:'Orbitron';font-size:1.2em;color:var(--gold);text-align:center;padding:10px 0;text-shadow:0 0 10px rgba(255,215,0,0.5)}
.atmosphere-text{color:#888;font-style:italic;text-align:center;padding:5px 15px;font-size:0.9em}
.combat-scene-header{background:linear-gradient(90deg,rgba(255,0,64,0.1),transparent,rgba(0,217,255,0.1));padding:8px 12px;border-radius:5px;margin:8px 0}
.log-entry.dialogue{background:rgba(100,100,150,0.15);border-left:3px solid #888;padding:6px 10px;font-style:italic}
.log-entry.combat{background:rgba(255,215,0,0.05);margin:5px 0}
.log-entry.heal{border-left:3px solid var(--green);background:rgba(0,255,136,0.1);padding-left:8px}
.log-entry.victory{background:linear-gradient(90deg,rgba(255,215,0,0.2),transparent);text-align:center;padding:15px;margin:10px 0}
.log-entry.stats{background:rgba(0,0,0,0.3);border-radius:8px;padding:10px;margin:10px 0}
.victory-scene{text-align:center;padding:15px 0}
.mvp-announcement,.killer-announcement{background:rgba(255,215,0,0.1);padding:5px 10px;border-radius:5px;margin:5px 0;display:inline-block}
.morale-break{background:rgba(139,0,0,0.2);padding:8px 12px;border-radius:5px;margin:5px 0}
.betrayal-scene{background:rgba(128,0,128,0.2);border:1px solid var(--purple);padding:10px;border-radius:5px;margin:8px 0}
.combo-announcement{background:linear-gradient(90deg,rgba(155,89,182,0.2),rgba(0,217,255,0.2));padding:10px;border-radius:5px;text-align:center;margin:8px 0}
.hazard-event{background:rgba(255,165,0,0.2);padding:8px;border-radius:5px;border-left:3px solid var(--orange)}
.revival-scene{background:rgba(0,255,136,0.15);border:1px solid var(--green);padding:10px;border-radius:5px}
.explosion-scene{background:rgba(255,100,0,0.2);padding:8px;border-radius:5px;text-align:center}
.terrain-effect{color:var(--orange);font-style:italic;padding:5px 0}
.round-summary{background:rgba(0,0,0,0.3);padding:8px 12px;border-radius:5px;text-align:center;margin:10px 0;font-size:0.9em}
.initiative{background:rgba(0,217,255,0.1);padding:6px 10px;border-radius:5px;font-size:0.85em}
.battle-end-header{font-family:'Orbitron';font-size:1.3em;color:var(--gold);text-align:center;padding:15px 0;text-shadow:0 0 15px rgba(255,215,0,0.5)}

/* SPEED CONTROLS */
.speed-controls{display:inline-flex;gap:4px;margin-left:10px;vertical-align:middle}

/* Tactical Commands Panel */
.tactical-panel{background:linear-gradient(135deg,rgba(0,20,40,0.95),rgba(0,40,60,0.9));border:2px solid var(--cyan);border-radius:10px;padding:12px;margin:10px 0;box-shadow:0 0 20px rgba(0,255,255,0.2)}
.tactical-title{font-size:0.9em;font-weight:bold;color:var(--cyan);text-align:center;margin-bottom:10px;text-shadow:0 0 10px var(--cyan)}
.tactical-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.tactical-btn{background:linear-gradient(135deg,rgba(0,50,80,0.9),rgba(0,30,50,0.9));border:1px solid rgba(0,255,255,0.4);border-radius:8px;padding:10px 8px;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:4px;color:#fff}
.tactical-btn:hover:not(:disabled){background:linear-gradient(135deg,rgba(0,80,120,0.9),rgba(0,50,80,0.9));border-color:var(--cyan);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,255,255,0.3)}
.tactical-btn:disabled,.tactical-btn.cooldown{opacity:0.4;cursor:not-allowed;filter:grayscale(0.5)}
.tact-icon{font-size:1.5em}
.tact-name{font-size:0.75em;font-weight:bold;color:var(--cyan)}
.tact-desc{font-size:0.6em;color:#888;text-align:center}
@media(max-width:768px){.tactical-grid{grid-template-columns:repeat(2,1fr)}.tactical-btn{padding:8px 6px}.tact-icon{font-size:1.2em}}
.speed-btn{background:rgba(0,0,0,0.4);border:1px solid #555;color:#888;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7em;transition:all 0.2s}
.speed-btn:hover{border-color:var(--gold);color:var(--gold)}
.speed-btn.active{border-color:var(--cyan);color:var(--cyan);background:rgba(0,217,255,0.1)}

/* DIALOGUE BOXES */
.dialogue-box{padding:8px 12px;border-radius:8px;margin:5px 0;font-size:0.95em}
.dialogue-box.attacker{background:linear-gradient(90deg,rgba(255,0,64,0.15),transparent);border-left:3px solid var(--red)}
.dialogue-box.defender{background:linear-gradient(270deg,rgba(0,217,255,0.15),transparent);border-right:3px solid var(--cyan);text-align:right}
.dialogue-box strong{color:var(--gold)}
.dialogue-box em{color:#ddd}
.last-words{background:rgba(100,0,0,0.3);border:1px solid var(--red);padding:10px 15px;border-radius:8px;margin:8px 0;text-align:center}
.last-words strong{color:var(--red)}
.killer-taunt{background:rgba(255,215,0,0.1);border-left:3px solid var(--gold);padding:8px 12px;margin:5px 0}
.killer-taunt strong{color:var(--gold)}

/* COMBAT DIALOGUE FLASH */
#combat-dialogue.flash{animation:dialogueFlash 0.5s ease-out}
@keyframes dialogueFlash{0%{background:rgba(255,215,0,0.3)}100%{background:transparent}}

/* MOBILE RESPONSIVE */
@media(max-width:768px){
  .container{padding:8px}
  .header{padding:10px;margin-bottom:8px}
  .title{font-size:1.4em}
  .mode-bar{gap:5px;flex-wrap:wrap;justify-content:center}
  .mode-btn{padding:8px 12px;font-size:0.65em;flex:0 0 auto}
  .main-grid{grid-template-columns:1fr!important;gap:10px}
  .arena{padding:10px;min-height:auto}
  .teams-row{grid-template-columns:1fr;gap:8px}
  .team-box{padding:10px}
  .battle-unit{width:52px;padding:4px}
  .unit-avatar{width:30px;height:30px;font-size:1em}
  .unit-nm{font-size:0.5em}
  .log{max-height:180px;font-size:0.7em;padding:8px}
  .controls{gap:6px;margin:10px 0;flex-wrap:wrap}
  .btn{padding:10px 16px;font-size:0.7em;min-width:100px}
  .panel{padding:10px}
  .panel-title{font-size:0.75em}
  .roster{max-height:280px;grid-template-columns:1fr}
  .u-card{padding:6px;gap:6px}
  .u-img{width:32px;height:32px;font-size:1.1em}
  .u-name{font-size:0.7em}
  .u-stats{font-size:0.55em;gap:4px}
  .modal{max-width:95%;max-height:90vh;border-radius:15px}
  .modal-head{padding:12px}
  .modal-avatar{width:60px;height:60px;font-size:1.8em}
  .modal-name{font-size:1em}
  .modal-body{padding:12px}
  .modal-stats{gap:5px;grid-template-columns:repeat(2,1fr)}
  .m-stat{padding:6px}
  .m-stat-lbl{font-size:0.6em}
  .m-stat-val{font-size:0.9em}
  .formation-panel{padding:8px}
  .formation-unit{width:42px}
  .formation-unit-portrait{width:28px;height:28px}
  .formation-unit-name{font-size:0.45em}
  .equipment-grid{grid-template-columns:1fr}
  .equip-item{padding:8px}
  .variant-options{gap:4px;flex-wrap:wrap}
  .variant-opt{padding:4px 8px;min-width:60px}
  
  /* Victory screen mobile */
  .victory-text{font-size:1.5em}
  .champion-portrait{width:80px;height:80px}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .stat-card{padding:8px}
  .stat-icon{font-size:1.2em}
  .stat-value{font-size:0.9em}
  .battle-totals{flex-direction:column;gap:8px;font-size:0.7em}
  
  /* Tournament mobile */
  .tournament-setup{padding:15px}
  .tournament-title{font-size:1.1em}
  .bracket-display{flex-direction:column;gap:15px}
  .bracket-column{width:100%}
  .bracket-lines{transform:rotate(90deg);width:30px;height:30px}
  
  /* Battle arena mobile */
  .battle-arena{padding:12px;min-height:250px}
  .fighters-row{gap:15px;min-height:180px}
  .fighter-portrait{width:100px;height:100px}
  .fighter-portrait .emoji-fallback{font-size:2.5em}
  .fighter-name{font-size:0.8em}
  .fighter-hp-bar{width:100px;height:10px}
  .vs-badge{font-size:1.5em}
  .combat-dialogue{font-size:0.8em;padding:10px 15px}
  
  /* Nav bar */
  .nav-bar{padding:6px!important;gap:4px}
  .nav-btn{padding:8px 12px!important;font-size:0.65em!important}
  .nav-btn .icon{font-size:1.2em}
}

@media(max-width:480px){
  .container{padding:5px}
  .header{padding:8px}
  .title{font-size:1.2em}
  .mode-bar{gap:4px}
  .mode-btn{padding:6px 10px;font-size:0.55em}
  .battle-unit{width:46px}
  .unit-avatar{width:26px;height:26px;font-size:0.9em}
  .log{max-height:140px;font-size:0.65em}
  .btn{padding:8px 12px;font-size:0.6em;min-width:80px}
  .modal-special .tooltip{width:180px;font-size:0.65em}
  .terrain-bar{padding:4px 8px;font-size:0.6em;gap:4px}
  .npc-encounter{padding:6px}
  .npc-unit{padding:3px 6px;font-size:0.8em}
  
  /* Victory mobile small */
  .victory-banner{padding:15px}
  .victory-text{font-size:1.3em}
  .champion-portrait{width:60px;height:60px}
  .stats-grid{grid-template-columns:1fr}
  
  /* Fighter portraits small */
  .fighter-portrait{width:80px;height:80px}
  .fighter-portrait .emoji-fallback{font-size:2em}
  .fighter-hp-bar{width:80px;height:8px}
  .fighter-info{padding:6px 10px}
  
  /* Quick actions mobile */
  .unit-quick-actions{flex-direction:column;gap:6px}
  .quick-btn{padding:10px;font-size:0.75em}
}

/* Extra small screens */
@media(max-width:360px){
  .title{font-size:1em}
  .mode-btn{padding:5px 8px;font-size:0.5em}
  .fighter-portrait{width:65px;height:65px}
  .vs-badge{font-size:1.2em}
  .battle-unit{width:40px}
  .unit-avatar{width:22px;height:22px}
}

/* VISUAL BATTLE ARENA */
.battle-arena{
  background:linear-gradient(180deg,rgba(15,8,25,0.95),rgba(30,15,50,0.95));
  border:4px solid var(--gold);
  border-radius:20px;
  padding:20px;
  margin-bottom:15px;
  position:relative;
  overflow:hidden;
  min-height:300px;
  box-shadow:0 10px 40px rgba(0,0,0,0.5),0 0 40px rgba(255,215,0,0.15),inset 0 0 60px rgba(0,0,0,0.5);
}
.battle-arena .arena-bg{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0;overflow:hidden}
.battle-arena .arena-bg img{width:100%;height:100%;object-fit:cover;opacity:0.5;filter:saturate(1.2)}
.battle-arena::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.4),rgba(0,0,0,0.2),rgba(0,0,0,0.5));z-index:1;pointer-events:none}
.arena-title{
  position:relative;z-index:2;
  text-align:center;
  font-family:'Orbitron';
  font-weight:700;
  color:var(--gold);
  font-size:1.1em;
  margin-bottom:15px;
  text-shadow:0 0 20px rgba(255,215,0,0.5),0 2px 4px rgba(0,0,0,0.8);
  letter-spacing:1px;
}
.fighters-row{
  position:relative;z-index:2;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:25px;
  min-height:220px;
}
.combat-dialogue{position:relative;z-index:2}
.fighter-side{flex:1;display:flex;flex-direction:column;align-items:center;gap:12px;position:relative;z-index:2}
.fighter-side.left{align-items:flex-start}.fighter-side.right{align-items:flex-end}

/* Fighter Portrait */
.fighter-portrait{
  width:150px;height:150px;
  border-radius:18px;
  border:4px solid var(--gold);
  background:linear-gradient(145deg,rgba(20,20,40,0.9),rgba(0,0,0,0.7));
  display:flex;align-items:center;justify-content:center;
  position:relative;
  overflow:hidden;
  transition:all 0.4s ease;
  box-shadow:0 0 30px rgba(255,215,0,0.3),inset 0 0 30px rgba(0,0,0,0.5);
}
.fighter-portrait img{width:100%;height:100%;object-fit:cover;object-position:center top}
.fighter-portrait .emoji-fallback{font-size:4.5em;filter:drop-shadow(0 0 10px rgba(255,215,0,0.5))}
.portrait-loading{background:linear-gradient(90deg,rgba(255,215,0,0.1) 25%,rgba(255,215,0,0.2) 50%,rgba(255,215,0,0.1) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
.fighter-portrait.attacking{animation:attackSlide 0.5s ease-out;box-shadow:0 0 40px var(--red),0 0 60px rgba(255,0,64,0.3)}
.fighter-portrait.defending{animation:defendShake 0.4s;box-shadow:0 0 40px var(--red)}
.fighter-portrait.dead{filter:grayscale(1) brightness(0.3);border-color:#444;transform:rotate(-8deg) scale(0.85);box-shadow:none}
.fighter-portrait.healing{animation:healGlow 0.6s;box-shadow:0 0 40px var(--green),0 0 60px rgba(0,255,136,0.3)}
.fighter-portrait.special{animation:specialPulse 0.6s;box-shadow:0 0 50px var(--purple),0 0 80px rgba(155,89,182,0.3)}
@keyframes attackSlide{0%{transform:translateX(0)}30%{transform:translateX(50px) scale(1.1)}60%{transform:translateX(30px)}100%{transform:translateX(0)}}
@keyframes attackSlideRight{0%{transform:translateX(0)}30%{transform:translateX(-50px) scale(1.1)}60%{transform:translateX(-30px)}100%{transform:translateX(0)}}
@keyframes defendShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-15px) rotate(-3deg)}40%{transform:translateX(15px) rotate(3deg)}60%{transform:translateX(-10px)}80%{transform:translateX(10px)}}
@keyframes healGlow{0%,100%{box-shadow:0 0 20px var(--green)}50%{box-shadow:0 0 50px var(--green);transform:scale(1.05)}}
@keyframes specialPulse{0%{box-shadow:0 0 20px var(--purple)}50%{box-shadow:0 0 60px var(--purple);transform:scale(1.1);filter:brightness(1.3)}100%{box-shadow:0 0 20px var(--purple)}}

/* Fighter Info Box */
.fighter-info{
  text-align:center;
  background:linear-gradient(145deg,rgba(10,10,25,0.9),rgba(5,5,15,0.9));
  padding:10px 18px;
  border-radius:12px;
  border:2px solid rgba(255,215,0,0.4);
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
}
.fighter-side.right .fighter-info{text-align:center}
.fighter-name{
  font-family:'Orbitron';
  font-size:0.95em;
  font-weight:700;
  color:var(--gold);
  white-space:nowrap;
  text-shadow:0 0 10px rgba(255,215,0,0.4);
}
.fighter-hp-bar{
  width:130px;height:12px;
  background:rgba(0,0,0,0.6);
  border-radius:6px;
  overflow:hidden;
  margin-top:6px;
  border:1px solid rgba(255,255,255,0.2);
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.5);
}
.fighter-hp-fill{
  height:100%;
  background:linear-gradient(90deg,var(--green),#00cc66);
  transition:width 0.4s ease;
  border-radius:6px;
  box-shadow:0 0 8px var(--green);
}
.fighter-hp-fill.mid{background:linear-gradient(90deg,var(--orange),#cc7000);box-shadow:0 0 8px var(--orange)}
.fighter-hp-fill.low{background:linear-gradient(90deg,var(--red),#cc0033);box-shadow:0 0 8px var(--red);animation:pulse 0.5s infinite}
.fighter-hp-text{font-size:0.75em;color:#ccc;margin-top:4px;font-family:'Orbitron'}

/* VS Badge */
.vs-badge{
  font-family:'Orbitron';
  font-size:2.5em;
  font-weight:900;
  color:var(--red);
  text-shadow:0 0 30px var(--red),0 0 50px rgba(255,0,64,0.5);
  animation:vsPulse 1s infinite;
  z-index:3;
}
@keyframes vsPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.15);opacity:0.8}}

/* Combat Effects */
.combat-effects{position:absolute;inset:0;pointer-events:none;z-index:10}
.slash-effect{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:4.5em;opacity:0;animation:slashAppear 0.4s forwards}
@keyframes slashAppear{0%{opacity:0;transform:translate(-50%,-50%) scale(0.5) rotate(-45deg)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2) rotate(0deg)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.5) rotate(15deg)}}
.damage-number{
  position:absolute;
  font-family:'Orbitron';
  font-size:2em;
  font-weight:900;
  color:var(--red);
  text-shadow:3px 3px 6px #000,0 0 20px var(--red);
  animation:damageFloat 1s forwards;
  z-index:20;
}
@keyframes damageFloat{0%{opacity:1;transform:translateY(0) scale(1)}50%{transform:translateY(-35px) scale(1.3)}100%{opacity:0;transform:translateY(-70px) scale(0.8)}}
.heal-number{color:var(--green);text-shadow:3px 3px 6px #000,0 0 20px var(--green)}

/* Combat Dialogue Box */
.combat-dialogue{
  background:linear-gradient(145deg,rgba(10,10,25,0.95),rgba(5,5,15,0.95));
  border:3px solid var(--gold);
  border-radius:15px;
  padding:15px 25px;
  margin:12px auto;
  max-width:520px;
  text-align:center;
  font-size:0.95em;
  line-height:1.6;
  min-height:65px;
  position:relative;
  box-shadow:0 5px 25px rgba(0,0,0,0.4),0 0 20px rgba(255,215,0,0.15);
}
.combat-dialogue .speaker{color:var(--gold);font-family:'Orbitron';font-weight:700}
.combat-dialogue .action{color:var(--red);font-style:italic}
.combat-dialogue .quote{color:#fff;font-style:italic}
.screen-shake{animation:screenShake 0.3s}
@keyframes screenShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.blood-splatter{position:absolute;font-size:2em;opacity:0;animation:splatterFade 0.8s forwards}
@keyframes splatterFade{0%{opacity:0;transform:scale(0.5)}20%{opacity:1;transform:scale(1.2)}100%{opacity:0;transform:scale(1) translateY(20px)}}
@media(max-width:768px){
  .battle-arena{padding:12px;min-height:240px}
  .fighter-portrait{width:110px;height:110px}
  .fighter-portrait .emoji-fallback{font-size:3em}
  .fighter-name{font-size:0.8em}
  .fighter-hp-bar{width:100px;height:10px}
  .vs-badge{font-size:1.8em}
  .combat-dialogue{font-size:0.85em;padding:10px 15px}
}

/* BOTTOM NAV BAR FOR MOBILE */
.nav-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(20,20,40,0.98);border-top:2px solid var(--gold);padding:6px;z-index:900;justify-content:space-around}
@media(max-width:768px){.nav-bar{display:flex}}
.nav-btn{background:rgba(0,0,0,0.4);border:1px solid var(--gold);color:var(--gold);padding:8px 12px;border-radius:8px;font-family:'Orbitron';font-size:0.65em;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;transition:all 0.2s}
.nav-btn:hover,.nav-btn.active{background:rgba(255,215,0,0.2);transform:scale(1.05)}
.nav-btn .icon{font-size:1.4em}
.nav-btn .label{font-size:0.7em}

/* ENCYCLOPEDIA */
.encyclopedia-bg{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:1500;display:none;overflow-y:auto}
.encyclopedia-bg.show{display:block}
.encyclopedia{max-width:900px;margin:0 auto;padding:15px}
.encyclopedia-header{display:flex;justify-content:space-between;align-items:center;padding:15px;border-bottom:2px solid var(--gold);margin-bottom:15px;position:sticky;top:0;background:rgba(10,10,26,0.98);z-index:10}
.encyclopedia-title{font-family:'Orbitron';font-size:1.5em;color:var(--gold)}
.encyclopedia-close{background:var(--red);border:none;color:#fff;padding:8px 20px;border-radius:20px;cursor:pointer;font-family:'Orbitron';font-weight:700}
.encyclopedia-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:15px;position:sticky;top:70px;background:rgba(10,10,26,0.98);padding:10px 0;z-index:9}
.enc-tab{background:rgba(40,40,80,0.6);border:2px solid rgba(100,100,150,0.4);color:#aaa;padding:8px 16px;border-radius:20px;cursor:pointer;font-family:'Orbitron';font-size:0.7em;transition:all 0.2s}
.enc-tab:hover{border-color:var(--gold);color:var(--gold)}
.enc-tab.active{background:var(--gold);color:#000;border-color:var(--gold)}
.encyclopedia-content{min-height:400px}
.enc-section{margin-bottom:20px}
.enc-section-title{font-family:'Orbitron';font-size:1em;color:var(--cyan);margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid rgba(0,255,255,0.3)}
.enc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
.enc-card{background:rgba(35,40,70,0.9);border:2px solid rgba(80,80,120,0.4);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s}
.enc-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.enc-card-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.enc-card-avatar{width:60px;height:60px;border-radius:8px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:1.8em;border:2px solid var(--gold);overflow:hidden;flex-shrink:0;position:relative}
.enc-card-avatar.has-image{border-color:var(--cyan)}
.enc-card-avatar img{width:100%;height:100%;object-fit:cover;object-position:center top;border-radius:6px}
.no-image-badge{font-size:0.6em;opacity:0.6;margin-left:4px}
.enc-variant-thumb{width:28px;height:28px;border-radius:4px;overflow:hidden;border:1px solid var(--gold);flex-shrink:0;position:relative}
.enc-variant-thumb img{width:100%;height:100%;object-fit:cover;border-radius:3px}
.variant-tooltip-image{width:80px;height:80px;border-radius:8px;overflow:hidden;margin:0 auto 10px;border:2px solid var(--cyan)}
.variant-tooltip-image img{width:100%;height:100%;object-fit:cover}
.enc-card-info{flex:1}
.enc-card-name{font-family:'Orbitron';font-size:0.9em;color:var(--gold)}
.enc-card-meta{font-size:0.7em;color:#888;display:flex;gap:10px;flex-wrap:wrap}
.enc-card-meta span{display:flex;align-items:center;gap:3px}
.enc-card-stats{display:flex;gap:8px;margin-top:6px;font-size:0.7em}
.enc-card-stats div{background:rgba(0,0,0,0.3);padding:3px 8px;border-radius:4px}
.enc-card-stats .hp{color:var(--green)}.enc-card-stats .atk{color:var(--red)}.enc-card-stats .def{color:var(--blue)}
.enc-card-desc{font-size:0.75em;color:#aaa;margin-top:8px;line-height:1.4}
.enc-card-special{background:rgba(155,89,182,0.2);border:1px solid var(--purple);border-radius:6px;padding:6px;margin-top:8px;font-size:0.7em}
.enc-card-special .name{color:var(--purple);font-weight:700}.enc-card-special .desc{color:#ccc}
.enc-card-variants{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,215,0,0.2)}
.enc-card-variants-title{font-size:0.65em;color:var(--gold);margin-bottom:4px}
.enc-variant-list{display:flex;flex-wrap:wrap;gap:4px}
.enc-variant{background:rgba(155,89,182,0.2);padding:2px 8px;border-radius:10px;font-size:0.65em;color:var(--purple);cursor:help;transition:all 0.2s}
.enc-variant:hover{background:rgba(155,89,182,0.4);color:#fff}
.enc-variant-wrapper{position:relative;display:inline-block}
.variant-tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);width:220px;padding:10px;background:#1a1a2e;border:1px solid var(--purple);border-radius:8px;opacity:0;visibility:hidden;transition:all 0.2s;z-index:1000;pointer-events:none;box-shadow:0 4px 15px rgba(0,0,0,0.5)}
.enc-variant-wrapper:hover .variant-tooltip{opacity:1;visibility:visible;bottom:calc(100% + 5px)}
.variant-tooltip-title{font-weight:bold;color:var(--purple);margin-bottom:4px;font-size:0.9em}
.variant-tooltip-desc{font-size:0.75em;color:#aaa;margin-bottom:8px;font-style:italic}
.variant-tooltip-stats{display:flex;flex-direction:column;gap:3px}
.variant-stat{font-size:0.75em;color:#ddd;display:flex;justify-content:space-between}
.stat-up{color:var(--green);font-weight:bold}
.stat-down{color:var(--red);font-weight:bold}
.stat-same{color:#666}
.enc-equip-card{background:rgba(255,165,0,0.1);border:1px solid var(--orange)}
.enc-equip-card:hover{border-color:var(--gold)}
.enc-equip-type{font-size:0.6em;color:var(--orange);text-transform:uppercase;font-family:'Orbitron'}
.enc-equip-special{background:rgba(0,255,255,0.1);border:1px solid var(--cyan);border-radius:4px;padding:3px 6px;margin-top:6px;font-size:0.65em;color:var(--cyan)}
.enc-ability-card{background:rgba(155,89,182,0.1);border:1px solid var(--purple)}
.enc-ability-type{font-size:0.6em;color:var(--purple);text-transform:uppercase;font-family:'Orbitron'}
.enc-ability-chance{background:rgba(0,255,136,0.2);padding:2px 6px;border-radius:10px;font-size:0.65em;color:var(--green)}
.enc-terrain-card{background:rgba(0,255,255,0.1);border:1px solid var(--cyan)}
.enc-terrain-effect{background:rgba(0,0,0,0.3);padding:6px;border-radius:4px;margin-top:6px;font-size:0.7em;color:#ccc}
.enc-npc-list{margin-top:8px}
.enc-npc{display:inline-flex;align-items:center;gap:4px;background:rgba(0,0,0,0.3);padding:3px 8px;border-radius:15px;margin:2px;font-size:0.65em}
.enc-npc.hostile{color:var(--red)}.enc-npc.friendly{color:var(--green)}
.enc-search{width:100%;padding:10px 15px;border-radius:20px;border:2px solid var(--gold);background:rgba(0,0,0,0.4);color:#fff;font-family:'Rajdhani';font-size:0.9em;margin-bottom:15px}
.enc-search:focus{outline:none;box-shadow:0 0 10px rgba(255,215,0,0.3)}
.enc-search::placeholder{color:#666}
@media(max-width:768px){
  .encyclopedia{padding:10px}
  .encyclopedia-header{padding:10px;flex-direction:column;gap:10px}
  .encyclopedia-title{font-size:1.2em}
  .encyclopedia-tabs{gap:4px;top:90px}
  .enc-tab{padding:6px 12px;font-size:0.6em}
  .enc-grid{grid-template-columns:1fr}
  .enc-card{padding:10px}
  .enc-card-avatar{width:40px;height:40px;font-size:1.4em}
}

/* Floating Image Preview */
#image-preview{
  position:fixed;
  pointer-events:none;
  z-index:99999;
  opacity:0;
  transition:opacity 0.15s ease;
  display:none;
}
#image-preview.visible{
  opacity:1;
  display:block;
}
#image-preview img{
  width:320px;
  height:420px;
  object-fit:cover;
  object-position:center top;
  border-radius:12px;
  border:4px solid var(--cyan);
  box-shadow:0 20px 80px rgba(0,0,0,0.95), 0 0 30px rgba(0,255,255,0.3);
}
</style>
</head>
<body>
<div id="image-preview"><img src="" alt="Preview"></div>
<div class="toast" id="toast"></div>
<div class="modal-bg" id="modal"><div class="modal" id="modal-content"></div></div>
<div class="winner-overlay" id="winner"></div>
<div class="encyclopedia-bg" id="encyclopedia"></div>
<div class="encyclopedia-bg" id="achievements-screen"></div>
<div id="achievement-container"></div>
<div class="sound-toggle">
  <button class="sound-btn" id="music-btn" onclick="toggleMusic()" title="Music"></button>
  <button class="sound-btn" id="sfx-btn" onclick="toggleSFX()" title="Sound Effects"></button>
</div>
<div class="nav-bar" id="nav-bar">
  <button class="nav-btn active" onclick="showScreen('game')"><span class="icon"></span><span class="label">Battle</span></button>
  <button class="nav-btn" onclick="showScreen('team')"><span class="icon"></span><span class="label">Team</span></button>
  <button class="nav-btn" onclick="showScreen('equip')"><span class="icon"></span><span class="label">Equip</span></button>
  <button class="nav-btn" onclick="openEncyclopedia()"><span class="icon"></span><span class="label">Wiki</span></button>
  <button class="nav-btn" onclick="openAchievements()"><span class="icon"></span><span class="label">Achieve</span></button>
</div>
<div class="container">
<div class="header"><h1 class="title"> GALAXY CLASH </h1></div>
<div class="mode-bar">
<button class="mode-btn active" id="mode-classic" onclick="setMode('classic')"> Classic</button>
<button class="mode-btn purple" id="mode-teams" onclick="setMode('teams')"> Teams</button>
<button class="mode-btn red" id="mode-hunger" onclick="setMode('hunger')"> Hunger Games</button>
<button class="mode-btn" id="mode-ai" style="border-color:var(--cyan);color:var(--cyan)" onclick="setMode('ai')"> VS AI</button>
<button class="mode-btn" id="mode-tournament" style="border-color:var(--orange);color:var(--orange)" onclick="setMode('tournament')"> Tournament</button>
<button class="mode-btn" style="border-color:var(--green);color:var(--green)" onclick="openEncyclopedia()"> Encyclopedia</button>
<button class="mode-btn" style="border-color:var(--orange);color:var(--orange)" onclick="openAchievements()"> Achievements</button>
</div>
<div class="ai-mode-bar" id="ai-bar" style="display:none">
  <span style="color:#888;font-size:0.7em">AI Difficulty:</span>
  <div class="ai-difficulty">
    <button class="diff-btn easy active" onclick="setAIDifficulty('easy')"> Easy</button>
    <button class="diff-btn" onclick="setAIDifficulty('normal')"> Normal</button>
    <button class="diff-btn hard" onclick="setAIDifficulty('hard')"> Hard</button>
    <button class="diff-btn brutal" onclick="setAIDifficulty('brutal')"> Brutal</button>
  </div>
</div>
<div class="main-grid">
<div class="arena">
<div class="bf-title" id="bf-title">Select your warriors and begin</div>
<div class="battle-arena" id="battle-arena" style="display:none">
  <div class="arena-bg" id="arena-bg"></div>
  <div class="arena-title" id="arena-round"> BATTLE ARENA </div>
  <div class="fighters-row">
    <div class="fighter-side left" id="fighter-left">
      <div class="fighter-portrait" id="portrait-left"><span class="emoji-fallback"></span></div>
      <div class="fighter-info">
        <div class="fighter-name" id="name-left">Fighter 1</div>
        <div class="fighter-hp-bar"><div class="fighter-hp-fill" id="hp-left" style="width:100%"></div></div>
        <div class="fighter-hp-text" id="hp-text-left">100/100</div>
      </div>
    </div>
    <div class="vs-badge"></div>
    <div class="fighter-side right" id="fighter-right">
      <div class="fighter-portrait" id="portrait-right"><span class="emoji-fallback"></span></div>
      <div class="fighter-info">
        <div class="fighter-name" id="name-right">Fighter 2</div>
        <div class="fighter-hp-bar"><div class="fighter-hp-fill" id="hp-right" style="width:100%"></div></div>
        <div class="fighter-hp-text" id="hp-text-right">100/100</div>
      </div>
    </div>
    <div class="combat-effects" id="combat-effects"></div>
  </div>
  <div class="combat-dialogue" id="combat-dialogue">
    <span class="quote">The battle is about to begin...</span>
  </div>
</div>
<div class="battlefield-preview" id="battlefield-preview"></div>
<div id="tournament-panel" style="display:none"></div>
<div class="teams-row" id="teams-row"></div>
<div class="log" id="log"></div>
<div class="controls" id="controls">
<button class="btn" onclick="startBattle()"> START BATTLE</button>
<button class="btn sec" onclick="randomAll()"> Random</button>
<button class="btn undo-btn" id="undo-btn" onclick="undo()" disabled> Undo</button>
<button class="btn red" onclick="resetAll()"> Reset</button>
</div>
</div>
<div class="side">
<div class="player-tabs" id="ptabs"></div>
<div class="panel">
<div class="panel-title"><span>SELECT UNITS</span><span>$<span id="spent">0</span>/$<span id="budget-display">15</span></span></div>
<div class="budget-control">
  <label>Budget: $</label>
  <input type="number" id="budget-input" value="15" min="5" max="100" step="5" onchange="updateBudget(this.value)">
  <button onclick="updateBudget(10)" class="budget-preset">$10</button>
  <button onclick="updateBudget(15)" class="budget-preset active">$15</button>
  <button onclick="updateBudget(20)" class="budget-preset">$20</button>
  <button onclick="updateBudget(30)" class="budget-preset">$30</button>
</div>
<div class="roster-search">
  <input type="text" id="roster-search" placeholder=" Search units..." oninput="filterRoster()">
  <button class="clear-search" onclick="clearSearch()"></button>
</div>
<div class="roster-filters">
  <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
  <button class="filter-btn" data-filter="jedi" onclick="setFilter('jedi')"> Jedi</button>
  <button class="filter-btn" data-filter="sith" onclick="setFilter('sith')"> Sith</button>
  <button class="filter-btn" data-filter="empire" onclick="setFilter('empire')"> Empire</button>
  <button class="filter-btn" data-filter="rebel" onclick="setFilter('rebel')"> Rebel</button>
  <button class="filter-btn" data-filter="bounty" onclick="setFilter('bounty')"> Bounty</button>
  <button class="filter-btn" data-filter="mando" onclick="setFilter('mando')"> Mando</button>
  <button class="filter-btn" data-filter="droid" onclick="setFilter('droid')"> Droid</button>
  <button class="filter-btn" data-filter="other" onclick="setFilter('other')"> Other</button>
</div>
<div style="font-size:0.6em;color:#666;margin-bottom:8px;text-align:center">Click to view details  Drag to add quickly</div>
<div class="save-bar">
<button class="save-btn gold" onclick="saveTeam()"> Save Team</button>
<button class="save-btn green" onclick="showSavedTeams()"> Load</button>
<button class="save-btn" onclick="exportTeams()"> Export All</button>
<button class="save-btn" onclick="importTeams()"> Import</button>
</div>
<div id="saved-teams-list"></div>
<div id="faction-panel"></div>
<div id="equipment-panel"></div>
<div id="formation-panel"></div>
<div class="roster" id="roster"></div>
</div>
</div>
</div>
</div>
<script>
const COLORS=['#00D9FF','#FF0040','#00ff88','#ff8c00'];
let BUDGET=15; // Now modifiable
let currentFilter = 'all';
let searchQuery = '';
let mode='classic',players=[],active=0,battle=null;

// Star Wars themed team names
const TEAM_NAMES = {
  republic: ['Clone Force 99', 'Phoenix Squadron', 'Rogue Squadron', 'Gold Squadron', 'Blue Squadron', 'Torrent Company', 'Ghost Company', '501st Legion', '212th Battalion', 'Wolfpack', 'Delta Squad', 'Omega Squad', 'Domino Squad', 'Shadow Squadron'],
  empire: ['Death Squadron', 'Inferno Squad', 'Shadow Guard', 'Imperial Fist', 'Crimson Guard', 'Black Sun', 'Onyx Squadron', 'Obsidian Command', 'Vader\'s Fist', 'Storm Command', 'Dark Troopers', 'Purge Troop'],
  sith: ['Sith Eternal', 'Dark Council', 'Brotherhood of Darkness', 'Rule of Two', 'Crimson Dawn', 'Shadow Collective', 'Knights of Ren', 'Acolytes of Beyond', 'Sith Triumvirate'],
  bounty: ['Bounty Guild', 'Hutt Cartel', 'Pyke Syndicate', 'Death Watch', 'Nite Owls', 'Children of the Watch', 'Mandalore\'s Finest', 'Fett Clan'],
  jedi: ['Jedi Council', 'Temple Guard', 'Jedi Sentinels', 'Jedi Shadows', 'Path of the Whills', 'Guardians of Peace', 'Order of Light', 'High Republic'],
  rebel: ['Rebel Alliance', 'Rogue One', 'Pathfinders', 'Spectres', 'Resistance Cell', 'Echo Base', 'Endor Strike Team', 'Massassi Group'],
  misc: ['Scum & Villainy', 'Outer Rim Outlaws', 'Corellian Crew', 'Smuggler\'s Run', 'Spice Runners', 'Cantina Regulars', 'Mos Eisley Misfits', 'Kessel Runners']
};

const TEAM_COLORS = [
  '#FFD700', // Gold
  '#FF0040', // Red
  '#00D9FF', // Cyan
  '#9B59B6', // Purple
  '#00FF88', // Green
  '#FF6B35', // Orange
  '#E91E63', // Pink
  '#00BCD4', // Teal
  '#8BC34A', // Lime
  '#FF5722', // Deep Orange
  '#3F51B5', // Indigo
  '#009688', // Dark Teal
];

function getRandomTeamName(){
  const allNames = Object.values(TEAM_NAMES).flat();
  return allNames[Math.floor(Math.random() * allNames.length)];
}

function getRandomTeamColor(){
  return TEAM_COLORS[Math.floor(Math.random() * TEAM_COLORS.length)];
}

function openTeamCustomizer(playerIndex){
  const p = players[playerIndex];
  const allNames = Object.values(TEAM_NAMES).flat();
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'team-customizer';
  modal.innerHTML = `
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <span> CUSTOMIZE TEAM</span>
        <button class="modal-close" onclick="closeTeamCustomizer()"></button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:15px">
          <label style="display:block;color:var(--gold);font-family:'Orbitron';font-size:0.8em;margin-bottom:5px">Team Name</label>
          <div style="display:flex;gap:8px">
            <input type="text" id="team-name-input" value="${p.name}" 
              style="flex:1;background:rgba(0,0,0,0.5);border:1px solid var(--gold);color:#fff;padding:8px 12px;border-radius:5px;font-size:1em"
              maxlength="20" placeholder="Enter team name">
            <button onclick="document.getElementById('team-name-input').value=getRandomTeamName()" 
              style="background:var(--purple);border:none;color:#fff;padding:8px 12px;border-radius:5px;cursor:pointer;font-size:0.9em"></button>
          </div>
        </div>
        
        <div style="margin-bottom:15px">
          <label style="display:block;color:var(--gold);font-family:'Orbitron';font-size:0.8em;margin-bottom:5px">Preset Names</label>
          <select id="team-preset-select" onchange="document.getElementById('team-name-input').value=this.value"
            style="width:100%;background:rgba(0,0,0,0.5);border:1px solid var(--gold);color:#fff;padding:8px;border-radius:5px;font-size:0.9em">
            <option value="">-- Select a preset --</option>
            ${Object.entries(TEAM_NAMES).map(([cat, names]) => 
              `<optgroup label="${cat.charAt(0).toUpperCase() + cat.slice(1)}">
                ${names.map(n => `<option value="${n}">${n}</option>`).join('')}
              </optgroup>`
            ).join('')}
          </select>
        </div>
        
        <div style="margin-bottom:15px">
          <label style="display:block;color:var(--gold);font-family:'Orbitron';font-size:0.8em;margin-bottom:5px">Team Color</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="team-color-input" value="${p.color}" 
              style="width:50px;height:40px;border:none;border-radius:5px;cursor:pointer">
            <div style="display:flex;flex-wrap:wrap;gap:4px;flex:1">
              ${TEAM_COLORS.map(c => 
                `<div onclick="document.getElementById('team-color-input').value='${c}'" 
                  style="width:24px;height:24px;background:${c};border-radius:4px;cursor:pointer;border:2px solid ${c===p.color?'#fff':'transparent'}"
                  title="${c}"></div>`
              ).join('')}
            </div>
          </div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:20px">
          <button onclick="randomizeTeam(${playerIndex})" 
            style="flex:1;background:var(--purple);border:none;color:#fff;padding:10px;border-radius:5px;cursor:pointer;font-family:'Orbitron';font-size:0.8em">
             RANDOMIZE ALL
          </button>
          <button onclick="saveTeamCustomization(${playerIndex})" 
            style="flex:1;background:var(--green);border:none;color:#000;padding:10px;border-radius:5px;cursor:pointer;font-family:'Orbitron';font-size:0.8em">
             SAVE
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  setTimeout(() => modal.classList.add('show'), 10);
}

function closeTeamCustomizer(){
  const modal = document.getElementById('team-customizer');
  if(modal){
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  }
}

function randomizeTeam(playerIndex){
  document.getElementById('team-name-input').value = getRandomTeamName();
  document.getElementById('team-color-input').value = getRandomTeamColor();
}

function saveTeamCustomization(playerIndex){
  const name = document.getElementById('team-name-input').value.trim() || `Player ${playerIndex + 1}`;
  const color = document.getElementById('team-color-input').value;
  
  players[playerIndex].name = name;
  players[playerIndex].color = color;
  
  closeTeamCustomizer();
  renderTabs();
  renderTeams();
  toast(`Team updated: ${name}`);
}

// ============================================
// UNDO SYSTEM
// ============================================
const undoHistory = [];
const MAX_UNDO = 20;

function saveUndoState(){
  const state = JSON.stringify(players.map(p => ({
    ...p,
    units: p.units.map(u => ({...u})),
    equipment: [...p.equipment],
    formation: {front: [...p.formation.front], back: [...p.formation.back]}
  })));
  undoHistory.push(state);
  if(undoHistory.length > MAX_UNDO) undoHistory.shift();
  updateUndoButton();
}

function undo(){
  if(undoHistory.length === 0 || battle) return;
  const state = JSON.parse(undoHistory.pop());
  players.forEach((p, i) => {
    if(state[i]){
      p.units = state[i].units;
      p.equipment = state[i].equipment;
      p.spent = state[i].spent;
      p.leader = state[i].leader;
      p.noLeader = state[i].noLeader;
      p.formation = state[i].formation;
    }
  });
  renderTabs();
  renderRoster();
  renderTeams();
  renderFormation();
  renderEquipment();
  updateUndoButton();
  toast(' Undone!');
}

function updateUndoButton(){
  const btn = document.getElementById('undo-btn');
  if(btn){
    btn.disabled = undoHistory.length === 0 || battle;
    btn.style.opacity = undoHistory.length === 0 ? '0.5' : '1';
  }
}

// ============================================
// FACTION BONUS SYSTEM
// ============================================
const FACTION_BONUSES = {
  'Sith': {
    name: 'Dark Side Mastery',
    emoji: '',
    minUnits: 3,
    bonus: {atk: 10, def: 0, hp: 0, spd: 1},
    desc: '+10 ATK, +1 SPD for all Sith units'
  },
  'Jedi': {
    name: 'Light Side Harmony',
    emoji: '',
    minUnits: 3,
    bonus: {atk: 5, def: 10, hp: 0, spd: 0},
    desc: '+5 ATK, +10 DEF for all Jedi units'
  },
  'Rebel': {
    name: 'Hope of the Rebellion',
    emoji: '',
    minUnits: 3,
    bonus: {atk: 5, def: 5, hp: 15, spd: 0},
    desc: '+5 ATK, +5 DEF, +15 HP for all Rebel units'
  },
  'Empire': {
    name: 'Imperial Discipline',
    emoji: '',
    minUnits: 3,
    bonus: {atk: 8, def: 8, hp: 0, spd: 0},
    desc: '+8 ATK, +8 DEF for all Empire units'
  },
  'Bounty Hunter': {
    name: 'Hunter\'s Mark',
    emoji: '',
    minUnits: 2,
    bonus: {atk: 12, def: 0, hp: 0, spd: 2},
    desc: '+12 ATK, +2 SPD for all Bounty Hunters'
  },
  'Mandalorian': {
    name: 'The Way',
    emoji: '',
    minUnits: 2,
    bonus: {atk: 5, def: 15, hp: 10, spd: 0},
    desc: '+5 ATK, +15 DEF, +10 HP for all Mandalorians'
  },
  'Republic': {
    name: 'Clone Protocol',
    emoji: '',
    minUnits: 3,
    bonus: {atk: 6, def: 6, hp: 10, spd: 1},
    desc: '+6 ATK, +6 DEF, +10 HP, +1 SPD for all Republic units'
  },
  'Droid': {
    name: 'Networked Efficiency',
    emoji: '',
    minUnits: 3,
    bonus: {atk: 5, def: 10, hp: 20, spd: 0},
    desc: '+5 ATK, +10 DEF, +20 HP for all Droids'
  },
  'Separatist': {
    name: 'Droid Army',
    emoji: '',
    minUnits: 2,
    bonus: {atk: 8, def: 5, hp: 15, spd: 0},
    desc: '+8 ATK, +5 DEF, +15 HP for all Separatists'
  },
  'Nightsister': {
    name: 'Dathomir Magick',
    emoji: '',
    minUnits: 2,
    bonus: {atk: 10, def: 5, hp: 0, spd: 1},
    desc: '+10 ATK, +5 DEF, +1 SPD for all Nightsisters'
  }
};

function getActiveFactionBonuses(units){
  const factionCounts = {};
  units.forEach(u => {
    factionCounts[u.faction] = (factionCounts[u.faction] || 0) + 1;
  });
  
  const activeBonuses = [];
  Object.entries(FACTION_BONUSES).forEach(([faction, data]) => {
    if(factionCounts[faction] >= data.minUnits){
      activeBonuses.push({faction, ...data});
    }
  });
  return activeBonuses;
}

function applyFactionBonus(unit, bonuses){
  const bonus = bonuses.find(b => b.faction === unit.faction);
  if(bonus){
    return {
      atk: bonus.bonus.atk || 0,
      def: bonus.bonus.def || 0,
      hp: bonus.bonus.hp || 0,
      spd: bonus.bonus.spd || 0
    };
  }
  return {atk: 0, def: 0, hp: 0, spd: 0};
}

function renderFactionBonuses(){
  const p = players[active];
  if(!p) return '';
  
  const bonuses = getActiveFactionBonuses(p.units);
  if(bonuses.length === 0) return '';
  
  return `
    <div class="faction-bonuses">
      <div class="faction-title"> ACTIVE FACTION BONUSES</div>
      ${bonuses.map(b => `
        <div class="faction-bonus">
          <span class="faction-emoji">${b.emoji}</span>
          <span class="faction-name">${b.name}</span>
          <span class="faction-desc">${b.desc}</span>
        </div>
      `).join('')}
    </div>
  `;
}

let selectedBattlefield=null;
let draggedUnit=null;
let draggedEquip=null;

// SPECIAL ABILITIES - Full combat implementation
const SPECIALS={
'Force Lightning':{desc:'Chains lightning to 3 enemies for 25-40 dmg each',chance:0.35,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive).slice(0,3);let d=0;t.forEach(e=>{const dmg=25+Math.random()*15;e.curHp-=dmg;d+=dmg;anim(e,'lightning');});return{msg:` ${u.name} unleashes FORCE LIGHTNING! ${t.map(x=>x.name).join(', ')} hit for ${Math.round(d)} total!`,dmg:d};}},
'Force Choke':{desc:'Chokes highest HP enemy for 30-50 armor-piercing dmg',chance:0.4,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive).sort((a,b)=>b.curHp-a.curHp)[0];if(!t)return null;const dmg=30+Math.random()*20;t.curHp-=dmg;anim(t,'hit');return{msg:` ${u.name} FORCE CHOKES ${t.name}! ${Math.round(dmg)} damage!`,dmg};}},
'Force Drain':{desc:'Steals 20-35 HP from enemy',chance:0.4,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive)[0];if(!t)return null;const dmg=20+Math.random()*15;t.curHp-=dmg;const heal=Math.min(dmg,u.maxHp-u.curHp);u.curHp+=heal;anim(t,'hit');anim(u,'heal');return{msg:` ${u.name} DRAINS ${t.name}! Steals ${Math.round(dmg)} HP!`,dmg,heal};}},
'Force Absorb':{desc:'50% chance to absorb Force attacks as healing',chance:0.5,type:'defend',
  fn:(u,dmg,atk)=>{if(['Sith','Jedi'].includes(atk.faction)){const h=dmg*0.5;u.curHp=Math.min(u.maxHp,u.curHp+h);anim(u,'heal');return{reduce:dmg*0.5,msg:` ${u.name} ABSORBS the attack! Heals ${Math.round(h)}!`};}return null;}},
'Resurrection':{desc:'Revives fallen ally as Undead with 50% HP. Can revive multiple times.',chance:0.35,type:'roundEnd',
  fn:(u,allies)=>{const dead=allies.filter(a=>!a.alive&&!a.resurrected);if(!dead.length)return null;const t=dead[Math.floor(Math.random()*dead.length)];t.alive=true;t.resurrected=true;t.isUndead=true;t.curHp=t.maxHp*0.5;t.atkBuff+=0.1;t.emoji='';const oldName=t.name;t.name='Undead '+t.name.replace('Undead ','');anim(t,'resurrect');return{msg:` ${u.name} performs DARK RESURRECTION! ${oldName} rises as ${t.name}!`};}},
'Dark Revival':{desc:'Revives self once when killed with 30% HP',type:'onDeath',once:true,
  fn:(u)=>{if(u.usedRevival)return null;u.usedRevival=true;u.curHp=u.maxHp*0.3;u.alive=true;u.isUndead=true;u.name='Revenant '+u.name;anim(u,'resurrect');return{msg:` ${u.name} REFUSES TO DIE! Returns with ${Math.round(u.curHp)} HP!`,prevented:true};}},
'Bribery':{desc:'20% chance to bribe enemy to skip their turn or betray',chance:0.2,type:'roundStart',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive&&!e.bribed&&e.cost<=3)[0];if(!t)return null;if(Math.random()<0.3){t.betrayed=true;t.bribed=true;anim(t,'betray');return{msg:` ${u.name} BRIBES ${t.name}! They will BETRAY their team!`,betrayer:t};}else{t.bribed=true;t.skipTurn=true;return{msg:` ${u.name} bribes ${t.name} to hesitate this round!`};}}},
'Betrayal':{desc:'May attack allies if ignored or kill stolen. 15% chance each round.',chance:0.15,type:'roundEnd',
  fn:(u,allies,enemies)=>{if(allies.filter(a=>a.alive).length<=1)return null;const ally=allies.filter(a=>a.alive&&a.uid!==u.uid)[Math.floor(Math.random()*allies.filter(a=>a.alive&&a.uid!==u.uid).length)];if(!ally)return null;const dmg=20+Math.random()*30;ally.curHp-=dmg;anim(ally,'betray');anim(u,'shake');return{msg:` ${u.name} BETRAYS ${ally.name}! "You were WEAK!" ${Math.round(dmg)} damage!`,dmg};}},
'Dark Influence':{desc:'25% chance to turn enemy to your side temporarily',chance:0.25,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive&&!e.influenced&&e.cost<=2)[0];if(!t)return null;t.influenced=2;t.originalOwner=t.ownerId;t.ownerId=u.ownerId;anim(t,'betray');return{msg:` ${u.name} uses DARK INFLUENCE! ${t.name} fights for them for 2 rounds!`};}},
'Sacrifice':{desc:'Can sacrifice self to fully heal and buff strongest ally',type:'active',chance:0.2,
  fn:(u,allies)=>{if(u.curHp>u.maxHp*0.3)return null;const strongest=allies.filter(a=>a.alive&&a.uid!==u.uid).sort((a,b)=>b.atk-a.atk)[0];if(!strongest)return null;strongest.curHp=strongest.maxHp;strongest.atkBuff+=0.25;strongest.defBuff+=0.25;u.curHp=0;u.alive=false;anim(u,'death');anim(strongest,'heal');return{msg:` ${u.name} SACRIFICES themselves! ${strongest.name} fully healed and buffed!`,sacrifice:true};}},
'Vapaad':{desc:'Damage taken increases attack power',type:'passive',fn:(u)=>({atkMod:1+(1-u.curHp/u.maxHp)*0.5})},
'Soresu Mastery':{desc:'Blocks 30% of all incoming damage',chance:1,type:'defend',fn:(u,dmg)=>({reduce:dmg*0.3,msg:` Soresu blocks ${Math.round(dmg*0.3)} damage!`})},
'Dual Blades':{desc:'Attacks twice per round',chance:1,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive)[Math.floor(Math.random()*enemies.filter(e=>e.alive).length)];if(!t)return null;const dmg=Math.max(5,u.atk*0.7-t.def*0.2+Math.random()*15);t.curHp-=dmg;anim(t,'hit');return{msg:` Second blade hits ${t.name} for ${Math.round(dmg)}!`,dmg};}},
'Four Arms':{desc:'4 attacks with reduced damage each',chance:1,type:'attack',
  fn:(u,allies,enemies)=>{let d=0,hits=[];for(let i=0;i<3;i++){const t=enemies.filter(e=>e.alive)[Math.floor(Math.random()*enemies.filter(e=>e.alive).length)];if(t){const dmg=Math.max(3,u.atk*0.4-t.def*0.15+Math.random()*10);t.curHp-=dmg;d+=dmg;hits.push(t.name);anim(t,'hit');}}return{msg:` Four sabers strike! ${hits.join(', ')} for ${Math.round(d)} total!`,dmg:d};}},
'Rage':{desc:'Below 50% HP = +50% damage',type:'passive',fn:(u)=>u.curHp<u.maxHp*0.5?{atkMod:1.5}:{atkMod:1}},
'Wookiee Rage':{desc:'Below 40% HP = +40% attack',type:'passive',fn:(u)=>u.curHp<u.maxHp*0.4?{atkMod:1.4}:{atkMod:1}},
'Lucky Shot':{desc:'20% chance for triple damage',chance:0.2,type:'attack',fn:()=>({dmgMod:3,msg:` LUCKY SHOT! TRIPLE DAMAGE!`})},
'Sniper':{desc:'First attack deals +60% damage',type:'passive',once:true,fn:(u)=>{if(!u.sniperUsed){u.sniperUsed=true;return{atkMod:1.6,msg:` Sniper strikes from stealth!`};}return{atkMod:1};}},
'Beskar Armor':{desc:'-50% lightsaber dmg, -20% all dmg',chance:1,type:'defend',fn:(u,dmg,atk)=>{const r=['Jedi','Sith'].includes(atk.faction)?dmg*0.5:dmg*0.2;return{reduce:r,msg:` Beskar absorbs ${Math.round(r)} damage!`};}},
'Shield':{desc:'Absorbs first 40 damage each round',type:'roundStart',fn:(u)=>{u.shield=40;return{msg:` ${u.name}'s shields activate!`};}},
'Repair':{desc:'Heals lowest HP ally for 25-35',chance:0.6,type:'roundEnd',
  fn:(u,allies)=>{const t=allies.filter(a=>a.alive&&a.curHp<a.maxHp).sort((a,b)=>a.curHp-b.curHp)[0];if(!t)return null;const h=Math.min(25+Math.random()*10,t.maxHp-t.curHp);t.curHp+=h;anim(t,'heal');return{msg:` ${u.name} repairs ${t.name} for ${Math.round(h)} HP!`,heal:h};}},
'Heal':{desc:'Heals most wounded ally for 30-45',chance:0.7,type:'roundEnd',
  fn:(u,allies)=>{const t=allies.filter(a=>a.alive&&a.curHp<a.maxHp).sort((a,b)=>a.curHp/a.maxHp-b.curHp/b.maxHp)[0];if(!t)return null;const h=Math.min(30+Math.random()*15,t.maxHp-t.curHp);t.curHp+=h;anim(t,'heal');return{msg:` ${u.name} heals ${t.name} for ${Math.round(h)} HP!`,heal:h};}},
'Leadership':{desc:'Clones get +15% ATK/DEF',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.faction==='Republic'&&a.uid!==u.uid).forEach(a=>{a.atkBuff+=0.15;a.defBuff+=0.15;});return{msg:` ${u.name}'s Leadership inspires clones!`};}},
'Command':{desc:'Stormtroopers get +20% ATK',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.faction==='Empire'&&a.uid!==u.uid).forEach(a=>{a.atkBuff+=0.2;});return{msg:` ${u.name} commands the troops!`};}},
'Tactical Genius':{desc:'All allies +10% ATK, +15% DEF',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.uid!==u.uid).forEach(a=>{a.atkBuff+=0.1;a.defBuff+=0.15;});return{msg:` Thrawn's tactical brilliance guides the team!`};}},
'Chaos Factor':{desc:'Random: heal ally, hurt enemy, or backfire',chance:0.4,type:'roundEnd',
  fn:(u,allies,enemies)=>{const r=Math.random();if(r<0.4){const a=allies.filter(x=>x.alive&&x.uid!==u.uid)[0];if(a){a.curHp=Math.min(a.maxHp,a.curHp+20);anim(a,'heal');return{msg:` Jar Jar accidentally heals ${a.name}!`};}}else if(r<0.7){const e=enemies.filter(x=>x.alive)[0];if(e){e.curHp-=25;anim(e,'hit');return{msg:` Jar Jar trips and hits ${e.name} for 25!`,dmg:25};}}else{u.curHp-=15;return{msg:` "Oopsie!" Jar Jar hurts himself for 15!`};}return null;}},
'New Hope':{desc:'All allies +8% stats',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.uid!==u.uid).forEach(a=>{a.atkBuff+=0.08;a.defBuff+=0.08;});return{msg:` ${u.name} inspires hope!`};}},
'Jetpack':{desc:'+15% evasion',type:'passive',fn:()=>({evade:0.15})},
'Force Unleashed':{desc:'AoE: 35-50 damage to ALL enemies',chance:0.25,type:'attack',
  fn:(u,allies,enemies)=>{let d=0;enemies.filter(e=>e.alive).forEach(e=>{const dmg=35+Math.random()*15;e.curHp-=dmg;d+=dmg;anim(e,'lightning');});return{msg:` ${u.name} UNLEASHES THE FORCE! ALL enemies take ${Math.round(d)} total!`,dmg:d};}},
'Force Mastery':{desc:'+25% damage from mastery of both sides',type:'passive',fn:()=>({atkMod:1.25})},
'Chosen One':{desc:'15% chance for double damage burst',chance:0.15,type:'attack',fn:()=>({dmgMod:2,msg:` Chosen One's power SURGES! DOUBLE DAMAGE!`})},
'Savage Assault':{desc:'+30% ATK, -10% DEF. May betray allies.',type:'passive',fn:()=>({atkMod:1.3,defMod:0.9}),betrayChance:0.1},
'Makashi':{desc:'25% crit chance in duels',chance:0.25,type:'attack',fn:()=>({dmgMod:1.5,msg:` Elegant Makashi! Critical strike!`})},
'Nightsister':{desc:'25% chance to poison for 15 dmg/turn',chance:0.25,type:'attack',fn:(u,allies,enemies,target)=>{if(target&&!target.poisoned){target.poisoned=3;anim(target,'poison');return{msg:` Dark magick POISONS ${target.name}!`};}return null;}},
'Protocol':{desc:'Reveals enemy team info',type:'battleStart',fn:()=>({msg:` "Oh my!" C-3PO analyzes the enemy!`})},
// New abilities for new units
'Ultimate Warrior':{desc:'No Force but +35% ATK, +20% DEF',type:'passive',fn:()=>({atkMod:1.35,defMod:1.2})},
'Force Suppression':{desc:'All Force users get -25% ability effectiveness',type:'aura',fn:(u,allies,enemies)=>{[...allies,...enemies].filter(a=>['Jedi','Sith'].includes(a.faction)&&a.uid!==u.uid).forEach(a=>{a.atkBuff=(a.atkBuff||0)-0.15;});return{msg:` The Daughter suppresses the Force!`};}},
'Force Nullifier':{desc:'Path engines counter Force: +40% dmg vs Force users',type:'passive',fn:(u,allies,enemies,target)=>{if(target&&['Jedi','Sith'].includes(target.faction))return{atkMod:1.4};return{atkMod:1};}},
'Darksaber Wielder':{desc:'-30% damage from Mandalorians, +20% ATK',type:'passive',fn:()=>({atkMod:1.2,defMod:1.1})},
'Battle Meditation':{desc:'All allies +12% ATK/DEF',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.uid!==u.uid).forEach(a=>{a.atkBuff=(a.atkBuff||0)+0.12;a.defBuff=(a.defBuff||0)+0.12;});return{msg:` Bastila's Battle Meditation empowers the team!`};}},
'Overwhelming Force':{desc:'More troops = more damage. +2% per 10 units',type:'passive',fn:(u)=>{const bonus=(u.qty||10)*0.002;return{atkMod:1+bonus};}},
'Assassination Protocol':{desc:'25% instakill on weak units',chance:0.25,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive&&e.cost<=1)[0];if(t){t.curHp=0;t.alive=false;anim(t,'death');return{msg:` "Query: Can I kill this one?" HK-47 TERMINATES ${t.name}!`,instakill:true};}return null;}},
'Heavy Assault':{desc:'+25% damage, attacks all front line',chance:0.4,type:'attack',
  fn:(u,allies,enemies)=>{const front=enemies.filter(e=>e.alive&&e.isFront);if(!front.length)return null;let d=0;front.forEach(e=>{const dmg=20+Math.random()*15;e.curHp-=dmg;d+=dmg;anim(e,'hit');});return{msg:` Ultra droids bombard front line for ${Math.round(d)}!`,dmg:d};}},
'Fear Will Keep Them':{desc:'Enemies have -10% ATK from fear',type:'aura',fn:(u,allies,enemies)=>{enemies.forEach(e=>{e.atkBuff=(e.atkBuff||0)-0.1;});return{msg:` Tarkin: "Fear will keep them in line."`};}},
'Living Force':{desc:'Heals 10 HP per round',type:'roundEnd',fn:(u)=>{if(u.alive){const h=Math.min(10,u.maxHp-u.curHp);u.curHp+=h;if(h>0)return{msg:` Qui-Gon channels the Living Force. +${h} HP.`,heal:h};}return null;}},
'Quickdraw':{desc:'Always attacks first. +30% damage on first attack',type:'passive',fn:(u)=>{if(!u.quickdrawUsed){u.quickdrawUsed=true;return{atkMod:1.3,spdMod:99};}return{atkMod:1};}},
'Electric Judgment':{desc:'30% chance to stun with light-side lightning',chance:0.3,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive)[0];if(!t)return null;t.stunned=1;const dmg=15+Math.random()*10;t.curHp-=dmg;anim(t,'lightning');return{msg:` Plo Koon uses Electric Judgment! ${t.name} stunned!`,dmg};}},
'Crush':{desc:'35% chance to kill unit under 100 HP',chance:0.35,type:'attack',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive&&e.curHp<100)[0];if(t){t.curHp=0;t.alive=false;anim(t,'death');return{msg:` The Rancor CRUSHES ${t.name}!`,instakill:true};}return null;}},
'Force Healer':{desc:'Heals most wounded ally for 40-60 HP',chance:0.8,type:'roundEnd',
  fn:(u,allies)=>{const t=allies.filter(a=>a.alive&&a.curHp<a.maxHp).sort((a,b)=>a.curHp-b.curHp)[0];if(!t)return null;const h=Math.min(40+Math.random()*20,t.maxHp-t.curHp);t.curHp+=h;anim(t,'heal');return{msg:` Torban Buck heals ${t.name} for ${Math.round(h)}!`,heal:h};}},
'Extreme Tactics':{desc:'+25% damage',type:'passive',fn:()=>({atkMod:1.25})},
'Air Superiority':{desc:'Ignores front line, attacks back directly',type:'passive',fn:()=>({ignoreFormation:true})},
'Fleet Commander':{desc:'Rebel units +15% stats',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.faction==='Rebel'&&a.uid!==u.uid).forEach(a=>{a.atkBuff=(a.atkBuff||0)+0.15;a.defBuff=(a.defBuff||0)+0.15;});return{msg:` Ackbar commands the fleet!`};}},
'Tactical Analysis':{desc:'All allies +8% ATK/DEF',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.uid!==u.uid).forEach(a=>{a.atkBuff=(a.atkBuff||0)+0.08;a.defBuff=(a.defBuff||0)+0.08;});return{msg:` Tactical Droid calculates...`};}},
'Sentinel':{desc:'+20% DEF when protecting Jedi',type:'passive',fn:(u,allies)=>{if(allies.some(a=>a.faction==='Jedi'))return{defMod:1.2};return{defMod:1};}},
'Elite Guard':{desc:'+15% ATK/DEF when protecting Sith',type:'passive',fn:(u,allies)=>{if(allies.some(a=>a.faction==='Sith'))return{atkMod:1.15,defMod:1.15};return{};}},
'Pain Immortality':{desc:'Regenerates 20 HP/round',type:'roundEnd',fn:(u)=>{if(u.alive&&u.curHp<u.maxHp){u.curHp=Math.min(u.maxHp,u.curHp+20);return{msg:` Sion draws strength from pain! +20 HP!`,heal:20};}return null;}},
'Siege Mode':{desc:'Attacks all enemies for reduced damage',chance:0.3,type:'attack',
  fn:(u,allies,enemies)=>{let d=0;enemies.filter(e=>e.alive).forEach(e=>{const dmg=15+Math.random()*10;e.curHp-=dmg;d+=dmg;anim(e,'hit');});return{msg:` Spider droid bombards ALL enemies for ${Math.round(d)}!`,dmg:d};}},
'Electrostaff':{desc:'30% chance to stun',chance:0.3,type:'attack',fn:(u,allies,enemies,target)=>{if(target){target.stunned=1;return{msg:` Electrostaff STUNS ${target.name}!`};}return null;}},
'Self Destruct':{desc:'When killed, deals 80 damage to killer',type:'onDeath',fn:(u,killer)=>{if(killer){killer.curHp-=80;anim(killer,'hit');return{msg:` IG-11 self-destructs! 80 damage to ${killer.name}!`,dmg:80};}return null;}},
'Rebellious Spirit':{desc:'+20% damage when outnumbered',type:'passive',fn:(u,allies,enemies)=>{if(enemies.filter(e=>e.alive).length>allies.filter(a=>a.alive).length)return{atkMod:1.2};return{atkMod:1};}},
'Bo-Rifle':{desc:'Melee and ranged. +15% ATK',type:'passive',fn:()=>({atkMod:1.15})},
'Death Watch':{desc:'+15% ATK/DEF, +30% vs Empire',type:'passive',fn:(u,allies,enemies,target)=>{if(target&&target.faction==='Empire')return{atkMod:1.45,defMod:1.15};return{atkMod:1.15,defMod:1.15};}},
'Force Potential':{desc:'Random powerful Force ability',chance:0.25,type:'attack',
  fn:(u,allies,enemies)=>{const r=Math.random();if(r<0.3){const t=enemies.filter(e=>e.alive)[0];if(t){const dmg=50+Math.random()*30;t.curHp-=dmg;anim(t,'lightning');return{msg:` Grogu unleashes FORCE WAVE! ${Math.round(dmg)} damage!`,dmg};}}return null;}},
'Explosives Expert':{desc:'25% chance for AoE explosion',chance:0.25,type:'attack',
  fn:(u,allies,enemies)=>{let d=0;enemies.filter(e=>e.alive).slice(0,3).forEach(e=>{const dmg=20+Math.random()*15;e.curHp-=dmg;d+=dmg;anim(e,'hit');});return{msg:` Sabine's explosives hit for ${Math.round(d)}!`,dmg:d};}},
'Heavy Repeater':{desc:'+20% ATK',type:'passive',fn:()=>({atkMod:1.2})},
'Forge Master':{desc:'Buffs ally armor +20% DEF',chance:0.5,type:'roundStart',
  fn:(u,allies)=>{const t=allies.filter(a=>a.alive&&a.uid!==u.uid)[0];if(t){t.defBuff=(t.defBuff||0)+0.2;return{msg:` The Armorer forges armor for ${t.name}!`};}return null;}},
'Learn':{desc:'Copies leader\'s special at 50% power',type:'passive',fn:(u,allies)=>{const leader=allies.find(a=>a.isLeader);if(leader&&leader.special)return{learnFrom:leader.special};return{};}},
'Sabotage':{desc:'25% chance to disable enemy equipment',chance:0.25,type:'roundStart',
  fn:(u,allies,enemies)=>{const t=enemies.filter(e=>e.alive&&e.equipment?.length)[0];if(t){t.equipmentDisabled=2;return{msg:` Chopper sabotages ${t.name}'s equipment!`};}return null;}},
'Blunt Analysis':{desc:'+10% team accuracy',type:'battleStart',fn:(u,allies)=>{allies.forEach(a=>{a.accuracy=(a.accuracy||1)+0.1;});return{msg:` K-2SO: "The odds are not in our favor."`};}},
'Diplomacy':{desc:'10% chance to prevent attack',chance:0.1,type:'defend',fn:(u,dmg,atk)=>{if(Math.random()<0.1)return{reduce:dmg,msg:` Padm attempts diplomacy!`};return null;}},
'Defector':{desc:'+20% damage vs Empire',type:'passive',fn:(u,allies,enemies,target)=>{if(target&&target.faction==='Empire')return{atkMod:1.2};return{atkMod:1};}},
'Mentor':{desc:'Younglings get +50% stats',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.id==='youngling'||a.id==='jedipadawan').forEach(a=>{a.atkBuff=(a.atkBuff||0)+0.5;a.defBuff=(a.defBuff||0)+0.5;});return{msg:` Tera Sinube teaches the young ones.`};}},
'Rally':{desc:'First Order troops +15% ATK',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.faction==='Empire'&&a.uid!==u.uid).forEach(a=>{a.atkBuff=(a.atkBuff||0)+0.15;});return{msg:` Hux rallies the troops!`};}},
'First Shot':{desc:'Shoots first. +50% first attack',type:'passive',fn:(u)=>{if(!u.firstShotUsed){u.firstShotUsed=true;return{atkMod:1.5,spdMod:50};}return{atkMod:1};}},
'Command Synergy':{desc:'+25% stats with same faction leader',type:'passive',fn:(u,allies)=>{const leader=allies.find(a=>a.isLeader);if(leader&&leader.faction===u.faction)return{atkMod:1.25,defMod:1.25};return{};}},
'Shield Wall':{desc:'Front Gungans +30% DEF',type:'aura',fn:(u,allies)=>{allies.filter(a=>a.faction==='Gungan'&&a.isFront).forEach(a=>{a.defBuff=(a.defBuff||0)+0.3;});return{msg:` Gungans form shield wall!`};}},
'Forest Ambush':{desc:'+40% ATK in forest',type:'passive',fn:(u)=>{if(typeof selectedBattlefield!=='undefined'&&selectedBattlefield?.terrain?.type==='forest')return{atkMod:1.4};return{atkMod:1};}},
'Scavenge':{desc:'30% chance to buff ally +10% ATK',chance:0.3,type:'roundEnd',
  fn:(u,allies)=>{const t=allies.filter(a=>a.alive&&a.uid!==u.uid)[0];if(t){t.atkBuff=(t.atkBuff||0)+0.1;return{msg:` Jawas find upgrade for ${t.name}!`};}return null;}},
'Artillery':{desc:'Attacks ignore 40% DEF',type:'passive',fn:()=>({armorPiercing:0.4})},
'Potential':{desc:'+5% ATK/DEF per round',type:'roundEnd',fn:(u)=>{u.atkBuff=(u.atkBuff||0)+0.05;u.defBuff=(u.defBuff||0)+0.05;return{msg:` Youngling grows stronger!`};}},
'Pirate Synergy':{desc:'+30% stats with Nihil leader',type:'passive',fn:(u,allies)=>{const leader=allies.find(a=>a.isLeader);if(leader&&leader.faction==='Nihil')return{atkMod:1.3,defMod:1.3};return{};}},
'Spinning Blade':{desc:'30% chance to hit 2 enemies',chance:0.3,type:'attack',
  fn:(u,allies,enemies)=>{const targets=enemies.filter(e=>e.alive).slice(0,2);if(targets.length<2)return null;let d=0;targets.forEach(t=>{const dmg=15+Math.random()*10;t.curHp-=dmg;d+=dmg;anim(t,'hit');});return{msg:` Spinning blade hits ${targets.length} enemies!`,dmg:d};}},
'Psychometry':{desc:'Reveals enemies, +15% accuracy',type:'battleStart',fn:(u,allies,enemies)=>{enemies.forEach(e=>{e.revealed=true;});return{msg:` Cal senses through the Force!`};}},
'Street Smart':{desc:'+20% evasion, +15% ATK',type:'passive',fn:()=>({evade:0.2,atkMod:1.15})},
'Dyad Power':{desc:'+15% all stats per dead ally',type:'passive',fn:(u,allies)=>{const dead=allies.filter(a=>!a.alive).length;if(dead>0)return{atkMod:1+dead*0.15,defMod:1+dead*0.15};return{};}},
'Ewok Tactics':{desc:'Calls reinforcements',chance:0.2,type:'roundEnd',fn:(u,allies)=>{if(allies.length<6)return{msg:` Wicket calls for help! Yub nub!`};return null;}},
'Cloud-Rider':{desc:'+20% evasion, +15% ATK',type:'passive',fn:()=>({evade:0.2,atkMod:1.15})},
'Emperor\'s Hand':{desc:'+40% damage vs isolated targets',type:'passive',fn:(u,allies,enemies)=>{if(enemies.filter(e=>e.alive).length===1)return{atkMod:1.4};return{atkMod:1};}},
};

// UNITS DATABASE - Complete Roster
const UNITS=[
// Speed stat: Higher = attacks first. Range 1-10. Force users and assassins are fastest.

// ============ $10 TIER - LEGENDARY ============
{id:'starkiller',name:'Starkiller',cost:10,hp:280,atk:96,def:88,spd:9,emoji:'',faction:'Sith',special:'Force Unleashed',desc:'Secret apprentice of Vader. Raw power incarnate.',intro:'Starkiller materializes. Reality bends.'},
{id:'revan',name:'Darth Revan',cost:10,hp:270,atk:94,def:90,spd:8,emoji:'',faction:'Sith',special:'Force Mastery',desc:'Master of light and dark sides.',intro:'Revan steps forward, mask emotionless.'},
{id:'nihilus',name:'Darth Nihilus',cost:10,hp:250,atk:92,def:92,spd:7,emoji:'',faction:'Sith',special:'Force Drain',desc:'The Lord of Hunger. Consumes all life.',intro:'Nihilus floatsa void where life should be.'},
{id:'talzin',name:'Mother Talzin',cost:10,hp:240,atk:88,def:85,spd:6,emoji:'',faction:'Nightsister',special:'Resurrection',desc:'Raises the dead to fight. Can resurrect fallen enemies.',intro:'Talzin emerges from green mist.'},
{id:'mandalore',name:'Mandalore the Ultimate',cost:10,hp:300,atk:90,def:95,spd:6,emoji:'',faction:'Mandalorian',special:'Ultimate Warrior',desc:'Greatest Mandalorian. No Force, pure skill.',intro:'Mandalore raises his battle-axe. War begins.'},
{id:'daughter',name:'The Daughter',cost:10,hp:200,atk:85,def:100,spd:8,emoji:'',faction:'Celestial',special:'Force Suppression',desc:'Weakens all Force users on the battlefield.',intro:'Light incarnate descends. The Force wavers.'},
{id:'plagueis',name:'Darth Plagueis',cost:10,hp:230,atk:88,def:85,spd:5,emoji:'',faction:'Sith',special:'Dark Revival',desc:'Cheated death itself. Master of midichlorians.',intro:'Plagueis whispers of immortality.'},

// ============ $5 TIER - ELITE ============
{id:'palpatine',name:'Palpatine',cost:5,hp:200,atk:90,def:78,spd:8,emoji:'',faction:'Sith',special:'Force Lightning',desc:'UNLIMITED POWER. The Dark Lord.',intro:'"Good..." Lightning dances.'},
{id:'yoda',name:'Yoda',cost:5,hp:180,atk:88,def:85,spd:10,emoji:'',faction:'Jedi',special:'Force Absorb',desc:'900 years of wisdom. Strongest Jedi.',intro:'The Force radiates from Yoda.'},
{id:'vader',name:'Darth Vader',cost:5,hp:240,atk:92,def:90,spd:5,emoji:'',faction:'Sith',special:'Force Choke',desc:'More machine than man. The Chosen One fallen.',intro:'The breathing. Crimson ignites.'},
{id:'thrawn',name:'Grand Admiral Thrawn',cost:5,hp:150,atk:72,def:68,spd:6,emoji:'',faction:'Empire',special:'Tactical Genius',desc:'Brilliant strategist. Studies art to defeat enemies.',intro:'"I have foreseen this."'},
{id:'tarkin',name:'Grand Moff Tarkin',cost:5,hp:130,atk:65,def:70,spd:5,emoji:'',faction:'Empire',special:'Fear Will Keep Them',desc:'Rules through fear. Commands the Death Star.',intro:'"You may fire when ready."'},
{id:'snoke',name:'Supreme Leader Snoke',cost:5,hp:170,atk:88,def:75,spd:7,emoji:'',faction:'Sith',special:'Dark Influence',desc:'Master manipulator from the Unknown Regions.',intro:'Snoke probes your mind.'},
{id:'marchion',name:'Marchion Ro',cost:5,hp:185,atk:82,def:78,spd:7,emoji:'',faction:'Nihil',special:'Force Nullifier',desc:'Eye of the Nihil. Path engines counter Force users.',intro:'"The Republic will burn."'},
{id:'gideon',name:'Moff Gideon',cost:5,hp:200,atk:78,def:85,spd:5,emoji:'',faction:'Empire',special:'Darksaber Wielder',desc:'Tank with the Darksaber. Imperial Remnant leader.',intro:'The Darksaber hums with dark history.'},
{id:'jabba',name:'Jabba the Hutt',cost:5,hp:350,atk:40,def:60,spd:1,emoji:'',faction:'Hutt',special:'Bribery',desc:'Crime lord. Everyone has a price.',intro:'Jabba laughs. Credits flow.'},
{id:'malak',name:'Darth Malak',cost:5,hp:230,atk:86,def:82,spd:6,emoji:'',faction:'Sith',special:'Rage',desc:'Revan\'s fallen apprentice. Jaw replaced with metal.',intro:'Malak\'s mechanical jaw grinds.'},
{id:'bastila',name:'Bastila Shan',cost:5,hp:175,atk:82,def:80,spd:8,emoji:'',faction:'Jedi',special:'Battle Meditation',desc:'Can turn the tide of entire wars.',intro:'Bastila centers herself. The Force responds.'},
{id:'imperials',name:'200 Imperial Troopers',cost:5,hp:400,atk:75,def:65,spd:4,emoji:'',faction:'Empire',stack:true,qty:200,special:'Overwhelming Force',desc:'A full battalion of the Empire\'s finest.',intro:'The ground shakes with marching boots.'},
{id:'enfys',name:'Enfys Nest',cost:5,hp:165,atk:80,def:75,spd:8,emoji:'',faction:'Rebel',special:'Cloud-Rider',desc:'Marauder turned freedom fighter.',intro:'Enfys emerges from smoke and fire.'},
{id:'ultradroids',name:'4 B3 Ultra Battle Droids',cost:5,hp:280,atk:85,def:88,spd:3,emoji:'',faction:'Droid',stack:true,qty:4,special:'Heavy Assault',desc:'Massive siege droids with wrist rockets.',intro:'Ultra droids activate. Weapons hot.'},
{id:'hk47',name:'HK-47',cost:5,hp:190,atk:88,def:70,spd:7,emoji:'',faction:'Droid',special:'Assassination Protocol',desc:'"Meatbag" enthusiast. Built to kill.',intro:'"Statement: Shall I kill something for you, Master?"'},
{id:'faie',name:'Clone Commander Faie',cost:5,hp:180,atk:78,def:75,spd:6,emoji:'',faction:'Republic',special:'Leadership',desc:'Ruthless clone commander. Order 66 executor.',intro:'Commander Faie signals to advance.'},

// ============ $4 TIER - CHAMPIONS ============
{id:'mace',name:'Mace Windu',cost:4,hp:185,atk:86,def:82,spd:8,emoji:'',faction:'Jedi',special:'Vapaad',desc:'Aggressive combat master. Channels darkness.',intro:'Purple blade ignites.'},
{id:'quigon',name:'Qui-Gon Jinn',cost:4,hp:175,atk:80,def:78,spd:7,emoji:'',faction:'Jedi',special:'Living Force',desc:'Maverick Jedi. First to learn immortality.',intro:'"The ability to speak does not make you intelligent."'},
{id:'obiwan',name:'Obi-Wan Kenobi',cost:4,hp:180,atk:82,def:88,spd:7,emoji:'',faction:'Jedi',special:'Soresu Mastery',desc:'Defensive master. The negotiator.',intro:'"Hello there."'},
{id:'luke',name:'Luke Skywalker',cost:4,hp:175,atk:84,def:78,spd:8,emoji:'',faction:'Jedi',special:'New Hope',desc:'Son of the Chosen One.',intro:'Luke grips his saber.'},
{id:'ahsoka',name:'Ahsoka Tano',cost:4,hp:170,atk:85,def:76,spd:9,emoji:'',faction:'Jedi',special:'Dual Blades',desc:'Dual white sabers. No longer a Jedi.',intro:'White blades twirl.'},
{id:'rey',name:'Rey Skywalker',cost:4,hp:175,atk:83,def:77,spd:8,emoji:'',faction:'Jedi',special:'Dyad Power',desc:'All the Jedi. Palpatine\'s granddaughter.',intro:'"Be with me."'},
{id:'kylo',name:'Kylo Ren',cost:4,hp:185,atk:85,def:76,spd:7,emoji:'',faction:'Sith',special:'Rage',desc:'Conflicted heir. Vader\'s grandson.',intro:'Unstable blade crackles.'},
{id:'maul',name:'Darth Maul',cost:4,hp:180,atk:88,def:74,spd:9,emoji:'',faction:'Sith',special:'Savage Assault',desc:'Hatred incarnate. May betray allies.',intro:'Maul spins his staff.'},
{id:'cadbane',name:'Cad Bane',cost:4,hp:155,atk:84,def:68,spd:9,emoji:'',faction:'Bounty Hunter',special:'Quickdraw',desc:'Best bounty hunter in the galaxy.',intro:'"I\'ll take on any job... for the right price."'},
{id:'anakin',name:'Anakin Skywalker',cost:4,hp:190,atk:87,def:78,spd:8,emoji:'',faction:'Jedi',special:'Chosen One',desc:'Dangerous power. The Chosen One.',intro:'Anakin ignites his blade.'},
{id:'plokoon',name:'Plo Koon',cost:4,hp:170,atk:80,def:80,spd:7,emoji:'',faction:'Jedi',special:'Electric Judgment',desc:'Kel Dor master. Uses Force lightning for good.',intro:'Plo Koon adjusts his mask and ignites.'},
{id:'rancor',name:'Rancor',cost:4,hp:350,atk:90,def:50,spd:3,emoji:'',faction:'Beast',special:'Crush',desc:'Massive beast. Eats enemies whole.',intro:'The Rancor ROARS. The ground shakes.'},
{id:'torban',name:'Torban Buck',cost:4,hp:160,atk:65,def:75,spd:6,emoji:'',faction:'Jedi',special:'Force Healer',desc:'Jedi healer master. Taught padawans first aid.',intro:'Torban readies his healing touch.'},
{id:'saw',name:'Saw Gerrera',cost:4,hp:175,atk:82,def:70,spd:6,emoji:'',faction:'Rebel',special:'Extreme Tactics',desc:'Rebel extremist at his peak. No compromise.',intro:'"Save the rebellion! Save the dream!"'},
{id:'tiefighters',name:'TIE Fighter Squad',cost:4,hp:200,atk:80,def:55,spd:10,emoji:'',faction:'Empire',stack:true,qty:5,special:'Air Superiority',desc:'5 TIE fighters providing air support.',intro:'TIEs scream overhead.'},
{id:'ackbar',name:'Admiral Ackbar',cost:4,hp:145,atk:70,def:72,spd:6,emoji:'',faction:'Rebel',special:'Fleet Commander',desc:'Mon Calamari tactician. It\'s a trap expert.',intro:'"It\'s a trap!"'},

// ============ $3 TIER - VETERANS ============
{id:'grievous',name:'General Grievous',cost:3,hp:200,atk:82,def:78,spd:7,emoji:'',faction:'Separatist',special:'Four Arms',desc:'Four stolen sabers. Jedi killer.',intro:'Four blades ignite.'},
{id:'dooku',name:'Count Dooku',cost:3,hp:165,atk:84,def:75,spd:7,emoji:'',faction:'Sith',special:'Makashi',desc:'Elegant duelist. Former Jedi.',intro:'Dooku assumes his stance.'},
{id:'mara',name:'Mara Jade',cost:3,hp:160,atk:82,def:72,spd:8,emoji:'',faction:'Sith',special:'Emperor\'s Hand',desc:'Emperor\'s assassin. Deadly and beautiful.',intro:'Mara Jade emerges from shadow.'},
{id:'inquisitor',name:'Grand Inquisitor',cost:3,hp:175,atk:80,def:74,spd:7,emoji:'',faction:'Empire',special:'Spinning Blade',desc:'Jedi hunter. Double-bladed spinning saber.',intro:'The Inquisitor\'s blade begins to spin.'},
{id:'cal',name:'Cal Kestis',cost:3,hp:165,atk:78,def:72,spd:8,emoji:'',faction:'Jedi',special:'Psychometry',desc:'Survivor of Order 66. Armed with saber and blaster.',intro:'Cal grips his father\'s saber.'},
{id:'aayla',name:'Aayla Secura',cost:3,hp:160,atk:79,def:73,spd:8,emoji:'',faction:'Jedi',special:'Dual Blades',desc:'Twi\'lek Jedi Knight. Acrobatic fighter.',intro:'Aayla\'s blue blade twirls.'},
{id:'ventress',name:'Asajj Ventress',cost:3,hp:155,atk:80,def:70,spd:9,emoji:'',faction:'Sith',special:'Nightsister',desc:'Assassin turned bounty hunter.',intro:'Ventress crouches ready.'},
{id:'ezra',name:'Ezra Bridger',cost:3,hp:150,atk:75,def:68,spd:8,emoji:'',faction:'Jedi',special:'Street Smart',desc:'Lothal street kid. Lightsaber-blaster hybrid.',intro:'Ezra readies his unique weapon.'},
{id:'crosshair',name:'Crosshair',cost:3,hp:145,atk:85,def:60,spd:7,emoji:'',faction:'Empire',special:'Sniper',desc:'Bad Batch defector. Perfect aim.',intro:'Crosshair takes aim. One shot, one kill.'},
{id:'tactdroid',name:'ST Super Tactical Droid',cost:3,hp:160,atk:70,def:75,spd:6,emoji:'',faction:'Separatist',special:'Tactical Analysis',desc:'Almost as good as Thrawn. Battle strategist.',intro:'Calculating optimal strategy...'},
{id:'templeguards',name:'2 Jedi Temple Guards',cost:3,hp:200,atk:76,def:80,spd:6,emoji:'',faction:'Jedi',stack:true,qty:2,special:'Sentinel',desc:'Guardians of the Jedi Temple.',intro:'Yellow blades ignite in unison.'},
{id:'praetorians',name:'2 Praetorian Guards',cost:3,hp:190,atk:78,def:82,spd:6,emoji:'',faction:'Sith',stack:true,qty:2,special:'Elite Guard',desc:'Snoke\'s personal elite guards.',intro:'The Praetorians assume combat stance.'},
{id:'sion',name:'Darth Sion',cost:3,hp:250,atk:75,def:60,spd:4,emoji:'',faction:'Sith',special:'Pain Immortality',desc:'Lord of Pain. Cannot truly die.',intro:'Sion\'s broken body rises again.'},
{id:'spiderdroid',name:'OG-9 Spider Droid',cost:3,hp:220,atk:82,def:70,spd:4,emoji:'',faction:'Separatist',special:'Siege Mode',desc:'Massive homing spider droid. Heavy laser.',intro:'The spider droid targets acquired.'},
{id:'magnaguards',name:'2 Magna Guards',cost:3,hp:180,atk:75,def:78,spd:6,emoji:'',faction:'Separatist',stack:true,qty:2,special:'Electrostaff',desc:'Grievous\'s personal bodyguards.',intro:'Electrostaffs crackle to life.'},
{id:'savage',name:'Savage Opress',cost:3,hp:210,atk:82,def:72,spd:5,emoji:'',faction:'Sith',special:'Betrayal',desc:'Brutal warrior. Easily angered. May betray allies.',intro:'Savage roars, ready to kill anyone.'},

// ============ $2 TIER - WARRIORS ============
{id:'chewie',name:'Chewbacca',cost:2,hp:160,atk:74,def:72,spd:4,emoji:'',faction:'Rebel',special:'Wookiee Rage',desc:'200 years experience. Han\'s partner.',intro:'Chewbacca ROARS.'},
{id:'han',name:'Han Solo',cost:2,hp:130,atk:76,def:64,spd:8,emoji:'',faction:'Rebel',special:'Lucky Shot',desc:'Never tell me the odds.',intro:'"Never tell me the odds."'},
{id:'rex',name:'Captain Rex',cost:2,hp:140,atk:72,def:70,spd:6,emoji:'',faction:'Republic',special:'Leadership',desc:'501st Captain. Removed his chip.',intro:'Rex signals advance.'},
{id:'cody',name:'Commander Cody',cost:2,hp:140,atk:70,def:72,spd:6,emoji:'',faction:'Republic',special:'Leadership',desc:'212th Commander. Executed Order 66.',intro:'Cody readies his men.'},
{id:'ig11',name:'IG-11',cost:2,hp:155,atk:78,def:65,spd:7,emoji:'',faction:'Droid',special:'Self Destruct',desc:'Nurse droid turned warrior. Will self-destruct.',intro:'"I am not a hunter. I am a nurse droid."'},
{id:'jyn',name:'Jyn Erso',cost:2,hp:135,atk:73,def:68,spd:7,emoji:'',faction:'Rebel',special:'Rebellious Spirit',desc:'Rogue One leader. Stole Death Star plans.',intro:'"Rebellions are built on hope."'},
{id:'zeb',name:'Zeb Orrelios',cost:2,hp:165,atk:75,def:70,spd:5,emoji:'',faction:'Rebel',special:'Bo-Rifle',desc:'Lasat Honor Guard. Last of his kind.',intro:'Zeb grips his bo-rifle.'},
{id:'bokatan',name:'Bo-Katan Kryze',cost:2,hp:145,atk:74,def:73,spd:7,emoji:'',faction:'Mandalorian',special:'Death Watch',desc:'Mandalore\'s rightful ruler. Seeks the Darksaber.',intro:'Bo-Katan lands with purpose.'},
{id:'jango',name:'Jango Fett',cost:2,hp:140,atk:77,def:67,spd:8,emoji:'',faction:'Bounty Hunter',special:'Jetpack',desc:'Clone template. Boba\'s father.',intro:'Dual pistols clear leather.'},
{id:'mando',name:'Din Djarin',cost:2,hp:145,atk:74,def:75,spd:6,emoji:'',faction:'Mandalorian',special:'Beskar Armor',desc:'This is the way. Grogu\'s protector.',intro:'"This is the way."'},
{id:'grogu',name:'Grogu',cost:2,hp:100,atk:60,def:55,spd:5,emoji:'',faction:'Jedi',special:'Force Potential',desc:'Easily scared. Powerful in moments. Wildcard.',intro:'Grogu coos curiously.'},
{id:'sabine',name:'Sabine Wren',cost:2,hp:135,atk:76,def:65,spd:8,emoji:'',faction:'Mandalorian',special:'Explosives Expert',desc:'Artist and demolitions expert. Ghost crew.',intro:'Sabine primes her explosives.'},
{id:'paz',name:'Paz Vizsla',cost:2,hp:175,atk:78,def:80,spd:5,emoji:'',faction:'Mandalorian',special:'Heavy Repeater',desc:'Heaviest heavy. M-55 repeating blaster.',intro:'Paz\'s cannon spools up.'},
{id:'armorer',name:'The Armorer',cost:2,hp:150,atk:72,def:78,spd:6,emoji:'',faction:'Mandalorian',special:'Forge Master',desc:'Enhances allies\' armor and weapons.',intro:'The Armorer raises her hammer.'},
{id:'supercommandos',name:'2 Super Commandos',cost:2,hp:160,atk:72,def:74,spd:6,emoji:'',faction:'Empire',stack:true,qty:2,special:'Jetpack',desc:'Imperial Mandalorian soldiers.',intro:'Super Commandos descend from above.'},
{id:'jedipadawan',name:'Jedi Padawan',cost:2,hp:120,atk:65,def:60,spd:7,emoji:'',faction:'Jedi',special:'Learn',desc:'Learns from leader and allies. High potential.',intro:'The Padawan steadies their blade.'},
{id:'sithpadawan',name:'Sith Padawan',cost:2,hp:125,atk:68,def:58,spd:7,emoji:'',faction:'Sith',special:'Learn',desc:'Learns from leader and allies. Ambitious.',intro:'The acolyte hungers for power.'},

// ============ $1 TIER - SUPPORT ============
{id:'c3po',name:'C-3PO',cost:1,hp:70,atk:15,def:45,spd:2,emoji:'',faction:'Droid',special:'Protocol',desc:'6 million forms of communication.',intro:'"Oh my!"'},
{id:'r2d2',name:'R2-D2',cost:1,hp:85,atk:30,def:55,spd:4,emoji:'',faction:'Droid',special:'Repair',desc:'Astromech hero. Saves the day.',intro:'R2 beeps determinedly.'},
{id:'chopper',name:'Chopper',cost:1,hp:80,atk:40,def:50,spd:5,emoji:'',faction:'Droid',special:'Sabotage',desc:'Grumpy astromech. Ghost crew member.',intro:'Chopper grumbles angrily.'},
{id:'jarjar',name:'Jar Jar Binks',cost:1,hp:95,atk:40,def:40,spd:5,emoji:'',faction:'Gungan',special:'Chaos Factor',desc:'Lucky or Sith Lord? Nobody knows.',intro:'"Mesa ready!"'},
{id:'k2so',name:'K-2SO',cost:1,hp:120,atk:55,def:60,spd:5,emoji:'',faction:'Droid',special:'Blunt Analysis',desc:'Reprogrammed Imperial droid. Brutally honest.',intro:'"I find that answer vague and unconvincing."'},
{id:'padme',name:'Padm Amidala',cost:1,hp:100,atk:60,def:55,spd:6,emoji:'',faction:'Republic',special:'Diplomacy',desc:'Former Queen. Senator. Fighter.',intro:'Padm takes aim with her blaster.'},
{id:'finn',name:'Finn',cost:1,hp:115,atk:62,def:58,spd:6,emoji:'',faction:'Rebel',special:'Defector',desc:'FN-2187. Stormtrooper who chose freedom.',intro:'"I\'m not going back!"'},
{id:'phasma',name:'Captain Phasma',cost:1,hp:130,atk:65,def:68,spd:5,emoji:'',faction:'Empire',special:'Command',desc:'Chrome commander. Buffs Stormtroopers.',intro:'Chrome gleams.'},
{id:'fennec',name:'Fennec Shand',cost:1,hp:120,atk:72,def:58,spd:9,emoji:'',faction:'Bounty Hunter',special:'Sniper',desc:'Elite assassin. Master sniper.',intro:'Fennec takes aim.'},
{id:'boba',name:'Boba Fett',cost:1,hp:135,atk:70,def:68,spd:7,emoji:'',faction:'Bounty Hunter',special:'Jetpack',desc:'Most feared hunter. Survived the Sarlacc.',intro:'Jetpack ignites.'},
{id:'wicket',name:'Wicket',cost:1,hp:75,atk:45,def:40,spd:7,emoji:'',faction:'Rebel',special:'Ewok Tactics',desc:'Brave Ewok warrior. Small but fierce.',intro:'Wicket chatters excitedly.'},
{id:'bb8',name:'BB-8',cost:1,hp:65,atk:25,def:50,spd:8,emoji:'',faction:'Droid',special:'Repair',desc:'Loyal astromech. Poe\'s companion.',intro:'BB-8 beeps encouragingly.'},
{id:'sinube',name:'Tera Sinube',cost:1,hp:90,atk:45,def:60,spd:2,emoji:'',faction:'Jedi',special:'Mentor',desc:'Very slow but excellent teacher. Buffs younglings.',intro:'"Patience, young one."'},
{id:'droidekas',name:'2 Droidekas',cost:1,hp:160,atk:70,def:75,spd:3,emoji:'',faction:'Droid',special:'Shield',stack:true,qty:2,desc:'Destroyer droids with shields.',intro:'Droidekas roll out.'},
{id:'hux',name:'General Hux',cost:1,hp:90,atk:50,def:55,spd:5,emoji:'',faction:'Empire',special:'Rally',desc:'First Order commander. More bark than bite.',intro:'"This is where the end begins!"'},
{id:'greedo',name:'Greedo',cost:1,hp:100,atk:65,def:50,spd:8,emoji:'',faction:'Bounty Hunter',special:'First Shot',desc:'Always shoots first. Or does he?',intro:'"Going somewhere, Solo?"'},

// ============ $0.50 TIER - TROOPS ============
{id:'b1droids',name:'20 B1 Battle Droids',cost:0.5,hp:220,atk:52,def:42,spd:4,emoji:'',faction:'Droid',stack:true,qty:20,desc:'Roger roger. Expendable.',intro:'"Roger roger."'},
{id:'fostormtroopers',name:'10 First Order Stormtroopers',cost:0.5,hp:165,atk:58,def:52,spd:4,emoji:'',faction:'Empire',stack:true,qty:10,special:'Command Synergy',desc:'Better trained than Imperial troopers.',intro:'First Order troops take position.'},
{id:'stormtroopers',name:'10 Stormtroopers',cost:0.5,hp:160,atk:55,def:50,spd:4,emoji:'',faction:'Empire',stack:true,qty:10,special:'Command Synergy',desc:'Aim questionable. Powerful with leaders.',intro:'Stormtroopers position.'},
{id:'clonetroopers',name:'10 Clone Troopers',cost:0.5,hp:175,atk:60,def:55,spd:5,emoji:'',faction:'Republic',stack:true,qty:10,special:'Command Synergy',desc:'Perfect soldiers. Follow orders.',intro:'Clones form up.'},
{id:'rebeltroopers',name:'10 Rebel Troopers',cost:0.5,hp:150,atk:54,def:48,spd:5,emoji:'',faction:'Rebel',stack:true,qty:10,special:'Command Synergy',desc:'Hope soldiers. Fight for freedom.',intro:'Rebels ready.'},
{id:'wookies',name:'3 Wookiee Warriors',cost:0.5,hp:200,atk:70,def:65,spd:4,emoji:'',faction:'Rebel',stack:true,qty:3,special:'Wookiee Rage',desc:'Kashyyyk warriors. Powerful with Rebel leaders.',intro:'Wookiees ROAR.'},
{id:'arcs',name:'3 ARC Troopers',cost:0.5,hp:180,atk:74,def:70,spd:6,emoji:'',faction:'Republic',stack:true,qty:3,desc:'Elite clone commandos. The best.',intro:'ARCs move out.'},
{id:'gungans',name:'5 Gungan Swordsmen',cost:0.5,hp:140,atk:55,def:50,spd:5,emoji:'',faction:'Gungan',stack:true,qty:5,special:'Shield Wall',desc:'Powerful with Gungan leaders.',intro:'Gungans ready their boomas.'},
{id:'ewoks',name:'5 Ewok Spearmen',cost:0.5,hp:120,atk:48,def:45,spd:6,emoji:'',faction:'Rebel',stack:true,qty:5,special:'Forest Ambush',desc:'Murder bears. Great in forests.',intro:'Ewoks screech.'},
{id:'mandorifles',name:'2 Mandalorian Riflemen',cost:0.5,hp:130,atk:72,def:60,spd:6,emoji:'',faction:'Mandalorian',stack:true,qty:2,special:'Jetpack',desc:'Snipers with jetpacks.',intro:'Mandalorians take aim from above.'},
{id:'jawas',name:'5 Jawas',cost:0.5,hp:80,atk:35,def:40,spd:7,emoji:'',faction:'Jawa',stack:true,qty:5,special:'Scavenge',desc:'Set traps. Find upgrades. Sneaky.',intro:'"Utinni!"'},
{id:'scouttroopers',name:'3 Scout Troopers',cost:0.5,hp:120,atk:62,def:48,spd:7,emoji:'',faction:'Empire',stack:true,qty:3,special:'Command Synergy',desc:'Fast reconnaissance. Speeder bikes.',intro:'Scouts fan out.'},
{id:'medics',name:'2 Clone Medics',cost:0.5,hp:110,atk:45,def:50,spd:5,emoji:'',faction:'Republic',stack:true,qty:2,special:'Heal',desc:'Prioritize lowest cost units first.',intro:'Medics ready bacta.'},
{id:'mortartroopers',name:'3 Mortar Stormtroopers',cost:0.5,hp:130,atk:68,def:45,spd:4,emoji:'',faction:'Empire',stack:true,qty:3,special:'Artillery',desc:'Heavy weapons specialists.',intro:'Mortars lock on target.'},
{id:'youngling',name:'Jedi Youngling',cost:0.5,hp:60,atk:35,def:35,spd:6,emoji:'',faction:'Jedi',special:'Potential',desc:'Better paired with Tera Sinube.',intro:'The youngling grips their training saber.'},
{id:'nihilmarauders',name:'5 Nihil Marauders',cost:0.5,hp:135,atk:60,def:45,spd:6,emoji:'',faction:'Nihil',stack:true,qty:5,special:'Pirate Synergy',desc:'Space pirates. Strong with Nihil leaders.',intro:'"The storm is coming!"'},
];

const BATTLEFIELDS=[
// Each battlefield has: name, image, music (settings for procedural music), hazards, terrain effects, and NPCs
{name:'Mustafar - Rivers of Fire',image:'mustafar',emoji:'',
  music:{tempo:140,key:'minor',bass:80,intensity:0.9,style:'aggressive'},
  hazards:['Lava Geyser','Platform Collapse'],
  terrain:{type:'lava',effect:'burn',desc:' Lava terrain: Front line takes 5 damage/round from heat'},
  npcs:[{name:'Mining Droid',emoji:'',hp:60,atk:30,def:20,hostile:false,chance:0.15,msg:'A damaged mining droid offers assistance!',buff:{hp:20}},
        {name:'Lava Flea',emoji:'',hp:80,atk:45,def:15,hostile:true,chance:0.2,msg:'A LAVA FLEA attacks from the magma!'}]},
{name:'Geonosis - Arena of Death',image:'geonosis',emoji:'',
  music:{tempo:130,key:'minor',bass:100,intensity:0.85,style:'tribal'},
  hazards:['Arena Beast','Sandstorm'],
  terrain:{type:'sand',effect:'slow',desc:' Sand terrain: -10% DEF for all (sand in joints)'},
  npcs:[{name:'Reek',emoji:'',hp:150,atk:55,def:30,hostile:true,chance:0.25,msg:'A REEK charges into the battle!'},
        {name:'Acklay',emoji:'',hp:180,atk:65,def:25,hostile:true,chance:0.15,msg:'An ACKLAY screeches and attacks!'},
        {name:'Nexu',emoji:'',hp:100,atk:70,def:20,hostile:true,chance:0.2,msg:'A NEXU pounces from the shadows!'}]},
{name:'Hoth - Frozen Wasteland',image:'hoth',emoji:'',
  music:{tempo:100,key:'minor',bass:60,intensity:0.6,style:'cold'},
  hazards:['Wampa Attack','Blizzard'],
  terrain:{type:'ice',effect:'cold',desc:' Ice terrain: 15% chance to slip and miss attacks'},
  npcs:[{name:'Wampa',emoji:'',hp:200,atk:60,def:35,hostile:true,chance:0.2,msg:'A WAMPA emerges from the blizzard!'},
        {name:'Tauntaun',emoji:'',hp:80,atk:20,def:25,hostile:false,chance:0.15,msg:'A tauntaun provides warmth!',buff:{def:10}}]},
{name:'Coruscant Undercity',image:'coruscant',emoji:'',
  music:{tempo:120,key:'minor',bass:90,intensity:0.7,style:'urban'},
  hazards:['Gang Ambush','Collapse'],
  terrain:{type:'urban',effect:'cover',desc:' Urban terrain: Back line gets +15% DEF (cover)'},
  npcs:[{name:'Death Stick Dealer',emoji:'',hp:40,atk:15,def:10,hostile:false,chance:0.2,msg:'A dealer offers "enhancements"...',buff:{atk:15,def:-10}},
        {name:'Coruscant Guard',emoji:'',hp:120,atk:50,def:45,hostile:false,chance:0.1,msg:'Coruscant Guard investigates the disturbance.',ally:true},
        {name:'Gang Members',emoji:'',hp:100,atk:55,def:30,hostile:true,chance:0.25,msg:'A local gang attacks both sides!'}]},
{name:'Death Star - Trash Compactor',image:'deathstar',emoji:'',
  music:{tempo:110,key:'minor',bass:120,intensity:0.75,style:'imperial'},
  hazards:['Walls Closing','Dianoga Attack'],
  terrain:{type:'compactor',effect:'crush',desc:' Compactor: All units lose 10 HP/round as walls close'},
  npcs:[{name:'Dianoga',emoji:'',hp:120,atk:40,def:50,hostile:true,chance:0.3,msg:'The DIANOGA rises from the murky water!'},
        {name:'Mouse Droid',emoji:'',hp:20,atk:5,def:5,hostile:false,chance:0.2,msg:'A mouse droid beeps helpfully!',buff:{def:5}}]},
{name:'Dagobah - Swamp of Mystery',image:'dagobah',emoji:'',
  music:{tempo:70,key:'major',bass:50,intensity:0.4,style:'mystical'},
  hazards:['Swamp Gas','Dragonsnake'],
  terrain:{type:'swamp',effect:'force',desc:' Force Nexus: Force users get +20% ability chance'},
  npcs:[{name:'Dragonsnake',emoji:'',hp:140,atk:50,def:20,hostile:true,chance:0.2,msg:'A DRAGONSNAKE bursts from the swamp!'},
        {name:'Force Ghost',emoji:'',hp:1,atk:0,def:999,hostile:false,chance:0.1,msg:'A Force Ghost offers wisdom...',buff:{atk:10,def:10}}]},
{name:'Tatooine - Dune Sea',image:'tatooine',emoji:'',
  music:{tempo:90,key:'minor',bass:70,intensity:0.5,style:'desert'},
  hazards:['Sandstorm','Tusken Raid'],
  terrain:{type:'desert',effect:'heat',desc:' Desert heat: Units without armor lose 5 HP/round'},
  npcs:[{name:'Tusken Raiders',emoji:'',hp:130,atk:55,def:40,hostile:true,chance:0.25,msg:'TUSKEN RAIDERS attack the intruders!'},
        {name:'Krayt Dragon',emoji:'',hp:300,atk:80,def:50,hostile:true,chance:0.05,msg:'A KRAYT DRAGON emerges! RUN!'},
        {name:'Jawa Traders',emoji:'',hp:50,atk:10,def:15,hostile:false,chance:0.2,msg:'Jawas offer equipment repairs!',buff:{hp:25}}]},
{name:'Endor - Forest Moon',image:'endor',emoji:'',
  music:{tempo:95,key:'major',bass:55,intensity:0.55,style:'forest'},
  hazards:['Log Trap','Scout Walker'],
  terrain:{type:'forest',effect:'ambush',desc:' Forest: First attacker each round gets +25% damage'},
  npcs:[{name:'Ewok Tribe',emoji:'',hp:80,atk:35,def:25,hostile:false,chance:0.3,msg:'Ewoks emerge to help the Rebels!',ally:true,faction:'Rebel'},
        {name:'Wild Boar',emoji:'',hp:90,atk:45,def:20,hostile:true,chance:0.15,msg:'A wild boar charges blindly!'}]},
{name:'Kamino - Stormy Platform',image:'kamino',emoji:'',
  music:{tempo:105,key:'minor',bass:85,intensity:0.65,style:'storm'},
  hazards:['Lightning Strike','Wave Surge'],
  terrain:{type:'rain',effect:'electric',desc:' Storm: Lightning attacks deal +30% damage'},
  npcs:[{name:'Aiwha',emoji:'',hp:100,atk:30,def:40,hostile:false,chance:0.15,msg:'An aiwha offers aerial transport!',buff:{def:15}},
        {name:'Kaminoan Scientist',emoji:'',hp:30,atk:5,def:10,hostile:false,chance:0.1,msg:'A scientist provides medical aid!',buff:{hp:40}}]},
{name:'Naboo - Theed Palace',image:'naboo',emoji:'',
  music:{tempo:85,key:'major',bass:45,intensity:0.45,style:'elegant'},
  hazards:['Droid Patrol','Palace Guard'],
  terrain:{type:'palace',effect:'elegant',desc:' Royal grounds: Makashi and Protocol abilities +50% effective'},
  npcs:[{name:'Battle Droids',emoji:'',hp:100,atk:40,def:30,hostile:true,chance:0.2,msg:'Roger roger! Battle droids engage!'},
        {name:'Gungan Warrior',emoji:'',hp:90,atk:45,def:35,hostile:false,chance:0.15,msg:'A Gungan warrior joins the fight!',ally:true}]},
{name:'Jakku - Starship Graveyard',image:'jakku',emoji:'',
  music:{tempo:100,key:'minor',bass:75,intensity:0.6,style:'desolate'},
  hazards:['Unstable Wreckage','Scavenger Trap'],
  terrain:{type:'scrap',effect:'salvage',desc:' Scrap field: Equipment effects +25% stronger'},
  npcs:[{name:'Scavenger Gang',emoji:'',hp:110,atk:50,def:35,hostile:true,chance:0.2,msg:'Scavengers want your gear!'},
        {name:'Happabore',emoji:'',hp:180,atk:25,def:60,hostile:false,chance:0.1,msg:'A happabore plods through, blocking attacks!',buff:{def:20}}]},
{name:'Exegol - Sith Throne',image:'exegol',emoji:'',
  music:{tempo:150,key:'minor',bass:130,intensity:1.0,style:'dark'},
  hazards:['Force Storm','Sith Cultists'],
  terrain:{type:'dark',effect:'darkside',desc:' Dark Side nexus: Sith get +25% all stats, Jedi get -15%'},
  npcs:[{name:'Sith Eternal Cultists',emoji:'',hp:150,atk:45,def:40,hostile:true,chance:0.25,msg:'Sith cultists rise to defend Exegol!'},
        {name:'Sith Trooper Squad',emoji:'',hp:180,atk:60,def:50,hostile:true,chance:0.15,msg:'Sith Troopers open fire!'}]},
];

// EQUIPMENT SYSTEM
const EQUIPMENT={
// Weapons
'Lightsaber Crystal (Kyber)':{cost:1,type:'weapon',emoji:'',stats:{atk:10},desc:'+10 ATK. Pure kyber crystal.'},
'Darksaber':{cost:2,type:'weapon',emoji:'',stats:{atk:15,def:5},desc:'+15 ATK, +5 DEF. Symbol of Mandalore.'},
'Beskar Spear':{cost:1.5,type:'weapon',emoji:'',stats:{atk:12},special:'armorPierce',desc:'+12 ATK. Ignores 50% armor.'},
'E-11 Blaster Rifle':{cost:0.5,type:'weapon',emoji:'',stats:{atk:8},desc:'+8 ATK. Standard issue.'},
'Bowcaster':{cost:1,type:'weapon',emoji:'',stats:{atk:14,def:-5},desc:'+14 ATK, -5 DEF. Powerful but heavy.'},
'Electrostaff':{cost:1,type:'weapon',emoji:'',stats:{atk:10},special:'antiForce',desc:'+10 ATK. +25% vs Force users.'},
// Armor
'Beskar Armor':{cost:2,type:'armor',emoji:'',stats:{def:20,hp:20},desc:'+20 DEF, +20 HP. Mandalorian steel.'},
'Clone Trooper Armor':{cost:0.5,type:'armor',emoji:'',stats:{def:8,hp:15},desc:'+8 DEF, +15 HP.'},
'Sith Robes':{cost:1,type:'armor',emoji:'',stats:{atk:8,def:5},desc:'+8 ATK, +5 DEF. Dark side enhanced.'},
'Jedi Robes':{cost:1,type:'armor',emoji:'',stats:{def:10},special:'forceBoost',desc:'+10 DEF. +15% Force ability chance.'},
'Stormtrooper Armor':{cost:0.5,type:'armor',emoji:'',stats:{def:10,hp:10,atk:-5},desc:'+10 DEF, +10 HP, -5 ATK.'},
// Accessories
'Jetpack':{cost:1,type:'accessory',emoji:'',stats:{},special:'extraEvasion',desc:'+20% evasion chance.'},
'Holocron':{cost:1.5,type:'accessory',emoji:'',stats:{atk:5,def:5},special:'abilityBoost',desc:'+5 ATK/DEF. +20% ability trigger.'},
'Bacta Tank':{cost:1,type:'accessory',emoji:'',stats:{hp:30},special:'regen',desc:'+30 HP. Heal 10 HP/round.'},
'Thermal Detonator':{cost:0.5,type:'accessory',emoji:'',stats:{},special:'detonator',desc:'On death: 40 damage to all enemies.'},
'Shield Generator':{cost:1,type:'accessory',emoji:'',stats:{def:5},special:'personalShield',desc:'+5 DEF. Start with 30 shield.'},
'Mandalorian Vambrace':{cost:1,type:'accessory',emoji:'',stats:{atk:5,def:5},special:'flamethrower',desc:'+5 ATK/DEF. 20% chance: 25 AoE damage.'},
};

// UNIT VARIANTS/SKINS
const VARIANTS={
// Format: unitId: [{id, name, portrait, mods:{hp,atk,def}, cost (modifier), desc}]
// Cost: positive = more expensive, negative = cheaper (in $0.25 increments)
'vader':[
  {id:'base',name:'Sith Lord',portrait:'vader',mods:{},cost:0,desc:'Classic armored Dark Lord.'},
  {id:'ani',name:'Newly Fallen',portrait:'vader-fallen',mods:{atk:10,def:-10,hp:-20},cost:-0.25,desc:'Fresh from Mustafar. Burning with rage.'},
  {id:'suit',name:'Battle-Scarred',portrait:'vader-damaged',mods:{atk:-5,def:15,hp:30},cost:0.5,desc:'Rebuilt after Kenobi rematch.'},
],
'luke':[
  {id:'base',name:'Rebel Hero',portrait:'luke',mods:{},cost:0,desc:'Yavin medal ceremony era.'},
  {id:'farm',name:'Tatooine Farmboy',portrait:'luke-farm',mods:{atk:-15,def:-10,hp:-20},cost:-0.5,desc:'Before the adventure began.'},
  {id:'jedi',name:'Jedi Knight',portrait:'luke-jedi',mods:{atk:15,def:10,hp:10},cost:0.5,desc:'ROTJ black robes. Fully trained.'},
  {id:'dark',name:'Dark Emperor',portrait:'luke-dark',mods:{atk:25,def:-5},cost:0.25,desc:'Dark Empire comics. Fallen to darkness.'},
],
'obiwan':[
  {id:'base',name:'Jedi Master',portrait:'obiwan',mods:{},cost:0,desc:'ROTS era. Council member.'},
  {id:'padawan',name:'Young Padawan',portrait:'obiwan-young',mods:{atk:-10,def:-5,hp:-15},cost:-0.5,desc:'TPM era. Qui-Gon\'s apprentice.'},
  {id:'clone',name:'Clone Wars General',portrait:'obiwan-clone',mods:{atk:10,def:5},cost:0.25,desc:'Armored Jedi General at his peak.'},
  {id:'old',name:'Old Ben',portrait:'obiwan-old',mods:{atk:-5,def:15,hp:-10},cost:0,desc:'ANH era. Desert hermit.'},
],
'palpatine':[
  {id:'base',name:'Galactic Emperor',portrait:'palpatine',mods:{},cost:0,desc:'Ruler of the Empire.'},
  {id:'senator',name:'Senator Sheev',portrait:'palpatine-senator',mods:{atk:-20,def:10},cost:-0.25,desc:'Hiding in plain sight.'},
  {id:'clone',name:'Exegol Clone',portrait:'palpatine-clone',mods:{atk:5,hp:-30,def:-10},cost:-0.5,desc:'Decayed but powerful.'},
],
'anakin':[
  {id:'base',name:'Jedi Knight',portrait:'anakin',mods:{},cost:0,desc:'Hero With No Fear.'},
  {id:'padawan',name:'Brash Padawan',portrait:'anakin-young',mods:{atk:-10,def:-5,hp:-20},cost:-0.5,desc:'AOTC era. Reckless youth.'},
  {id:'general',name:'The Hero',portrait:'anakin-general',mods:{atk:12,def:8},cost:0.25,desc:'Clone Wars General. Peak power.'},
  {id:'dark',name:'Sith Eyes',portrait:'anakin-dark',mods:{atk:20,def:-15,hp:10},cost:0.25,desc:'Moments before becoming Vader.'},
],
'ahsoka':[
  {id:'base',name:'Jedi Commander',portrait:'ahsoka',mods:{},cost:0,desc:'Clone Wars veteran.'},
  {id:'padawan',name:'Snippy Padawan',portrait:'ahsoka-young',mods:{atk:-8,def:-5,hp:-15},cost:-0.5,desc:'Early Clone Wars. Still learning.'},
  {id:'rebel',name:'Fulcrum Agent',portrait:'ahsoka-fulcrum',mods:{atk:8,def:10},cost:0.25,desc:'Rebels era. Intel operative.'},
  {id:'white',name:'White Sabers',portrait:'ahsoka-white',mods:{atk:12,def:12,hp:15},cost:0.5,desc:'Purified kyber crystals. Mando era.'},
],
'maul':[
  {id:'base',name:'Sith Assassin',portrait:'maul',mods:{},cost:0,desc:'TPM. Sidious\' weapon.'},
  {id:'apprentice',name:'Shadow Apprentice',portrait:'maul-young',mods:{atk:5,def:-10},cost:-0.25,desc:'Training on Dathomir.'},
  {id:'spider',name:'Spider-Legged',portrait:'maul-spider',mods:{atk:-5,hp:40,def:-15},cost:0.25,desc:'Mad with vengeance. Clone Wars.'},
  {id:'crimson',name:'Crime Lord',portrait:'maul-crimson',mods:{atk:8,def:8},cost:0.25,desc:'Crimson Dawn leader. Solo era.'},
],
'boba':[
  {id:'base',name:'Bounty Hunter',portrait:'boba',mods:{},cost:0,desc:'OT era. Best in the galaxy.'},
  {id:'kid',name:'Clone Child',portrait:'boba-young',mods:{atk:-15,def:-10,hp:-20},cost:-0.5,desc:'AOTC era. Jango\'s son.'},
  {id:'sarlacc',name:'Sarlacc Survivor',portrait:'boba-scarred',mods:{atk:5,def:-5,hp:-10},cost:-0.25,desc:'Escaped the pit. Battle-worn.'},
  {id:'daimyo',name:'Daimyo of Tatooine',portrait:'boba-daimyo',mods:{def:15,hp:20,atk:-5},cost:0.5,desc:'Ruling Jabba\'s empire.'},
],
'mando':[
  {id:'base',name:'The Mandalorian',portrait:'mando',mods:{},cost:0,desc:'This is the Way.'},
  {id:'foundling',name:'Death Watch Foundling',portrait:'mando-young',mods:{atk:-20,def:-15,hp:-25},cost:-0.5,desc:'Childhood rescue.'},
  {id:'full',name:'Pure Beskar',portrait:'mando-beskar',mods:{def:20,hp:15},cost:0.5,desc:'Fully upgraded armor.'},
],
'yoda':[
  {id:'base',name:'Grand Master',portrait:'yoda',mods:{},cost:0,desc:'900 years of wisdom.'},
  {id:'young',name:'Prime Warrior',portrait:'yoda-young',mods:{atk:10,def:5,hp:20},cost:0.5,desc:'At his physical peak.'},
  {id:'exile',name:'Dagobah Hermit',portrait:'yoda-exile',mods:{atk:-10,def:15,hp:-15},cost:-0.25,desc:'ESB era. In hiding.'},
],
'han':[
  {id:'base',name:'Scruffy Smuggler',portrait:'han',mods:{},cost:0,desc:'ANH era. Cocky pilot.'},
  {id:'young',name:'Corellia Scrumrat',portrait:'han-young',mods:{atk:5,def:-10},cost:-0.25,desc:'Solo movie era.'},
  {id:'general',name:'Rebel General',portrait:'han-general',mods:{def:10,hp:10},cost:0.25,desc:'Endor strike team leader.'},
  {id:'old',name:'Retired Legend',portrait:'han-old',mods:{atk:-5,def:5},cost:0,desc:'TFA era. Still got it.'},
],
'kylo':[
  {id:'base',name:'Vader\'s Heir',portrait:'kylo',mods:{},cost:0,desc:'Master of the Knights of Ren.'},
  {id:'ben',name:'Redeemed Ben',portrait:'kylo-ben',mods:{atk:-10,def:5,hp:10},cost:0,desc:'Returned to the light.'},
  {id:'supreme',name:'Supreme Leader',portrait:'kylo-supreme',mods:{atk:15,def:10},cost:0.5,desc:'Ruling the First Order.'},
],
'grievous':[
  {id:'base',name:'Jedi Hunter',portrait:'grievous',mods:{},cost:0,desc:'CW era. Lightsaber collector.'},
  {id:'kaleesh',name:'Kaleesh Warlord',portrait:'grievous-kaleesh',mods:{atk:-15,def:-20,hp:30},cost:-0.25,desc:'Before the cyborg conversion.'},
  {id:'full',name:'Four-Armed Fury',portrait:'grievous-4arms',mods:{atk:20,def:-10},cost:0.25,desc:'All four sabers ignited.'},
],
// NEW CHARACTER VARIANTS
'revan':[
  {id:'base',name:'Sith Lord',portrait:'revan',mods:{},cost:0,desc:'The Prodigal Knight fallen.'},
  {id:'jedi',name:'Redeemed Jedi',portrait:'revan-jedi',mods:{atk:-5,def:10,hp:10},cost:0.25,desc:'Returned to the light.'},
  {id:'prime',name:'Peak Power',portrait:'revan-prime',mods:{atk:10,def:5},cost:0.5,desc:'Master of both sides.'},
],
'starkiller':[
  {id:'base',name:'Secret Apprentice',portrait:'starkiller',mods:{},cost:0,desc:'Vader\'s hidden weapon.'},
  {id:'light',name:'Redeemed',portrait:'starkiller-light',mods:{atk:-5,def:10,hp:15},cost:0.25,desc:'Chose to save the Rebels.'},
  {id:'dark',name:'Sith Stalker',portrait:'starkiller-dark',mods:{atk:15,def:-10},cost:0.5,desc:'Embraced the darkness fully.'},
],
'rey':[
  {id:'base',name:'Scavenger',portrait:'rey',mods:{},cost:0,desc:'Jakku survivor.'},
  {id:'jedi',name:'Jedi',portrait:'rey-jedi',mods:{atk:10,def:5},cost:0.25,desc:'Trained by Luke and Leia.'},
  {id:'palpatine',name:'Dark Rey',portrait:'rey-dark',mods:{atk:20,def:-10,hp:-10},cost:0.25,desc:'Embraced her lineage.'},
  {id:'skywalker',name:'All the Jedi',portrait:'rey-skywalker',mods:{atk:15,def:15,hp:10},cost:0.5,desc:'Channeling every Jedi.'},
],
'cal':[
  {id:'base',name:'Padawan Survivor',portrait:'cal',mods:{},cost:0,desc:'Order 66 survivor.'},
  {id:'knight',name:'Jedi Knight',portrait:'cal-knight',mods:{atk:10,def:8},cost:0.25,desc:'Fully trained by Cere.'},
  {id:'dark',name:'Dark Cal',portrait:'cal-dark',mods:{atk:15,def:-5},cost:0.25,desc:'Fallen to Dathomir\'s influence.'},
],
'dooku':[
  {id:'base',name:'Sith Lord',portrait:'dooku',mods:{},cost:0,desc:'Count of Serenno.'},
  {id:'jedi',name:'Jedi Master',portrait:'dooku-jedi',mods:{atk:-5,def:10,hp:5},cost:0,desc:'Before leaving the Order.'},
  {id:'apprentice',name:'Darth Tyranus',portrait:'dooku-tyranus',mods:{atk:10,def:5},cost:0.25,desc:'Sidious\'s right hand.'},
],
'thrawn':[
  {id:'base',name:'Grand Admiral',portrait:'thrawn',mods:{},cost:0,desc:'Imperial Navy genius.'},
  {id:'exile',name:'Exiled Commander',portrait:'thrawn-exile',mods:{atk:-5,def:5,hp:10},cost:0,desc:'After Lothal defeat.'},
  {id:'ascendancy',name:'Chiss Ascendancy',portrait:'thrawn-chiss',mods:{atk:5,def:10},cost:0.25,desc:'With Chiss support.'},
],
'rex':[
  {id:'base',name:'Captain Rex',portrait:'rex',mods:{},cost:0,desc:'501st commander.'},
  {id:'arc',name:'ARC Trooper',portrait:'rex-arc',mods:{atk:10,def:5},cost:0.25,desc:'Elite training complete.'},
  {id:'rebel',name:'Rebel Veteran',portrait:'rex-rebel',mods:{atk:-5,def:10,hp:5},cost:0,desc:'Endor era. Still fighting.'},
],
'mace':[
  {id:'base',name:'Jedi Master',portrait:'mace',mods:{},cost:0,desc:'Vapaad master.'},
  {id:'council',name:'High Council',portrait:'mace-council',mods:{def:10,hp:10},cost:0.25,desc:'Leading the Jedi Order.'},
  {id:'fallen',name:'Window Survivor',portrait:'mace-fallen',mods:{atk:15,def:-10,hp:-30},cost:-0.25,desc:'Survived Sidious. Seeking revenge.'},
],
'quigon':[
  {id:'base',name:'Maverick Master',portrait:'quigon',mods:{},cost:0,desc:'Living Force adherent.'},
  {id:'young',name:'Knight',portrait:'quigon-young',mods:{atk:5,def:-5},cost:0,desc:'Before taking Obi-Wan.'},
  {id:'ghost',name:'Force Ghost',portrait:'quigon-ghost',mods:{atk:-20,def:50,hp:-50},cost:-0.25,desc:'First to return.'},
],
'jango':[
  {id:'base',name:'Prime Hunter',portrait:'jango',mods:{},cost:0,desc:'Clone template.'},
  {id:'young',name:'True Mandalore',portrait:'jango-young',mods:{atk:5,def:5},cost:0.25,desc:'Jaster\'s legacy bearer.'},
],
'ventress':[
  {id:'base',name:'Sith Assassin',portrait:'ventress',mods:{},cost:0,desc:'Dooku\'s apprentice.'},
  {id:'nightsister',name:'Nightsister Witch',portrait:'ventress-witch',mods:{atk:5,def:-5,hp:10},cost:0.25,desc:'Returned to Dathomir.'},
  {id:'bounty',name:'Bounty Hunter',portrait:'ventress-bounty',mods:{atk:-5,def:10},cost:0,desc:'After leaving the Sith.'},
],
'grogu':[
  {id:'base',name:'The Child',portrait:'grogu',mods:{},cost:0,desc:'Mysterious foundling.'},
  {id:'jedi',name:'Padawan',portrait:'grogu-jedi',mods:{atk:10,def:5,hp:10},cost:0.5,desc:'Training with Luke.'},
  {id:'armor',name:'Beskar Protected',portrait:'grogu-armor',mods:{def:20,hp:15},cost:0.5,desc:'Armorer\'s gift.'},
],
'bokatan':[
  {id:'base',name:'Mandalore Heir',portrait:'bokatan',mods:{},cost:0,desc:'Death Watch lieutenant.'},
  {id:'ruler',name:'Mand\'alor',portrait:'bokatan-ruler',mods:{atk:5,def:10,hp:10},cost:0.5,desc:'With the Darksaber.'},
],
'ezra':[
  {id:'base',name:'Street Kid',portrait:'ezra',mods:{},cost:0,desc:'Lothal orphan.'},
  {id:'jedi',name:'Jedi Padawan',portrait:'ezra-jedi',mods:{atk:8,def:5},cost:0.25,desc:'Trained by Kanan.'},
  {id:'exile',name:'Purrgil Exile',portrait:'ezra-exile',mods:{atk:5,def:10,hp:10},cost:0.25,desc:'After Lothal liberation.'},
],
};

// ============================================
// CINEMATIC BATTLE NARRATION SYSTEM
// ============================================
const GORE={
  // Basic attack descriptions by damage type
  slash:['carves through flesh','slashes deep','cleaves armor','rends through','tears into','gashes open'],
  shoot:['blasts a hole through','scorches flesh','punctures','riddles with bolts','burns through'],
  death:['collapses bleeding','crumples lifeless','falls gurgling','drops in a heap','slumps to the ground'],
  
  // Lightsaber-specific attacks (used for Jedi/Sith)
  saber:[
    'drives the blade through',
    'cleaves through with a sizzling arc',
    'buries the saber to the hilt in',
    'severs limbs from',
    'carves a burning wound across',
    'plunges the humming blade into',
    'bisects with a single stroke',
    'leaves a cauterized gash across'
  ],
  
  // Blaster attacks
  blaster:[
    'sends a bolt searing through',
    'punches a smoking hole in',
    'scorches the armor of',
    'lands a direct hit on',
    'peppers with blaster fire',
    'catches with a well-aimed shot'
  ],
  
  // Melee/physical attacks
  melee:[
    'slams a crushing blow into',
    'batters with brutal force',
    'smashes into',
    'delivers a devastating strike to',
    'hammers down upon',
    'tears into with raw strength'
  ],
  
  // Critical hit descriptions
  critical:[
    'DEVASTATING BLOW! Blood sprays as',
    'BRUTAL STRIKE! Bone crunches as',
    'VICIOUS HIT! Flesh tears as',
    'SAVAGE ATTACK! Armor shatters as',
    'MERCILESS BLOW! Gore splatters as'
  ],
  
  // Kill descriptions by method
  killSaber:[
    'The blade burns through vital organs. Steam rises from the wound as life fades.',
    'A single, precise thrust ends it. The body slides off the blade, smoking.',
    'The saber carves clean through. Two halves hit the ground separately.',
    'Lifted off the ground by the blade, gasping once before going still.',
    'The killing stroke leaves a cauterized hole where a heart once beat.'
  ],
  
  killBlaster:[
    'The bolt tears through the skull. Brain matter sizzles on the back wall.',
    'Multiple shots stitch across the chest. Each impact jerks the body backward.',
    'A point-blank shot to the face. The helmet caves inward.',
    'The killing bolt punches through the heart. Death is instant.',
    'Blaster fire rips through flesh and bone, leaving a smoking corpse.'
  ],
  
  killMelee:[
    'Bones shatter under the final blow. The body crumples, broken.',
    'A massive strike caves in the skull. Blood pools rapidly.',
    'Grabbed and torn apart with inhuman strength.',
    'The killing blow sends teeth scattering across the battlefield.',
    'Slammed into the ground with such force the earth cracks.'
  ],
  
  // Environmental/special deaths
  killSpecial:[
    'Consumed by dark energy, the body withers to a husk.',
    'Lightning arcs through every nerve ending. The screaming stops.',
    'Force-crushed, organs rupturing internally. Blood seeps from every orifice.',
    'Thrown against wreckage with spine-shattering force.',
    'The life force is drained completely, leaving an empty shell.'
  ],
  
  // Heroic sacrifice lines
  sacrifice:[
    'standing defiant to the end',
    'buying precious time for allies',
    'holding the line with their last breath',
    'refusing to yield even as death claimed them',
    'falling as a warrior, never as a coward'
  ],
  
  // Character-specific rivalries (always triggers if these pairs fight)
  rivalries:{
    'vader-obiwan': ['We meet again, at last.', 'I was but the learner...'],
    'vader-luke': ['Join me, and together we can rule the galaxy!', 'I am your father.'],
    'vader-ahsoka': ['I won\'t leave you! Not this time.', 'Then you will die.'],
    'obiwan-anakin': ['You were the Chosen One!', 'You were my brother, Anakin!'],
    'obiwan-maul': ['Look what has become of you.', 'Look what I have risen above.'],
    'palpatine-yoda': ['At last, the Jedi are no more.', 'Not if anything to say about it, I have!'],
    'palpatine-mace': ['I am the Senate!', 'Not yet.'],
    'luke-palpatine': ['Your overconfidence is your weakness.', 'Your faith in your friends is yours!'],
    'han-boba': ['Boba Fett? Where?!', 'He\'s worth more to me alive.'],
    'maul-obiwan': ['KENOBI!!!', 'Look what I have risen above.'],
    'ahsoka-vader': ['I won\'t leave you!', 'Then you will die.'],
    'kylo-han': ['I know what I have to do...', 'Ben!'],
    'kylo-luke': ['Did you come back to say you forgive me?', 'No.'],
    'rey-kylo': ['You\'re a monster!', 'Yes, I am.'],
    'obiwan-grievous': ['Hello there.', 'General Kenobi!'],
    'dooku-anakin': ['I sense great fear in you.', 'Your skills are impressive.'],
    'anakin-dooku': ['My powers have doubled since we last met.', 'This ends now!'],
    'revan-malak': ['You cannot escape your destiny.', 'I am the Dark Lord now!'],
    'malak-revan': ['You were weak, Revan!', 'I remember everything...'],
    'bastila-revan': ['I will redeem you!', 'Or fall trying.'],
    'revan-nihilus': ['You are a wound in the Force.', '...'],
    'nihilus-talzin': ['Your hunger means nothing to the dead.', '...'],
    'starkiller-vader': ['You lied to me!', 'I lied to myself.'],
    'vader-starkiller': ['You were meant to root out the rebels!', 'I AM the rebellion!'],
    'palpatine-starkiller': ['You were weak, like your father.', 'My father was a Jedi!'],
    'mace-palpatine': ['You are under arrest, Chancellor.', 'Are you threatening me?'],
    'quigon-obiwan': ['You will be a great Jedi.', 'I will not fail you, Master.'],
    'quigon-maul': ['We\'ll handle this.', 'At last we reveal ourselves.'],
    'ahsoka-maul': ['I don\'t fear you.', 'Then you will die braver than most.'],
    'cody-obiwan': ['Blast him!', 'Cody?! What are you doing?!'],
    'rex-ahsoka': ['I\'m not leaving without you!', 'Rex, I need you to trust me.'],
    'rex-cody': ['Good soldiers follow orders...', 'Cody, snap out of it!'],
    'grievous-obiwan': ['General Kenobi! You are a bold one.', 'Your move.'],
    'grievous-mace': ['Jedi scum!', 'This ends now, droid.'],
    'dooku-yoda': ['I\'ve become more powerful than any Jedi.', 'Much to learn, you still have.'],
    'ventress-anakin': ['Skywalker. You\'re mine!', 'In your dreams, assassin.'],
    'ventress-obiwan': ['My dear Obi-Wan...', 'Ventress. What a pleasant surprise.'],
    'savage-ventress': ['You abandoned me!', 'You were never strong enough.'],
    'savage-maul': ['Brother... help me...', 'Savage! NOOOO!'],
    'thrawn-ezra': ['You cannot escape art, Bridger.', 'Then I\'ll make my own masterpiece.'],
    'ezra-thrawn': ['Wherever we\'re going, we\'re going together.', 'How... unexpected.'],
    'cal-inquisitor': ['You cannot hide from the Empire.', 'I\'m done hiding.'],
    'inquisitor-cal': ['Another survivor. How tedious.', 'I\'ve beaten worse than you.'],
    'bokatan-gideon': ['Give me the Darksaber!', 'It belongs to the Empire now.'],
    'mando-gideon': ['The kid comes with me.', 'Such a small thing to die for.'],
    'grogu-vader': ['...', 'I sense... fear.'],
    'cadbane-boba': ['You\'re not like your father.', 'I\'m nothing like him.'],
    'boba-cadbane': ['You killed my father.', 'He had it coming.'],
    'jango-mace': ['I\'m just a simple man.', 'We\'ll see about that.'],
    'fennec-boba': ['You sure about this?', 'I trust you with my life.'],
    'hk47-revan': ['Statement: Shall I kill something for you?', 'I missed you too, HK.'],
    'rey-palpatine': ['You are a Palpatine.', 'I am all the Jedi!'],
    'finn-phasma': ['I\'m in charge now!', 'You were always weak, FN-2187.'],
    'ackbar-tarkin': ['The Empire ends today!', 'You cannot win against the Death Star.'],
    'tarkin-vader': ['Lord Vader, is this necessary?', 'I find your lack of faith disturbing.'],
    'saw-jyn': ['I raised you, Jyn!', 'You left me behind!'],
    'mara-luke': ['I was sent to kill you.', 'Then why haven\'t you?'],
    'snoke-kylo': ['You are no Vader.', 'I will finish what he started.'],
    'marchion-yoda': ['The Jedi are relics!', 'Blinded by hate, you are.'],
    'padme-anakin': ['You\'re breaking my heart!', 'Don\'t make me destroy you.'],
    'sion-nihilus': ['Pain... keeps me alive.', '...'],
    'plagueis-palpatine': ['I taught you everything.', 'Ironic, isn\'t it?'],
  },
  
  // Combat taunts (random during attacks)
  taunts:{
    'Sith': [
      'Your fear betrays you!',
      'The dark side is STRONGER!',
      'You are weak, like all your kind!',
      'Embrace the darkness... or die!',
      'I sense your fear!',
      'You cannot defeat true power!',
      'Your screams fuel my power!',
      'Pathetic!',
      'Kneel before the dark side!'
    ],
    'Jedi': [
      'The Force is with me!',
      'I will not fall to darkness!',
      'There is no emotion, there is peace.',
      'You underestimate the light!',
      'This ends now!',
      'For the Republic!',
      'Trust in the Force!',
      'You cannot win!',
      'I will do what I must.'
    ],
    'Bounty Hunter': [
      'You\'re worth more dead.',
      'Nothing personal. Just business.',
      'I always collect.',
      'You\'re outmatched.',
      'This one\'s going on my wall.',
      'Credits are credits.',
      'Running just makes it worse.',
      'Contract fulfilled.',
      'Should\'ve paid up.'
    ],
    'Empire': [
      'For the Empire!',
      'You will submit!',
      'Resistance is futile!',
      'Order will prevail!',
      'You are outnumbered!',
      'The Emperor wills it!',
      'Rebel scum!',
      'Long live the Empire!',
      'You\'re already dead.'
    ],
    'Rebel': [
      'For freedom!',
      'The Empire falls today!',
      'Hope lives!',
      'We will never surrender!',
      'For the Alliance!',
      'Tyranny ends here!',
      'This is our moment!',
      'We fight as one!',
      'Liberty or death!'
    ],
    'Mandalorian': [
      'This is the Way.',
      'I have spoken.',
      'Weapons are my religion.',
      'Mandalore will rise!',
      'Oya! For Mandalore!',
      'I can bring you in warm, or cold.',
      'Beskar beats blasters.',
      'Ka\'ra guide my aim!',
      'We are Mandalore!'
    ],
    'Droid': [
      'Roger roger!',
      'Probability of success: high.',
      'Target acquired.',
      'Executing combat protocols.',
      'You are terminated.',
      'Processing elimination.',
      'Query: Can I kill this one?',
      'Hostiles detected.',
      'Combat mode: engaged.'
    ],
    'Nightsister': [
      'The spirits hunger!',
      'Dathomir\'s power flows through me!',
      'Your soul will be mine!',
      'The dead rise at my command!',
      'Magick consumes all!',
      'Feel the ichor burn!'
    ],
    'Republic': [
      'For the Republic!',
      'We\'re clones, but we\'re not all the same.',
      'Just like the simulations!',
      'Watch those wrist rockets!',
      'Good soldiers follow orders.',
      'We\'re brothers! All of us!'
    ],
    'Separatist': [
      'For the Confederacy!',
      'Roger roger!',
      'Count Dooku will be pleased.',
      'Democracy is failing!',
      'Crush them!',
      'The Republic is corrupt!'
    ],
    'Nihil': [
      'The storm is coming!',
      'We are the Nihil!',
      'Burn it all down!',
      'Chaos reigns!',
      'No rules. No mercy!',
      'The Republic dies today!'
    ],
    'Celestial': [
      'Balance must be maintained.',
      'The Force wills it.',
      'Light and dark... both serve me.',
      'Mortis watches.',
      'You cannot comprehend our power.'
    ],
    'Hutt': [
      'Everyone has a price!',
      'You dare challenge the Hutts?',
      'Credits solve everything.',
      'My palace, my rules!',
      'Ho ho ho... pathetic.'
    ],
    'Gungan': [
      'Mesa gonna stomp you!',
      'Yousa in big doo-doo!',
      'For the Gungan Grand Army!',
      'Wesa warriors!',
      'Boom-boom time!'
    ]
  },
  
  // Reactions when taking damage
  reactions:{
    light: [
      'grunts in pain, blood trickling from a shallow cut',
      'staggers back, armor dented but holding',
      'absorbs the blow, a bruise blooming under skin',
      'winces from the impact, teeth clenched against the sting',
      'grits teeth, ignoring the warm blood seeping',
      'shakes off the hit, adrenaline surging',
      'flinches as flesh tears slightly',
      'hisses through the pain, eyes narrowing'
    ],
    heavy: [
      'cries out in agony, bone fracturing with a snap',
      'stumbles, nearly falling, blood pouring from the gash',
      'clutches the wound, fingers slick with gore',
      'spits blood, tasting copper on the tongue',
      'roars in pain and fury, veins bulging',
      'doubles over, internals shifting painfully',
      'gasps as ribs crack audibly',
      'limps forward, leg mangled and bleeding'
    ],
    critical: [
      'screams as blood sprays in an arterial arc',
      'collapses to one knee, vision swimming in red',
      'gasps, barely clinging to life, lungs filling with fluid',
      'staggers, vision blurring from blood loss',
      'feels bones crack under the impact, shards piercing organs',
      'convulses as nerves fire in overload',
      'crumples, limbs twitching uncontrollably',
      'howls as entrails threaten to spill'
    ]
  },
  
  // Last words (on death)
  lastWords:{
    'vader': ['Tell your sister... you were right...', '...there is good in me after all...'],
    'palpatine': ['UNLIMITED... power...', 'The dark side... will return...'],
    'obiwan': ['Strike me down, and I shall become more powerful...', 'The Force will be with you... always...'],
    'yoda': ['Luminous beings are we...', 'There is... another...'],
    'maul': ['KENOBI...!', 'He... is the Chosen One...'],
    'anakin': ['I\'m sorry... for everything...', 'Padm...'],
    'luke': ['The Force... will always...', 'See you around, kid...'],
    'han': ['I know...', 'Chewie... take care of them...'],
    'dooku': ['I should have... known...', 'The Sith... always betray...'],
    'grievous': ['You fool... I have been trained...', '*coughs* ...impossible...'],
    'boba': ['I always... get my mark...', 'Like my father... before me...'],
    'mando': ['This... is the Way...', 'The kid... protect the kid...'],
    'rex': ['For... the Republic...', 'Good soldiers... follow orders...'],
    'ahsoka': ['I am no Jedi...', 'Anakin... I\'m sorry...'],
    'kylo': ['I wanted... to be free of this pain...', 'Ben... my name is Ben...'],
    // NEW CHARACTER LAST WORDS
    'starkiller': ['I... was never... a slave...', 'The Force... set me free...'],
    'revan': ['The mask... returns to the void...', 'I remember... everything...'],
    'nihilus': ['...hunger... eternal...', '...'],
    'talzin': ['The spirits... will avenge me...', 'My son... Maul...'],
    'mandalore': ['Mandalore... lives on...', 'For the clans!'],
    'daughter': ['Balance... must be... preserved...', 'Father... help me...'],
    'plagueis': ['I taught Sidious... too well...', 'Death... is not the end...'],
    'thrawn': ['Miscalculated... impossible...', 'Art... never lies...'],
    'tarkin': ['The Death Star... is fully operational...', 'Evacuate? In our moment of triumph?'],
    'snoke': ['You... are nothing!', 'I made you...'],
    'bastila': ['The Force... will guide us...', 'Revan... I loved you...'],
    'malak': ['I... cannot be defeated...', 'Revan... you were always... stronger...'],
    'quigon': ['Promise me... train the boy...', 'The Chosen One...'],
    'mace': ['This party\'s... over...', 'The Sith... control everything...'],
    'rey': ['Be with me...', 'I am... all the Jedi...'],
    'cal': ['Cere... I\'m sorry...', 'The Force... will be free...'],
    'ventress': ['I die... free...', 'The dark side... abandons all...'],
    'savage': ['Brother...', 'I was... never weak!'],
    'inquisitor': ['The Jedi... will fall...', 'There are worse things... than death...'],
    'ezra': ['Lothal... stays free...', 'Kanan... I understand now...'],
    'grogu': ['*sad coo*', '*reaches out*'],
    'jango': ['Boba... I\'m sorry...', 'I\'m just... a simple man...'],
    'cadbane': ['Todo... finish the job...', 'I always... collect...'],
    'fennec': ['Fett... it was an honor...', 'The job... is done...'],
    'hk47': ['Statement: System... failure...', 'Commentary: What... a waste...'],
    'bokatan': ['Mandalore... will rise again...', 'The Darksaber... chooses its own...'],
    'gideon': ['The Empire... is eternal...', 'You\'re too late...'],
    'sion': ['Pain... keeps me alive...', 'Finally... peace...'],
    'padme': ['There is good in him...', 'Obi-Wan... there... is... good...'],
    'finn': ['I\'m not... afraid...', 'Rey...'],
    'marchion': ['The Eye... sees all...', 'The Nihil... will return...'],
    'ackbar': ['It\'s... a trap...', 'For the... Alliance...'],
    'saw': ['Save the dream...', 'Jyn... I\'m sorry...'],
    'jyn': ['Rebellions... are built on hope...', 'Father...'],
    'jarjar': ['Ohhh... mesa in big doo-doo...', '*trips one last time*'],
    'c3po': ['Oh... my...', 'I\'ve seen things... you people wouldn\'t believe...'],
    'r2d2': ['*sad beeps*', '*power down sounds*'],
    'chewie': ['*mournful howl*', '*final roar*'],
  },
  
  // Victory lines
  victoryLines:{
    'vader': 'The dark side is supreme.',
    'palpatine': 'Everything is proceeding as I have foreseen.',
    'yoda': 'Won this battle, we have. But the war continues.',
    'luke': 'The Force was with us today.',
    'maul': 'At last... REVENGE!',
    'obiwan': 'It\'s over. We have won.',
    'ahsoka': 'For all those we\'ve lost.',
    'han': 'Great, kid. Don\'t get cocky.',
    'boba': 'The bounty is collected.',
    'mando': 'This is the Way.',
    'rex': 'Good soldiers follow orders.',
    'grievous': 'Another fine addition to my collection.',
    'thrawn': 'As I calculated.',
    'starkiller': 'The Force... UNLEASHED!',
    'revan': 'I am Revan reborn.',
    'nihilus': '...',
    'talzin': 'The dead serve me well.',
    'mandalore': 'For Mandalore! Victory!',
    'daughter': 'Balance is restored.',
    'plagueis': 'Death is but a doorway.',
    'tarkin': 'You may fire when ready.',
    'snoke': 'Weak. All of you.',
    'bastila': 'The Force guides us to victory.',
    'malak': 'I am the Dark Lord!',
    'quigon': 'The living Force provides.',
    'mace': 'The oppression of the Sith will never return.',
    'rey': 'I am Rey Skywalker.',
    'cal': 'Trust in the Force.',
    'ventress': 'Pathetic.',
    'savage': 'I AM the strongest!',
    'inquisitor': 'The Jedi are extinct.',
    'ezra': 'Told you we\'d win!',
    'grogu': '*happy coo*',
    'jango': 'Simple man, simple victory.',
    'cadbane': 'I\'ll take my payment now.',
    'fennec': 'Clean kill.',
    'hk47': 'Statement: That was most satisfying.',
    'bokatan': 'Mandalore rises!',
    'gideon': 'Long live the Empire.',
    'sion': 'Pain is my ally.',
    'padme': 'For democracy.',
    'finn': 'That\'s what happens when you mess with the Resistance!',
    'marchion': 'The storm consumes all!',
    'ackbar': 'The Empire has fallen!',
    'saw': 'The dream lives on!',
    'jyn': 'For my father.',
    'jarjar': 'Mesa did it! Meesa hero!',
    'c3po': 'Oh, thank the maker!',
    'r2d2': '*triumphant beeps*',
    'chewie': '*victorious roar*',
    'dooku': 'Elegance always triumphs.',
    'anakin': 'That\'s what I\'m trained for.',
    'kylo': 'I will finish what you started.',
    'cody': 'Good soldiers follow orders.'
  },
  
  // Battlefield atmosphere descriptions
  atmosphere:{
    'mustafar': ['Lava geysers erupt nearby, casting hellish shadows.', 'The heat is unbearable. Sweat evaporates instantly.', 'Embers drift through the toxic air like dying stars.'],
    'hoth': ['Ice cracks underfoot with each movement.', 'Breath crystallizes in the frozen air.', 'The howling wind drowns out all but the loudest screams.'],
    'geonosis': ['Sand swirls in the arena, stinging exposed flesh.', 'The crowd roars for blood.', 'Ancient dust rises with each fallen body.'],
    'deathstar': ['The walls groan under the station\'s immense power.', 'Emergency lights bathe everything in crimson.', 'The hum of the reactor vibrates through the deck plating.'],
    'dagobah': ['Mist curls around the combatants like grasping fingers.', 'The Force feels thick here, almost tangible.', 'Something ancient watches from the shadows.'],
    'coruscant': ['Sirens wail in the distance. The undercity never sleeps.', 'Neon signs flicker, painting the violence in garish colors.', 'Trash and debris crunch underfoot.'],
    'endor': ['Leaves fall silently around the carnage.', 'The forest holds its breath.', 'Branches crack as bodies are thrown through the undergrowth.'],
    'kamino': ['Rain hammers down relentlessly.', 'Lightning illuminates frozen moments of violence.', 'Water mixes with blood, swirling into the storm drains.'],
    'exegol': ['Dark energy crackles through the air.', 'The Sith temple groans with malevolent power.', 'Shadows seem to move with purpose here.'],
    'tatooine': ['Twin suns beat down mercilessly.', 'Sand drinks the spilled blood eagerly.', 'Heat mirages make the enemy seem to multiply.'],
    'naboo': ['Marble cracks beneath the violence.', 'Elegant statues topple, shattered by stray fire.', 'The serene waters now run red.'],
    'jakku': ['Rusted starship hulls provide deadly obstacles.', 'The desert wind carries the smell of old death.', 'Wreckage shifts dangerously underfoot.']
  },
  
  // Unit-specific attack styles
  unitStyles:{
    'vader': {weapon:'saber', style:'His mechanical breathing echoes as', desc:'methodical and terrifying'},
    'palpatine': {weapon:'special', style:'Cackling with dark glee,', desc:'sadistic and overwhelming'},
    'yoda': {weapon:'saber', style:'Moving with impossible speed,', desc:'precise and defensive'},
    'luke': {weapon:'saber', style:'Drawing on the Force,', desc:'hopeful yet determined'},
    'ahsoka': {weapon:'saber', style:'White blades twirling in deadly arcs,', desc:'graceful and relentless'},
    'maul': {weapon:'saber', style:'Fueled by pure hatred,', desc:'savage and acrobatic'},
    'obiwan': {weapon:'saber', style:'With classic Soresu form,', desc:'patient and controlled'},
    'anakin': {weapon:'saber', style:'Aggressive and reckless,', desc:'powerful but unstable'},
    'mace': {weapon:'saber', style:'Channeling Vapaad,', desc:'aggressive and focused'},
    'dooku': {weapon:'saber', style:'With elegant Makashi flourishes,', desc:'refined and deadly'},
    'grievous': {weapon:'saber', style:'Four arms spinning in a deadly storm,', desc:'mechanical and overwhelming'},
    'kylo': {weapon:'saber', style:'His unstable blade crackling,', desc:'raw and emotional'},
    'starkiller': {weapon:'special', style:'Reality warping around him,', desc:'overwhelming and destructive'},
    'revan': {weapon:'saber', style:'Wielding both light and dark,', desc:'unpredictable and masterful'},
    'nihilus': {weapon:'special', style:'Hunger incarnate,', desc:'consuming and inevitable'},
    'han': {weapon:'blaster', style:'With a smuggler\'s luck,', desc:'quick-draw and cocky'},
    'boba': {weapon:'blaster', style:'With cold professionalism,', desc:'tactical and lethal'},
    'mando': {weapon:'blaster', style:'This is the Way', desc:'determined and skilled'},
    'chewie': {weapon:'melee', style:'Roaring with Wookiee fury,', desc:'brutal and unstoppable'},
    'rex': {weapon:'blaster', style:'With clone precision,', desc:'disciplined and reliable'},
    'fennec': {weapon:'blaster', style:'With assassin\'s precision,', desc:'silent and deadly'},
    'thrawn': {weapon:'blaster', style:'Executing a calculated strategy,', desc:'tactical and predatory'}
  }
};

// Generate cinematic attack narration
function narrateAttack(attacker, defender, damage, isCrit, isKill){
  const style = GORE.unitStyles[attacker.id] || {weapon: ['Jedi','Sith'].includes(attacker.faction) ? 'saber' : 'blaster', style: '', desc: ''};
  const weapon = style.weapon;
  
  // Get full display names
  const attackerName = typeof getCombatName === 'function' ? getCombatName(attacker) : attacker.name;
  const defenderName = typeof getCombatName === 'function' ? getCombatName(defender) : defender.name;
  
  let narration = '';
  
  // Add style prefix if unit has one
  if(style.style) narration += style.style + ' ';
  
  // Check for rivalry dialogue
  const rivalryKey = `${attacker.id}-${defender.id}`;
  const reverseKey = `${defender.id}-${attacker.id}`;
  if(GORE.rivalries[rivalryKey] && Math.random() < 0.4){
    const quote = pick(GORE.rivalries[rivalryKey]);
    narration = `<em>"${quote}"</em>  `;
  }
  
  // Build attack description
  if(isCrit){
    narration += pick(GORE.critical) + ' ' + attackerName + ' ';
  } else {
    narration += attackerName + ' ';
  }
  
  // Add weapon-appropriate verb
  switch(weapon){
    case 'saber': narration += pick(GORE.saber); break;
    case 'blaster': narration += pick(GORE.blaster); break;
    case 'melee': narration += pick(GORE.melee); break;
    case 'special': narration += pick(GORE.saber); break;
    default: narration += pick(GORE.slash);
  }
  
  narration += ` ${defenderName}!`;
  
  return narration;
}

// Generate cinematic kill narration
function narrateKill(victim, killer){
  const style = GORE.unitStyles[killer?.id] || {weapon: ['Jedi','Sith'].includes(killer?.faction) ? 'saber' : 'blaster'};
  const weapon = style.weapon;
  
  let killDesc;
  switch(weapon){
    case 'saber': killDesc = pick(GORE.killSaber); break;
    case 'blaster': killDesc = pick(GORE.killBlaster); break;
    case 'melee': killDesc = pick(GORE.killMelee); break;
    case 'special': killDesc = pick(GORE.killSpecial); break;
    default: killDesc = pick(GORE.killBlaster);
  }
  
  // Get full display names
  const victimName = typeof getCombatName === 'function' ? getCombatName(victim) : victim.name;
  const killerName = killer && typeof getCombatName === 'function' ? getCombatName(killer) : killer?.name;
  
  // Check if this was a heroic sacrifice (leader death or last unit)
  const team = battle?.players.find(p => p.id === victim.ownerId);
  const isHeroic = victim.isLeader || (team && team.combatants.filter(c => c.alive).length <= 1);
  
  let narration = `<strong style="color:var(--red)"> ${victimName} FALLS!</strong> `;
  narration += killDesc;
  
  if(isHeroic && victim.isLeader){
    narration += ` <em>${victimName} died ${pick(GORE.sacrifice)}.</em>`;
  }
  
  // Add kill credit
  if(killer){
    killer.killCount = (killer.killCount || 0) + 1;
    if(killer.killCount >= 3){
      narration += ` <strong style="color:var(--gold)">${killerName} is on a KILLING SPREE! (${killer.killCount} kills)</strong>`;
    }
  }
  
  return narration;
}

// Generate round atmosphere
function narrateRoundStart(round, battlefield){
  const bfKey = battlefield?.image || 'default';
  const atmosphere = GORE.atmosphere[bfKey];
  
  let narration = `<strong> ROUND ${round} </strong>`;
  
  if(atmosphere && Math.random() < 0.5){
    narration += `<div class="atmosphere"><em>${pick(atmosphere)}</em></div>`;
  }
  
  return narration;
}

// Generate battle summary
function narrateBattleSummary(winner, stats){
  let summary = `<div class="battle-summary">`;
  summary += `<strong> BATTLE COMPLETE </strong><br>`;
  summary += `<span style="color:${winner.color}">${winner.name}</span> claims VICTORY!<br><br>`;
  
  // Find MVP
  const allCombatants = battle.players.flatMap(p => p.combatants);
  const mvp = allCombatants.reduce((a, b) => (a.damageDealt || 0) > (b.damageDealt || 0) ? a : b);
  const mostKills = allCombatants.reduce((a, b) => (a.killCount || 0) > (b.killCount || 0) ? a : b);
  
  if(mvp && mvp.damageDealt > 0){
    summary += `<strong> MVP:</strong> ${mvp.name} (${Math.round(mvp.damageDealt)} damage dealt)<br>`;
  }
  if(mostKills && mostKills.killCount > 0){
    summary += `<strong> Most Kills:</strong> ${mostKills.name} (${mostKills.killCount} kills)<br>`;
  }
  
  // Describe surviving units
  const survivors = winner.combatants.filter(c => c.alive);
  if(survivors.length){
    const survDesc = survivors.map(s => `${s.name} (${Math.round(s.curHp)}/${s.maxHp} HP)`).join(', ');
    summary += `<br><strong>Survivors:</strong> ${survDesc}`;
  }
  
  summary += `</div>`;
  return summary;
}

// ============================================
// SOUND SYSTEM
// ============================================
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let sfxEnabled=true;
let musicEnabled=true;
let currentMusic=null;

// Sound effect generators using Web Audio API
const SOUNDS={
  lightsaber:()=>playTone([200,800,600],0.15,'sawtooth',0.3),
  blaster:()=>playTone([800,200],0.1,'square',0.2),
  hit:()=>playNoise(0.1,0.4),
  death:()=>{playTone([400,100],0.3,'sawtooth',0.3);playNoise(0.2,0.3);},
  heal:()=>playTone([400,600,800,1000],0.4,'sine',0.2),
  force:()=>playTone([200,400,300,500,400],0.5,'sine',0.15),
  explosion:()=>{playNoise(0.3,0.6);playTone([100,50],0.3,'sawtooth',0.4);},
  block:()=>playTone([500,800],0.1,'triangle',0.2),
  combo:()=>{playTone([400,600,800,1000,1200],0.3,'sine',0.25);playTone([300,500,700,900,1100],0.3,'square',0.1);},
  achievement:()=>playTone([523,659,784,1047],0.5,'sine',0.2),
  victory:()=>{playTone([523,659,784,1047,1319],0.8,'sine',0.3);setTimeout(()=>playTone([784,1047,1319,1568],0.6,'triangle',0.2),300);},
  defeat:()=>{playTone([400,300,200,100],0.6,'sawtooth',0.25);playNoise(0.4,0.2);},
  click:()=>playTone([800,600],0.05,'square',0.1),
  start:()=>playTone([300,400,500,600],0.3,'triangle',0.2),
  // New sounds
  crit:()=>{playTone([600,1200,800],0.15,'sawtooth',0.35);playNoise(0.1,0.3);},
  special:()=>playTone([300,500,700,900,700,500,700],0.5,'sine',0.25),
  poison:()=>playTone([200,250,200,180,200],0.4,'triangle',0.15),
  shield:()=>playTone([800,1000,1200,1000],0.2,'sine',0.2),
  betray:()=>{playTone([600,300,150],0.4,'sawtooth',0.3);playNoise(0.2,0.25);},
  resurrect:()=>playTone([200,300,400,600,800,1000],0.6,'sine',0.25),
  roundStart:()=>playTone([400,500,600],0.2,'triangle',0.2),
  tournamentWin:()=>{playTone([523,659,784],0.3,'sine',0.3);setTimeout(()=>playTone([659,784,1047],0.3,'sine',0.3),200);setTimeout(()=>playTone([784,1047,1319,1568],0.5,'sine',0.35),400);},
  countdown:()=>playTone([600,400],0.1,'square',0.15),
  fanfare:()=>{playTone([523,523,523,698],0.4,'triangle',0.25);setTimeout(()=>playTone([698,880,1047],0.5,'sine',0.3),350);},
};

function playTone(freqs,duration,type='sine',volume=0.2){
  if(!sfxEnabled)return;
  try{
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.type=type;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(volume,audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+duration);
    
    const stepTime=duration/freqs.length;
    freqs.forEach((f,i)=>{
      osc.frequency.setValueAtTime(f,audioCtx.currentTime+i*stepTime);
    });
    
    osc.start();
    osc.stop(audioCtx.currentTime+duration);
  }catch(e){}
}

function playNoise(duration,volume=0.3){
  if(!sfxEnabled)return;
  try{
    const bufferSize=audioCtx.sampleRate*duration;
    const buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
    const data=buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++)data[i]=(Math.random()*2-1)*Math.pow(1-i/bufferSize,2);
    const source=audioCtx.createBufferSource();
    const gain=audioCtx.createGain();
    source.buffer=buffer;
    source.connect(gain);
    gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(volume,audioCtx.currentTime);
    source.start();
  }catch(e){}
}

function playSound(name){
  if(sfxEnabled&&SOUNDS[name])SOUNDS[name]();
}

function toggleSFX(){
  sfxEnabled=!sfxEnabled;
  document.getElementById('sfx-btn').classList.toggle('muted',!sfxEnabled);
  if(sfxEnabled)playSound('click');
}

function toggleMusic(){
  musicEnabled=!musicEnabled;
  document.getElementById('music-btn').classList.toggle('muted',!musicEnabled);
  if(musicEnabled && currentBattlefieldMusic) playBattlefieldMusic(currentBattlefieldMusic);
  else stopBattlefieldMusic();
}

let ambientInterval=null;
let currentBattlefieldMusic=null;
let musicOscillators=[];
let battlefieldAudio=null;

function playBattlefieldMusic(bfName){
  if(!musicEnabled) return;
  stopBattlefieldMusic();
  currentBattlefieldMusic = bfName;
  
  // Get music path from our musicFiles object
  const musicPath = musicFiles[bfName];
  if(!musicPath){
    debugLog('No music file for', bfName, ', using procedural');
    playProceduralMusic(bfName);
    return;
  }
  
  // Try to load audio file
  battlefieldAudio = new Audio();
  battlefieldAudio.loop = true;
  battlefieldAudio.volume = 0.3;
  
  debugLog('Loading music:', musicPath);
  battlefieldAudio.src = musicPath;
  
  battlefieldAudio.onerror = (e) => {
    debugLog('Music load error:', e);
    battlefieldAudio = null;
    playProceduralMusic(bfName);
  };
  
  battlefieldAudio.oncanplaythrough = () => {
    if(musicEnabled && currentBattlefieldMusic === bfName && battlefieldAudio){
      debugLog('Playing music for:', bfName);
      battlefieldAudio.play().catch(e => {
        debugLog('Audio autoplay blocked:', e);
        playProceduralMusic(bfName);
      });
    }
  };
  
  // Timeout fallback
  setTimeout(() => {
    if(battlefieldAudio && battlefieldAudio.readyState < 2){
      debugLog('Music load timeout');
      battlefieldAudio = null;
      playProceduralMusic(bfName);
    }
  }, 5000);
}

function playProceduralMusic(bfName){
  // Fallback procedural music based on battlefield
  const musicConfig = {
    'mustafar': {tempo:140,key:'minor',bass:80,intensity:0.9},
    'geonosis': {tempo:130,key:'minor',bass:100,intensity:0.85},
    'hoth': {tempo:100,key:'minor',bass:60,intensity:0.6},
    'coruscant': {tempo:120,key:'minor',bass:90,intensity:0.7},
    'deathstar': {tempo:110,key:'minor',bass:120,intensity:0.75},
    'dagobah': {tempo:70,key:'major',bass:50,intensity:0.4},
    'tatooine': {tempo:90,key:'minor',bass:70,intensity:0.5},
    'endor': {tempo:95,key:'major',bass:55,intensity:0.55},
    'kamino': {tempo:105,key:'minor',bass:85,intensity:0.65},
    'naboo': {tempo:85,key:'major',bass:45,intensity:0.45},
    'jakku': {tempo:100,key:'minor',bass:75,intensity:0.6},
    'exegol': {tempo:150,key:'minor',bass:130,intensity:1.0},
  };
  
  const config = musicConfig[bfName] || {tempo:100,key:'minor',bass:80,intensity:0.5};
  const {tempo, key, bass, intensity} = config;
  const baseFreq = key === 'minor' ? 110 : 130;
  const interval = 60000 / tempo;
  
  // Create ambient pad
  try {
    const padOsc = audioCtx.createOscillator();
    const padGain = audioCtx.createGain();
    padOsc.type = 'sine';
    padOsc.frequency.value = baseFreq;
    padGain.gain.value = 0.03 * intensity;
    padOsc.connect(padGain);
    padGain.connect(audioCtx.destination);
    padOsc.start();
    musicOscillators.push({osc: padOsc, gain: padGain});
    
    const pad2 = audioCtx.createOscillator();
    const pad2Gain = audioCtx.createGain();
    pad2.type = 'sine';
    pad2.frequency.value = baseFreq * (key === 'minor' ? 1.2 : 1.25);
    pad2Gain.gain.value = 0.02 * intensity;
    pad2.connect(pad2Gain);
    pad2Gain.connect(audioCtx.destination);
    pad2.start();
    musicOscillators.push({osc: pad2, gain: pad2Gain});
  } catch(e){}
  
  // Rhythmic bass
  ambientInterval = setInterval(() => {
    if(!musicEnabled) return;
    playTone([bass, bass*0.9], 0.2, 'sine', 0.04 * intensity);
    if(Math.random() < 0.3) playTone([baseFreq*2, baseFreq*2.5], 0.3, 'sine', 0.02 * intensity);
  }, interval);
}

function stopBattlefieldMusic(){
  // Stop audio file
  if(battlefieldAudio){
    battlefieldAudio.pause();
    battlefieldAudio.src = '';
    battlefieldAudio = null;
  }
  
  // Stop oscillators
  musicOscillators.forEach(({osc, gain}) => {
    try {
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
      setTimeout(() => osc.stop(), 500);
    } catch(e){}
  });
  musicOscillators = [];
  
  // Stop interval
  if(ambientInterval){
    clearInterval(ambientInterval);
    ambientInterval = null;
  }
  currentBattlefieldMusic = null;
}

function startAmbientMusic(){
  // Legacy function - now uses battlefield music
}

// ============================================
// AI OPPONENT SYSTEM
// ============================================
let aiMode=false;
let aiDifficulty='easy';
const AI_BUDGETS={easy:12,normal:15,hard:17,brutal:20};
const AI_NAMES={easy:'Padawan Bot',normal:'Knight Bot',hard:'Master Bot',brutal:'Sith Lord AI'};

function setAIDifficulty(diff){
  aiDifficulty=diff;
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  if(aiMode)generateAITeam();
}

function generateAITeam(){
  const ai=players[1];
  ai.units=[];
  ai.equipment=[];
  ai.spent=0;
  ai.leader=null;
  ai.noLeader=Math.random()<0.2;
  ai.formation={front:[],back:[]};
  ai.name=AI_NAMES[aiDifficulty];
  
  const budget=AI_BUDGETS[aiDifficulty];
  let remaining=budget;
  
  // AI unit selection strategy based on difficulty
  let pool=[...UNITS].sort((a,b)=>{
    if(aiDifficulty==='brutal')return b.cost-a.cost; // Best units first
    if(aiDifficulty==='hard')return (b.atk+b.def)-( a.atk+a.def);
    return Math.random()-0.5; // Random for easy/normal
  });
  
  // Brutal AI prioritizes synergies
  if(aiDifficulty==='brutal'){
    const factions=['Sith','Jedi','Bounty Hunter'];
    const targetFaction=factions[Math.floor(Math.random()*factions.length)];
    pool.sort((a,b)=>(b.faction===targetFaction?1:0)-(a.faction===targetFaction?1:0));
  }
  
  for(const u of pool){
    if(remaining<u.cost)continue;
    if(!u.stack&&ai.units.some(x=>x.id===u.id))continue;
    
    const newUnit={...u,uid:Date.now()+Math.random()};
    
    // AI picks good variants on higher difficulties
    if(VARIANTS[u.id]&&(aiDifficulty==='hard'||aiDifficulty==='brutal')){
      const goodVariants=VARIANTS[u.id].filter(v=>(v.mods.atk||0)+(v.mods.def||0)+(v.mods.hp||0)/10>0);
      if(goodVariants.length){
        const v=goodVariants[Math.floor(Math.random()*goodVariants.length)];
        newUnit.variant=v.id;
        newUnit.variantName=v.name;
        newUnit.variantEmoji=v.emoji;
      }
    }
    
    ai.units.push(newUnit);
    ai.spent+=u.cost;
    remaining-=u.cost;
    
    // Smart formation placement
    if(u.def>=70||u.hp>=180)ai.formation.front.push(newUnit.uid);
    else ai.formation.back.push(newUnit.uid);
    
    if(ai.units.length>=6)break;
  }
  
  // AI picks leader (highest cost unit on hard+)
  if(!ai.noLeader&&ai.units.length){
    const leaderPick=aiDifficulty==='easy'?
      ai.units[Math.floor(Math.random()*ai.units.length)]:
      ai.units.reduce((best,u)=>u.cost>best.cost?u:best,ai.units[0]);
    ai.leader=leaderPick.uid;
  }
  
  // AI buys equipment on hard+
  if((aiDifficulty==='hard'||aiDifficulty==='brutal')&&remaining>0){
    const equipPool=Object.entries(EQUIPMENT).sort((a,b)=>b[1].cost-a[1].cost);
    for(const [name,eq] of equipPool){
      if(eq.cost<=remaining&&ai.equipment.length<ai.units.length){
        ai.equipment.push(name);
        remaining-=eq.cost;
        // Assign to random unit
        const unequipped=ai.units.filter(u=>!(u.equipment||[]).length);
        if(unequipped.length){
          const target=unequipped[Math.floor(Math.random()*unequipped.length)];
          target.equipment=target.equipment||[];
          target.equipment.push(name);
        }
      }
    }
  }
  
  renderTeams();
}

// ============================================
// COMBO ATTACK SYSTEM
// ============================================
const COMBO_ATTACKS=[
  {units:['vader','palpatine'],name:'DARK SIDE DEVASTATION',emoji:'',damage:120,desc:'Vader and Palpatine unleash combined Force fury!'},
  {units:['luke','obiwan'],name:'JEDI LEGACY STRIKE',emoji:'',damage:100,desc:'Master and apprentice fight as one!'},
  {units:['luke','leia'],name:'TWIN SUNS ASSAULT',emoji:'',damage:90,desc:'The Skywalker twins coordinate their attack!'},
  {units:['han','chewie'],name:'SMUGGLER\'S GAMBIT',emoji:'',damage:85,desc:'Han and Chewie pull off a classic maneuver!'},
  {units:['anakin','obiwan'],name:'TEAM KENOBI',emoji:'',damage:110,desc:'The legendary duo strikes together!'},
  {units:['anakin','ahsoka'],name:'MASTER & SNIPS',emoji:'',damage:95,desc:'Anakin and Ahsoka in perfect sync!'},
  {units:['maul','savage'],name:'BROTHER\'S VENGEANCE',emoji:'',damage:105,desc:'The Opress brothers attack with fury!'},
  {units:['boba','jango'],name:'FETT FAMILY BARRAGE',emoji:'',damage:100,desc:'Father and son unleash their arsenal!'},
  {units:['rex','fives'],name:'CLONE TACTICS',emoji:'',damage:80,desc:'501st brothers execute a perfect ambush!'},
  {units:['palpatine','dooku'],name:'SITH LIGHTNING STORM',emoji:'',damage:115,desc:'Two Sith Lords electrify the battlefield!'},
  {units:['yoda','mace'],name:'COUNCIL STRIKE',emoji:'',damage:105,desc:'The Jedi Council\'s finest attack!'},
  {units:['mando','grogu'],name:'THIS IS THE WAY',emoji:'',damage:75,heal:40,desc:'Din protects while Grogu uses the Force!'},
  {units:['kylo','rey'],name:'DYAD IN THE FORCE',emoji:'',damage:130,desc:'The Force Dyad unleashes unstoppable power!'},
  {units:['grievous','dooku'],name:'SEPARATIST ASSAULT',emoji:'',damage:95,desc:'The Separatist commanders strike together!'},
];

function checkForCombo(team){
  const unitIds=team.filter(u=>u.alive).map(u=>u.id);
  for(const combo of COMBO_ATTACKS){
    if(combo.units.every(id=>unitIds.includes(id))){
      return combo;
    }
  }
  return null;
}

function executeCombo(combo,team,enemies){
  playSound('combo');
  
  const comboUnits=team.filter(u=>combo.units.includes(u.id)&&u.alive);
  
  // Show combo alert in dialogue
  const dialogue=document.getElementById('combat-dialogue');
  if(dialogue){
    dialogue.innerHTML=`
      <div class="combo-alert">
        <div class="combo-title">${combo.emoji} ${combo.name} ${combo.emoji}</div>
        <div class="combo-fighters">
          ${comboUnits.map(u=>`<div class="combo-fighter"><div class="emoji">${u.variantEmoji||u.emoji}</div><div class="name">${u.name}</div></div>`).join('')}
        </div>
        <div class="combo-damage">${combo.damage} COMBO DAMAGE!</div>
        <div style="font-size:0.8em;color:#ccc;margin-top:5px">${combo.desc}</div>
      </div>`;
  }
  
  addLog(` <strong style="color:var(--gold)">${combo.name}</strong>! ${combo.desc}`,'special');
  
  // Deal damage to random enemies
  const dmgPerTarget=Math.floor(combo.damage/(Math.min(3,enemies.filter(e=>e.alive).length)||1));
  const targets=enemies.filter(e=>e.alive).sort(()=>Math.random()-0.5).slice(0,3);
  
  targets.forEach(target=>{
    const finalDmg=dmgPerTarget+Math.random()*20;
    target.curHp-=finalDmg;
    addLog(`${combo.emoji} Combo hits ${target.name} for <strong style="color:var(--red)">${Math.round(finalDmg)} DMG</strong>!`,'damage');
    anim(target,'crit');
    if(target.curHp<=0)killUnit(target,comboUnits[0]);
  });
  
  // Heal if combo has heal
  if(combo.heal){
    comboUnits.forEach(u=>{
      const healAmt=Math.min(combo.heal,u.maxHp-u.curHp);
      if(healAmt>0){
        u.curHp+=healAmt;
        addLog(` ${u.name} heals ${Math.round(healAmt)} from combo synergy!`,'heal');
        anim(u,'heal');
      }
    });
  }
  
  // Track for achievements
  comboUnits.forEach(u=>{
    u.combosUsed=(u.combosUsed||0)+1;
  });
  
  checkAchievement('combo_master');
  
  return true;
}

// ============================================
// ACHIEVEMENTS SYSTEM
// ============================================
const ACHIEVEMENTS={
  first_blood:{name:'First Blood',desc:'Win your first battle',icon:'',xp:100},
  serial_killer:{name:'Serial Killer',desc:'Get 10 kills in one battle',icon:'',xp:200},
  flawless:{name:'Flawless Victory',desc:'Win without losing any units',icon:'',xp:300},
  underdog:{name:'Underdog',desc:'Win with less than $10 spent',icon:'',xp:250},
  full_squad:{name:'Full Squad',desc:'Field exactly 6 units',icon:'',xp:100},
  combo_master:{name:'Combo Master',desc:'Execute a combo attack',icon:'',xp:200},
  sith_lord:{name:'Sith Lord',desc:'Win with 3+ Sith units',icon:'',xp:150},
  jedi_master:{name:'Jedi Master',desc:'Win with 3+ Jedi units',icon:'',xp:150},
  bounty_collected:{name:'Bounty Collected',desc:'Win with 2+ Bounty Hunters',icon:'',xp:150},
  ai_easy:{name:'Padawan Slayer',desc:'Beat Easy AI',icon:'',xp:100},
  ai_normal:{name:'Knight Slayer',desc:'Beat Normal AI',icon:'',xp:200},
  ai_hard:{name:'Master Slayer',desc:'Beat Hard AI',icon:'',xp:300},
  ai_brutal:{name:'Sith Slayer',desc:'Beat Brutal AI',icon:'',xp:500},
  ten_wins:{name:'Veteran',desc:'Win 10 battles',icon:'',xp:300},
  hundred_kills:{name:'Executioner',desc:'Accumulate 100 total kills',icon:'',xp:400},
  equipment_master:{name:'Geared Up',desc:'Win with 3+ equipment items',icon:'',xp:150},
  leader_victory:{name:'Leadership',desc:'Win with leader alive',icon:'',xp:200},
  comeback:{name:'Comeback Kid',desc:'Win after being down to 1 unit',icon:'',xp:350},
  speed_run:{name:'Speed Run',desc:'Win in 5 rounds or less',icon:'',xp:250},
  heavyweight:{name:'Heavyweight',desc:'Spend exactly $15 budget',icon:'',xp:100},
};

// Load achievements from localStorage
let playerStats=JSON.parse(localStorage.getItem('galaxyClashStats')||'{}');
if(!playerStats.achievements)playerStats.achievements={};
if(!playerStats.totalWins)playerStats.totalWins=0;
if(!playerStats.totalKills)playerStats.totalKills=0;
if(!playerStats.xp)playerStats.xp=0;
if(!playerStats.level)playerStats.level=1;

function saveStats(){
  localStorage.setItem('galaxyClashStats',JSON.stringify(playerStats));
}

function getLevel(xp){
  return Math.floor(Math.sqrt(xp/100))+1;
}

function getXPForLevel(level){
  return Math.pow(level-1,2)*100;
}

function unlockAchievement(id){
  if(playerStats.achievements[id])return false;
  
  const ach=ACHIEVEMENTS[id];
  if(!ach)return false;
  
  playerStats.achievements[id]=Date.now();
  playerStats.xp+=ach.xp;
  const newLevel=getLevel(playerStats.xp);
  const leveledUp=newLevel>playerStats.level;
  playerStats.level=newLevel;
  saveStats();
  
  playSound('achievement');
  
  // Show popup
  const container=document.getElementById('achievement-container');
  const popup=document.createElement('div');
  popup.className='achievement-popup';
  popup.innerHTML=`
    <div class="achievement-header">
      <div class="achievement-icon">${ach.icon}</div>
      <div>
        <div class="achievement-label">Achievement Unlocked!</div>
        <div class="achievement-title">${ach.name}</div>
      </div>
    </div>
    <div class="achievement-desc">${ach.desc}</div>
    <div class="achievement-xp">+${ach.xp} XP${leveledUp?`  LEVEL UP! Level ${newLevel}!`:''}</div>
  `;
  container.appendChild(popup);
  setTimeout(()=>popup.remove(),4000);
  
  return true;
}

function checkAchievement(id){
  if(playerStats.achievements[id])return;
  unlockAchievement(id);
}

function checkBattleAchievements(winner,loser){
  const winnerP=battle.players.find(p=>p.id===winner.id);
  const winnerOriginal=players.find(p=>p.id===winner.id);
  
  // First blood
  if(playerStats.totalWins===0)checkAchievement('first_blood');
  
  // Increment wins
  if(winner.id==='p1'||(aiMode&&winner.id==='p1')){
    playerStats.totalWins++;
    saveStats();
  }
  
  // Ten wins
  if(playerStats.totalWins>=10)checkAchievement('ten_wins');
  
  // Serial killer - 10 kills in one battle
  const maxKills=Math.max(...winnerP.combatants.map(c=>c.killCount||0));
  if(maxKills>=10)checkAchievement('serial_killer');
  
  // Flawless - all units alive
  if(winnerP.combatants.every(c=>c.alive))checkAchievement('flawless');
  
  // Underdog - win with <$10
  if(winnerOriginal&&winnerOriginal.spent<10)checkAchievement('underdog');
  
  // Full squad
  if(winnerOriginal&&winnerOriginal.units.length===6)checkAchievement('full_squad');
  
  // Faction achievements
  const sithCount=winnerP.combatants.filter(c=>c.faction==='Sith').length;
  const jediCount=winnerP.combatants.filter(c=>c.faction==='Jedi').length;
  const bhCount=winnerP.combatants.filter(c=>c.faction==='Bounty Hunter').length;
  if(sithCount>=3)checkAchievement('sith_lord');
  if(jediCount>=3)checkAchievement('jedi_master');
  if(bhCount>=2)checkAchievement('bounty_collected');
  
  // AI victories
  if(aiMode&&winner.id==='p1'){
    if(aiDifficulty==='easy')checkAchievement('ai_easy');
    if(aiDifficulty==='normal')checkAchievement('ai_normal');
    if(aiDifficulty==='hard')checkAchievement('ai_hard');
    if(aiDifficulty==='brutal')checkAchievement('ai_brutal');
  }
  
  // Equipment master
  const totalEquip=winnerP.combatants.reduce((sum,c)=>(c.equipment||[]).length+sum,0);
  if(totalEquip>=3)checkAchievement('equipment_master');
  
  // Leader victory
  const leaderAlive=winnerP.combatants.find(c=>c.isLeader&&c.alive);
  if(leaderAlive)checkAchievement('leader_victory');
  
  // Speed run
  if(battle.round<=5)checkAchievement('speed_run');
  
  // Heavyweight
  if(winnerOriginal&&winnerOriginal.spent===15)checkAchievement('heavyweight');
  
  // Hundred kills
  if(playerStats.totalKills>=100)checkAchievement('hundred_kills');
}

function openAchievements(){
  const screen=document.getElementById('achievements-screen');
  const totalXP=playerStats.xp;
  const level=playerStats.level;
  const currentLevelXP=getXPForLevel(level);
  const nextLevelXP=getXPForLevel(level+1);
  const progressXP=totalXP-currentLevelXP;
  const neededXP=nextLevelXP-currentLevelXP;
  const progressPct=Math.min(100,(progressXP/neededXP)*100);
  
  const unlockedCount=Object.keys(playerStats.achievements).length;
  const totalCount=Object.keys(ACHIEVEMENTS).length;
  
  screen.innerHTML=`
    <div class="encyclopedia">
      <div class="encyclopedia-header">
        <div class="encyclopedia-title"> ACHIEVEMENTS</div>
        <button class="encyclopedia-close" onclick="closeAchievements()"> Close</button>
      </div>
      
      <div class="xp-bar-container">
        <div class="xp-header">
          <span class="xp-level"> Level ${level}</span>
          <span class="xp-amount">${totalXP} XP (${progressXP}/${neededXP} to next level)</span>
        </div>
        <div class="xp-bar"><div class="xp-fill" style="width:${progressPct}%"></div></div>
      </div>
      
      <div style="text-align:center;margin-bottom:15px;color:#888">
        <span style="color:var(--gold);font-family:'Orbitron'">${unlockedCount}/${totalCount}</span> Achievements Unlocked
        &nbsp;|&nbsp;
        <span style="color:var(--green)">${playerStats.totalWins}</span> Wins
        &nbsp;|&nbsp;
        <span style="color:var(--red)">${playerStats.totalKills}</span> Total Kills
      </div>
      
      <div class="achievements-grid" style="max-height:none">
        ${Object.entries(ACHIEVEMENTS).map(([id,ach])=>{
          const unlocked=playerStats.achievements[id];
          return `
            <div class="ach-card ${unlocked?'unlocked':'locked'}" title="${ach.desc}">
              <div class="icon">${ach.icon}</div>
              <div class="name">${ach.name}</div>
              <div class="desc">${ach.desc}</div>
              <div class="xp">${unlocked?' Unlocked':'+'+ach.xp+' XP'}</div>
            </div>`;
        }).join('')}
      </div>
      
      <div style="text-align:center;margin-top:20px">
        <button class="btn red" onclick="if(confirm('Reset all achievements and stats?')){localStorage.removeItem('galaxyClashStats');location.reload();}"> Reset Progress</button>
      </div>
    </div>`;
  screen.classList.add('show');
}

function closeAchievements(){
  document.getElementById('achievements-screen').classList.remove('show');
}

// ============================================
// ASSET CONFIGURATION - CHANGE THESE IF NEEDED
// ============================================
// Set USE_LOCAL_FILES to true if GitHub URLs don't work
// Then place the game HTML file in the same folder as your assets:
// YourFolder/
//    galaxy-clash.html (this file)
//    images/units/
//    images/variants/
//    music/

// Debug mode - set to true to see console logs
const DEBUG_ASSETS = false;

function debugLog(...args) {
  if(DEBUG_ASSETS) console.log('[Galaxy-Clash]', ...args);
}

// ============================================
// IMAGE SYSTEM - Direct full paths (local files)
// ============================================

// Unit portraits - FULL PATH from game root
const unitImages = {
  // SITH / DARK SIDE
  'vader': '../images/units/Vader.jpg',
  'palpatine': '../images/units/Palpatine.webp',
  'maul': '../images/units/Darth Maul.jpg',
  'dooku': '../images/units/Count Dooku.jpg',
  'ventress': '../images/units/Asajj-Ventress.webp',
  'savage': '../images/units/Savage Opress.jpg',
  'kylo': '../images/units/Kylo Ren.jpg',
  'nihilus': '../images/units/Darth Nihilus.png',
  'revan': '../images/units/Darth Revan.jpg',
  'plagueis': '../images/units/Darth Plagueis.jpg',
  'sion': '../images/units/Darth Sion.webp',
  'starkiller': '../images/units/StarKiller.jpg',
  'malak': '../images/units/darth malak.webp',
  'snoke': '../images/units/Snoke.jpg',
  'inquisitor': '../images/units/Grand Inquisitor.jpg',
  'talzin': '../images/units/Mother Talzin.jpg',
  
  // JEDI / LIGHT SIDE
  'yoda': '../images/units/Yoda.webp',
  'luke': '../images/units/Luke-Skywalker.webp',
  'obiwan': '../images/units/Obiwan.jpg',
  'anakin': '../images/units/Anakin Skywlker.png',
  'ahsoka': '../images/units/Ahsoka.webp',
  'mace': '../images/units/Mace-Windu.jpg',
  'quigon': '../images/units/Qui Gon Jinn.jpg',
  'plokoon': '../images/units/Plo koon.jpg',
  'aayla': '../images/units/Aayla-Secura.jpeg',
  'cal': '../images/units/Cal Kestis.webp',
  'ezra': '../images/units/Ezra.webp',
  'bastila': '../images/units/Bastila Shan.webp',
  'rey': '../images/units/Rey Skywalker.jpg',
  'templeguards': '../images/units/Jedi Temple Guard.png',
  'jedipadawan': '../images/units/jedi padawan.webp',
  'youngling': '../images/units/Jedi Youngling.jpeg',
  'sinube': '../images/units/Tera Sinube.png',
  'daughter': '../images/units/The Daughter.jpg',
  
  // EMPIRE
  'thrawn': '../images/units/Grand Admiral Thrawn.jpg',
  'tarkin': '../images/units/Tarkin.jpg',
  'gideon': '../images/units/Moff Gideon.jpg',
  'hux': '../images/units/General Hux.jpg',
  'phasma': '../images/units/Captain Phasma.jpg',
  'grievous': '../images/units/general-grievous.jpg',
  'stormtroopers': '../images/units/Storm Troopers.jpg',
  'imperials': '../images/units/Imperial Army Trooper.jpg',
  'scouttroopers': '../images/units/Scout Troopers.jpg',
  'mortartroopers': '../images/units/Mortar Stormtrooper.webp',
  'fostormtroopers': '../images/units/First Order Troopers.jpg',
  'tiefighters': '../images/units/Tie Fighter.jpg',
  'supercommandos': '../images/units/Super Commando.jpg',
  'praetorians': '../images/units/praetorian_guard.jpg',
  
  // REBELS / REPUBLIC
  'han': '../images/units/HanSolo.webp',
  'chewie': '../images/units/Chewbacca.jpg',
  'rex': '../images/units/Captain Rex.jpg',
  'cody': '../images/units/Commander Cody.jpg',
  'clones': '../images/units/Clone Troopers.webp',
  'arctroopers': '../images/units/Arc Troopers.jpg',
  'medics': '../images/units/Clone Trooper Medics.webp',
  'faie': '../images/units/Clone Commander Faie.jpg',
  'rebels': '../images/units/Rebel Troopers.jpg',
  'jyn': '../images/units/Jyn Erso.jpg',
  'finn': '../images/units/Finn FN-2187.webp',
  'ackbar': '../images/units/Admiral Akbar.jpg',
  'saw': '../images/units/Saw-Gerrera.jpg',
  'padme': '../images/units/Padme.png',
  'sabine': '../images/units/Sabine Wren.jpg',
  'zeb': '../images/units/Zeb Orrelios.jpg',
  'chopper': '../images/units/Chopper.jpg',
  'torban': '../images/units/Torban Buck.jpg',
  
  // BOUNTY HUNTERS
  'boba': '../images/units/Boba Fett.png',
  'jango': '../images/units/Jango Fett.webp',
  'cadbane': '../images/units/CadBane.webp',
  'fennec': '../images/units/Fennec Shand.jpg',
  'greedo': '../images/units/Greedo.jpg',
  'mara': '../images/units/Mara Jade.jpg',
  'enfys': '../images/units/Enfys Nest.jpg',
  
  // MANDALORIANS
  'mando': '../images/units/Din Djarin "Mando".webp',
  'bokatan': '../images/units/Bo-Katan Kryze.jpg',
  'armorer': '../images/units/The Armorer.jpg',
  'paz': '../images/units/Paz Vizsla.webp',
  'mandorifles': '../images/units/Mandalorian Rifleman.jpg',
  'mandalore': '../images/units/Mandalore the Ultimate.jpg',
  
  // DROIDS
  'b1s': '../images/units/B1 Battledroids.webp',
  'droidekas': '../images/units/Droidekas.jpg',
  'ultradroids': '../images/units/B3_Ultra_Battle_Droid.webp',
  'magnaguards': '../images/units/magna Guards.webp',
  'tactdroid': '../images/units/ST-series Super Tactical.webp',
  'spiderdroid': '../images/units/OG9.webp',
  'hk47': '../images/units/HK-47.webp',
  'ig11': '../images/units/IG-11.webp',
  'c3po': '../images/units/C3PO.webp',
  'r2d2': '../images/units/R2D2.jpg',
  'k2so': '../images/units/K-2SO.webp',
  'bb8': '../images/units/BB-8.webp',
  
  // OTHER
  'jabba': '../images/units/Jabba.jpg',
  'wookiees': '../images/units/Wookie Fighters.webp',
  'ewoks': '../images/units/Ewok Spearmen.webp',
  'wicket': '../images/units/Wicket.jpg',
  'gungans': '../images/units/Gungan Swordsman.webp',
  'jarjar': '../images/units/Jar Jar Binks.jpg',
  'jawas': '../images/units/Jawas.jpg',
  'grogu': '../images/units/Grogu.jpg',
  'rancor': '../images/units/Rancor.webp',
  'marchion': '../images/units/Marchion Ro.webp',
  'nihilmarauders': '../images/units/Nihil Pirate Marauders.webp',
  'sithpadawan': '../images/units/sith padawan.avif',
  'crosshair': '../images/units/Bad Batch Crosshair.jpg',
  
  // Aliases for units with different IDs
  'arcs': '../images/units/Arc Troopers.jpg',
  'b1droids': '../images/units/B1 Battledroids.webp',
  'clonetroopers': '../images/units/Clone Troopers.webp',
  'rebeltroopers': '../images/units/Rebel Troopers.jpg',
  'wookies': '../images/units/Wookie Fighters.webp',
};

// Variant portraits - FULL PATH from game root
const variantImages = {
  // Vader
  'vader-fallen': '../images/variants/vader-fallen.jpeg',
  'vader-damaged': '../images/variants/vader-damaged.webp',
  
  // Palpatine
  'palpatine-senator': '../images/variants/palpatine-senator.webp',
  'palpatine-clone': '../images/variants/palpatine-clone.jpg',
  
  // Maul
  'maul-young': '../images/variants/maul-young.jpg',
  'maul-spider': '../images/variants/maul-spider.jpg',
  'maul-crimson': '../images/variants/maul-crimson.jpg',
  
  // Yoda
  'yoda-young': '../images/variants/yoda-young.webp',
  'yoda-exile': '../images/variants/yoda-exile.webp',
  
  // Luke
  'luke-farm': '../images/variants/luke-farm.png',
  'luke-jedi': '../images/variants/luke-jedi.webp',
  'luke-dark': '../images/variants/luke-dark.webp',
  
  // Obi-Wan
  'obiwan-young': '../images/variants/obiwan-young.jpeg',
  'obiwan-clone': '../images/variants/obiwan-clone.jpg',
  'obiwan-old': '../images/variants/obiwan-old.png',
  
  // Anakin
  'anakin-young': '../images/variants/anakin-young.webp',
  'anakin-general': '../images/variants/anakin-general.jpeg',
  'anakin-dark': '../images/variants/anakin-dark.jpg',
  
  // Ahsoka
  'ahsoka-young': '../images/variants/ahsoka-young.webp',
  'ahsoka-fulcrum': '../images/variants/ahsoka-fulcrum.jpg',
  'ahsoka-white': '../images/variants/ahsoka-white.webp',
  
  // Han
  'han-young': '../images/variants/han-young.webp',
  'han-general': '../images/variants/han-general.jpg',
  'han-old': '../images/variants/han-old.webp',
  
  // Boba
  'boba-young': '../images/variants/boba-young.jpeg',
  'boba-scarred': '../images/variants/boba-scarred.jpg',
  'boba-daimyo': '../images/variants/boba-daimyo.jpeg',
  
  // Mando
  'mando-young': '../images/variants/mando-young.jpg',
  'mando-beskar': '../images/variants/mando-beskar.jpeg',
  
  // Kylo
  'kylo-ben': '../images/variants/kylo-ben.jpeg',
  'kylo-supreme': '../images/variants/kylo-supreme.jpg',
  
  // Grievous
  'grievous-kaleesh': '../images/variants/grievous-kaleesh.jpg',
  'grievous-4arms': '../images/variants/grievous-4arms.jpg',
  
  // Revan
  'revan-jedi': '../images/variants/Redeemed Jedi revan.jpg',
  'revan-prime': '../images/variants/revan Peak Power.jpg',
  
  // Starkiller
  'starkiller-light': '../images/variants/Redeemed starkiller.png',
  'starkiller-dark': '../images/variants/Sith Stalker starkiller.webp',
  
  // Rey
  'rey-scavenger': '../images/variants/scavenger_rey.webp',
  'rey-jedi': '../images/variants/Rey_jedi.webp',
  'rey-dark': '../images/variants/dark rey.jpg',
  'rey-skywalker': '../images/variants/all the jedi rey.jpg',
  
  // Cal
  'cal-padawan': '../images/variants/PadawanCalKestis.webp',
  'cal-knight': '../images/variants/Jedi Knight cal kestis.png',
  'cal-dark': '../images/variants/Dark Cal kestis.avif',
  
  // Dooku
  'dooku-jedi': '../images/variants/jedi master dooku.png',
  'dooku-tyranus': '../images/variants/Darth Tyranus dooku.webp',
  
  // Thrawn
  'thrawn-exile': '../images/variants/thrawn exiled.webp',
  'thrawn-chiss': '../images/variants/Chiss Ascendancy thrawn.webp',
  
  // Rex
  'rex-arc': '../images/variants/captain-rex-arc.jpeg',
  'rex-rebel': '../images/variants/rex rebel veteran.webp',
  
  // Mace
  'mace-council': '../images/variants/Mace Windu - High Council.png',
  'mace-fallen': '../images/variants/windu survivor.webp',
  
  // Qui-Gon
  'quigon-young': '../images/variants/Qui-Gon Jinn - Knight.png',
  'quigon-ghost': '../images/variants/qui-gon-jinn-ghost.jpeg',
  
  // Jango
  'jango-young': '../images/variants/True Mandalore jango.avif',
  
  // Ventress
  'ventress-witch': '../images/variants/nightsisterventress.jpg',
  'ventress-bounty': '../images/variants/Asajj Ventress - Bounty Hunter.png',
  
  // Grogu
  'grogu-jedi': '../images/variants/Padawan grogu.webp',
  'grogu-armor': '../images/variants/grogu-beskar-armor.avif',
  
  // Bo-Katan
  'bokatan-ruler': "../images/variants/Bo-Katan - Mand'alor.png",
  
  // Ezra
  'ezra-jedi': '../images/variants/jedi padawan ezra.avif',
  'ezra-exile': '../images/variants/ezraexile.jpg',
  'ezra-base': '../images/variants/EzraStreetkid.webp',
  
  // Jar Jar
  'jarjar-dark': '../images/variants/darth_jar_jar.jpg',
};

// Battlefield images - FULL PATH
const battlefieldImages = {
  'mustafar': '../battlefields/mustafar.jpeg',
  'geonosis': '../battlefields/geonosis.jpeg',
  'hoth': '../battlefields/hoth.webp',
  'coruscant': '../battlefields/coruscant.jpg',
  'deathstar': '../battlefields/deathstar.webp',
  'dagobah': '../battlefields/dagobah.jpg',
  'tatooine': '../battlefields/tatooine.webp',
  'endor': '../battlefields/endor.webp',
  'kamino': '../battlefields/kamino.jpg',
  'naboo': '../battlefields/naboo.webp',
  'jakku': '../battlefields/jakku.jpeg',
  'exegol': '../battlefields/exegol.webp',
};

// Music files - FULL PATH
const musicFiles = {
  'mustafar': '../music/mustafar.mp3',
  'geonosis': '../music/geonosis.mp3',
  'hoth': '../music/hoth.mp3',
  'coruscant': '../music/coruscant.mp3',
  'deathstar': '../music/deathstar.mp3',
  'dagobah': '../music/dagobah.mp3',
  'tatooine': '../music/tatooine.mp3',
  'endor': '../music/endor.mp3',
  'kamino': '../music/kamino.mp3',
  'naboo': '../music/naboo.mp3',
  'jakku': '../music/jakku.mp3',
  'exegol': '../music/exegol.mp3',
};

// Simple function to get image path
function getUnitImage(unitId, variantId) {
  // Check variant first
  if (variantId && variantId !== 'base') {
    const variantKey = `${unitId}-${variantId}`;
    if (variantImages[variantKey]) {
      return variantImages[variantKey];
    }
  }
  // Return base unit image
  return unitImages[unitId] || null;
}

// Create portrait image HTML
function createPortraitImg(unitId, variantId, fallbackEmoji, size='100%') {
  const imgPath = getUnitImage(unitId, variantId);
  
  if (!imgPath) {
    debugLog('No image for:', unitId, variantId);
    return `<span class="emoji-fallback" style="font-size:2em;display:flex;align-items:center;justify-content:center;width:100%;height:100%">${fallbackEmoji}</span>`;
  }
  
  debugLog('Loading:', imgPath);
  
  return `<img src="${imgPath}" 
    style="width:${size};height:${size};object-fit:cover;object-position:center top;border-radius:inherit;" 
    onerror="this.style.display='none';this.parentElement.innerHTML='<span class=\\'emoji-fallback\\' style=\\'font-size:2em;display:flex;align-items:center;justify-content:center;width:100%;height:100%\\'>${fallbackEmoji}</span>'" 
    alt="${unitId}">`;
}

// Create battlefield image HTML
function createBattlefieldImg(bfKey, fallbackEmoji) {
  const imgPath = battlefieldImages[bfKey];
  
  if (!imgPath) {
    debugLog('No battlefield image for:', bfKey);
    return `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:5em;opacity:0.3">${fallbackEmoji}</div>`;
  }
  
  return `<img src="${imgPath}" 
    style="width:100%;height:100%;object-fit:cover;"
    onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:5em;opacity:0.3\\'>${fallbackEmoji}</div>'" 
    alt="${bfKey}">`;
}

// Get music file path
function getMusicPath(bfKey) {
  return musicFiles[bfKey] || null;
}

// ============================================
// BATTLEFIELD PREVIEW SYSTEM
// ============================================
function selectRandomBattlefield(){
  selectedBattlefield = BATTLEFIELDS[Math.floor(Math.random() * BATTLEFIELDS.length)];
  const preview = document.getElementById('battlefield-preview');
  if(preview) renderBattlefieldPreview();
}

function rerollBattlefield(){
  playSound('click');
  selectedBattlefield = BATTLEFIELDS[Math.floor(Math.random() * BATTLEFIELDS.length)];
  renderBattlefieldPreview();
}

function renderBattlefieldPreview(){
  const preview = document.getElementById('battlefield-preview');
  if(!preview) return; // Guard against null
  
  if(!selectedBattlefield) {
    selectedBattlefield = BATTLEFIELDS[Math.floor(Math.random() * BATTLEFIELDS.length)];
  }
  const bf = selectedBattlefield;
  
  // Hazard descriptions
  const hazardDescs = {
    'Lava Geyser': 'Random lava eruptions deal 15-30 damage to a random unit each round',
    'Platform Collapse': 'Platforms may collapse, dealing 20-40 falling damage to unlucky units',
    'Arena Beast': 'Wild beasts may enter the arena and attack both teams for 25 damage',
    'Sandstorm': 'Reduces visibility, 20% chance for attacks to miss their target',
    'Wampa Attack': 'A Wampa may emerge from the snow and attack both teams',
    'Blizzard': 'Freezing conditions deal 5 cold damage to all units each round',
    'Gang Ambush': 'Local gangs may attack both sides for 15-25 damage',
    'Collapse': 'Structural collapse deals 10-20 damage to random units',
    'Walls Closing': 'Compactor walls deal 10 crushing damage to all units each round',
    'Dianoga Attack': 'The creature may grab and damage a unit for 20-30 damage',
    'Lightning Strike': 'Random lightning strikes deal 30-50 damage to a single unit',
    'Flooding': 'Rising water levels may drown units, dealing 15 damage over time',
    'Toxic Gas': 'Poisonous gas deals 8 damage per round to all units',
    'Creature Attack': 'Local wildlife may attack random units for 15-25 damage',
    'Rockslide': 'Falling rocks deal 20-35 damage to front line units',
    'Quicksand': 'Units may get stuck, losing their turn and taking 10 damage',
    'Scavenger Droids': 'Droids may steal equipment from random units',
    'Hull Breach': 'Explosive decompression deals 25 damage to all units',
    'Sith Spirits': 'Dark spirits may curse units, reducing their stats by 15%',
    'Force Storm': 'Chaotic Force energy damages everyone for 10-20 damage',
    'Tusken Raiders': 'Raiders may ambush the battlefield, attacking for 20 damage',
    'Sarlacc Pit': 'Units near the pit may be grabbed and take 30 damage per round',
    'Gungan Cavalry': 'Gungan warriors may join the fray as hostile NPCs',
    'Sea Monster': 'Underwater creature attacks surface units for 25-40 damage',
    'Imperial Patrol': 'Stormtroopers may investigate and attack both sides',
    'Scrap Collapse': 'Falling debris damages random units for 15-25 damage'
  };
  
  // Build hazard HTML with tooltips
  const hazardsHtml = bf.hazards.map(h => {
    const desc = hazardDescs[h] || 'Environmental hazard that may occur during battle';
    return `<span class="hazard-tag"> ${h}<div class="tooltip"><strong style="color:var(--red)"> ${h}</strong><br>${desc}</div></span>`;
  }).join(' ');
  
  // Build NPC HTML with tooltips
  const npcsHtml = bf.npcs.map(n => {
    const typeClass = n.hostile ? 'hostile' : 'friendly';
    const typeLabel = n.hostile ? ' HOSTILE' : ' FRIENDLY';
    const typeColor = n.hostile ? 'var(--red)' : 'var(--green)';
    return `<span class="npc-tag ${typeClass}">${n.emoji} ${n.name}<div class="tooltip">
      <div class="npc-type" style="color:${typeColor}">${typeLabel}</div>
      <div>${n.msg}</div>
      <div class="npc-stats">HP: ${n.hp} | ATK: ${n.atk} | DEF: ${n.def}</div>
    </div></span>`;
  }).join(' ');
  
  preview.style.display = 'block';
  preview.innerHTML = `
    <div class="bf-preview-header">
      <div class="bf-preview-title">${bf.emoji} ${bf.name}</div>
      <button class="bf-preview-reroll" onclick="rerollBattlefield()"> Reroll Battlefield</button>
    </div>
    <div class="bf-preview-image">${createBattlefieldImg(bf.image, bf.emoji)}</div>
    <div class="bf-preview-info">
      <div class="bf-preview-terrain">
        <div class="icon">${bf.terrain.desc.split(' ')[0]}</div>
        <div class="text">${bf.terrain.desc.substring(bf.terrain.desc.indexOf(' ')+1)}</div>
      </div>
      <div class="bf-preview-hazards">
        Hazards: ${hazardsHtml}
      </div>
      <div class="bf-preview-npcs">
        Encounters: ${npcsHtml}
      </div>
    </div>
  `;
}

// ============================================
// DRAG AND DROP SYSTEM
// ============================================
function initDragDrop(){
  // This is called after rendering to attach drag events
}

function handleUnitDragStart(e, uid){
  draggedUnit = uid;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', uid);
}

function handleUnitDragEnd(e){
  draggedUnit = null;
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function handleEquipDragStart(e, equipName, equipIndex){
  draggedEquip = {name: equipName, index: equipIndex};
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', equipName);
}

function handleEquipDragEnd(e){
  draggedEquip = null;
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function handleDropZoneDragOver(e){
  e.preventDefault();
  e.target.closest('.drop-zone, .battle-unit')?.classList.add('drag-over');
}

function handleDropZoneDragLeave(e){
  e.target.closest('.drop-zone, .battle-unit')?.classList.remove('drag-over');
}

function handleFormationDrop(e, formation){
  e.preventDefault();
  e.target.classList.remove('drag-over');
  
  if(!draggedUnit) return;
  const p = players[active];
  const unit = p.units.find(u => u.uid == draggedUnit);
  if(!unit) return;
  
  // Remove from both formations
  p.formation.front = p.formation.front.filter(id => id != draggedUnit);
  p.formation.back = p.formation.back.filter(id => id != draggedUnit);
  
  // Add to new formation
  if(formation === 'front'){
    p.formation.front.push(unit.uid);
  } else {
    p.formation.back.push(unit.uid);
  }
  
  playSound('click');
  renderTeams();
  renderFormation();
  draggedUnit = null;
}

function handleLeaderDrop(e){
  e.preventDefault();
  e.target.classList.remove('drag-over');
  
  if(!draggedUnit) return;
  const p = players[active];
  const unit = p.units.find(u => u.uid == draggedUnit);
  if(!unit) return;
  
  p.leader = unit.uid;
  p.noLeader = false;
  
  playSound('click');
  renderTeams();
  renderFormation();
  draggedUnit = null;
}

function handleUnitEquipDrop(e, uid){
  e.preventDefault();
  e.target.closest('.battle-unit')?.classList.remove('drag-over');
  
  if(!draggedEquip) return;
  const p = players[active];
  const unit = p.units.find(u => u.uid == uid);
  if(!unit) return;
  
  // Remove equipment from any other unit
  p.units.forEach(u => {
    if(u.equipment){
      u.equipment = u.equipment.filter(eq => eq !== draggedEquip.name);
    }
  });
  
  // Assign to this unit
  if(!unit.equipment) unit.equipment = [];
  if(!unit.equipment.includes(draggedEquip.name)){
    unit.equipment.push(draggedEquip.name);
  }
  
  playSound('click');
  renderTeams();
  renderEquipment();
  draggedEquip = null;
}

// COMBAT DIALOGUE SYSTEM
const COMBAT_QUOTES={
  'vader':{
    attack:["I find your lack of faith disturbing.","You are beaten. It is useless to resist.","The circle is now complete."],
    defend:["Impressive. Most impressive.","You have controlled your fear.","Your powers are weak."],
    kill:["You should not have come back.","All too easy.","There is no escape."],
    death:["Tell your sister... you were right...","*heavy breathing stops*"]
  },
  'luke':{
    attack:["I'll never turn to the dark side!","You'll find I'm full of surprises!","This is for the Rebellion!"],
    defend:["I can feel the conflict within you.","There is still good in you."],
    kill:["I'm sorry it had to end this way.","The Force was with me."],
    death:["Father... I won't leave you...","No... not like this..."]
  },
  'palpatine':{
    attack:["UNLIMITED POWER!","Now you will experience the full power of the dark side!","Good... good... let the hate flow through you!"],
    defend:["I am the Senate!","Your feeble skills are no match for the dark side!"],
    kill:["Now, young Skywalker... you will die.","Everything is proceeding as I have foreseen."],
    death:["No... NO... NOOOO!","*cackling turns to screaming*"]
  },
  'yoda':{
    attack:["Strong am I with the Force!","Underestimate me, do not!","Judge me by my size, do you?"],
    defend:["Do or do not. There is no try.","The Force, my ally is."],
    kill:["Powerful you have become, but not that powerful.","Ended, this contest is."],
    death:["When gone am I, the last of the Jedi will you be...","Strong in the Force... you are..."]
  },
  'obiwan':{
    attack:["Hello there!","You were supposed to destroy the Sith!","So uncivilized."],
    defend:["You cannot win, Darth.","I have the high ground!"],
    kill:["You were my brother, Anakin!","It's over!"],
    death:["Strike me down and I shall become more powerful...","The Force will be with you... always..."]
  },
  'maul':{
    attack:["At last we will reveal ourselves!","I shall have my REVENGE!","You cannot imagine the depths I would go to!"],
    defend:["Every step you have taken has led to THIS!","I was apprentice to the most powerful being in the galaxy!"],
    kill:["Revenge... I must have REVENGE!","Truly, you are weak."],
    death:["He will... avenge us...","Is it... the Chosen One...?"]
  },
  'ahsoka':{
    attack:["I am no Jedi!","You're not my master anymore!","For the Clone Wars fallen!"],
    defend:["I've been trained to defend the Republic!","Try harder!"],
    kill:["This is what happens when you cross a Togruta.","Rest now."],
    death:["Anakin... I knew there was good in you...","Master..."]
  },
  'anakin':{
    attack:["This is where the fun begins!","I HATE YOU!","You underestimate my power!"],
    defend:["I'm a slow learner.","My powers have doubled!"],
    kill:["I'm sorry. I wasn't strong enough.","Don't make me destroy you."],
    death:["I... I couldn't save them...","Padm..."]
  },
  'boba':{
    attack:["He's no good to me dead.","I'm just a simple man making my way through the galaxy.","As you wish."],
    defend:["I'm worth a lot to me.","You're not worth the carbonite."],
    kill:["Nothing personal.","Target eliminated."],
    death:["What... the Sarlacc couldn't do...","Not... like this..."]
  },
  'han':{
    attack:["Never tell me the odds!","Great shot kid, that was one in a million!","Hokey religions are no match for a good blaster!"],
    defend:["I've got a bad feeling about this...","Boring conversation anyway."],
    kill:["Sorry about the mess.","That's two you owe me, junior."],
    death:["Ben...","Chewie... take care of her..."]
  },
  'chewie':{
    attack:["RRRAARRWHHGWWR!","AAARARRRGWWWH!","GRRRRAAAWWRRRR!"],
    defend:["Rrrrrrr-Loss!","RAWRGWAWGGR!"],
    kill:["RRWWWGG!","*victorious roar*"],
    death:["Rrrr... aaahhh...","*mournful wail*"]
  },
  'grievous':{
    attack:["Your lightsabers will make a fine addition to my collection!","Army or not, you must realize you are doomed!","I will deal with this Jedi slime myself!"],
    defend:["You fool! I've been trained in your Jedi arts by Count Dooku!","*coughing intensifies*"],
    kill:["Time to abandon ship.","Another fine addition."],
    death:["*mechanical wheezing*","Jedi... SCUM..."]
  },
  'default':{
    attack:["Prepare yourself!","Face me!","You will fall!"],
    defend:["Is that all you've got?","Pathetic!","I expected more!"],
    kill:["Victory is mine!","You were no match for me.","Rest in pieces."],
    death:["This... cannot be...","I... failed...","Avenge... me..."]
  }
};

function getCombatQuote(unitId,type){
  const quotes=COMBAT_QUOTES[unitId]||COMBAT_QUOTES['default'];
  const typeQuotes=quotes[type]||COMBAT_QUOTES['default'][type];
  return typeQuotes[Math.floor(Math.random()*typeQuotes.length)];
}

// Current fighters being displayed
let currentFighters={attacker:null,defender:null};

function pick(a){return a[Math.floor(Math.random()*a.length)];}
function toast(m,e,duration=2500){const t=document.getElementById('toast');t.textContent=m;t.className='toast'+(e?' error':'');setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),duration);}
function anim(c,type){if(!battle)return;for(let pi=0;pi<battle.players.length;pi++){const idx=battle.players[pi].combatants.indexOf(c);if(idx>=0){const el=document.getElementById(`u-${pi}-${idx}`);if(el){el.classList.remove('hit','heal','lightning','crit','shake','block','poison','death');void el.offsetWidth;el.classList.add(type);setTimeout(()=>el.classList.remove(type),type==='death'?600:500);}break;}}}

// VISUAL BATTLE ARENA FUNCTIONS
function showBattleArena(show, bf){
  const arena = document.getElementById('battle-arena');
  const bg = document.getElementById('arena-bg');
  if(!arena) return;
  arena.style.display = show ? 'block' : 'none';
  
  if(show && bf && bg){
    bg.innerHTML = createBattlefieldImg(bf.image, bf.emoji);
  }
}

function updateFighterPortrait(side,unit){
  const portrait=document.getElementById(`portrait-${side}`);
  const nameEl=document.getElementById(`name-${side}`);
  const hpFill=document.getElementById(`hp-${side}`);
  const hpText=document.getElementById(`hp-text-${side}`);
  
  if(!unit){
    portrait.innerHTML='<span class="emoji-fallback"></span>';
    portrait.classList.add('dead');
    nameEl.textContent='Defeated';
    return;
  }
  
  const emoji=unit.emoji;
  portrait.innerHTML=createPortraitImg(unit.id, unit.variant, emoji, '100%');
  portrait.className='fighter-portrait';
  
  // Use full combat name: "Palpatine: Dark Emperor" not just "Dark Emperor"
  nameEl.textContent=getCombatName(unit);
  nameEl.style.color=unit.ownerColor||'var(--gold)';
  
  const hpPct=Math.max(0,(unit.curHp/unit.maxHp)*100);
  hpFill.style.width=hpPct+'%';
  hpFill.className='fighter-hp-fill'+(hpPct>60?'':hpPct>30?' mid':' low');
  hpText.textContent=`${Math.round(unit.curHp)}/${unit.maxHp}`;
}

function animateCombat(attacker,defender,damage,isSpecial,isCrit,isKill){
  const leftSide=battle.players[0].combatants.includes(attacker);
  const atkSide=leftSide?'left':'right';
  const defSide=leftSide?'right':'left';
  
  // Update portraits
  updateFighterPortrait('left',leftSide?attacker:defender);
  updateFighterPortrait('right',leftSide?defender:attacker);
  
  const atkPortrait=document.getElementById(`portrait-${atkSide}`);
  const defPortrait=document.getElementById(`portrait-${defSide}`);
  const effects=document.getElementById('combat-effects');
  const dialogue=document.getElementById('combat-dialogue');
  
  // Clear previous effects
  effects.innerHTML='';
  atkPortrait.classList.remove('attacking','defending','dead','healing','special');
  defPortrait.classList.remove('attacking','defending','dead','healing','special');
  
  // Attacker animation
  atkPortrait.classList.add(isSpecial?'special':'attacking');
  if(atkSide==='right')atkPortrait.style.animation='attackSlideRight 0.5s ease-out';
  else atkPortrait.style.animation='';
  
  // Defender animation
  setTimeout(()=>{
    defPortrait.classList.add('defending');
    
    // Show damage number
    const dmgEl=document.createElement('div');
    dmgEl.className='damage-number';
    dmgEl.textContent='-'+Math.round(damage);
    dmgEl.style.left=defSide==='left'?'25%':'75%';
    dmgEl.style.top='40%';
    if(isCrit)dmgEl.style.fontSize='2.2em';
    effects.appendChild(dmgEl);
    
    // Show slash effect
    const slashEl=document.createElement('div');
    slashEl.className='slash-effect';
    slashEl.textContent=isSpecial?'':isCrit?'':'';
    effects.appendChild(slashEl);
    
    // Screen shake on big hits
    if(damage>40||isCrit){
      document.getElementById('battle-arena').classList.add('screen-shake');
      setTimeout(()=>document.getElementById('battle-arena').classList.remove('screen-shake'),300);
    }
    
    // Update defender HP
    updateFighterPortrait(defSide,defender);
  },250);
  
  // Combat dialogue
  const quoteType=isKill?'kill':'attack';
  const quote=getCombatQuote(attacker.id,quoteType);
  const actionText=isKill?
    `<span class="action">${defender.name} ${pick(GORE.death)}!</span>`:
    `<span class="action">${pick(GORE.slash)} ${defender.name}!</span>`;
  
  dialogue.innerHTML=`<span class="speaker">${attacker.name}:</span> "<span class="quote">${quote}</span>"<br>${actionText} <strong style="color:var(--red)">${Math.round(damage)} DMG${isCrit?' CRIT!':''}</strong>`;
  
  // Handle death
  if(isKill){
    setTimeout(()=>{
      defPortrait.classList.add('dead');
      const deathQuote=getCombatQuote(defender.id,'death');
      dialogue.innerHTML+=`<br><span class="speaker" style="color:#888">${defender.name}:</span> "<span class="quote" style="color:#888">${deathQuote}</span>"`;
      
      // Blood splatter effect
      for(let i=0;i<3;i++){
        const blood=document.createElement('div');
        blood.className='blood-splatter';
        blood.textContent='';
        blood.style.left=(defSide==='left'?20:70)+Math.random()*15+'%';
        blood.style.top=30+Math.random()*40+'%';
        blood.style.animationDelay=i*0.1+'s';
        effects.appendChild(blood);
      }
    },500);
  }
}

function animateHeal(healer,target,amount){
  const leftSide=battle.players[0].combatants.includes(healer);
  
  updateFighterPortrait('left',leftSide?healer:target);
  updateFighterPortrait('right',leftSide?target:healer);
  
  const targetSide=leftSide?'right':'left';
  const portrait=document.getElementById(`portrait-${targetSide}`);
  const effects=document.getElementById('combat-effects');
  const dialogue=document.getElementById('combat-dialogue');
  
  portrait.classList.add('healing');
  
  const healEl=document.createElement('div');
  healEl.className='damage-number heal-number';
  healEl.textContent='+'+Math.round(amount);
  healEl.style.left=targetSide==='left'?'25%':'75%';
  healEl.style.top='40%';
  effects.appendChild(healEl);
  
  dialogue.innerHTML=`<span class="speaker" style="color:var(--green)">${healer.name}</span> heals <span class="speaker">${target.name}</span> for <strong style="color:var(--green)">+${Math.round(amount)} HP</strong>!`;
}

function animateSpecialAbility(unit,abilityName,targets){
  const leftSide=battle.players[0].combatants.includes(unit);
  updateFighterPortrait(leftSide?'left':'right',unit);
  
  const portrait=document.getElementById(`portrait-${leftSide?'left':'right'}`);
  const dialogue=document.getElementById('combat-dialogue');
  
  portrait.classList.add('special');
  
  const quote=getCombatQuote(unit.id,'attack');
  dialogue.innerHTML=`<span class="speaker" style="color:var(--purple)">${unit.name}</span> uses <strong style="color:var(--purple)">${abilityName}</strong>!<br>"<span class="quote">${quote}</span>"`;
}

function updateArenaRound(round){
  document.getElementById('arena-round').textContent=` ROUND ${round} `;
}

// SAVE/LOAD TEAM FUNCTIONS
function getSavedTeams(){try{return JSON.parse(localStorage.getItem('galaxyClashTeams')||'[]');}catch(e){return[];}}
function setSavedTeams(teams){localStorage.setItem('galaxyClashTeams',JSON.stringify(teams));}

function saveTeam(){
  const p=players[active];
  if(!p.units.length){toast('No units to save!',true);return;}
  const name=prompt('Enter team name:',`${p.name} Team`);
  if(!name)return;
  const teams=getSavedTeams();
  const team={name,units:p.units.map(u=>u.id),spent:p.spent,date:Date.now()};
  teams.unshift(team);
  if(teams.length>20)teams.pop();
  setSavedTeams(teams);
  toast(`Team "${name}" saved!`);
  showSavedTeams();
}

function showSavedTeams(){
  const teams=getSavedTeams();
  const container=document.getElementById('saved-teams-list');
  if(!teams.length){container.innerHTML='<div class="saved-teams"><span style="color:#666;font-size:0.7em">No saved teams yet</span></div>';return;}
  container.innerHTML=`<div class="saved-teams">${teams.map((t,i)=>`
    <div class="saved-team">
      <span class="name">${t.name}</span>
      <span class="cost">$${t.spent?.toFixed(1)||'?'}</span>
      <div class="actions">
        <button class="load-btn" onclick="loadTeam(${i})">Load</button>
        <button class="del-btn" onclick="deleteTeam(${i})"></button>
      </div>
    </div>`).join('')}</div>`;
}

function loadTeam(idx){
  const teams=getSavedTeams();
  const team=teams[idx];
  if(!team)return;
  const p=players[active];
  p.units=[];p.spent=0;
  team.units.forEach(id=>{
    const u=UNITS.find(x=>x.id===id);
    if(u&&p.spent+u.cost<=BUDGET){
      p.units.push({...u,uid:Date.now()+Math.random()});
      p.spent+=u.cost;
    }
  });
  renderTabs();renderRoster();renderTeams();
  toast(`Loaded "${team.name}"!`);
  document.getElementById('saved-teams-list').innerHTML='';
}

function deleteTeam(idx){
  const teams=getSavedTeams();
  const name=teams[idx]?.name;
  if(!confirm(`Delete "${name}"?`))return;
  teams.splice(idx,1);
  setSavedTeams(teams);
  toast(`Deleted "${name}"`);
  showSavedTeams();
}

function exportTeams(){
  const teams=getSavedTeams();
  if(!teams.length){toast('No teams to export!',true);return;}
  const data=JSON.stringify(teams,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='galaxy-clash-teams.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Teams exported!');
}

function importTeams(){
  const input=document.createElement('input');
  input.type='file';input.accept='.json';
  input.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const imported=JSON.parse(ev.target.result);
        if(!Array.isArray(imported))throw new Error('Invalid format');
        const existing=getSavedTeams();
        const merged=[...imported,...existing].slice(0,20);
        setSavedTeams(merged);
        toast(`Imported ${imported.length} teams!`);
        showSavedTeams();
      }catch(err){toast('Invalid file format!',true);}
    };
    reader.readAsText(file);
  };
  input.click();
}

// Tournament state
let tournament = null;

function setMode(m){
  mode=m;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  const modeBtn=document.getElementById('mode-'+m);
  if(modeBtn)modeBtn.classList.add('active');
  players=[];
  aiMode=(m==='ai');
  tournament = null;
  
  // Show/hide AI difficulty bar
  const aiBar=document.getElementById('ai-bar');
  if(aiBar)aiBar.style.display=aiMode?'flex':'none';
  
  // Show/hide tournament panel
  const tournamentPanel = document.getElementById('tournament-panel');
  if(tournamentPanel) tournamentPanel.style.display = m==='tournament' ? 'block' : 'none';
  
  if(m==='classic'||m==='ai'){
    players=[
      {id:'p1',name:'Player 1',units:[],equipment:[],spent:0,color:COLORS[0],leader:null,noLeader:false,formation:{front:[],back:[]}},
      {id:'p2',name:aiMode?AI_NAMES[aiDifficulty]:'Player 2',units:[],equipment:[],spent:0,color:COLORS[1],leader:null,noLeader:false,formation:{front:[],back:[]}}
    ];
    if(aiMode)generateAITeam();
  } else if(m==='tournament'){
    // Tournament mode - 4 teams
    for(let i=0;i<4;i++){
      players.push({
        id:'p'+i,
        name:getRandomTeamName(),
        units:[],equipment:[],spent:0,
        color:COLORS[i],
        leader:null,noLeader:false,
        formation:{front:[],back:[]}
      });
    }
    showTournamentSetup();
  } else {
    for(let i=0;i<4;i++)players.push({id:'p'+i,name:'Player '+(i+1),units:[],equipment:[],spent:0,color:COLORS[i],alliance:m==='teams'?(i<2?'A':'B'):'none',leader:null,noLeader:false,formation:{front:[],back:[]}});
  }
  active=0;selectRandomBattlefield();renderTabs();renderRoster();renderTeams();renderFormation();renderEquipment();
}

// Tournament System
function showTournamentSetup(){
  const panel = document.getElementById('tournament-panel');
  if(!panel) return;
  
  panel.innerHTML = `
    <div class="tournament-setup">
      <div class="tournament-title"> TOURNAMENT MODE</div>
      <div class="tournament-desc">Set up 4 teams to compete in a bracket tournament!</div>
      
      <div class="tournament-bracket-preview">
        <div class="bracket-round">
          <div class="bracket-match">
            <div class="bracket-team" style="border-color:${players[0]?.color}">${players[0]?.name || 'Team 1'}</div>
            <div class="bracket-vs">VS</div>
            <div class="bracket-team" style="border-color:${players[1]?.color}">${players[1]?.name || 'Team 2'}</div>
          </div>
          <div class="bracket-match">
            <div class="bracket-team" style="border-color:${players[2]?.color}">${players[2]?.name || 'Team 3'}</div>
            <div class="bracket-vs">VS</div>
            <div class="bracket-team" style="border-color:${players[3]?.color}">${players[3]?.name || 'Team 4'}</div>
          </div>
        </div>
        <div class="bracket-connector"></div>
        <div class="bracket-round finals">
          <div class="bracket-match">
            <div class="bracket-team"> FINALS </div>
          </div>
        </div>
      </div>
      
      <div class="tournament-options">
        <button class="btn" onclick="randomizeAllTournamentTeams()"> Randomize All Teams</button>
        <button class="btn" onclick="startTournament()" ${players.every(p=>p.units.length>=1)?'':'disabled'}> START TOURNAMENT</button>
      </div>
      
      <div class="tournament-tip"> Select each team tab to customize their roster, or randomize all!</div>
    </div>
  `;
}

function randomizeAllTournamentTeams(){
  players.forEach((p, i) => {
    p.units = [];
    p.equipment = [];
    p.spent = 0;
    p.leader = null;
    p.formation = {front: [], back: []};
    p.name = getRandomTeamName();
    
    // Random units
    let rem = BUDGET;
    const shuffled = [...UNITS].sort(() => Math.random() - 0.5);
    for(const u of shuffled){
      if(u.cost <= rem && (u.stack || !p.units.some(x => x.id === u.id))){
        const newUnit = {...u, uid: Date.now() + Math.random() + i};
        if(VARIANTS[u.id] && Math.random() < 0.5){
          const v = pick(VARIANTS[u.id]);
          newUnit.variant = v.id;
          newUnit.variantName = v.name;
        }
        p.units.push(newUnit);
        p.spent += u.cost;
        rem -= u.cost;
        if(u.def >= 70 || u.hp >= 180) p.formation.front.push(newUnit.uid);
        else p.formation.back.push(newUnit.uid);
        if(p.units.length >= 5) break;
      }
    }
    // Set leader
    if(p.units.length){
      const best = p.units.reduce((a, b) => a.cost > b.cost ? a : b);
      p.leader = best.uid;
    }
  });
  
  renderTabs();
  renderRoster();
  renderTeams();
  renderFormation();
  showTournamentSetup();
  toast('All tournament teams randomized!');
}

function startTournament(){
  // Validate all teams have units
  if(!players.every(p => p.units.length >= 1)){
    toast('All teams need at least 1 unit!', true);
    return;
  }
  
  tournament = {
    teams: players.map(p => ({...p})), // Copy team states
    bracket: [
      {match: 1, team1: 0, team2: 1, winner: null},
      {match: 2, team1: 2, team2: 3, winner: null},
      {match: 3, team1: null, team2: null, winner: null} // Finals
    ],
    currentMatch: 0,
    results: [],
    champion: null
  };
  
  playSound('fanfare');
  showTournamentBracket();
}

function showTournamentBracket(){
  const t = tournament;
  const match1 = t.bracket[0];
  const match2 = t.bracket[1];
  const finals = t.bracket[2];
  
  const getTeamDisplay = (teamIdx, winner) => {
    if(teamIdx === null) return '<div class="bracket-team tbd">TBD</div>';
    const team = t.teams[teamIdx];
    const isWinner = winner === teamIdx;
    const isLoser = winner !== null && winner !== teamIdx;
    return `<div class="bracket-team ${isWinner?'winner':''} ${isLoser?'loser':''}" style="border-color:${team.color}">${team.name}</div>`;
  };
  
  document.getElementById('winner').innerHTML = `
    <div class="tournament-bracket-screen">
      <div class="tournament-header"> TOURNAMENT BRACKET</div>
      
      <div class="bracket-display">
        <div class="bracket-column round1">
          <div class="bracket-label">SEMI-FINALS</div>
          <div class="bracket-match ${t.currentMatch === 0 ? 'current' : match1.winner !== null ? 'complete' : ''}">
            ${getTeamDisplay(match1.team1, match1.winner)}
            <div class="bracket-vs">VS</div>
            ${getTeamDisplay(match1.team2, match1.winner)}
          </div>
          <div class="bracket-match ${t.currentMatch === 1 ? 'current' : match2.winner !== null ? 'complete' : ''}">
            ${getTeamDisplay(match2.team1, match2.winner)}
            <div class="bracket-vs">VS</div>
            ${getTeamDisplay(match2.team2, match2.winner)}
          </div>
        </div>
        
        <div class="bracket-lines">
          <div class="line-connector"></div>
        </div>
        
        <div class="bracket-column finals">
          <div class="bracket-label"> FINALS</div>
          <div class="bracket-match ${t.currentMatch === 2 ? 'current' : finals.winner !== null ? 'champion' : ''}">
            ${getTeamDisplay(finals.team1, finals.winner)}
            <div class="bracket-vs">VS</div>
            ${getTeamDisplay(finals.team2, finals.winner)}
          </div>
        </div>
      </div>
      
      ${t.champion !== null ? `
        <div class="tournament-champion">
          <div class="champion-title"> CHAMPION </div>
          <div class="champion-name" style="color:${t.teams[t.champion].color}">${t.teams[t.champion].name}</div>
        </div>
        <button class="btn" onclick="closeTournament()"> FINISH</button>
      ` : `
        <div class="bracket-actions">
          <button class="btn" onclick="playNextTournamentMatch()"> PLAY MATCH ${t.currentMatch + 1}</button>
          <button class="btn sec" onclick="closeTournament()"> Cancel Tournament</button>
        </div>
      `}
    </div>
  `;
  document.getElementById('winner').classList.add('show');
}

function playNextTournamentMatch(){
  const t = tournament;
  const matchIdx = t.currentMatch;
  const match = t.bracket[matchIdx];
  
  if(match.team1 === null || match.team2 === null){
    toast('Waiting for previous matches to complete!', true);
    return;
  }
  
  // Set up the battle between these two teams
  closeWinner();
  
  // Restore team states for this match
  players = [
    JSON.parse(JSON.stringify(t.teams[match.team1])),
    JSON.parse(JSON.stringify(t.teams[match.team2]))
  ];
  players[0].id = 'p1';
  players[1].id = 'p2';
  
  // Regenerate UIDs to avoid conflicts
  players.forEach(p => {
    p.units.forEach(u => {
      const oldUid = u.uid;
      u.uid = Date.now() + Math.random();
      if(p.leader === oldUid) p.leader = u.uid;
      p.formation.front = p.formation.front.map(x => x === oldUid ? u.uid : x);
      p.formation.back = p.formation.back.map(x => x === oldUid ? u.uid : x);
    });
  });
  
  active = 0;
  aiMode = false;
  selectRandomBattlefield();
  renderTabs();
  renderTeams();
  renderFormation();
  
  toast(`Match ${matchIdx + 1}: ${players[0].name} vs ${players[1].name}!`);
  
  // Auto-start battle
  setTimeout(() => startBattle(), 500);
}

function continueTournament(){
  closeWinner();
  
  if(!tournament) return;
  
  // Determine winner from last battle
  const t = tournament;
  const matchIdx = t.currentMatch;
  const match = t.bracket[matchIdx];
  
  // Find which team won (by checking which player still exists with units)
  // The winner's name should match one of the tournament teams
  const lastWinnerName = t.results[t.results.length - 1]?.winner;
  
  let winnerIdx = null;
  if(t.teams[match.team1].name === lastWinnerName) winnerIdx = match.team1;
  else if(t.teams[match.team2].name === lastWinnerName) winnerIdx = match.team2;
  
  if(winnerIdx !== null){
    match.winner = winnerIdx;
    
    // Update finals bracket
    if(matchIdx === 0) t.bracket[2].team1 = winnerIdx;
    else if(matchIdx === 1) t.bracket[2].team2 = winnerIdx;
    else if(matchIdx === 2) t.champion = winnerIdx;
    
    t.currentMatch++;
  }
  
  // Check if tournament is complete
  if(t.champion !== null){
    playSound('tournamentWin');
    // Add achievement
    checkAchievement('tournament_champion');
  }
  
  showTournamentBracket();
}

function closeTournament(){
  closeWinner();
  tournament = null;
  setMode('classic');
}

function renderTabs(){
  const ptabs=document.getElementById('ptabs');
  if(!ptabs)return;
  // In AI mode, only show player 1 tab
  const tabPlayers=aiMode?[players[0]]:players;
  ptabs.innerHTML=tabPlayers.map((p,i)=>`<div class="p-tab ${i===active?'active':''}" onclick="setActive(${i})" style="color:${p.color}">${p.name}<br>$${p.spent.toFixed(1)}</div>`).join('');
  if(aiMode){
    ptabs.innerHTML+=`<div class="p-tab" style="color:${players[1].color};opacity:0.6;pointer-events:none">${players[1].name}<br> AI</div>`;
  }
}
function setActive(i){if(aiMode&&i>0)return;active=i;renderTabs();renderRoster();}

// Budget control
function updateBudget(val){
  const newBudget = Math.max(5, Math.min(100, parseInt(val) || 15));
  BUDGET = newBudget;
  document.getElementById('budget-input').value = newBudget;
  document.getElementById('budget-display').textContent = newBudget;
  
  // Update preset buttons
  document.querySelectorAll('.budget-preset').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.textContent.replace('$','')) === newBudget);
  });
  
  renderRoster();
  renderTabs();
}

// Search and filter functions
function filterRoster(){
  searchQuery = document.getElementById('roster-search').value.toLowerCase();
  renderRoster();
}

function clearSearch(){
  document.getElementById('roster-search').value = '';
  searchQuery = '';
  renderRoster();
}

function setFilter(filter){
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });
  renderRoster();
}

function matchesFilter(unit){
  if(currentFilter === 'all') return true;
  const faction = unit.faction.toLowerCase();
  switch(currentFilter){
    case 'jedi': return faction === 'jedi';
    case 'sith': return faction === 'sith' || faction === 'nightsister';
    case 'empire': return faction === 'empire' || faction === 'separatist';
    case 'rebel': return faction === 'rebel' || faction === 'republic';
    case 'bounty': return faction === 'bounty hunter';
    case 'mando': return faction === 'mandalorian';
    case 'droid': return faction === 'droid';
    case 'other': return !['jedi','sith','empire','rebel','republic','bounty hunter','mandalorian','droid','nightsister','separatist'].includes(faction);
    default: return true;
  }
}

function matchesSearch(unit){
  if(!searchQuery) return true;
  return unit.name.toLowerCase().includes(searchQuery) || 
         unit.faction.toLowerCase().includes(searchQuery) ||
         (unit.desc && unit.desc.toLowerCase().includes(searchQuery)) ||
         (unit.special && unit.special.toLowerCase().includes(searchQuery));
}

function renderRoster(){
  const roster=document.getElementById('roster');
  const spent=document.getElementById('spent');
  if(!roster||!players[active])return;
  const p=players[active];
  if(spent)spent.textContent=p.spent.toFixed(1);
  
  // Filter and sort units
  const filteredUnits = UNITS.filter(u => matchesFilter(u) && matchesSearch(u));
  
  // Sort units: selected units first, then by cost
  const sortedUnits = filteredUnits.sort((a, b) => {
    const aSelected = p.units.some(u => u.id === a.id);
    const bSelected = p.units.some(u => u.id === b.id);
    if (aSelected && !bSelected) return -1;
    if (!aSelected && bSelected) return 1;
    return b.cost - a.cost; // Then by cost descending
  });
  
  if(sortedUnits.length === 0){
    roster.innerHTML = `<div style="text-align:center;color:#666;padding:20px">No units match your search/filter</div>`;
    return;
  }
  
  roster.innerHTML = sortedUnits.map(u=>{
    const cnt=p.units.filter(x=>x.id===u.id).length;
    const canAdd=(u.stack||cnt===0)&&p.spent+u.cost<=BUDGET;
    const dis=!canAdd&&cnt===0;
    return `<div class="u-card ${cnt?'sel':''} ${dis?'dis':''}" 
      onclick="showModal('${u.id}')"
      draggable="${!dis}"
      ondragstart="handleRosterDragStart(event,'${u.id}')"
      ondragend="handleRosterDragEnd(event)">
      ${cnt?`<div class="sel-count">${cnt}</div>`:''}
      <div class="u-img">${createPortraitImg(u.id, null, u.emoji, '100%')}</div>
      <div class="u-info">
        <div class="u-name">${u.name}</div>
        <div class="u-cost">$${u.cost}</div>
        <div class="u-stats">HP:<span>${u.hp}</span> ATK:<span>${u.atk}</span></div>
      </div>
    </div>`;
  }).join('');
}

// Roster drag handlers
let draggedRosterUnit = null;

function handleRosterDragStart(e, unitId){
  draggedRosterUnit = unitId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'copy';
  e.dataTransfer.setData('text/plain', 'roster:' + unitId);
}

function handleRosterDragEnd(e){
  draggedRosterUnit = null;
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function getSynergies(units){
  const s=[];
  if(units.filter(u=>u.faction==='Republic').length>=3)s.push({msg:'Clone Brotherhood: 3+ Clones = +10% DEF'});
  if(units.filter(u=>u.faction==='Sith').length>=2)s.push({msg:'Rule of Two: 2 Sith = +15% ATK'});
  if(units.filter(u=>u.faction==='Jedi').length>=3)s.push({msg:'Jedi Council: 3+ Jedi = +8% ATK/DEF'});
  if(units.filter(u=>u.faction==='Bounty Hunter').length>=2)s.push({msg:'Hunter Duo: 2+ Hunters = +12% ATK'});
  if(units.filter(u=>u.faction==='Rebel').length>=3)s.push({msg:'Rebel Alliance: 3+ Rebels = +8% stats'});
  return s;
}

function showModal(id, preSelectedVariant = 'base', editUid = null){
  const u=UNITS.find(x=>x.id===id);if(!u)return;const p=players[active];
  const existing=p.units.filter(x=>x.id===u.id);
  const cnt=existing.length;
  const variants=VARIANTS[u.id]||[];
  const hasVariants=variants.length>0;
  
  // Store the editing UID globally
  editingUnitUid = editUid;
  
  // For existing units, find the specific one being edited (or use first)
  const currentUnit = editUid ? p.units.find(x => x.uid === editUid) : existing[0];
  const selectedVariant = currentUnit ? (currentUnit.variant || 'base') : preSelectedVariant;
  const currentEquip=currentUnit?.equipment||[];
  const isEditing = !!currentUnit;
  
  // Calculate cost with selected variant
  const variantData = variants.find(v => v.id === selectedVariant);
  const variantCost = variantData?.cost || 0;
  const totalCost = u.cost + variantCost;
  const variantMods = variantData?.mods || {};
  
  const canAdd=(u.stack||cnt===0)&&p.spent+totalCost<=BUDGET;
  const spec=SPECIALS[u.special];const syns=getSynergies([...p.units,u]);
  
  // Calculate stats with variant mods
  const displayHp = u.hp + (variantMods.hp || 0);
  const displayAtk = u.atk + (variantMods.atk || 0);
  const displayDef = u.def + (variantMods.def || 0);
  
  // Unit quick actions for editing
  const quickActions = isEditing ? `
    <div class="unit-quick-actions">
      <button class="quick-btn ${currentUnit && p.leader === currentUnit.uid ? 'active' : ''}" onclick="toggleLeaderFromModal('${currentUnit?.uid}')" title="Set as Leader">
         ${currentUnit && p.leader === currentUnit.uid ? 'Leader' : 'Make Leader'}
      </button>
      <button class="quick-btn" onclick="toggleFormationFromModal('${currentUnit?.uid}')" title="Toggle Front/Back">
        ${p.formation.front.includes(currentUnit?.uid) ? ' Front  Back' : ' Back  Front'}
      </button>
      <button class="quick-btn danger" onclick="removeUnitFromModal('${currentUnit?.uid}')" title="Remove Unit">
         Remove
      </button>
    </div>
  ` : '';
  
  document.getElementById('modal-content').innerHTML=`<button class="modal-close" onclick="closeModal()"></button>
    <div class="modal-head">
      <div class="modal-avatar" id="modal-avatar">${createPortraitImg(u.id, selectedVariant, u.emoji, '100%')}</div>
      <div class="modal-name">${u.name}${selectedVariant!=='base'?`<div style="font-size:0.6em;color:var(--purple);margin-top:2px">${variantData?.name||''}</div>`:''}</div>
      <div class="modal-cost" id="modal-cost">$${totalCost.toFixed(2)}</div>
      ${isEditing ? `<div style="font-size:0.65em;color:var(--cyan);margin-top:4px"> Editing unit</div>` : ''}
    </div>
    <div class="modal-body">
    
    ${quickActions}
    
    ${hasVariants?`<div class="variant-section">
      <div class="variant-title"> SELECT VARIANT / OUTFIT ${!isEditing?'<span style="font-size:0.7em;color:#888">(choose before adding)</span>':''}</div>
      <div class="variant-options">
        ${[{id:'base',name:'Default',portrait:u.id,mods:{},cost:0,desc:'Standard appearance.'},...variants].map(v=>{
          const costDisplay=v.cost>0?`<span style="color:var(--red)">+$${v.cost.toFixed(2)}</span>`:
                           v.cost<0?`<span style="color:var(--green)">-$${Math.abs(v.cost).toFixed(2)}</span>`:'';
          const canAfford = p.spent + u.cost + v.cost <= BUDGET;
          const clickHandler = isEditing ? `selectVariantForUnit('${currentUnit.uid}','${v.id}')` : 
                              (cnt ? `selectVariant('${u.id}','${v.id}')` : `showModal('${u.id}','${v.id}')`);
          return `
          <div class="variant-opt ${selectedVariant===v.id?'selected':''} ${!canAfford && !isEditing?'unaffordable':''}" 
               onclick="${clickHandler}" 
               title="${v.desc}${!canAfford && !isEditing?' (Cannot afford)':''}">
            <div style="width:40px;height:40px;border-radius:6px;overflow:hidden;margin:0 auto 4px;border:2px solid ${selectedVariant===v.id?'var(--gold)':'#444'}">${createPortraitImg(u.id, v.id, u.emoji, '100%')}</div>
            <div class="name">${v.name}</div>
            ${costDisplay?`<div style="font-size:0.6em;font-family:'Orbitron'">${costDisplay}</div>`:''}
            <div class="mods">${formatVariantMods(v.mods||{})}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`:''}
    
    <div class="modal-stats">
      <div class="m-stat"><div class="m-stat-lbl">HP</div><div class="m-stat-val">${displayHp}${variantMods.hp?`<span class="${variantMods.hp>0?'mod-pos':'mod-neg'}">(${variantMods.hp>0?'+':''}${variantMods.hp})</span>`:''}</div></div>
      <div class="m-stat"><div class="m-stat-lbl">ATK</div><div class="m-stat-val">${displayAtk}${variantMods.atk?`<span class="${variantMods.atk>0?'mod-pos':'mod-neg'}">(${variantMods.atk>0?'+':''}${variantMods.atk})</span>`:''}</div></div>
      <div class="m-stat"><div class="m-stat-lbl">DEF</div><div class="m-stat-val">${displayDef}${variantMods.def?`<span class="${variantMods.def>0?'mod-pos':'mod-neg'}">(${variantMods.def>0?'+':''}${variantMods.def})</span>`:''}</div></div>
      <div class="m-stat"><div class="m-stat-lbl">SPD</div><div class="m-stat-val stat-spd">${u.spd||5}</div></div>
    </div>
    <div class="modal-desc">${u.desc}</div>
    ${u.special?`<div class="modal-special"><span class="modal-special-lbl">SPECIAL: </span><span class="modal-special-nm">${u.special}</span><div class="tooltip">${spec?.desc||'Unique ability'}</div></div>`:''}
    ${syns.length?`<div class="modal-synergy"><div class="modal-synergy-lbl"> SYNERGIES</div>${syns.map(s=>`<div> ${s.msg}</div>`).join('')}</div>`:''}
    
    ${isEditing?`<div class="modal-equipment">
      <div class="modal-equip-title"> EQUIPMENT</div>
      <div style="font-size:0.65em;color:#888;margin-bottom:4px">Click to assign/unassign equipment</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px">
        ${(p.equipment||[]).map((eq,i)=>{
          const isAssigned=currentEquip.includes(eq);
          return `<span class="equipped-item ${isAssigned?'assigned':''}" onclick="assignEquipToUnit('${u.id}','${eq}',${i})">${EQUIPMENT[eq].emoji} ${eq.split('(')[0].trim()}</span>`;
        }).join('')||'<span style="color:#666;font-size:0.7em">No equipment purchased</span>'}
      </div>
      ${currentEquip.length?`<div style="margin-top:4px;font-size:0.6em;color:var(--green)">Equipped: ${currentEquip.map(e=>EQUIPMENT[e].emoji).join(' ')}</div>`:''}
    </div>`:''}
    
    <div class="modal-btns">
      ${!isEditing ? `<button class="modal-btn" onclick="addUnitWithVariant('${u.id}','${selectedVariant}')" ${!canAdd?'disabled':''}>Add to Team</button>` : ''}
      ${isEditing ? `<button class="modal-btn" onclick="closeModal()">Done</button>` : ''}
      ${cnt && !isEditing?`<button class="modal-btn rem" onclick="remUnit('${u.id}')">Remove One</button>`:''}
    </div>
  </div>`;
  document.getElementById('modal').classList.add('show');
}

// Quick actions from modal
function toggleLeaderFromModal(uid){
  if(!uid) return;
  const p = players[active];
  if(p.leader === uid){
    p.leader = null;
    toast('Leader removed');
  } else {
    p.leader = uid;
    toast('Leader set!');
  }
  renderTeams();
  renderFormation();
  // Refresh modal
  const unit = p.units.find(u => u.uid === uid);
  if(unit) showModal(unit.id, unit.variant || 'base', uid);
}

function toggleFormationFromModal(uid){
  if(!uid) return;
  const p = players[active];
  const inFront = p.formation.front.includes(uid);
  if(inFront){
    p.formation.front = p.formation.front.filter(x => x !== uid);
    p.formation.back.push(uid);
    toast('Moved to back row');
  } else {
    p.formation.back = p.formation.back.filter(x => x !== uid);
    p.formation.front.push(uid);
    toast('Moved to front row');
  }
  renderTeams();
  renderFormation();
  // Refresh modal
  const unit = p.units.find(u => u.uid === uid);
  if(unit) showModal(unit.id, unit.variant || 'base', uid);
}

function removeUnitFromModal(uid){
  if(!uid) return;
  const p = players[active];
  const unit = p.units.find(u => u.uid === uid);
  if(!unit) return;
  
  // Calculate refund (base cost + variant cost)
  const variantCost = unit.variantCost || 0;
  const refund = unit.cost + variantCost;
  
  // Remove from arrays
  p.units = p.units.filter(u => u.uid !== uid);
  p.formation.front = p.formation.front.filter(x => x !== uid);
  p.formation.back = p.formation.back.filter(x => x !== uid);
  if(p.leader === uid) p.leader = null;
  p.spent -= refund;
  
  toast(`${unit.name} removed (+$${refund.toFixed(2)})`);
  closeModal();
  renderTabs();
  renderRoster();
  renderTeams();
  renderFormation();
  renderFactionPanel();
}

// Select variant for specific unit being edited
function selectVariantForUnit(uid, variantId){
  const p = players[active];
  const unit = p.units.find(u => u.uid === uid);
  if(!unit) return;
  
  const baseUnit = UNITS.find(u => u.id === unit.id);
  const variants = VARIANTS[unit.id] || [];
  const oldVariant = variants.find(v => v.id === unit.variant);
  const newVariant = variants.find(v => v.id === variantId);
  
  // Calculate cost difference
  const oldCost = oldVariant?.cost || 0;
  const newCost = newVariant?.cost || 0;
  const costDiff = newCost - oldCost;
  
  // Check budget
  if(p.spent + costDiff > BUDGET){
    toast('Cannot afford this variant!', true);
    return;
  }
  
  // Apply variant
  if(variantId === 'base'){
    delete unit.variant;
    delete unit.variantName;
    delete unit.variantCost;
  } else {
    unit.variant = variantId;
    unit.variantName = newVariant.name;
    unit.variantCost = newCost;
  }
  
  p.spent += costDiff;
  
  renderTabs();
  renderRoster();
  renderTeams();
  showModal(unit.id, variantId, uid);
}

// Add unit with pre-selected variant
function addUnitWithVariant(id, variantId){
  saveUndoState();
  const u=UNITS.find(x=>x.id===id);const p=players[active];
  const variants=VARIANTS[id]||[];
  const variantData=variants.find(v=>v.id===variantId);
  const variantCost=variantData?.cost||0;
  const totalCost=u.cost+variantCost;
  
  if(p.spent+totalCost>BUDGET){toast('Over budget!',true);return;}
  if(!u.stack&&p.units.some(x=>x.id===id)){toast('Already selected!',true);return;}
  
  const newUnit={...u,uid:Date.now()+Math.random()};
  
  // Apply variant
  if(variantId && variantId !== 'base' && variantData){
    newUnit.variant = variantId;
    newUnit.variantName = variantData.name;
    newUnit.variantCost = variantCost;
  }
  
  p.units.push(newUnit);
  p.spent += totalCost;
  
  // Auto-assign to formation based on stats
  if(u.def>=70||u.hp>=180)p.formation.front.push(newUnit.uid);
  else p.formation.back.push(newUnit.uid);
  
  renderTabs();renderRoster();renderTeams();renderFormation();renderFactionPanel();
  showModal(id, variantId);
}

function selectVariant(unitId,variantId){
  const p=players[active];
  const unit=p.units.find(u=>u.id===unitId);
  if(unit){
    const variants=VARIANTS[unitId]||[];
    const oldVariant=variants.find(x=>x.id===unit.variant);
    const newVariant=variants.find(x=>x.id===variantId);
    
    // Calculate cost difference
    const oldCost=oldVariant?.cost||0;
    const newCost=newVariant?.cost||0;
    const costDiff=newCost-oldCost;
    
    // Check if player can afford
    if(p.spent+costDiff>BUDGET){
      toast('Cannot afford this variant!',true);
      return;
    }
    
    // Apply cost change
    p.spent+=costDiff;
    unit.variantCost=newCost;
    
    unit.variant=variantId;
    if(newVariant){
      unit.variantName=newVariant.name;
      unit.variantPortrait=newVariant.portrait;
    }else{
      delete unit.variantName;
      delete unit.variantPortrait;
    }
    playSound('click');
    renderTabs();renderTeams();renderFormation();
  }
  showModal(unitId);
}

function assignEquipToUnit(unitId,equipName,equipIdx){
  const p=players[active];
  const unit=p.units.find(u=>u.id===unitId);
  if(!unit)return;
  if(!unit.equipment)unit.equipment=[];
  
  const idx=unit.equipment.indexOf(equipName);
  if(idx>=0){
    // Unassign
    unit.equipment.splice(idx,1);
  }else{
    // Check if equipment is already assigned to another unit
    const otherUnit=p.units.find(u=>u.uid!==unit.uid&&u.equipment?.includes(equipName));
    if(otherUnit){
      // Remove from other unit first
      otherUnit.equipment=otherUnit.equipment.filter(e=>e!==equipName);
    }
    unit.equipment.push(equipName);
  }
  renderTeams();
  showModal(unitId);
}
function closeModal(){document.getElementById('modal').classList.remove('show');}

function addUnit(id){
  saveUndoState();
  const u=UNITS.find(x=>x.id===id);const p=players[active];if(p.spent+u.cost>BUDGET){toast('Over budget!',true);return;}if(!u.stack&&p.units.some(x=>x.id===id)){toast('Already selected!',true);return;}const newUnit={...u,uid:Date.now()+Math.random()};p.units.push(newUnit);p.spent+=u.cost;
  // Auto-assign to formation based on stats
  if(u.def>=70||u.hp>=180)p.formation.front.push(newUnit.uid);
  else p.formation.back.push(newUnit.uid);
  renderTabs();renderRoster();renderTeams();renderFormation();renderFactionPanel();showModal(id);}
function remUnit(id){
  saveUndoState();
  const p=players[active];const i=p.units.findIndex(x=>x.id===id);if(i>=0){const uid=p.units[i].uid;p.formation.front=p.formation.front.filter(x=>x!==uid);p.formation.back=p.formation.back.filter(x=>x!==uid);if(p.leader===uid)p.leader=null;p.spent-=p.units[i].cost;p.units.splice(i,1);renderTabs();renderRoster();renderTeams();renderFormation();renderFactionPanel();showModal(id);}}

function renderFactionPanel(){
  const panel = document.getElementById('faction-panel');
  if(panel) panel.innerHTML = renderFactionBonuses();
}

function renderFormation(){
  const p=players[active];
  if(!p.units.length){document.getElementById('formation-panel').innerHTML='';return;}
  
  const leaderUnit=p.leader?p.units.find(u=>u.uid===p.leader):null;
  const frontUnits=p.units.filter(u=>p.formation.front.includes(u.uid));
  const backUnits=p.units.filter(u=>p.formation.back.includes(u.uid));
  const unassigned=p.units.filter(u=>!p.formation.front.includes(u.uid)&&!p.formation.back.includes(u.uid));
  
  // Leader bonuses explanation
  const leaderBonus=leaderUnit?getLeaderBonus(leaderUnit):{atk:0,def:0,desc:'None'};
  const noLeaderBonus={atk:5,def:5,desc:'+5% ATK/DEF to all (no single point of failure)'};
  
  // Helper to render formation unit with click-to-edit
  const renderFormationUnit = (u) => `
    <div class="formation-unit ${p.leader===u.uid?'leader':''} editable" draggable="true" 
      ondragstart="handleUnitDragStart(event,'${u.uid}')"
      ondragend="handleUnitDragEnd(event)"
      onclick="openUnitEditor('${u.uid}')" 
      title="Click to edit ${u.name}${u.variantName?' - '+u.variantName:''}">
      <div class="formation-unit-portrait">
        ${createPortraitImg(u.id, u.variant, u.emoji, '100%')}
      </div>
      <div class="formation-unit-name">${u.name.split(' ')[0]}</div>
      ${u.variantName&&u.variant!=='base'?`<div class="formation-unit-variant">${u.variantName}</div>`:''}
      ${(u.equipment||[]).length?`<div class="formation-unit-equip">${u.equipment.map(e=>EQUIPMENT[e]?.emoji||'').join('')}</div>`:''}
      <button class="formation-leader-btn ${p.leader===u.uid?'active':''}" 
        onclick="event.stopPropagation();setLeader('${u.uid}')" 
        title="${p.leader===u.uid?'Remove as leader':'Set as leader'}"></button>
    </div>`;
  
  document.getElementById('formation-panel').innerHTML=`
    <div class="formation-panel">
      <div class="formation-title">
         FORMATION & LEADER <span class="info">(click units to edit, drag to move)</span>
        <button class="auto-form-btn" onclick="autoFormation()" title="Auto-assign units based on stats"> Auto-Form</button>
      </div>
      ${unassigned.length?`<div class="unassigned-notice"> ${unassigned.length} unit(s) not assigned - click Auto-Form or drag to rows</div>`:''}
      
      <div class="drop-zone leader-drop" 
        ondragover="handleDropZoneDragOver(event)" 
        ondragleave="handleDropZoneDragLeave(event)" 
        ondrop="handleLeaderDrop(event)">
        <div class="drop-zone-label"> DROP HERE TO SET LEADER</div>
        ${p.noLeader?`<div style="color:var(--cyan);font-size:0.7em;padding:5px"> No Leader Mode: ${noLeaderBonus.desc}</div>`:
          leaderUnit?`<div class="leader-display">
            <div class="leader-portrait" onclick="openUnitEditor('${leaderUnit.uid}')" style="cursor:pointer" title="Click to edit">
              ${createPortraitImg(leaderUnit.id, leaderUnit.variant, leaderUnit.emoji, '100%')}
            </div>
            <div class="leader-info">
              <div class="leader-name">${leaderUnit.name}${leaderUnit.variantName?' - '+leaderUnit.variantName:''}</div>
              <div class="leader-bonus">+${leaderBonus.atk}% ATK, +${leaderBonus.def}% DEF to team</div>
            </div>
            <button onclick="clearLeader()" class="leader-remove-btn" title="Remove leader"></button>
          </div>`:
          `<span style="color:#555;font-size:0.65em">Drag a unit here to make them leader</span>`}
      </div>
      <label class="no-leader-toggle"><input type="checkbox" ${p.noLeader?'checked':''} onchange="toggleNoLeader()"> No Leader Mode</label>
      
      <div class="formation-drop">
        <div class="drop-zone formation-zone front" 
          ondragover="handleDropZoneDragOver(event)" 
          ondragleave="handleDropZoneDragLeave(event)" 
          ondrop="handleFormationDrop(event,'front')">
          <div class="drop-zone-label"> FRONT LINE (+10% DEF, targeted first)</div>
          <div class="formation-units-row">
            ${frontUnits.map(u=>renderFormationUnit(u)).join('')||'<span class="formation-empty">Drag units here</span>'}
          </div>
        </div>
        <div class="drop-zone formation-zone back" 
          ondragover="handleDropZoneDragOver(event)" 
          ondragleave="handleDropZoneDragLeave(event)" 
          ondrop="handleFormationDrop(event,'back')">
          <div class="drop-zone-label"> BACK LINE (+10% ATK, protected)</div>
          <div class="formation-units-row">
            ${backUnits.map(u=>renderFormationUnit(u)).join('')||'<span class="formation-empty">Drag units here</span>'}
          </div>
        </div>
      </div>
    </div>`;
}

// Auto-formation: assigns units to front/back based on their stats
function autoFormation(){
  const p=players[active];
  if(!p.units.length)return;
  
  // Clear current formation
  p.formation.front=[];
  p.formation.back=[];
  
  // Sort units by DEF/ATK ratio - high DEF goes front, high ATK goes back
  const sorted=[...p.units].sort((a,b)=>{
    const aRatio=(a.def||0)/(a.atk||1);
    const bRatio=(b.def||0)/(b.atk||1);
    return bRatio-aRatio; // Higher DEF ratio first
  });
  
  // Split roughly 40% front, 60% back (front is smaller, gets hit first)
  const frontCount=Math.max(1,Math.ceil(sorted.length*0.4));
  
  sorted.forEach((u,i)=>{
    if(i<frontCount){
      p.formation.front.push(u.uid);
    }else{
      p.formation.back.push(u.uid);
    }
  });
  
  // Auto-select leader: highest cost unit not already leader
  if(!p.leader&&!p.noLeader){
    const bestLeader=[...p.units].sort((a,b)=>b.cost-a.cost)[0];
    if(bestLeader)p.leader=bestLeader.uid;
  }
  
  toast(' Formation auto-assigned!');
  renderFormation();
  saveUndoState();
}

function getLeaderBonus(leader){
  // Better leaders give better bonuses based on their stats/cost
  const base=Math.floor(leader.cost*2)+5;
  return{atk:base,def:base,desc:`+${base}% ATK/DEF`};
}

function setLeader(uid){
  const p=players[active];
  if(p.noLeader)return;
  p.leader=p.leader===uid?null:uid;
  renderFormation();renderTeams();
}

function clearLeader(){
  players[active].leader=null;
  renderFormation();renderTeams();
}

function toggleNoLeader(){
  const p=players[active];
  p.noLeader=!p.noLeader;
  if(p.noLeader)p.leader=null;
  renderFormation();renderTeams();
}

let draggedUid=null;
function dragUnit(e,uid){draggedUid=uid;e.dataTransfer.effectAllowed='move';}
function dropUnit(e,row){
  e.preventDefault();
  if(!draggedUid)return;
  const p=players[active];
  p.formation.front=p.formation.front.filter(x=>x!==draggedUid);
  p.formation.back=p.formation.back.filter(x=>x!==draggedUid);
  p.formation[row].push(draggedUid);
  draggedUid=null;
  renderFormation();
}

// EQUIPMENT SYSTEM
function renderEquipment(){
  const p=players[active];
  const equipList=Object.entries(EQUIPMENT);
  const equipped=p.equipment||[];
  
  // Build assignment map
  const assignments={};
  p.units.forEach(u=>{
    (u.equipment||[]).forEach(eq=>{
      assignments[eq]=u.variantName||u.name;
    });
  });
  
  document.getElementById('equipment-panel').innerHTML=`
    <div class="equipment-section">
      <div class="equipment-title"> EQUIPMENT <span>$${equipped.reduce((s,e)=>s+EQUIPMENT[e].cost,0).toFixed(1)} spent</span></div>
      <div style="font-size:0.55em;color:#666;margin-bottom:6px">Click to buy/sell  Drag onto units in your team to equip</div>
      <div class="equipment-grid">
        ${equipList.map(([name,eq])=>{
          const owned=equipped.filter(e=>e===name).length;
          const canBuy=p.spent+eq.cost<=BUDGET;
          return `<div class="equip-item ${owned?'selected':''}" onclick="${canBuy||owned?`toggleEquipment('${name}')`:''}">
            <div class="top">
              <span class="emoji">${eq.emoji}</span>
              <span class="cost">$${eq.cost}</span>
            </div>
            <div class="name">${name.split('(')[0].trim()}</div>
            <div class="stats">${formatEquipStats(eq.stats)}${eq.special?' ':''}</div>
            ${owned?`<div style="color:var(--green);font-size:0.8em"> Owned${owned>1?' x'+owned:''}</div>`:''}
          </div>`;
        }).join('')}
      </div>
      ${equipped.length?`<div class="equipped-list">
        <strong style="font-size:0.6em;color:#888">Your Equipment (drag to unit):</strong>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:5px">
        ${equipped.map((e,i)=>{
          const assignedTo=assignments[e];
          return `<div class="equip-item ${assignedTo?'assigned':''}" draggable="true"
            ondragstart="handleEquipDragStart(event,'${e}',${i})"
            ondragend="handleEquipDragEnd(event)">
            <span class="emoji">${EQUIPMENT[e].emoji}</span>
            <span class="name">${e.split('(')[0].trim()}</span>
            ${assignedTo?`<span class="assigned-to"> ${assignedTo.split(' ')[0]}</span>`:'<span style="font-size:0.5em;color:#888">Unassigned</span>'}
          </div>`;
        }).join('')}
        </div>
      </div>`:''}
    </div>`;
}

function formatEquipStats(stats){
  const parts=[];
  if(stats.atk)parts.push((stats.atk>0?'+':'')+stats.atk+' ATK');
  if(stats.def)parts.push((stats.def>0?'+':'')+stats.def+' DEF');
  if(stats.hp)parts.push((stats.hp>0?'+':'')+stats.hp+' HP');
  return parts.join(', ')||'Special';
}

function toggleEquipment(name){
  const p=players[active];
  const eq=EQUIPMENT[name];
  const idx=p.equipment.indexOf(name);
  if(idx>=0){
    p.equipment.splice(idx,1);
    p.spent-=eq.cost;
    // Remove from any unit
    p.units.forEach(u=>{
      if(u.equipment){
        u.equipment=u.equipment.filter(e=>e!==name);
      }
    });
  }else if(p.spent+eq.cost<=BUDGET){
    p.equipment.push(name);
    p.spent+=eq.cost;
  }
  playSound('click');
  renderTabs();renderEquipment();renderTeams();renderFormation();
}

function removeEquipment(idx){
  const p=players[active];
  const name=p.equipment[idx];
  const eq=EQUIPMENT[name];
  p.equipment.splice(idx,1);
  p.spent-=eq.cost;
  renderTabs();renderEquipment();renderTeams();
}

// VARIANT SYSTEM
function getVariantMods(unit){
  if(!unit.variant||unit.variant==='base')return{hp:0,atk:0,def:0};
  const variants=VARIANTS[unit.id];
  if(!variants)return{hp:0,atk:0,def:0};
  const v=variants.find(x=>x.id===unit.variant);
  return v?.mods||{hp:0,atk:0,def:0};
}

function formatVariantMods(mods){
  const parts=[];
  if(mods.hp)parts.push(`<span class="${mods.hp>0?'pos':'neg'}">${mods.hp>0?'+':''}${mods.hp} HP</span>`);
  if(mods.atk)parts.push(`<span class="${mods.atk>0?'pos':'neg'}">${mods.atk>0?'+':''}${mods.atk} ATK</span>`);
  if(mods.def)parts.push(`<span class="${mods.def>0?'pos':'neg'}">${mods.def>0?'+':''}${mods.def} DEF</span>`);
  return parts.join(' ')||'No modifiers';
}
function renderTeams(){
  const teamsRow=document.getElementById('teams-row');
  if(!teamsRow||!players.length)return;
  teamsRow.innerHTML=players.map((p,i)=>{
  const leaderUnit=p.leader?p.units.find(u=>u.uid===p.leader):null;
  const isActive = i === active;
  const canEditTeam = !battle && (i === 0 || !aiMode); // Can edit team name/settings
  // Allow clicking units if: not in battle AND (it's player's own team OR not AI mode)
  const canEditUnits = !battle && (i === 0 || !aiMode);
  const canDrop = isActive && !battle;
  return `<div class="team-box ${i%2?'enemy':''} ${isActive?'active-team':''}" style="border-color:${p.color}"
    ${canDrop ? `
      ondragover="handleTeamDragOver(event,${i})"
      ondragleave="handleTeamDragLeave(event)"
      ondrop="handleTeamDrop(event,${i})"
    ` : ''}>
    <div class="team-label" style="color:${p.color}">
      <span ${canEditTeam ? `onclick="openTeamCustomizer(${i})" style="cursor:pointer" title="Click to customize"` : ''}>${p.name}</span>
      ${leaderUnit?'':p.noLeader?'':''}
      ${canEditTeam ? `<button onclick="openTeamCustomizer(${i})" style="background:none;border:1px solid ${p.color};color:${p.color};padding:2px 6px;border-radius:3px;cursor:pointer;font-size:0.7em;margin-left:5px" title="Edit Team"></button>` : ''}
      <span>$${p.spent.toFixed(1)}</span>
    </div>
    <div class="units-flex team-drop-zone" data-team="${i}">${p.units.length?p.units.map(u=>{
      const isLeader=p.leader===u.uid;
      const row=p.formation.front.includes(u.uid)?'front':'back';
      const emoji=u.variantEmoji||u.emoji;
      const equipList=u.equipment||[];
      const equipIcons=equipList.map(e=>EQUIPMENT[e]?.emoji||'').join('');
      const draggable = canEditUnits ? 'draggable="true"' : '';
      const displayName = u.name;
      const variantDisplay = u.variantName && u.variant !== 'base' ? u.variantName : '';
      // Pass player index so we know which player's unit to edit
      const clickAction = canEditUnits ? `onclick="openUnitEditorForPlayer(${i},'${u.uid}')"` : '';
      return `<div class="battle-unit ${isLeader?'leader':''} ${row} ${canEditUnits?'editable':''}" ${draggable}
        ${clickAction}
        ${canEditUnits ? `
          ondragstart="handleUnitDragStart(event,'${u.uid}')"
          ondragend="handleUnitDragEnd(event)"
          ondragover="handleDropZoneDragOver(event)"
          ondragleave="handleDropZoneDragLeave(event)"
          ondrop="handleUnitEquipDrop(event,'${u.uid}')"
        ` : ''}>
        ${isLeader?'<div class="leader-badge">LEADER</div>':''}
        <div class="unit-avatar">${createPortraitImg(u.id, u.variant, emoji, '100%')}</div>
        <div class="unit-nm" title="${displayName}${variantDisplay?' - '+variantDisplay:''}">
          ${displayName}
          ${variantDisplay?`<br><span style="font-size:0.7em;color:var(--purple)">${variantDisplay}</span>`:''}
        </div>
        <div class="row-badge ${row}">${row==='front'?'FRONT':'BACK'}</div>
        ${equipIcons?`<div class="unit-equip-icons" title="${equipList.join(', ')}">${equipIcons}</div>`:''}
      </div>`;
    }).join(''):`<span style="color:#666;font-size:0.65em;padding:10px;text-align:center;width:100%">
      ${canDrop ? ' Drag units here or click to add' : 'No units'}
    </span>`}</div>
  </div>`;
}).join('');}

// Open unit editor modal for existing unit
function openUnitEditor(uid){
  const p = players[active];
  const unit = p.units.find(u => u.uid === uid);
  if(!unit) return;
  // Pass the specific UID so modal knows which unit to edit
  showModal(unit.id, unit.variant || 'base', uid);
}

// Open unit editor for a specific player's unit (switches active tab if needed)
function openUnitEditorForPlayer(playerIndex, uid){
  // Switch to the correct player tab first
  if(active !== playerIndex){
    active = playerIndex;
    renderTabs();
    renderRoster();
  }
  // Now open the editor
  openUnitEditor(uid);
}

// Store currently editing unit UID
let editingUnitUid = null;

// Team drop handlers
function handleTeamDragOver(e, teamIndex){
  e.preventDefault();
  if(teamIndex !== active) return; // Only allow drop on active team
  e.currentTarget.classList.add('drag-over');
}

function handleTeamDragLeave(e){
  e.currentTarget.classList.remove('drag-over');
}

function handleTeamDrop(e, teamIndex){
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  if(teamIndex !== active) return;
  
  const data = e.dataTransfer.getData('text/plain');
  
  // Check if it's a roster unit being dragged
  if(data.startsWith('roster:')){
    const unitId = data.replace('roster:', '');
    addUnitFromDrag(unitId);
  }
}

// Add unit from drag
function addUnitFromDrag(unitId){
  const u = UNITS.find(x => x.id === unitId);
  if(!u) return;
  
  const p = players[active];
  const cnt = p.units.filter(x => x.id === u.id).length;
  const canAdd = (u.stack || cnt === 0) && p.spent + u.cost <= BUDGET;
  
  if(!canAdd){
    toast('Cannot add unit: ' + (p.spent + u.cost > BUDGET ? 'Over budget!' : 'Already have one!'));
    return;
  }
  
  // Add with base variant (user can edit after)
  const newUnit = {...u, uid: Date.now() + Math.random(), variant: 'base'};
  p.units.push(newUnit);
  p.spent += u.cost;
  
  // Auto-assign formation
  if(u.def >= 70 || u.hp >= 180){
    p.formation.front.push(newUnit.uid);
  } else {
    p.formation.back.push(newUnit.uid);
  }
  
  playSound('blaster');
  renderTabs();
  renderRoster();
  renderTeams();
  renderFormation();
  renderFactionPanel();
  
  toast(`${u.name} added to team!`);
}

function randomAll(){players.forEach((p,i)=>{
  // Randomize team name and color (but not for AI)
  if(!aiMode || i === 0){
    p.name = getRandomTeamName();
    p.color = TEAM_COLORS[i % TEAM_COLORS.length];
  }
  p.units=[];p.equipment=[];p.spent=0;p.leader=null;p.noLeader=Math.random()<0.3;p.formation={front:[],back:[]};let rem=BUDGET;const shuffled=[...UNITS].sort(()=>Math.random()-0.5);for(const u of shuffled){if(u.cost<=rem&&(u.stack||!p.units.some(x=>x.id===u.id))){const newUnit={...u,uid:Date.now()+Math.random()};
  // Random variant if available
  if(VARIANTS[u.id]&&Math.random()<0.5){const v=pick(VARIANTS[u.id]);newUnit.variant=v.id;newUnit.variantName=v.name;}
  p.units.push(newUnit);p.spent+=u.cost;rem-=u.cost;if(u.def>=70||u.hp>=180)p.formation.front.push(newUnit.uid);else p.formation.back.push(newUnit.uid);if(p.units.length>=6)break;}}
  // Random equipment
  const equipList=Object.entries(EQUIPMENT).sort(()=>Math.random()-0.5);for(const[name,eq]of equipList){if(eq.cost<=rem&&Math.random()<0.4){p.equipment.push(name);p.spent+=eq.cost;rem-=eq.cost;if(p.equipment.length>=3)break;}}
  // Assign equipment to units
  p.equipment.forEach((eq,i)=>{if(p.units[i%p.units.length]){if(!p.units[i%p.units.length].equipment)p.units[i%p.units.length].equipment=[];p.units[i%p.units.length].equipment.push(eq);}});
  if(!p.noLeader&&p.units.length){const best=p.units.reduce((a,b)=>a.cost>b.cost?a:b);p.leader=best.uid;}});selectRandomBattlefield();renderTabs();renderRoster();renderTeams();renderFormation();renderEquipment();toast('Teams randomized!');}
function resetAll(){
  players.forEach(p=>{p.units=[];p.equipment=[];p.spent=0;p.leader=null;p.noLeader=false;p.formation={front:[],back:[]};});
  battle=null;selectedBattlefield=null;
  resetTacticalCooldowns();
  const tactPanel=document.getElementById('tactical-panel');if(tactPanel)tactPanel.remove();
  const log=document.getElementById('log');if(log)log.innerHTML='';
  const bfTitle=document.getElementById('bf-title');if(bfTitle)bfTitle.textContent='Select your warriors';
  const formPanel=document.getElementById('formation-panel');if(formPanel)formPanel.innerHTML='';
  const equipPanel=document.getElementById('equipment-panel');if(equipPanel)equipPanel.innerHTML='';
  showBattleArena(false);selectRandomBattlefield();renderTabs();renderRoster();renderTeams();renderEquipment();
  const controls=document.getElementById('controls');if(controls)controls.innerHTML=`<button class="btn" onclick="startBattle()"> START BATTLE</button><button class="btn sec" onclick="randomAll()"> Random</button><button class="btn undo-btn" id="undo-btn" onclick="undo()" disabled> Undo</button><button class="btn red" onclick="resetAll()"> Reset</button>`;
}

function startBattle(){
  for(const p of players)if(!p.units.length){toast(p.name+' needs units!',true);return;}
  
  playSound('start');
  
  // Use selected battlefield or pick random
  const bf = selectedBattlefield || pick(BATTLEFIELDS);
  document.getElementById('bf-title').textContent=bf.name;
  const bfPreview = document.getElementById('battlefield-preview');
  if(bfPreview) bfPreview.style.display='none';
  
  // Start battlefield-specific music (loads from music folder or falls back to procedural)
  playBattlefieldMusic(bf.image);
  
  battle={round:0,phase:'battle',bf,stats:{kills:{},damage:{},taken:{},heals:{},specials:{},crits:{}},players:players.map(p=>{
    const leaderUnit=p.leader?p.units.find(u=>u.uid===p.leader):null;
    const leaderBonus=leaderUnit?getLeaderBonus(leaderUnit):{atk:0,def:0};
    const noLeaderBonus=p.noLeader?{atk:5,def:5}:{atk:0,def:0};
    
    // Get active faction bonuses for this team
    const factionBonuses = getActiveFactionBonuses(p.units);
    
    return{...p,leaderAlive:!!leaderUnit,moraleLost:false,factionBonuses,combatants:p.units.map(u=>{
      const isLeader=p.leader===u.uid;
      const isFront=p.formation.front.includes(u.uid);
      const formationBonus=isFront?{atk:0,def:10}:{atk:10,def:0};
      
      // Apply variant modifiers
      const variantMods=getVariantMods(u);
      
      // Apply faction bonus
      const factionBonus = applyFactionBonus(u, factionBonuses);
      
      // Apply equipment stats
      const equipStats={hp:0,atk:0,def:0};
      const equipSpecials=[];
      (u.equipment||[]).forEach(eqName=>{
        const eq=EQUIPMENT[eqName];
        if(eq){
          if(eq.stats.hp)equipStats.hp+=eq.stats.hp;
          if(eq.stats.atk)equipStats.atk+=eq.stats.atk;
          if(eq.stats.def)equipStats.def+=eq.stats.def;
          if(eq.special)equipSpecials.push(eq.special);
        }
      });
      
      const finalHp=u.hp+(variantMods.hp||0)+equipStats.hp+(factionBonus.hp||0);
      const finalAtk=u.atk+(variantMods.atk||0)+equipStats.atk+(factionBonus.atk||0);
      const finalDef=u.def+(variantMods.def||0)+equipStats.def+(factionBonus.def||0);
      const finalSpd=(u.spd||5)+(factionBonus.spd||0);
      
      return{...u,
        hp:finalHp,maxHp:finalHp,curHp:finalHp,
        atk:finalAtk,def:finalDef,spd:finalSpd,
        alive:true,ownerId:p.id,ownerColor:p.color,
        atkBuff:(leaderBonus.atk+noLeaderBonus.atk+formationBonus.atk)/100,
        defBuff:(leaderBonus.def+noLeaderBonus.def+formationBonus.def)/100,
        isLeader,isFront,equipSpecials,
        shield:equipSpecials.includes('personalShield')?30:0,
        killCount:0,damageDealt:0,damageTaken:0,healingDone:0,specialsUsed:0};
    })};
  })};
  
  // Log faction bonuses
  battle.players.forEach(p => {
    if(p.factionBonuses && p.factionBonuses.length > 0){
      p.factionBonuses.forEach(b => {
        addLog(`${b.emoji} ${p.name} activates ${b.name}!`, 'synergy');
      });
    }
  });
  
  // Apply synergies (legacy - now handled by faction bonuses above)
  battle.players.forEach(p=>{
    const team=p.combatants;
    // Auras
    team.forEach(c=>{const sp=SPECIALS[c.special];if(sp?.type==='aura'){const r=sp.fn(c,team);if(r?.msg)addLog(r.msg,'synergy');}});
  });
  
  // Apply terrain effects
  if(bf.terrain){
    const t=bf.terrain;
    battle.players.forEach(p=>{
      p.combatants.forEach(c=>{
        switch(t.type){
          case 'sand':c.defBuff-=0.1;break;
          case 'urban':if(!c.isFront)c.defBuff+=0.15;break;
          case 'swamp':if(['Jedi','Sith'].includes(c.faction))c.forceBoost=0.2;break;
          case 'forest':c.ambushReady=true;break;
          case 'rain':c.lightningBoost=0.3;break;
          case 'scrap':c.equipBoost=0.25;break;
          case 'dark':
            if(c.faction==='Sith'){c.atkBuff+=0.25;c.defBuff+=0.25;}
            if(c.faction==='Jedi'){c.atkBuff-=0.15;c.defBuff-=0.15;}
            break;
        }
      });
    });
  }
  
  renderBattle();document.getElementById('log').innerHTML='';
  showBattleArena(true, bf);
  
  // Initialize arena with first units from each team
  const p1First=battle.players[0].combatants.find(c=>c.alive);
  const p2First=battle.players[1]?.combatants.find(c=>c.alive);
  if(p1First)updateFighterPortrait('left',p1First);
  if(p2First)updateFighterPortrait('right',p2First);
  document.getElementById('combat-dialogue').innerHTML=`<span class="quote"> Warriors face off on <strong>${bf.name}</strong>... Let the battle begin! </span>`;
  
  addLog(' <strong>BATTLE BEGINS</strong> ','round');addLog(`<em>${bf.name}</em>`,'env');
  
  // Show terrain effect
  if(bf.terrain){
    addLog(`<div class="terrain-bar"><span class="icon">${bf.terrain.desc.split(' ')[0]}</span><span class="desc">${bf.terrain.desc}</span></div>`,'env');
  }
  
  // Log formation and leader info
  battle.players.forEach(p=>{
    const leader=p.combatants.find(c=>c.isLeader);
    const frontCount=p.combatants.filter(c=>c.isFront).length;
    const backCount=p.combatants.length-frontCount;
    if(leader){
      addLog(` <span style="color:${p.color}">${p.name}</span> Leader: <strong>${leader.name}</strong> (+${getLeaderBonus(leader).atk}% team buff)`,'synergy');
    }else if(p.noLeader){
      addLog(` <span style="color:${p.color}">${p.name}</span>: No Leader Mode (+5% all stats, no morale penalty)`,'synergy');
    }
    addLog(` <span style="color:${p.color}">${p.name}</span> Formation: ${frontCount} Front / ${backCount} Back`,'env');
  });
  
  battle.players.forEach(p=>{const syns=getSynergies(p.combatants);syns.forEach(s=>addLog(` <span style="color:${p.color}">${p.name}</span>: ${s.msg}`,'synergy'));});
  battle.players.forEach(p=>{addLog(`<strong style="color:${p.color}">${p.name}:</strong>`);p.combatants.forEach(c=>addLog(` ${c.intro||c.name}${c.isLeader?' ':''}${c.isFront?' [FRONT]':' [BACK]'}`));});
  
  // Auto-play controls
  document.getElementById('controls').innerHTML=`
    <button class="btn cont" onclick="startMovieMode()"> WATCH BATTLE</button>
    <button class="btn sec" onclick="runCinematicRound()"> Step (1 Round)</button>
    <button class="btn red" onclick="resetAll()"> Cancel</button>
    <div class="speed-controls">
      <button class="speed-btn" onclick="setBattleSpeed(2)" title="Slow - Dramatic"></button>
      <button class="speed-btn active" onclick="setBattleSpeed(1)" title="Normal"></button>
      <button class="speed-btn" onclick="setBattleSpeed(0.5)" title="Fast"></button>
      <button class="speed-btn" onclick="setBattleSpeed(0)" title="Instant"></button>
    </div>
  `;
  
  // Add tactical commands panel
  renderTacticalCommands();
}

// ============================================
// TACTICAL COMMANDS SYSTEM
// ============================================
let tacticalCooldowns = {};

function renderTacticalCommands(){
  const existing = document.getElementById('tactical-panel');
  if(existing) existing.remove();
  
  if(!battle) return;
  
  const playerTeam = battle.players.find(p => p.id === 'p1');
  if(!playerTeam) return;
  
  const panel = document.createElement('div');
  panel.id = 'tactical-panel';
  panel.className = 'tactical-panel';
  panel.innerHTML = `
    <div class="tactical-title"> TACTICAL COMMANDS</div>
    <div class="tactical-grid">
      <button class="tactical-btn ${tacticalCooldowns.focus?'cooldown':''}" onclick="useTactical('focus')" ${tacticalCooldowns.focus?'disabled':''}>
        <span class="tact-icon"></span>
        <span class="tact-name">Focus Fire</span>
        <span class="tact-desc">Next attack deals +50% damage</span>
      </button>
      <button class="tactical-btn ${tacticalCooldowns.defend?'cooldown':''}" onclick="useTactical('defend')" ${tacticalCooldowns.defend?'disabled':''}>
        <span class="tact-icon"></span>
        <span class="tact-name">Defensive Stance</span>
        <span class="tact-desc">Team takes -30% damage this round</span>
      </button>
      <button class="tactical-btn ${tacticalCooldowns.rally?'cooldown':''}" onclick="useTactical('rally')" ${tacticalCooldowns.rally?'disabled':''}>
        <span class="tact-icon"></span>
        <span class="tact-name">Rally Troops</span>
        <span class="tact-desc">All units gain +20% ATK for 2 rounds</span>
      </button>
      <button class="tactical-btn ${tacticalCooldowns.medic?'cooldown':''}" onclick="useTactical('medic')" ${tacticalCooldowns.medic?'disabled':''}>
        <span class="tact-icon"></span>
        <span class="tact-name">Emergency Medic</span>
        <span class="tact-desc">Heal lowest HP ally for 25% max HP</span>
      </button>
      <button class="tactical-btn ${tacticalCooldowns.retreat?'cooldown':''}" onclick="useTactical('retreat')" ${tacticalCooldowns.retreat?'disabled':''}>
        <span class="tact-icon"></span>
        <span class="tact-name">Tactical Retreat</span>
        <span class="tact-desc">Skip your attack, restore 15% HP to team</span>
      </button>
      <button class="tactical-btn ${tacticalCooldowns.fury?'cooldown':''}" onclick="useTactical('fury')" ${tacticalCooldowns.fury?'disabled':''}>
        <span class="tact-icon"></span>
        <span class="tact-name">Unleash Fury</span>
        <span class="tact-desc">Double attack speed, -20% DEF for 2 rounds</span>
      </button>
    </div>
  `;
  
  document.getElementById('log').parentElement.insertBefore(panel, document.getElementById('log'));
}

function useTactical(command){
  if(!battle || tacticalCooldowns[command]) return;
  
  const playerTeam = battle.players.find(p => p.id === 'p1');
  if(!playerTeam) return;
  
  const allies = playerTeam.combatants.filter(c => c.alive);
  if(!allies.length) return;
  
  playSound('click');
  tacticalCooldowns[command] = true;
  
  switch(command){
    case 'focus':
      battle.focusFire = true;
      addLog(' <span class="special">FOCUS FIRE!</span> Next attack will deal +50% damage!', 'special');
      break;
      
    case 'defend':
      allies.forEach(u => u.defBuff = (u.defBuff || 0) + 30);
      addLog(' <span class="special">DEFENSIVE STANCE!</span> Team takes reduced damage this round!', 'special');
      break;
      
    case 'rally':
      allies.forEach(u => {
        u.atkBuff = (u.atkBuff || 0) + 20;
        u.rallyRounds = 2;
      });
      addLog(' <span class="special">RALLY!</span> All allies gain +20% ATK for 2 rounds!', 'special');
      break;
      
    case 'medic':
      const lowest = allies.reduce((a, b) => (a.curHp / a.maxHp) < (b.curHp / b.maxHp) ? a : b);
      const heal = Math.floor(lowest.maxHp * 0.25);
      lowest.curHp = Math.min(lowest.maxHp, lowest.curHp + heal);
      addLog(` <span class="heal">MEDIC!</span> ${lowest.name} healed for ${heal} HP!`, 'heal');
      break;
      
    case 'retreat':
      battle.skipNextAttack = true;
      const retreatHeal = Math.floor(allies[0].maxHp * 0.15);
      allies.forEach(u => u.curHp = Math.min(u.maxHp, u.curHp + retreatHeal));
      addLog(` <span class="heal">TACTICAL RETREAT!</span> Team restored ${retreatHeal} HP each!`, 'heal');
      break;
      
    case 'fury':
      allies.forEach(u => {
        u.atkBuff = (u.atkBuff || 0) + 50;
        u.defBuff = (u.defBuff || 0) - 20;
        u.furyRounds = 2;
      });
      addLog(' <span class="crit">FURY UNLEASHED!</span> Double damage but reduced defense!', 'special');
      break;
  }
  
  renderBattle();
  renderTacticalCommands();
}

function resetTacticalCooldowns(){
  tacticalCooldowns = {};
}

// ============================================
// MOVIE MODE - Auto-play entire battle
// ============================================
let movieMode = false;

async function startMovieMode(){
  if(movieMode || !battle) return;
  movieMode = true;
  battlePaused = false;
  
  // Update controls for movie mode
  document.getElementById('controls').innerHTML=`
    <button class="btn" onclick="toggleBattlePause()" id="pause-btn"> PAUSE</button>
    <button class="btn sec" onclick="stopMovieMode()"> STOP</button>
    <button class="btn red" onclick="forceEndBattle()"> EXIT</button>
    <div class="speed-controls">
      <button class="speed-btn ${battleSpeed===2?'active':''}" onclick="setBattleSpeed(2)"></button>
      <button class="speed-btn ${battleSpeed===1?'active':''}" onclick="setBattleSpeed(1)"></button>
      <button class="speed-btn ${battleSpeed===0.5?'active':''}" onclick="setBattleSpeed(0.5)"></button>
      <button class="speed-btn ${battleSpeed===0?'active':''}" onclick="setBattleSpeed(0)"></button>
    </div>
  `;
  
  // Run rounds until battle ends
  while(movieMode && battle && !checkEnd() && battle.round < 12){
    await runCinematicRound();
    if(!movieMode) break;
    
    // Brief pause between rounds (unless instant mode)
    if(battleSpeed > 0){
      await pause(getDelay(1000));
    }
  }
  
  movieMode = false;
}

function stopMovieMode(){
  movieMode = false;
  battlePaused = false;
  if(battle){
    document.getElementById('controls').innerHTML=`
      <button class="btn cont" onclick="startMovieMode()"> CONTINUE</button>
      <button class="btn sec" onclick="runCinematicRound()"> Step</button>
      <button class="btn red" onclick="forceEndBattle()"> End Battle</button>
      <div class="speed-controls">
        <button class="speed-btn ${battleSpeed===2?'active':''}" onclick="setBattleSpeed(2)"></button>
        <button class="speed-btn ${battleSpeed===1?'active':''}" onclick="setBattleSpeed(1)"></button>
        <button class="speed-btn ${battleSpeed===0.5?'active':''}" onclick="setBattleSpeed(0.5)"></button>
        <button class="speed-btn ${battleSpeed===0?'active':''}" onclick="setBattleSpeed(0)"></button>
      </div>
    `;
  }
}

// Force end battle - emergency exit
function forceEndBattle(){
  movieMode = false;
  battlePaused = false;
  if(battle){
    addLog(' Battle ended manually.', 'round');
    endBattle();
  } else {
    resetAll();
  }
}

function renderBattle(){
  document.getElementById('teams-row').innerHTML=battle.players.map((p,i)=>`<div class="team-box ${i%2?'enemy':''}" style="border-color:${p.color}"><div class="team-label" style="color:${p.color}">${p.name}${p.moraleLost?' ':''}</div><div class="units-flex">${p.combatants.map((c,j)=>{
    const pct=Math.max(0,(c.curHp/c.maxHp)*100);
    const cls=pct>60?'':pct>30?'mid':'low';
    const buffs=[];
    if(c.atkBuff>0)buffs.push('');
    if(c.defBuff>0)buffs.push('');
    if(c.shield>0)buffs.push('');
    if(c.isUndead)buffs.push('');
    if(c.betrayed)buffs.push('');
    const displayName = c.variantName && c.variant !== 'base' ? `${c.name}: ${c.variantName}` : c.name;
    return `<div class="battle-unit ${c.alive?'':'dead'} ${c.shield?'shielded':''} ${c.isLeader?'leader':''} ${c.isFront?'front':'back'} ${c.isUndead?'undead':''} ${c.betrayed?'betrayed':''}" id="u-${i}-${j}">${c.isLeader&&c.alive?'<div class="leader-badge"></div>':''}${buffs.length?`<div class="buff-icons">${buffs.join('')}</div>`:''}<div class="unit-avatar">${c.emoji}</div><div class="unit-nm" title="${displayName}">${displayName}</div><div class="hp-bar"><div class="hp-fill ${cls}" style="width:${pct}%"></div></div></div>`;
  }).join('')}</div></div>`).join('');
}

function addLog(t,cls=''){const l=document.getElementById('log'),e=document.createElement('div');e.className='log-entry '+cls;e.innerHTML=t;l.appendChild(e);l.scrollTop=l.scrollHeight;}

// Get full combat display name: "Darth Vader: Newly Fallen" or just "Darth Vader"
function getCombatName(c){
  if(c.variantName && c.variant !== 'base'){
    return `${c.name}: ${c.variantName}`;
  }
  return c.name;
}

// Cinematic log with typing effect
function cinematicLog(text, cls='', delay=0){
  return new Promise(resolve => {
    setTimeout(() => {
      addLog(text, cls);
      resolve();
    }, delay);
  });
}

// Dramatic pause
function pause(ms){ return new Promise(r => setTimeout(r, ms)); }

// Calculate reading time based on text length (average reading speed ~200 words/min)
// Minimum 400ms, maximum 2500ms, scales with text length
function getReadingTime(text){
  if(!text) return 400;
  const words = text.split(/\s+/).length;
  const baseTime = Math.max(400, Math.min(2500, words * 150)); // ~150ms per word
  return getDelay(baseTime);
}

// Pause for dialogue with appropriate reading time
function dialoguePause(text){
  return pause(getReadingTime(text));
}

// Update the combat dialogue display in the arena
function updateCombatDialogue(speaker, quote){
  const dialogueEl = document.getElementById('combat-dialogue');
  if(dialogueEl){
    dialogueEl.innerHTML = `<strong>${speaker}:</strong> <span class="quote">"${quote}"</span>`;
    dialogueEl.classList.add('flash');
    setTimeout(() => dialogueEl.classList.remove('flash'), 500);
  }
}

// Battle speed control
let battleSpeed = 1; // 1 = normal, 0.5 = fast, 2 = slow, 0 = instant
function setBattleSpeed(speed){
  battleSpeed = speed;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  event?.target?.classList.add('active');
}
function getDelay(base){ return battleSpeed === 0 ? 0 : base * battleSpeed; }

function getAtk(c){let a=c.atk*(1+c.atkBuff);const sp=SPECIALS[c.special];if(sp?.type==='passive'&&sp.fn){const m=sp.fn(c);if(m?.atkMod)a*=m.atkMod;}return a;}
function getDef(c){let d=c.def*(1+c.defBuff);const sp=SPECIALS[c.special];if(sp?.type==='passive'&&sp.fn){const m=sp.fn(c);if(m?.defMod)d*=m.defMod;}return d;}

// ============================================
// CINEMATIC REAL-TIME BATTLE SYSTEM
// ============================================
let battleRunning = false;
let battlePaused = false;

async function runCinematicRound(){
  if(!battle || battleRunning) return;
  battleRunning = true;
  battle.round++;
  
  // Update controls
  document.getElementById('controls').innerHTML=`
    <button class="btn" onclick="toggleBattlePause()" id="pause-btn"> Pause</button>
    <div class="speed-controls">
      <button class="speed-btn" onclick="setBattleSpeed(2)"> Slow</button>
      <button class="speed-btn active" onclick="setBattleSpeed(1)"> Normal</button>
      <button class="speed-btn" onclick="setBattleSpeed(0.5)"> Fast</button>
      <button class="speed-btn" onclick="setBattleSpeed(0)"> Instant</button>
    </div>
  `;
  
  if(checkEnd()){ await endCinematicBattle(); return; }
  if(battle.round > 12){ await endCinematicBattle(); return; }
  
  const bf = battle.bf;
  
  // 
  // ROUND OPENING - Cinematic atmosphere
  // 
  await cinematicLog(`<div class="round-header"> ROUND ${battle.round} </div>`, 'round');
  await pause(getDelay(400));
  
  // Battlefield atmosphere (50% chance)
  if(GORE.atmosphere[bf.image] && Math.random() < 0.5){
    const atmosphere = pick(GORE.atmosphere[bf.image]);
    await cinematicLog(`<div class="atmosphere-text"><em>${atmosphere}</em></div>`, 'atmosphere');
    await pause(getDelay(600));
  }
  
  updateArenaRound(battle.round);
  
  // 
  // PRE-COMBAT PHASE - Buffs, heals, effects
  // 
  for(const p of battle.players){
    for(const c of p.combatants.filter(c => c.alive)){
      await checkPause();
      
      const sp = SPECIALS[c.special];
      if(sp?.type === 'roundStart'){
        const allies = p.combatants;
        const enemies = battle.players.filter(x => x.id !== p.id).flatMap(x => x.combatants.filter(e => e.alive));
        const r = sp.fn(c, allies, enemies);
        if(r?.msg){
          await cinematicLog(r.msg, 'special');
          await pause(getDelay(300));
        }
      }
      
      // Bacta regen
      if((c.equipSpecials || []).includes('regen')){
        const heal = Math.min(10, c.maxHp - c.curHp);
        if(heal > 0){
          c.curHp += heal;
          await cinematicLog(` <em>${c.name} takes a moment to apply bacta. The wounds begin to close.</em> <span style="color:var(--green)">+${heal} HP</span>`, 'heal');
          anim(c, 'heal');
          playSound('heal');
          await pause(getDelay(400));
        }
      }
    }
  }
  
  // Influence wearing off
  for(const p of battle.players){
    for(const c of p.combatants.filter(c => c.influenced)){
      c.influenced--;
      if(c.influenced <= 0 && c.originalOwner !== undefined){
        c.ownerId = c.originalOwner;
        delete c.originalOwner;
        delete c.influenced;
        await cinematicLog(`<div class="dialogue"> ${c.name} shakes their head, eyes clearing. <em>"What... what have I done?"</em></div>`, 'special');
        await pause(getDelay(500));
      }
    }
  }
  
  // 
  // TERRAIN EFFECTS - Environmental hazards
  // 
  if(bf.terrain){
    const t = bf.terrain;
    let terrainNarration = [];
    
    for(const p of battle.players){
      for(const c of p.combatants.filter(c => c.alive)){
        switch(t.type){
          case 'lava':
            if(c.isFront){
              c.curHp -= 5;
              terrainNarration.push(`${c.name} winces as superheated air scorches exposed flesh. (-5 HP)`);
            }
            break;
          case 'compactor':
            c.curHp -= 10;
            terrainNarration.push(`${c.name} is crushed against the closing walls! (-10 HP)`);
            break;
          case 'desert':
            if(!(c.equipSpecials || []).some(e => ['armor'].includes(e))){
              c.curHp -= 5;
              terrainNarration.push(`${c.name} staggers from dehydration. (-5 HP)`);
            }
            break;
        }
        if(c.curHp <= 0 && c.alive) await killUnitCinematic(c, null);
      }
    }
    
    if(terrainNarration.length > 0){
      await cinematicLog(`<div class="terrain-effect"> <em>${terrainNarration.join(' ')}</em></div>`, 'env');
      await pause(getDelay(500));
    }
  }
  
  // Poison tick
  for(const p of battle.players){
    for(const c of p.combatants.filter(c => c.alive && c.poisoned)){
      c.curHp -= 15;
      c.poisoned--;
      await cinematicLog(` <em>Poison courses through ${c.name}'s veins. Their movements grow sluggish.</em> <span style="color:var(--purple)">-15 HP</span>`, 'damage');
      if(c.curHp <= 0) await killUnitCinematic(c, null);
      await pause(getDelay(300));
    }
  }
  
  // 
  // NPC ENCOUNTERS
  // 
  if(bf.npcs && Math.random() < 0.35){
    const availableNpcs = bf.npcs.filter(n => Math.random() < n.chance);
    if(availableNpcs.length){
      const npc = pick(availableNpcs);
      await handleNpcEncounterCinematic(npc);
    }
  }
  
  // 
  // COMBAT PHASE - The main event
  // 
  const all = battle.players.flatMap(p => p.combatants.filter(c => c.alive && !c.skipTurn));
  const sortedBySpeed = [...all].sort((a, b) => {
    const spdA = (a.spd || 5) + Math.random() * 0.5;
    const spdB = (b.spd || 5) + Math.random() * 0.5;
    return spdB - spdA;
  });
  
  // Initiative announcement (Round 1 only)
  if(battle.round === 1 && sortedBySpeed.length > 0){
    await cinematicLog(`<div class="initiative"> <strong>Initiative Order:</strong> ${sortedBySpeed.slice(0, 5).map(u => `${u.name}`).join('  ')}${sortedBySpeed.length > 5 ? '...' : ''}</div>`, 'info');
    await pause(getDelay(500));
  }
  
  // Handle betrayals first
  for(const p of battle.players){
    for(const c of p.combatants.filter(c => c.alive && c.betrayed)){
      await checkPause();
      const allies = p.combatants.filter(a => a.alive && a.uid !== c.uid);
      if(allies.length){
        const target = allies[Math.floor(Math.random() * allies.length)];
        
        await cinematicLog(`<div class="betrayal-scene">
          <div class="dialogue"> ${c.name} turns suddenly, eyes filled with treachery.</div>
        </div>`, 'special');
        await pause(getDelay(600));
        
        await cinematicLog(`<em>"Nothing personal..."</em>`, 'dialogue');
        await pause(getDelay(400));
        
        const dmg = Math.max(10, c.atk * 0.8 - target.def * 0.2 + Math.random() * 20);
        target.curHp -= dmg;
        anim(target, 'betray');
        anim(c, 'shake');
        
        await cinematicLog(` ${c.name} BACKSTABS ${target.name}! <strong style="color:var(--red)">${Math.round(dmg)} DMG</strong>`, 'damage');
        
        if(target.curHp <= 0) await killUnitCinematic(target, c);
        c.betrayed = false;
        await pause(getDelay(500));
      }
    }
  }
  
  // Ice terrain slip
  if(bf.terrain?.type === 'ice'){
    sortedBySpeed.forEach(c => { if(Math.random() < 0.15) c.slipped = true; });
  }
  
  // Forest ambush
  if(bf.terrain?.type === 'forest' && sortedBySpeed.length && sortedBySpeed[0].ambushReady){
    sortedBySpeed[0].ambushBonus = true;
    sortedBySpeed[0].ambushReady = false;
  }
  
  // COMBO ATTACKS
  if(Math.random() < 0.2){
    for(const p of battle.players){
      const combo = checkForCombo(p.combatants);
      if(combo){
        const enemies = battle.players.filter(x => x.id !== p.id).flatMap(x => x.combatants.filter(e => e.alive));
        if(enemies.length){
          await executeComboCinematic(combo, p.combatants, enemies);
        }
      }
    }
  }
  
  // 
  // MAIN COMBAT LOOP - Each fight is a scene
  // 
  const pairs = [];
  const used = new Set();
  
  for(let i = 0; i < sortedBySpeed.length; i++){
    const c1 = sortedBySpeed[i];
    if(used.has(c1.uid) || !c1.alive) continue;
    
    // Find an enemy to fight
    for(let j = i + 1; j < sortedBySpeed.length; j++){
      const c2 = sortedBySpeed[j];
      if(used.has(c2.uid) || !c2.alive) continue;
      if(areEnemies(c1, c2)){
        pairs.push([c1, c2]);
        used.add(c1.uid);
        used.add(c2.uid);
        break;
      }
    }
  }
  
  // Execute each combat pair as a cinematic scene
  for(const [c1, c2] of pairs){
    await checkPause();
    if(!c1.alive || !c2.alive) continue;
    await doCombatCinematic(c1, c2);
  }
  
  // Hazard event
  if(Math.random() < 0.2){
    await doHazardCinematic();
  }
  
  // Clear skip turns
  battle.players.forEach(p => p.combatants.forEach(c => c.skipTurn = false));
  
  // 
  // ROUND END PHASE - Heals, specials
  // 
  for(const p of battle.players){
    for(const c of p.combatants.filter(c => c.alive)){
      await checkPause();
      const sp = SPECIALS[c.special];
      
      if(sp?.type === 'roundEnd'){
        const allies = p.combatants;
        const r = sp.fn(c, allies);
        if(r?.msg){
          await cinematicLog(r.msg, 'special');
          if(r.msg.includes('RESURRECTION') || r.msg.includes('rises')){
            playSound('heal');
            await pause(getDelay(800));
          } else {
            await pause(getDelay(400));
          }
        }
      }
      
      // Heal ability
      if(sp?.type === 'heal' && Math.random() < (sp.chance || 0.3)){
        const allies = p.combatants.filter(a => a.alive);
        const r = sp.fn(c, allies);
        if(r?.msg){
          await cinematicLog(`<div class="heal-scene"> <em>${c.name} channels healing energy...</em></div>`, 'heal');
          await pause(getDelay(300));
          await cinematicLog(r.msg, 'heal');
          playSound('heal');
          await pause(getDelay(400));
        }
      }
    }
  }
  
  // Update display
  renderBattle();
  
  // 
  // ROUND END
  // 
  battleRunning = false;
  
  if(checkEnd()){
    await endCinematicBattle();
  } else {
    // Round summary
    const alive1 = battle.players[0].combatants.filter(c => c.alive).length;
    const alive2 = battle.players[1].combatants.filter(c => c.alive).length;
    await cinematicLog(`<div class="round-summary">
      <em>Round ${battle.round} ends. 
      <span style="color:${battle.players[0].color}">${battle.players[0].name}</span>: ${alive1} standing | 
      <span style="color:${battle.players[1].color}">${battle.players[1].name}</span>: ${alive2} standing</em>
    </div>`, 'info');
    
    // If in movie mode, controls are handled by startMovieMode loop
    if(!movieMode){
      const nextRound = battle.round + 1;
      document.getElementById('controls').innerHTML = `
        <button class="btn cont" onclick="startMovieMode()"> WATCH BATTLE</button>
        <button class="btn sec" onclick="runCinematicRound()"> Round ${nextRound}</button>
        <button class="btn red" onclick="resetAll()"> End Battle</button>
        <div class="speed-controls">
          <button class="speed-btn ${battleSpeed===2?'active':''}" onclick="setBattleSpeed(2)"></button>
          <button class="speed-btn ${battleSpeed===1?'active':''}" onclick="setBattleSpeed(1)"></button>
          <button class="speed-btn ${battleSpeed===0.5?'active':''}" onclick="setBattleSpeed(0.5)"></button>
          <button class="speed-btn ${battleSpeed===0?'active':''}" onclick="setBattleSpeed(0)"></button>
        </div>
      `;
    }
  }
}

// Pause/Resume battle
function toggleBattlePause(){
  battlePaused = !battlePaused;
  const btn = document.getElementById('pause-btn');
  if(btn) btn.textContent = battlePaused ? ' Resume' : ' Pause';
}

async function checkPause(){
  while(battlePaused){
    await pause(100);
  }
}

// 
// CINEMATIC COMBAT SCENE
// 
async function doCombatCinematic(c1, c2){
  if(!c1.alive || !c2.alive) return;
  
  // Update arena portraits
  updateFighterPortrait('left', c1);
  updateFighterPortrait('right', c2);
  
  // Get full display names for combat
  const name1 = getCombatName(c1);
  const name2 = getCombatName(c2);
  
  // Scene opening - who's fighting
  await cinematicLog(`<div class="combat-scene-header">
     <strong style="color:${c1.ownerColor}">${name1}</strong> 
    <span style="color:#666">engages</span> 
    <strong style="color:${c2.ownerColor}">${name2}</strong>
  </div>`, 'combat');
  await pause(getDelay(500));
  
  // Check for rivalry dialogue (higher chance, more dramatic)
  const rivalryKey = `${c1.id}-${c2.id}`;
  const reverseKey = `${c2.id}-${c1.id}`;
  let hadRivalry = false;
  
  if(GORE.rivalries[rivalryKey] && Math.random() < 0.7){
    const quote = pick(GORE.rivalries[rivalryKey]);
    await cinematicLog(`<div class="dialogue-box attacker"><strong>${name1}:</strong> <em>"${quote}"</em></div>`, 'dialogue');
    updateCombatDialogue(name1, quote);
    playSound(['Jedi','Sith'].includes(c1.faction) ? 'lightsaber' : 'blaster');
    await dialoguePause(quote); // Use reading time
    hadRivalry = true;
  }
  
  if(GORE.rivalries[reverseKey] && Math.random() < 0.7){
    const quote = pick(GORE.rivalries[reverseKey]);
    await cinematicLog(`<div class="dialogue-box defender"><strong>${name2}:</strong> <em>"${quote}"</em></div>`, 'dialogue');
    updateCombatDialogue(name2, quote);
    await dialoguePause(quote); // Use reading time
    hadRivalry = true;
  }
  
  // If no rivalry, chance for faction taunt
  if(!hadRivalry && Math.random() < 0.4){
    const taunts = GORE.taunts[c1.faction];
    if(taunts){
      const taunt = pick(taunts);
      await cinematicLog(`<div class="dialogue-box attacker"><strong>${name1}:</strong> <em>"${taunt}"</em></div>`, 'dialogue');
      updateCombatDialogue(name1, taunt);
      await dialoguePause(taunt); // Use reading time
    }
  }
  
  // First attack (higher speed attacks first in the exchange)
  await doAttackCinematic(c1, c2);
  await pause(getDelay(400));
  
  // Counter attack if defender survives
  if(c2.alive && c1.alive){
    // Chance for defender to taunt back
    if(Math.random() < 0.25){
      const defTaunts = GORE.taunts[c2.faction];
      if(defTaunts){
        const taunt = pick(defTaunts);
        await cinematicLog(`<div class="dialogue-box defender"><strong>${name2}:</strong> <em>"${taunt}"</em></div>`, 'dialogue');
        updateCombatDialogue(name2, taunt);
        await dialoguePause(taunt);
      }
    }
    await doAttackCinematic(c2, c1);
    await pause(getDelay(300));
  }
}

async function doAttackCinematic(atk, def){
  if(!atk.alive || !def.alive) return;
  
  const atkPlayer = battle.players.find(p => p.id === atk.ownerId);
  const defPlayer = battle.players.find(p => p.id === def.ownerId);
  const allies = atkPlayer.combatants.filter(c => c.alive);
  const enemies = battle.players.filter(p => p.id !== atk.ownerId).flatMap(p => p.combatants.filter(c => c.alive));
  
  // Formation targeting
  const frontEnemies = enemies.filter(e => e.isFront);
  const backEnemies = enemies.filter(e => !e.isFront);
  let actualTarget = def;
  if(frontEnemies.length > 0 && !def.isFront && Math.random() > 0.2){
    actualTarget = pick(frontEnemies);
  }
  def = actualTarget;
  
  const sp = SPECIALS[atk.special];
  const atkEquipSpecials = atk.equipSpecials || [];
  const style = GORE.unitStyles[atk.id] || {};
  
  // Equipment: Flamethrower AoE
  if(atkEquipSpecials.includes('flamethrower') && Math.random() < 0.2){
    const aoeDmg = 25;
    enemies.forEach(e => { e.curHp -= aoeDmg; anim(e, 'hit'); });
    await cinematicLog(`<div class="special-attack"> ${atk.name} raises their vambracea torrent of flame engulfs the enemy ranks! <strong style="color:var(--orange)">ALL ENEMIES: ${aoeDmg} DMG</strong></div>`, 'special');
    enemies.filter(e => e.curHp <= 0 && e.alive).forEach(e => killUnitCinematic(e, atk));
    playSound('hit');
    return;
  }
  
  // Ice slip
  if(atk.slipped){
    await cinematicLog(` <em>${atk.name} loses footing on the ice, their attack going wide!</em>`, 'env');
    atk.slipped = false;
    return;
  }
  
  // Special ability check
  let abilityChance = sp?.chance || 0;
  if(atkEquipSpecials.includes('abilityBoost')) abilityChance += 0.2;
  if(atkEquipSpecials.includes('forceBoost') && ['Jedi', 'Sith'].includes(atk.faction)) abilityChance += 0.15;
  if(atk.forceBoost && ['Jedi', 'Sith'].includes(atk.faction)) abilityChance += atk.forceBoost;
  
  if(sp?.type === 'attack' && Math.random() < abilityChance){
    const r = sp.fn(atk, allies, enemies, def);
    if(r){
      // Dramatic ability announcement
      if(style.style){
        await cinematicLog(`<em>${style.style}</em>`, 'action');
        await pause(getDelay(300));
      }
      
      if(r.msg) await cinematicLog(r.msg, 'special');
      atk.specialsUsed = (atk.specialsUsed || 0) + 1;
      playSound(['Jedi', 'Sith'].includes(atk.faction) ? 'lightsaber' : 'blaster');
      
      if(r.dmgMod){
        let dmg = Math.max(5, getAtk(atk) - getDef(def) * 0.25 + Math.random() * 15) * r.dmgMod;
        if(atk.lightningBoost && sp.desc?.toLowerCase().includes('lightning')) dmg *= (1 + atk.lightningBoost);
        dmg = applyDef(def, dmg, atk);
        def.curHp -= dmg;
        atk.damageDealt = (atk.damageDealt || 0) + dmg;
        def.damageTaken = (def.damageTaken || 0) + dmg;
        battle.stats.damage[atk.name] = (battle.stats.damage[atk.name] || 0) + dmg;
        
        anim(def, r.dmgMod >= 2 ? 'crit' : 'hit');
        anim(atk, 'shake');
        await pause(getDelay(200));
        
        if(def.curHp <= 0) await killUnitCinematic(def, atk);
      }
      
      if(r.dmg){ atk.damageDealt = (atk.damageDealt || 0) + r.dmg; battle.stats.damage[atk.name] = (battle.stats.damage[atk.name] || 0) + r.dmg; }
      if(r.heal){ atk.healingDone = (atk.healingDone || 0) + r.heal; }
      
      for(const e of enemies.filter(e => e.curHp <= 0 && e.alive)){
        await killUnitCinematic(e, atk);
      }
      return;
    }
  }
  
  // Evasion check
  let evasion = 0;
  const evSp = SPECIALS[def.special];
  if(evSp?.type === 'passive'){ const m = evSp.fn(def); if(m?.evade) evasion += m.evade; }
  if((def.equipSpecials || []).includes('extraEvasion')) evasion += 0.2;
  
  if(evasion > 0 && Math.random() < evasion){
    await cinematicLog(`<em>${def.name} anticipates the strike, twisting away at the last moment!</em>`, 'special');
    return;
  }
  
  // Normal attack with cinematic narration
  let dmg = Math.max(5, getAtk(atk) - getDef(def) * 0.25 + Math.random() * 20);
  
  // Focus Fire tactical bonus
  if(battle.focusFire && battle.players[0].combatants.includes(atk)){
    dmg *= 1.5;
    await cinematicLog(` <span class="crit">FOCUSED STRIKE!</span> +50% damage!`, 'special');
    battle.focusFire = false;
    await pause(getDelay(200));
  }
  
  // Ambush bonus
  if(atk.ambushBonus){
    dmg *= 1.25;
    await cinematicLog(` <em>${atk.name} strikes from the shadows!</em>`, 'special');
    atk.ambushBonus = false;
    await pause(getDelay(200));
  }
  
  // Equipment bonuses
  if(atkEquipSpecials.includes('armorPierce')) dmg += getDef(def) * 0.5 * 0.25;
  if(atkEquipSpecials.includes('antiForce') && ['Jedi', 'Sith'].includes(def.faction)) dmg *= 1.25;
  if(atk.equipBoost && atkEquipSpecials.length) dmg *= (1 + atk.equipBoost);
  
  dmg = applyDef(def, dmg, atk);
  
  // Shield absorption
  if(def.shield > 0){
    const blocked = Math.min(def.shield, dmg);
    def.shield -= blocked;
    dmg -= blocked;
    if(blocked > 0){
      await cinematicLog(` <em>${def.name}'s shield flares, absorbing ${Math.round(blocked)} damage!</em>`, 'special');
      playSound('block');
    }
  }
  
  def.curHp -= dmg;
  atk.damageDealt = (atk.damageDealt || 0) + dmg;
  def.damageTaken = (def.damageTaken || 0) + dmg;
  battle.stats.damage[atk.name] = (battle.stats.damage[atk.name] || 0) + dmg;
  
  const isKill = def.curHp <= 0;
  const isCrit = dmg > 50;
  
  // Play sounds
  if(['Jedi', 'Sith'].includes(atk.faction)) playSound('lightsaber');
  else playSound('blaster');
  setTimeout(() => playSound('hit'), 150);
  
  // Visual animation
  animateCombat(atk, def, dmg, false, isCrit, isKill);
  
  // Cinematic attack narration
  const narration = narrateAttack(atk, def, dmg, isCrit, isKill);
  await cinematicLog(`${narration} <strong style="color:var(--red)">${Math.round(dmg)} DMG</strong>`, 'damage');
  
  anim(def, isCrit ? 'crit' : 'hit');
  anim(atk, 'shake');
  
  if(isKill) await killUnitCinematic(def, atk);
  
  renderBattle();
}

async function killUnitCinematic(v, k){
  if(!v.alive) return;
  
  // Check for onDeath abilities
  const sp = SPECIALS[v.special];
  if(sp?.type === 'onDeath' && (!sp.once || !v.usedRevival)){
    const r = sp.fn(v);
    if(r?.prevented){
      await cinematicLog(`<div class="revival-scene">${r.msg}</div>`, 'special');
      anim(v, 'resurrect');
      playSound('heal');
      await pause(getDelay(600));
      return;
    }
  }
  
  // Thermal Detonator
  if((v.equipSpecials || []).includes('detonator')){
    const enemies = battle.players.filter(p => p.id !== v.ownerId).flatMap(p => p.combatants.filter(c => c.alive));
    await cinematicLog(`<div class="explosion-scene"> <em>With dying breath, ${v.name} triggers their thermal detonator...</em></div>`, 'special');
    await pause(getDelay(400));
    await cinematicLog(`<strong style="color:var(--orange)">BOOM!</strong> The explosion tears through enemy ranks!`, 'special');
    enemies.forEach(e => { e.curHp -= 40; anim(e, 'shake'); });
    playSound('hit');
    await pause(getDelay(300));
    
    for(const e of enemies.filter(e => e.curHp <= 0 && e.alive)){
      e.alive = false;
      e.curHp = 0;
      await cinematicLog(` ${e.name} is consumed by the blast!`, 'death');
    }
  }
  
  // Last words (for notable characters)
  if(GORE.lastWords[v.id] && Math.random() < 0.6){
    const lastWord = pick(GORE.lastWords[v.id]);
    await cinematicLog(`<div class="last-words"><strong>${v.name}:</strong> <em>"${lastWord}"</em></div>`, 'dialogue');
    updateCombatDialogue(v.name, lastWord);
    await dialoguePause(lastWord); // Use reading time for dramatic effect
  }
  
  v.alive = false;
  v.curHp = 0;
  anim(v, 'death');
  playSound('death');
  
  playerStats.totalKills++;
  saveStats();
  
  // Cinematic death narration
  const killNarration = narrateKill(v, k);
  await cinematicLog(killNarration, 'death');
  
  // Leader death morale
  if(v.isLeader){
    const team = battle.players.find(p => p.id === v.ownerId);
    if(team && !team.moraleLost && !team.noLeader){
      team.moraleLost = true;
      team.combatants.filter(c => c.alive).forEach(c => { c.atkBuff -= 0.1; c.defBuff -= 0.1; });
      await pause(getDelay(300));
      await cinematicLog(`<div class="morale-break"> <em>With their leader fallen, ${team.name}'s remaining forces falter. Fear spreads through the ranks.</em> <span style="color:var(--red)">(-10% ATK/DEF)</span></div>`, 'death');
    }
  }
  
  // Killer's reaction (for notable kills)
  if(k && GORE.victoryLines[k.id] && v.cost >= 3 && Math.random() < 0.5){
    await pause(getDelay(300));
    await cinematicLog(`<div class="killer-taunt"><strong>${k.name}:</strong> <em>"${GORE.victoryLines[k.id]}"</em></div>`, 'dialogue');
    updateCombatDialogue(k.name, GORE.victoryLines[k.id]);
  }
  
  if(k){
    k.killCount = (k.killCount || 0) + 1;
    battle.stats.kills[k.name] = (battle.stats.kills[k.name] || 0) + 1;
  }
  
  renderBattle();
  await pause(getDelay(400));
}

async function endCinematicBattle(){
  battleRunning = false;
  stopBattlefieldMusic();
  
  let winner = null, loser = null;
  const all = battle.players.flatMap(p => p.combatants.filter(c => c.alive));
  
  if(mode === 'hunger' && battle.phase === 'ffa' && all.length === 1){
    // Hunger games winner
  } else if(mode === 'teams'){
    // Team mode
  } else {
    winner = battle.players.find(p => p.combatants.some(c => c.alive));
    loser = battle.players.find(p => !p.combatants.some(c => c.alive));
  }
  
  // Dramatic pause before victory
  await pause(getDelay(500));
  
  await cinematicLog(`<div class="battle-end-header"> BATTLE COMPLETE </div>`, 'round');
  await pause(getDelay(400));
  
  if(winner){
    // Victory fanfare
    if(winner.id === 'p1' || !aiMode) playSound('victory');
    else playSound('defeat');
    
    // Dramatic victory narration
    const survivors = winner.combatants.filter(c => c.alive);
    await cinematicLog(`<div class="victory-scene">
       <strong style="color:${winner.color};font-size:1.3em">${winner.name} CLAIMS VICTORY!</strong>
    </div>`, 'victory');
    await pause(getDelay(500));
    
    // Survivor descriptions
    if(survivors.length === 1){
      const last = survivors[0];
      await cinematicLog(`<em>${last.name} stands alone amid the carnage, ${Math.round(last.curHp)}/${last.maxHp} HP remaining. The sole survivor.</em>`, 'info');
    } else if(survivors.length > 1){
      await cinematicLog(`<em>${survivors.map(s => s.name).join(', ')} remain standing. Bloodied, but victorious.</em>`, 'info');
    }
    
    await pause(getDelay(400));
    
    // MVP announcement
    const everyone = battle.players.flatMap(p => p.combatants);
    const mvp = everyone.reduce((a, b) => (a.damageDealt || 0) > (b.damageDealt || 0) ? a : b);
    const topKiller = everyone.reduce((a, b) => (a.killCount || 0) > (b.killCount || 0) ? a : b);
    
    if(mvp && mvp.damageDealt > 0){
      await cinematicLog(`<div class="mvp-announcement"> <strong>MVP:</strong> ${mvp.name}  ${Math.round(mvp.damageDealt)} damage dealt</div>`, 'info');
    }
    if(topKiller && topKiller.killCount > 1){
      await cinematicLog(`<div class="killer-announcement"> <strong>Deadliest:</strong> ${topKiller.name}  ${topKiller.killCount} kills</div>`, 'info');
    }
    
    if(winner && loser) checkBattleAchievements(winner, loser);
  } else {
    await cinematicLog(`<div class="draw-scene"> <strong>DRAW!</strong> Both sides have been annihilated.</div>`, 'round');
  }
  
  // Full stats panel
  await pause(getDelay(300));
  
  const everyone = battle.players.flatMap(p => p.combatants);
  const byDamage = [...everyone].sort((a, b) => (b.damageDealt || 0) - (a.damageDealt || 0));
  const totalDmg = everyone.reduce((s, u) => s + (u.damageDealt || 0), 0);
  const totalKills = everyone.reduce((s, u) => s + (u.killCount || 0), 0);
  
  let statsHtml = `<div class="stats-panel">
    <div class="stats-title"> BATTLE STATISTICS</div>
    <div style="margin-top:10px">
      ${everyone.map(u => `<div class="unit-stats-row">
        <span class="emoji">${u.emoji}</span>
        <span class="name">${u.name} ${u.alive ? '' : ''}</span>
        <div class="stats">
          <span>DMG:<strong>${Math.round(u.damageDealt || 0)}</strong></span>
          <span>K:<strong>${u.killCount || 0}</strong></span>
        </div>
      </div>`).join('')}
    </div>
    <div style="margin-top:10px;text-align:center;font-size:0.7em;color:#888">
      Battle lasted ${battle.round} rounds | Total Damage: ${Math.round(totalDmg)} | Total Kills: ${totalKills}
    </div>
  </div>`;
  
  addLog(statsHtml, 'stats');
  
  // Reset controls
  document.getElementById('controls').innerHTML = `
    <button class="btn" onclick="startBattle()"> NEW BATTLE</button>
    <button class="btn sec" onclick="randomAll()"> Random Teams</button>
    <button class="btn red" onclick="resetAll()"> Reset</button>
  `;
  
  battle = null;
  showBattleArena(false);
}

async function doHazardCinematic(){
  const bf = battle.bf;
  if(!bf.hazards || !bf.hazards.length) return;
  
  const hazard = pick(bf.hazards);
  const targets = battle.players.flatMap(p => p.combatants.filter(c => c.alive));
  if(!targets.length) return;
  
  const target = pick(targets);
  let dmg = 15 + Math.random() * 25;
  
  await cinematicLog(`<div class="hazard-event"> <strong>ENVIRONMENTAL HAZARD:</strong> ${hazard}!</div>`, 'env');
  await pause(getDelay(400));
  
  target.curHp -= dmg;
  await cinematicLog(` ${target.name} takes <strong style="color:var(--orange)">${Math.round(dmg)}</strong> damage from the ${hazard.toLowerCase()}!`, 'damage');
  anim(target, 'shake');
  
  if(target.curHp <= 0) await killUnitCinematic(target, null);
  
  renderBattle();
}

async function handleNpcEncounterCinematic(npc){
  const hostileClass = npc.hostile ? 'hostile' : 'friendly';
  
  await cinematicLog(`<div class="npc-encounter ${hostileClass}">
    <div class="npc-unit"><span class="emoji">${npc.emoji}</span><strong>${npc.name}</strong></div>
    <div><em>${npc.msg}</em></div>
  </div>`, 'env');
  await pause(getDelay(600));
  
  if(npc.hostile){
    const allAlive = battle.players.flatMap(p => p.combatants.filter(c => c.alive));
    const targets = allAlive.sort(() => Math.random() - 0.5).slice(0, Math.min(2, allAlive.length));
    
    for(const target of targets){
      const dmg = Math.max(5, npc.atk - target.def * 0.3 + Math.random() * 15);
      target.curHp -= dmg;
      await cinematicLog(` ${npc.name} attacks ${target.name}! <strong style="color:var(--red)">${Math.round(dmg)} DMG</strong>`, 'damage');
      anim(target, 'hit');
      if(target.curHp <= 0) await killUnitCinematic(target, null);
      await pause(getDelay(300));
    }
  } else if(npc.buff){
    const team = pick(battle.players);
    const alive = team.combatants.filter(c => c.alive);
    if(alive.length){
      const target = pick(alive);
      if(npc.buff.hp) target.curHp = Math.min(target.maxHp, target.curHp + npc.buff.hp);
      if(npc.buff.atk) target.atkBuff += npc.buff.atk / 100;
      if(npc.buff.def) target.defBuff += npc.buff.def / 100;
      await cinematicLog(` ${target.name} receives a blessing! ${npc.buff.hp ? `+${npc.buff.hp} HP ` : ''}${npc.buff.atk ? `+${npc.buff.atk}% ATK ` : ''}${npc.buff.def ? `+${npc.buff.def}% DEF` : ''}`, 'heal');
      anim(target, 'heal');
    }
  }
  
  renderBattle();
}

async function executeComboCinematic(combo, allies, enemies){
  const participants = allies.filter(a => a.alive && combo.units.some(id => a.id === id || a.faction === id));
  if(participants.length < 2) return;
  
  await cinematicLog(`<div class="combo-announcement">
     <strong>COMBO ATTACK:</strong> ${combo.name}!
    <div style="font-size:0.8em;color:#aaa">${participants.map(p => p.name).join(' + ')}</div>
  </div>`, 'special');
  await pause(getDelay(500));
  
  // Execute combo effect (simplified - use existing executeCombo logic)
  const target = pick(enemies);
  if(target){
    const dmg = combo.damage || 50;
    target.curHp -= dmg;
    await cinematicLog(` ${combo.name} deals <strong style="color:var(--purple)">${dmg}</strong> damage to ${target.name}!`, 'special');
    anim(target, 'crit');
    playSound('hit');
    if(target.curHp <= 0) await killUnitCinematic(target, participants[0]);
  }
  
  await pause(getDelay(400));
  renderBattle();
}

function areEnemies(c1,c2){if(battle.phase==='ffa')return true;if(mode==='teams'){const p1=players.find(p=>p.id===c1.ownerId),p2=players.find(p=>p.id===c2.ownerId);return p1?.alliance!==p2?.alliance;}return c1.ownerId!==c2.ownerId;}

function doCombat(c1,c2){if(!c1.alive||!c2.alive)return;doAttack(c1,c2);if(c2.alive&&c1.alive)doAttack(c2,c1);}

function doAttack(atk,def){
  if(!atk.alive||!def.alive)return;
  const atkPlayer=battle.players.find(p=>p.id===atk.ownerId);
  const defPlayer=battle.players.find(p=>p.id===def.ownerId);
  const allies=atkPlayer.combatants.filter(c=>c.alive);
  const enemies=battle.players.filter(p=>p.id!==atk.ownerId).flatMap(p=>p.combatants.filter(c=>c.alive));
  
  // Formation targeting: prefer front line unless all front dead
  const frontEnemies=enemies.filter(e=>e.isFront);
  const backEnemies=enemies.filter(e=>!e.isFront);
  let actualTarget=def;
  if(frontEnemies.length>0&&!def.isFront&&Math.random()>0.2){
    // 80% chance to redirect to front line if attacking back while front exists
    actualTarget=pick(frontEnemies);
  }
  def=actualTarget;
  
  const sp=SPECIALS[atk.special];
  const atkEquipSpecials=atk.equipSpecials||[];
  
  // Equipment: Flamethrower AoE
  if(atkEquipSpecials.includes('flamethrower')&&Math.random()<0.2){
    const aoeDmg=25;
    enemies.forEach(e=>{e.curHp-=aoeDmg;anim(e,'hit');});
    addLog(` ${atk.name}'s vambrace unleashes FLAMES! All enemies take ${aoeDmg}!`,'special');
  }
  
  // ICE TERRAIN: Slip check
  if(atk.slipped){
    addLog(` ${atk.name} slips on the ice and misses!`,'env');
    atk.slipped=false;
    return;
  }
  
  // Check special attack trigger (with Holocron boost + terrain boosts)
  let abilityChance=sp?.chance||0;
  if(atkEquipSpecials.includes('abilityBoost'))abilityChance+=0.2;
  if(atkEquipSpecials.includes('forceBoost')&&['Jedi','Sith'].includes(atk.faction))abilityChance+=0.15;
  if(atk.forceBoost&&['Jedi','Sith'].includes(atk.faction))abilityChance+=atk.forceBoost; // Swamp terrain
  
  if(sp?.type==='attack'&&Math.random()<abilityChance){
    const r=sp.fn(atk,allies,enemies,def);
    if(r){
      if(r.msg)addLog(r.msg,'special');
      atk.specialsUsed=(atk.specialsUsed||0)+1;
      if(r.dmgMod){
        let dmg=Math.max(5,getAtk(atk)-getDef(def)*0.25+Math.random()*15)*r.dmgMod;
        // Lightning boost from storm terrain
        if(atk.lightningBoost&&sp.desc?.toLowerCase().includes('lightning'))dmg*=(1+atk.lightningBoost);
        dmg=applyDef(def,dmg,atk);def.curHp-=dmg;
        atk.damageDealt=(atk.damageDealt||0)+dmg;def.damageTaken=(def.damageTaken||0)+dmg;
        battle.stats.damage[atk.name]=(battle.stats.damage[atk.name]||0)+dmg;
        addLog(`${atk.name} ${pick(GORE.slash)} ${def.name}! <strong style="color:var(--red)">${Math.round(dmg)} DMG</strong>`,'damage');
        anim(def,r.dmgMod>=2?'crit':'hit');anim(atk,'shake');if(def.curHp<=0)killUnit(def,atk);
      }
      if(r.dmg){atk.damageDealt=(atk.damageDealt||0)+r.dmg;battle.stats.damage[atk.name]=(battle.stats.damage[atk.name]||0)+r.dmg;}
      if(r.heal){atk.healingDone=(atk.healingDone||0)+r.heal;}
      enemies.filter(e=>e.curHp<=0&&e.alive).forEach(e=>killUnit(e,atk));
      return;
    }
  }
  
  // Evasion check (with Jetpack equipment boost)
  let evasion=0;
  const evSp=SPECIALS[def.special];if(evSp?.type==='passive'){const m=evSp.fn(def);if(m?.evade)evasion+=m.evade;}
  if((def.equipSpecials||[]).includes('extraEvasion'))evasion+=0.2;
  if(evasion>0&&Math.random()<evasion){addLog(`${def.name} evades!`,'special');return;}
  
  // Normal attack with equipment modifiers
  let dmg=Math.max(5,getAtk(atk)-getDef(def)*0.25+Math.random()*20);
  
  // FOREST TERRAIN: Ambush bonus
  if(atk.ambushBonus){
    dmg*=1.25;
    addLog(` ${atk.name} strikes from ambush! +25% damage!`,'special');
    atk.ambushBonus=false;
  }
  
  // Equipment: Armor Pierce
  if(atkEquipSpecials.includes('armorPierce'))dmg+=getDef(def)*0.5*0.25; // Ignore 50% of armor reduction
  // Equipment: Anti-Force bonus
  if(atkEquipSpecials.includes('antiForce')&&['Jedi','Sith'].includes(def.faction))dmg*=1.25;
  // Equipment boost from scrap terrain
  if(atk.equipBoost&&atkEquipSpecials.length)dmg*=(1+atk.equipBoost);
  
  dmg=applyDef(def,dmg,atk);
  if(def.shield>0){const blocked=Math.min(def.shield,dmg);def.shield-=blocked;dmg-=blocked;if(blocked>0){addLog(` Shield absorbs ${Math.round(blocked)} damage! The energy dissipates harmlessly.`,'special');playSound('block');}}
  def.curHp-=dmg;
  atk.damageDealt=(atk.damageDealt||0)+dmg;def.damageTaken=(def.damageTaken||0)+dmg;
  battle.stats.damage[atk.name]=(battle.stats.damage[atk.name]||0)+dmg;
  
  const isKill=def.curHp<=0;
  const isCrit=dmg>50;
  
  // Play attack sound based on faction
  if(['Jedi','Sith'].includes(atk.faction))playSound('lightsaber');
  else playSound('blaster');
  setTimeout(()=>playSound('hit'),150);
  
  // Visual arena animation
  animateCombat(atk,def,dmg,false,isCrit,isKill);
  
  // Cinematic narration
  const narration = narrateAttack(atk, def, dmg, isCrit, isKill);
  addLog(`${narration} <strong style="color:var(--red)">${Math.round(dmg)} DMG</strong>`,'damage');
  anim(def,isCrit?'crit':'hit');anim(atk,'shake');if(isKill)killUnit(def,atk);
}

function applyDef(def,dmg,atk){
  const sp=SPECIALS[def.special];
  if(sp?.type==='defend'&&Math.random()<(sp.chance||1)){const r=sp.fn(def,dmg,atk);if(r){if(r.reduce){dmg-=r.reduce;anim(def,'block');}if(r.msg)addLog(r.msg,'special');}}
  return Math.max(0,dmg);
}

function killUnit(v,k){
  if(!v.alive)return;
  
  // Check for onDeath abilities like Dark Revival
  const sp=SPECIALS[v.special];
  if(sp?.type==='onDeath'&&(!sp.once||!v.usedRevival)){
    const r=sp.fn(v);
    if(r?.prevented){
      addLog(r.msg,'special');
      anim(v,'resurrect');
      return; // Death prevented
    }
  }
  
  // Equipment: Thermal Detonator on death
  if((v.equipSpecials||[]).includes('detonator')){
    const enemies=battle.players.filter(p=>p.id!==v.ownerId).flatMap(p=>p.combatants.filter(c=>c.alive));
    enemies.forEach(e=>{e.curHp-=40;anim(e,'shake');});
    addLog(` With a dying gasp, ${v.name} triggers their THERMAL DETONATOR! The explosion tears through enemy ranks, dealing 40 damage to all!`,'special');
    enemies.filter(e=>e.curHp<=0&&e.alive).forEach(e=>{e.alive=false;e.curHp=0;addLog(` ${e.name} is consumed by the blast, their body torn apart by the explosion!`,'death');});
  }
  
  v.alive=false;v.curHp=0;anim(v,'death');
  playSound('death');
  
  // Track kills for achievements
  playerStats.totalKills++;
  saveStats();
  
  // Cinematic kill narration
  const killNarration = narrateKill(v, k);
  addLog(killNarration, 'death');
  
  // Check if killed unit was a leader
  if(v.isLeader){
    const team=battle.players.find(p=>p.id===v.ownerId);
    if(team&&!team.moraleLost&&!team.noLeader){
      team.moraleLost=true;
      team.combatants.filter(c=>c.alive).forEach(c=>{c.atkBuff-=0.1;c.defBuff-=0.1;});
      addLog(`<div style="color:var(--red);font-style:italic"> With their leader fallen, ${team.name}'s remaining forces falter. Fear spreads through the ranks. (-10% ATK/DEF)</div>`,'death');
    }
  }
  
  if(k){
    battle.stats.kills[k.name]=(battle.stats.kills[k.name]||0)+1;
  }
}

// NPC ENCOUNTER SYSTEM
function handleNpcEncounter(npc){
  const hostileClass=npc.hostile?'hostile':'friendly';
  addLog(`<div class="npc-encounter ${hostileClass}">
    <div class="npc-unit"><span class="emoji">${npc.emoji}</span><strong>${npc.name}</strong><span class="stats">HP:${npc.hp} ATK:${npc.atk} DEF:${npc.def}</span></div>
    <div>${npc.msg}</div>
  </div>`,'env');
  
  if(npc.hostile){
    // Hostile NPC attacks random units from both teams
    const allAlive=battle.players.flatMap(p=>p.combatants.filter(c=>c.alive));
    const targets=allAlive.sort(()=>Math.random()-0.5).slice(0,Math.min(3,allAlive.length));
    let npcHp=npc.hp;
    
    targets.forEach(target=>{
      if(npcHp<=0)return;
      // NPC attacks target
      const dmg=Math.max(5,npc.atk-target.def*0.3+Math.random()*15);
      target.curHp-=dmg;
      anim(target,'hit');
      addLog(`${npc.emoji} ${npc.name} attacks ${target.name} for ${Math.round(dmg)} damage!`,'damage');
      if(target.curHp<=0)killUnit(target,null);
      
      // Target counterattacks if alive
      if(target.alive){
        const counter=Math.max(5,target.atk-npc.def*0.3+Math.random()*10);
        npcHp-=counter;
        addLog(` ${target.name} counterattacks! ${Math.round(counter)} damage to ${npc.name}`,'damage');
      }
    });
    
    if(npcHp<=0){
      addLog(` ${npc.name} has been defeated!`,'death');
      // Reward: small heal to all survivors
      allAlive.filter(c=>c.alive).forEach(c=>{
        const heal=Math.min(10,c.maxHp-c.curHp);
        if(heal>0)c.curHp+=heal;
      });
      addLog(` Victory bonus: All survivors heal 10 HP!`,'heal');
    }else{
      addLog(`${npc.emoji} ${npc.name} retreats with ${Math.round(npcHp)} HP remaining...`,'env');
    }
  }else{
    // Friendly NPC - provides buffs or allies
    if(npc.buff){
      // Apply buff to random player's team
      const luckyPlayer=pick(battle.players);
      luckyPlayer.combatants.filter(c=>c.alive).forEach(c=>{
        if(npc.buff.hp)c.curHp=Math.min(c.maxHp,c.curHp+npc.buff.hp);
        if(npc.buff.atk)c.atkBuff+=(npc.buff.atk/100);
        if(npc.buff.def)c.defBuff+=(npc.buff.def/100);
      });
      const buffDesc=[];
      if(npc.buff.hp)buffDesc.push(`+${npc.buff.hp} HP`);
      if(npc.buff.atk)buffDesc.push(`+${npc.buff.atk}% ATK`);
      if(npc.buff.def)buffDesc.push(`+${npc.buff.def}% DEF`);
      addLog(` ${npc.name} buffs <span style="color:${luckyPlayer.color}">${luckyPlayer.name}</span>'s team: ${buffDesc.join(', ')}!`,'heal');
    }
    
    if(npc.ally){
      // Add temporary ally to a player's team (favors matching faction)
      let targetPlayer=battle.players[Math.floor(Math.random()*battle.players.length)];
      if(npc.faction){
        const factionMatch=battle.players.find(p=>p.combatants.some(c=>c.faction===npc.faction));
        if(factionMatch)targetPlayer=factionMatch;
      }
      
      const allyUnit={
        name:npc.name,emoji:npc.emoji,hp:npc.hp,maxHp:npc.hp,curHp:npc.hp,
        atk:npc.atk,def:npc.def,alive:true,isNpc:true,
        ownerId:targetPlayer.id,ownerColor:targetPlayer.color,
        atkBuff:0,defBuff:0,isFront:true,
        uid:'npc-'+Date.now()
      };
      targetPlayer.combatants.push(allyUnit);
      addLog(` ${npc.name} joins <span style="color:${targetPlayer.color}">${targetPlayer.name}</span>'s team!`,'synergy');
    }
  }
  renderBattle();
}

function doHazard(){const h=pick(battle.bf.hazards);const all=battle.players.flatMap(p=>p.combatants.filter(c=>c.alive));if(!all.length)return;const v=pick(all);const dmg=Math.floor(Math.random()*25)+10;v.curHp-=dmg;v.damageTaken=(v.damageTaken||0)+dmg;addLog(` ${h} hits ${v.name} for ${dmg}!`,'env');anim(v,'shake');if(v.curHp<=0)killUnit(v,null);}

function triggerFFA(){battle.phase='ffa';battle.round=0;addLog(' <strong>FREE-FOR-ALL!</strong> ','round');addLog('<em>Only one survives...</em>','env');document.getElementById('controls').innerHTML=`<button class="btn cont" onclick="runRound()"> FFA</button><button class="btn red" onclick="resetAll()"> Reset</button>`;}

function checkEnd(){const all=battle.players.flatMap(p=>p.combatants.filter(c=>c.alive));if(mode==='hunger'&&battle.phase==='ffa')return all.length<=1;if(mode==='teams'){const alive=battle.players.filter(p=>p.combatants.some(c=>c.alive));const teams=new Set(alive.map(p=>players.find(x=>x.id===p.id)?.alliance));return teams.size<=1;}return battle.players.filter(p=>p.combatants.some(c=>c.alive)).length<=1;}

function endBattle(){
  stopBattlefieldMusic();
  
  let winText='',winUnit=null,winner=null,loser=null;
  const all=battle.players.flatMap(p=>p.combatants.filter(c=>c.alive));
  
  if(mode==='hunger'&&battle.phase==='ffa'&&all.length===1){winUnit=all[0];winText=` ${winUnit.name} WINS!`;}
  else if(mode==='teams'){const alive=battle.players.filter(p=>p.combatants.some(c=>c.alive));if(alive.length){const team=players.find(x=>x.id===alive[0].id)?.alliance;winText=` TEAM ${team==='A'?'ALPHA':'BETA'} WINS!`;}}
  else{
    winner=battle.players.find(p=>p.combatants.some(c=>c.alive));
    loser=battle.players.find(p=>!p.combatants.some(c=>c.alive));
    if(winner){winText=` ${winner.name} WINS!`;winUnit=winner.combatants.find(c=>c.alive);}
  }
  if(!winText)winText=' DRAW!';
  
  // Cinematic battle end narration
  addLog(narrateBattleSummary(winner || battle.players[0], battle.stats),'round');
  
  // Play victory/defeat sound
  const isPlayerWin = winner && (winner.id==='p1' || !aiMode);
  if(winner){
    playSound(isPlayerWin ? 'victory' : 'defeat');
    if(winner&&loser)checkBattleAchievements(winner,loser);
  }
  
  // Gather all combatants for stats
  const everyone=battle.players.flatMap(p=>p.combatants);
  const byDamage=[...everyone].sort((a,b)=>(b.damageDealt||0)-(a.damageDealt||0));
  const byKills=[...everyone].sort((a,b)=>(b.killCount||0)-(a.killCount||0));
  const byHeals=[...everyone].filter(u=>u.healingDone>0).sort((a,b)=>(b.healingDone||0)-(a.healingDone||0));
  const byTaken=[...everyone].sort((a,b)=>(b.damageTaken||0)-(a.damageTaken||0));
  
  const mvp=byDamage[0];
  const topKiller=byKills[0]?.killCount>0?byKills[0]:null;
  const topHealer=byHeals[0];
  const tank=byTaken[0];
  
  const totalDmg=everyone.reduce((s,u)=>s+(u.damageDealt||0),0);
  const totalHeals=everyone.reduce((s,u)=>s+(u.healingDone||0),0);
  const totalKills=everyone.reduce((s,u)=>s+(u.killCount||0),0);
  
  // Save to battle history
  saveBattleHistory({
    date: new Date().toISOString(),
    winner: winner?.name || 'Draw',
    loser: loser?.name || 'N/A',
    rounds: battle.round,
    battlefield: selectedBattlefield?.name || 'Unknown',
    mvp: mvp?.name || 'N/A',
    mvpDamage: Math.round(mvp?.damageDealt || 0),
    totalDamage: Math.round(totalDmg),
    mode: mode,
    isTournament: !!tournament
  });
  
  // Build victory screen HTML
  const victoryClass = isPlayerWin ? 'victory' : (winner ? 'defeat' : 'draw');
  
  document.getElementById('winner').innerHTML=`
    <div class="victory-screen ${victoryClass}">
      <div class="victory-banner">
        <div class="victory-glow"></div>
        <div class="victory-text">${winText}</div>
        ${winUnit ? `
          <div class="victory-champion">
            <div class="champion-portrait">${createPortraitImg(winUnit.id, winUnit.variant, winUnit.emoji, '100%')}</div>
            <div class="champion-name">${getCombatName(winUnit)}</div>
            <div class="champion-hp">${Math.round(winUnit.curHp)}/${winUnit.maxHp} HP</div>
          </div>
        ` : ''}
      </div>
      
      <div class="victory-stats">
        <div class="stats-title"> BATTLE STATISTICS</div>
        <div class="stats-grid">
          <div class="stat-card mvp">
            <div class="stat-icon"></div>
            <div class="stat-label">MVP</div>
            <div class="stat-value">${Math.round(mvp?.damageDealt||0)} DMG</div>
            <div class="stat-name">${mvp?.name||'N/A'}</div>
          </div>
          <div class="stat-card kills">
            <div class="stat-icon"></div>
            <div class="stat-label">Deadliest</div>
            <div class="stat-value">${topKiller?.killCount||0} Kills</div>
            <div class="stat-name">${topKiller?.name||'N/A'}</div>
          </div>
          ${topHealer?`
          <div class="stat-card healer">
            <div class="stat-icon"></div>
            <div class="stat-label">Healer</div>
            <div class="stat-value">${Math.round(topHealer.healingDone)} HP</div>
            <div class="stat-name">${topHealer.name}</div>
          </div>`:''}
          <div class="stat-card tank">
            <div class="stat-icon"></div>
            <div class="stat-label">Tank</div>
            <div class="stat-value">${Math.round(tank?.damageTaken||0)} Taken</div>
            <div class="stat-name">${tank?.name||'N/A'}</div>
          </div>
        </div>
        
        <div class="battle-totals">
          <span> ${Math.round(totalDmg)} Total Damage</span>
          <span> ${totalKills} Kills</span>
          <span> ${Math.round(totalHeals)} Healed</span>
          <span> ${battle.round} Rounds</span>
        </div>
      </div>
      
      <div class="victory-actions">
        ${tournament ? `
          <button class="btn victory-btn" onclick="continueTournament()"> NEXT MATCH</button>
        ` : `
          <button class="btn victory-btn" onclick="rematch()"> REMATCH</button>
          <button class="btn victory-btn sec" onclick="closeWinner();resetAll()"> NEW TEAMS</button>
        `}
        <button class="btn victory-btn" onclick="viewBattleHistory()"> HISTORY</button>
      </div>
    </div>
  `;
  document.getElementById('winner').classList.add('show');
  document.getElementById('controls').innerHTML=`<button class="btn" onclick="resetAll()"> NEW BATTLE</button>`;
  
  // Handle tournament progression
  if(tournament && winner){
    tournament.results.push({
      match: tournament.currentMatch,
      winner: winner.name,
      loser: loser?.name
    });
  }
  
  battle=null;
}

// Battle History System
let battleHistory = JSON.parse(localStorage.getItem('gc_battle_history') || '[]');

function saveBattleHistory(record){
  battleHistory.unshift(record);
  if(battleHistory.length > 50) battleHistory = battleHistory.slice(0, 50); // Keep last 50
  localStorage.setItem('gc_battle_history', JSON.stringify(battleHistory));
}

function viewBattleHistory(){
  closeWinner();
  const historyHtml = battleHistory.length ? battleHistory.map((h, i) => `
    <div class="history-entry ${h.isTournament ? 'tournament' : ''}">
      <div class="history-rank">#${i + 1}</div>
      <div class="history-info">
        <div class="history-winner"> ${h.winner}</div>
        <div class="history-details">
          vs ${h.loser}  ${h.rounds} rounds  ${h.battlefield}
        </div>
        <div class="history-mvp">MVP: ${h.mvp} (${h.mvpDamage} dmg)</div>
      </div>
      <div class="history-date">${new Date(h.date).toLocaleDateString()}</div>
    </div>
  `).join('') : '<div style="text-align:center;color:#888;padding:20px">No battles yet!</div>';
  
  document.getElementById('winner').innerHTML = `
    <div class="history-screen">
      <div class="history-header">
        <h2> BATTLE HISTORY</h2>
        <button class="btn sec" onclick="clearBattleHistory()"> Clear</button>
      </div>
      <div class="history-list">${historyHtml}</div>
      <button class="btn" onclick="closeWinner()">CLOSE</button>
    </div>
  `;
  document.getElementById('winner').classList.add('show');
}

function clearBattleHistory(){
  if(confirm('Clear all battle history?')){
    battleHistory = [];
    localStorage.removeItem('gc_battle_history');
    viewBattleHistory();
  }
}

function rematch(){
  closeWinner();
  startBattle();
}

function closeWinner(){document.getElementById('winner').classList.remove('show');}
// MOBILE SCREEN NAVIGATION
function showScreen(screen){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  event.target.closest('.nav-btn').classList.add('active');
  
  const panel=document.querySelector('.panel');
  const arena=document.querySelector('.arena');
  const formPanel=document.getElementById('formation-panel');
  const equipPanel=document.getElementById('equipment-panel');
  
  // Reset visibility
  if(panel)panel.style.display='';
  if(arena)arena.style.display='';
  if(formPanel)formPanel.style.display='';
  if(equipPanel)equipPanel.style.display='';
  
  if(window.innerWidth<=768){
    switch(screen){
      case 'game':
        if(panel)panel.style.display='none';
        break;
      case 'team':
        if(arena)arena.style.display='none';
        if(equipPanel)equipPanel.style.display='none';
        break;
      case 'equip':
        if(arena)arena.style.display='none';
        if(formPanel)formPanel.style.display='none';
        break;
    }
  }
}

// ENCYCLOPEDIA SYSTEM
function openEncyclopedia(){
  renderEncyclopedia('units');
  document.getElementById('encyclopedia').classList.add('show');
}

function closeEncyclopedia(){
  document.getElementById('encyclopedia').classList.remove('show');
}

function renderEncyclopedia(tab='units'){
  const enc=document.getElementById('encyclopedia');
  
  let content='';
  switch(tab){
    case 'units':content=renderEncUnits();break;
    case 'abilities':content=renderEncAbilities();break;
    case 'equipment':content=renderEncEquipment();break;
    case 'battlefields':content=renderEncBattlefields();break;
    case 'synergies':content=renderEncSynergies();break;
  }
  
  enc.innerHTML=`
    <div class="encyclopedia">
      <div class="encyclopedia-header">
        <div class="encyclopedia-title"> GALAXY CLASH ENCYCLOPEDIA</div>
        <button class="encyclopedia-close" onclick="closeEncyclopedia()"> Close</button>
      </div>
      <input type="text" class="enc-search" id="enc-search" placeholder=" Search..." oninput="filterEncyclopedia()">
      <div class="encyclopedia-tabs">
        <button class="enc-tab ${tab==='units'?'active':''}" onclick="renderEncyclopedia('units')"> Units (${UNITS.length})</button>
        <button class="enc-tab ${tab==='abilities'?'active':''}" onclick="renderEncyclopedia('abilities')"> Abilities (${Object.keys(SPECIALS).length})</button>
        <button class="enc-tab ${tab==='equipment'?'active':''}" onclick="renderEncyclopedia('equipment')"> Equipment (${Object.keys(EQUIPMENT).length})</button>
        <button class="enc-tab ${tab==='battlefields'?'active':''}" onclick="renderEncyclopedia('battlefields')"> Battlefields (${BATTLEFIELDS.length})</button>
        <button class="enc-tab ${tab==='synergies'?'active':''}" onclick="renderEncyclopedia('synergies')"> Synergies</button>
      </div>
      <div class="encyclopedia-content" id="enc-content">${content}</div>
    </div>`;
}

function filterEncyclopedia(){
  const search=document.getElementById('enc-search').value.toLowerCase();
  document.querySelectorAll('.enc-card').forEach(card=>{
    const text=card.textContent.toLowerCase();
    card.style.display=text.includes(search)?'':'none';
  });
}

function renderEncUnits(){
  const factions=[...new Set(UNITS.map(u=>u.faction))].sort();
  
  return factions.map(faction=>{
    const factionUnits=UNITS.filter(u=>u.faction===faction).sort((a,b)=>b.cost-a.cost);
    return `
      <div class="enc-section">
        <div class="enc-section-title">${faction} (${factionUnits.length} units)</div>
        <div class="enc-grid">
          ${factionUnits.map(u=>{
            const variants=VARIANTS[u.id]||[];
            const spec=SPECIALS[u.special];
            const hasImage = unitImages[u.id] ? true : false;
            return `
              <div class="enc-card" data-search="${u.name} ${u.faction} ${u.special||''}">
                <div class="enc-card-header">
                  <div class="enc-card-avatar ${hasImage?'has-image':''}">${createPortraitImg(u.id, null, u.emoji)}</div>
                  <div class="enc-card-info">
                    <div class="enc-card-name">${u.name} ${!hasImage?'<span class="no-image-badge"></span>':''}</div>
                    <div class="enc-card-meta">
                      <span> $${u.cost}</span>
                      <span> ${u.faction}</span>
                      ${u.stack?`<span> Squad (${u.qty})</span>`:''}
                    </div>
                    <div class="enc-card-stats">
                      <div class="hp"> ${u.hp}</div>
                      <div class="atk"> ${u.atk}</div>
                      <div class="def"> ${u.def}</div>
                    </div>
                  </div>
                </div>
                <div class="enc-card-desc">${u.desc}</div>
                ${u.special?`<div class="enc-card-special"><span class="name">${u.special}:</span> <span class="desc">${spec?.desc||'Special ability'}</span></div>`:''}
                ${variants.length?`
                  <div class="enc-card-variants">
                    <div class="enc-card-variants-title"> Variants:</div>
                    <div class="enc-variant-list">
                      ${variants.map(v=>{
                        const mods = v.mods || {};
                        const hpMod = mods.hp || 0;
                        const atkMod = mods.atk || 0;
                        const defMod = mods.def || 0;
                        const costMod = v.cost || 0;
                        const variantKey = `${u.id}-${v.id}`;
                        const hasVariantImage = variantImages[variantKey] ? true : false;
                        const formatMod = (val) => val > 0 ? `<span class="stat-up">+${val}</span>` : val < 0 ? `<span class="stat-down">${val}</span>` : '<span class="stat-same">+0</span>';
                        const formatCost = (val) => val > 0 ? `<span class="stat-down">+$${val}</span>` : val < 0 ? `<span class="stat-up">$${val}</span>` : '';
                        return `
                          <div class="enc-variant-wrapper">
                            <div class="enc-variant-thumb">${createPortraitImg(u.id, v.id, u.emoji)}</div>
                            <span class="enc-variant">${v.name} ${!hasVariantImage?'<span class="no-image-badge"></span>':''}</span>
                            <div class="variant-tooltip">
                              <div class="variant-tooltip-image">${createPortraitImg(u.id, v.id, u.emoji)}</div>
                              <div class="variant-tooltip-title">${v.name}</div>
                              <div class="variant-tooltip-desc">${v.desc || 'Alternate version'}</div>
                              <div class="variant-tooltip-stats">
                                <div class="variant-stat"> HP: ${u.hp}  ${u.hp + hpMod} (${formatMod(hpMod)})</div>
                                <div class="variant-stat"> ATK: ${u.atk}  ${u.atk + atkMod} (${formatMod(atkMod)})</div>
                                <div class="variant-stat"> DEF: ${u.def}  ${u.def + defMod} (${formatMod(defMod)})</div>
                                ${costMod !== 0 ? `<div class="variant-stat"> Cost: $${u.cost}  $${u.cost + costMod} (${formatCost(costMod)})</div>` : ''}
                              </div>
                            </div>
                          </div>`;
                      }).join('')}
                    </div>
                  </div>
                `:''}
              </div>`;
          }).join('')}
        </div>
      </div>`;
  }).join('');
}

function renderEncAbilities(){
  const types=['attack','defend','passive','aura','roundStart','roundEnd','onDeath','battleStart'];
  const typeLabels={attack:' Attack',defend:' Defense',passive:' Passive',aura:' Aura',roundStart:' Round Start',roundEnd:' Round End',onDeath:' On Death',battleStart:' Battle Start'};
  
  return types.map(type=>{
    const abilities=Object.entries(SPECIALS).filter(([n,s])=>s.type===type);
    if(!abilities.length)return'';
    return `
      <div class="enc-section">
        <div class="enc-section-title">${typeLabels[type]||type} (${abilities.length})</div>
        <div class="enc-grid">
          ${abilities.map(([name,spec])=>{
            const units=UNITS.filter(u=>u.special===name);
            return `
              <div class="enc-card enc-ability-card">
                <div class="enc-card-header">
                  <div class="enc-card-info">
                    <div class="enc-card-name">${name}</div>
                    <div class="enc-ability-type">${type}</div>
                  </div>
                  ${spec.chance?`<span class="enc-ability-chance">${Math.round(spec.chance*100)}% chance</span>`:''}
                </div>
                <div class="enc-card-desc">${spec.desc}</div>
                ${units.length?`<div style="margin-top:6px;font-size:0.7em;color:#888">Used by: ${units.map(u=>`${u.emoji} ${u.name}`).join(', ')}</div>`:''}
              </div>`;
          }).join('')}
        </div>
      </div>`;
  }).join('');
}

function renderEncEquipment(){
  const types=['weapon','armor','accessory'];
  const typeLabels={weapon:' Weapons',armor:' Armor',accessory:' Accessories'};
  
  return types.map(type=>{
    const items=Object.entries(EQUIPMENT).filter(([n,e])=>e.type===type);
    return `
      <div class="enc-section">
        <div class="enc-section-title">${typeLabels[type]} (${items.length})</div>
        <div class="enc-grid">
          ${items.map(([name,eq])=>`
            <div class="enc-card enc-equip-card">
              <div class="enc-card-header">
                <div class="enc-card-avatar" style="border-color:var(--orange)">${eq.emoji}</div>
                <div class="enc-card-info">
                  <div class="enc-card-name">${name}</div>
                  <div class="enc-equip-type">${type}</div>
                  <div style="font-size:0.8em;color:var(--gold);margin-top:4px"> $${eq.cost}</div>
                </div>
              </div>
              <div class="enc-card-stats" style="margin-top:8px">
                ${eq.stats.hp?`<div class="hp">+${eq.stats.hp} HP</div>`:''}
                ${eq.stats.atk?`<div class="atk">${eq.stats.atk>0?'+':''}${eq.stats.atk} ATK</div>`:''}
                ${eq.stats.def?`<div class="def">${eq.stats.def>0?'+':''}${eq.stats.def} DEF</div>`:''}
              </div>
              <div class="enc-card-desc">${eq.desc}</div>
              ${eq.special?`<div class="enc-equip-special"> Special: ${eq.special}</div>`:''}
            </div>
          `).join('')}
        </div>
      </div>`;
  }).join('');
}

function renderEncBattlefields(){
  return `
    <div class="enc-section">
      <div class="enc-section-title"> All Battlefields</div>
      <div class="enc-grid">
        ${BATTLEFIELDS.map(bf=>`
          <div class="enc-card enc-terrain-card">
            <div class="enc-card-header">
              <div class="enc-card-info">
                <div class="enc-card-name">${bf.name}</div>
              </div>
            </div>
            ${bf.terrain?`<div class="enc-terrain-effect"><strong>Terrain Effect:</strong> ${bf.terrain.desc}</div>`:''}
            <div style="margin-top:8px;font-size:0.7em;color:#888">
              <strong>Hazards:</strong> ${bf.hazards.join(', ')}
            </div>
            ${bf.npcs?`
              <div class="enc-npc-list">
                <strong style="font-size:0.7em;color:#888">Possible Encounters:</strong>
                ${bf.npcs.map(n=>`<span class="enc-npc ${n.hostile?'hostile':'friendly'}">${n.emoji} ${n.name}</span>`).join('')}
              </div>
            `:''}
          </div>
        `).join('')}
      </div>
    </div>`;
}

function renderEncSynergies(){
  const synergies=[
    {name:'Republic Army',req:'3+ Republic units',effect:'+10% DEF',emoji:''},
    {name:'Sith Lords',req:'2+ Sith units',effect:'+15% ATK',emoji:''},
    {name:'Jedi Council',req:'3+ Jedi units',effect:'+8% ATK & DEF',emoji:''},
    {name:'Bounty Hunters Guild',req:'2+ Bounty Hunter units',effect:'+12% ATK',emoji:''},
    {name:'Rebel Alliance',req:'3+ Rebel units',effect:'+8% ATK & DEF',emoji:''},
  ];
  
  const terrainEffects=[
    {terrain:'Lava',effect:'Front line takes 5 damage/round',icon:''},
    {terrain:'Sand',effect:'-10% DEF for all units',icon:''},
    {terrain:'Ice',effect:'15% chance to slip and miss',icon:''},
    {terrain:'Urban',effect:'Back line gets +15% DEF',icon:''},
    {terrain:'Compactor',effect:'All units lose 10 HP/round',icon:''},
    {terrain:'Swamp',effect:'Force users +20% ability chance',icon:''},
    {terrain:'Desert',effect:'Unarmored units lose 5 HP/round',icon:''},
    {terrain:'Forest',effect:'First attacker gets +25% damage',icon:''},
    {terrain:'Storm',effect:'Lightning attacks +30% damage',icon:''},
    {terrain:'Palace',effect:'Makashi/Protocol +50% effective',icon:''},
    {terrain:'Scrap',effect:'Equipment effects +25% stronger',icon:''},
    {terrain:'Dark Side',effect:'Sith +25%, Jedi -15%',icon:''},
  ];
  
  return `
    <div class="enc-section">
      <div class="enc-section-title"> Faction Synergies</div>
      <div class="enc-grid">
        ${synergies.map(s=>`
          <div class="enc-card">
            <div class="enc-card-header">
              <div class="enc-card-avatar" style="border-color:var(--cyan)">${s.emoji}</div>
              <div class="enc-card-info">
                <div class="enc-card-name">${s.name}</div>
                <div style="font-size:0.75em;color:#888">${s.req}</div>
              </div>
            </div>
            <div class="enc-card-desc" style="color:var(--green);font-weight:700">${s.effect}</div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="enc-section">
      <div class="enc-section-title"> Terrain Effects</div>
      <div class="enc-grid">
        ${terrainEffects.map(t=>`
          <div class="enc-card enc-terrain-card">
            <div class="enc-card-header">
              <div class="enc-card-avatar" style="border-color:var(--cyan)">${t.icon}</div>
              <div class="enc-card-info">
                <div class="enc-card-name">${t.terrain} Terrain</div>
              </div>
            </div>
            <div class="enc-card-desc">${t.effect}</div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="enc-section">
      <div class="enc-section-title"> Game Mechanics</div>
      <div class="enc-grid">
        <div class="enc-card">
          <div class="enc-card-name"> Leader System</div>
          <div class="enc-card-desc">Select a leader for team-wide buffs based on unit cost. If leader dies, team loses morale (-10% stats). "No Leader" mode gives smaller buff with no penalty risk.</div>
        </div>
        <div class="enc-card">
          <div class="enc-card-name"> Formation</div>
          <div class="enc-card-desc">Front line: +10% DEF, targeted first (80% of attacks). Back line: +10% ATK, protected until front falls.</div>
        </div>
        <div class="enc-card">
          <div class="enc-card-name"> Equipment</div>
          <div class="enc-card-desc">Buy equipment with your budget and assign to units. Equipment provides stat bonuses and special effects in battle.</div>
        </div>
        <div class="enc-card">
          <div class="enc-card-name"> Variants</div>
          <div class="enc-card-desc">Some units have alternate skins with different stat modifiers. Variants can be stronger or weaker than base form.</div>
        </div>
        <div class="enc-card">
          <div class="enc-card-name"> Betrayal</div>
          <div class="enc-card-desc">Some units may betray allies. Bribery can turn enemies. Rage abilities may cause friendly fire.</div>
        </div>
        <div class="enc-card">
          <div class="enc-card-name"> Resurrection</div>
          <div class="enc-card-desc">Certain abilities can revive fallen units as Undead with partial HP and ATK bonus.</div>
        </div>
      </div>
    </div>`;
}

document.addEventListener('DOMContentLoaded',()=>setMode('classic'));
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal();});

// Keyboard shortcuts for QoL
document.addEventListener('keydown', (e) => {
  // Ignore keyboard shortcuts when typing in input fields
  const activeEl = document.activeElement;
  const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
  
  // Escape to close modal (always works)
  if(e.key === 'Escape'){
    if(document.getElementById('modal').classList.contains('show')){
      closeModal();
      e.preventDefault();
    } else if(document.getElementById('encyclopedia').classList.contains('show')){
      closeEncyclopedia();
      e.preventDefault();
    } else if(document.getElementById('team-customizer').classList.contains('show')){
      closeTeamCustomizer();
      e.preventDefault();
    }
    // Also blur any focused input on Escape
    if(isTyping) activeEl.blur();
    return;
  }
  
  // Don't trigger shortcuts while typing
  if(isTyping) return;
  
  // Space to continue battle (when in battle and not in movie mode)
  if(e.key === ' ' && battle && !movieMode && !battlePaused){
    const continueBtn = document.querySelector('.btn.cont');
    if(continueBtn && !continueBtn.disabled){
      continueBtn.click();
      e.preventDefault();
    }
  }
  
  // R to randomize teams (when not in battle)
  if(e.key === 'r' && !battle && !document.getElementById('modal').classList.contains('show')){
    randomAll();
    e.preventDefault();
  }
  
  // B to start battle (when not in battle)
  if(e.key === 'b' && !battle && !document.getElementById('modal').classList.contains('show')){
    const startBtn = document.querySelector('.btn[onclick*="startBattle"]');
    if(startBtn && !startBtn.disabled){
      startBtn.click();
      e.preventDefault();
    }
  }
  
  // Number keys 1-2 to switch player tabs
  if(e.key === '1' && !battle) setActive(0);
  if(e.key === '2' && !battle && !aiMode) setActive(1);
  
  // Z for undo
  if((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey)){
    undo();
    e.preventDefault();
  }
});

// Double-click on team units to quickly remove
document.addEventListener('dblclick', (e) => {
  const unitEl = e.target.closest('.battle-unit.editable');
  if(unitEl && !battle){
    // Find the uid from the onclick handler
    const onclick = unitEl.getAttribute('onclick');
    if(onclick){
      const match = onclick.match(/openUnitEditor\('([^']+)'\)/);
      if(match){
        const uid = match[1];
        removeUnitFromModal(uid);
      }
    }
  }
});

// Show keyboard hints on first load
let hintsShown = localStorage.getItem('gc_hints_shown');
if(!hintsShown){
  setTimeout(() => {
    toast(' Tip: Press R to randomize, B to battle, Space to continue!', false, 4000);
    localStorage.setItem('gc_hints_shown', 'true');
  }, 2000);
}

// ============================================
// FLOATING IMAGE PREVIEW ON HOVER
// ============================================
const imagePreview = document.getElementById('image-preview');
const previewImg = imagePreview?.querySelector('img');
let previewTimeout = null;

function showImagePreview(e, imgSrc) {
  if (!imagePreview || !previewImg || !imgSrc) return;
  
  // Clear any pending hide
  if (previewTimeout) {
    clearTimeout(previewTimeout);
    previewTimeout = null;
  }
  
  previewImg.src = imgSrc;
  
  // Position near cursor but keep on screen
  const padding = 20;
  const previewWidth = 320;
  const previewHeight = 420;
  
  let x = e.clientX + padding;
  let y = e.clientY - previewHeight / 2;
  
  // Keep on screen horizontally
  if (x + previewWidth > window.innerWidth) {
    x = e.clientX - previewWidth - padding;
  }
  if (x < 0) x = padding;
  
  // Keep on screen vertically
  if (y < padding) y = padding;
  if (y + previewHeight > window.innerHeight - padding) {
    y = window.innerHeight - previewHeight - padding;
  }
  
  imagePreview.style.left = x + 'px';
  imagePreview.style.top = y + 'px';
  imagePreview.classList.add('visible');
}

function hideImagePreview() {
  previewTimeout = setTimeout(() => {
    if (imagePreview) {
      imagePreview.classList.remove('visible');
    }
  }, 50);
}

function updatePreviewPosition(e) {
  if (!imagePreview || !imagePreview.classList.contains('visible')) return;
  
  const padding = 20;
  const previewWidth = 320;
  const previewHeight = 420;
  
  let x = e.clientX + padding;
  let y = e.clientY - previewHeight / 2;
  
  if (x + previewWidth > window.innerWidth) {
    x = e.clientX - previewWidth - padding;
  }
  if (x < 0) x = padding;
  if (y < padding) y = padding;
  if (y + previewHeight > window.innerHeight - padding) {
    y = window.innerHeight - previewHeight - padding;
  }
  
  imagePreview.style.left = x + 'px';
  imagePreview.style.top = y + 'px';
}

// Attach hover events using event delegation
document.addEventListener('mouseover', function(e) {
  // Find the closest image container
  const imgContainer = e.target.closest('.u-img, .unit-avatar, .enc-card-avatar, .enc-variant-thumb');
  if (!imgContainer) return;
  
  const img = imgContainer.querySelector('img');
  if (img && img.src && !img.src.includes('undefined')) {
    showImagePreview(e, img.src);
  }
});

document.addEventListener('mouseout', function(e) {
  const imgContainer = e.target.closest('.u-img, .unit-avatar, .enc-card-avatar, .enc-variant-thumb');
  if (imgContainer) {
    hideImagePreview();
  }
});

document.addEventListener('mousemove', function(e) {
  if (imagePreview && imagePreview.classList.contains('visible')) {
    updatePreviewPosition(e);
  }
});
</script>
</body>
</html>
